import{i as C,F as $,ff as G,o as Q,f8 as X,dd as Z,y as H,cY as K,d as ee,aL as te,fg as oe,$ as ae,aM as le,aN as re}from"./index-1731638920964.js";import{_ as E}from"./index.vue_vue_type_script_setup_true_name_VirtualRule_lang-1731638920964.js";import{u as ne}from"./instance-1731638920964.js";import{h as ue}from"./product-17316389209644.js";import{u as se}from"./product-17316389209645.js";import{P as A}from"./index-1731638920964294.js";import{d as ie}from"./context-1731638920964.js";import"./index-1731638920964295.js";import"./index-1731638920964293.js";import{s as de}from"./utils-1731638920964.js";import{d as F,k as v,e as ce,p as pe,c as me,w as ve,ab as fe,U as f,Z as _e,f as n,u as e,G as w,V as S,X as l,_ as R,Y as P,a4 as ye,E as j}from"./vue-1731638920964.js";const ge={class:"metadata-source"},be={style:{padding:"0 10px"}},xe={style:{padding:"0 10px"}},Se={style:{display:"flex"}},Pe=F({name:"MetadataSource"}),Me=F({...Pe,props:{value:{type:Object,default:()=>{}},noEdit:{type:Array,default:()=>[]},target:{type:String,default:void 0},productNoEdit:{type:Array,default:[]},record:{type:Object,default:()=>({})},disabled:{type:Boolean,default:!1},isProduct:{type:Boolean,default:!1}},emits:["update:value"],setup(i,{emit:J}){const a=i,h=ne(),T=se(),V=ie(),U=v(de.filter(t=>C||!C&&t.value!=="rule")),I=ce(()=>o.value==="rule"&&a.target==="device"&&a.isProduct);pe("target",a.target);const q=$.useInjectFormItemContext(),o=v(""),L=v(""),_=v(null),c=v(!1),B=v(a.value||{}),N=me("metadataSource"),k=t=>{console.log("updateValue",{...a.value||{},...t}),J("update:value",{...a.value||{},...t}),q.onFieldChange()},z=t=>{o.value=t,k({source:t,type:t==="manual"?["write"]:t==="rule"?["report"]:[]})},O=async()=>{const t=await(_==null?void 0:_.value.onSave());t&&(k({...B.value,source:o.value,...t}),c.value=!1)},D=async()=>{var r,s;(await G((r=h.current)==null?void 0:r.productId,(s=h.current)==null?void 0:s.id,[a.record.id])).status===200&&Q("操作成功！")},M=async()=>{var t,r,s,y,p,g,b,x;if(C&&o.value==="rule"){let d;if(a.target==="product"?d=await ue((t=T.current)==null?void 0:t.id,a.record.id):d=await X((r=h.current)==null?void 0:r.productId,(s=h.current)==null?void 0:s.id,a.record.id),d&&d.status===200&&d.result){const m=(g=(p=(y=a.value)==null?void 0:y.virtualRule)==null?void 0:p.triggerProperties)!=null&&g.length?(x=(b=a.value)==null?void 0:b.virtualRule)==null?void 0:x.triggerProperties:d.result.triggerProperties;k({source:o.value,virtualRule:{triggerProperties:m!=null&&m.length?m:["*"],...d.result.rule}})}}};return ve(()=>JSON.stringify(a.value),()=>{var t,r,s;(t=a.value)!=null&&t.source?o.value=((r=a.value)==null?void 0:r.source)||"":o.value="device",B.value=a.value,L.value=((s=a.value)==null?void 0:s.type)||[]},{immediate:!0}),(t,r)=>{const s=Z,y=H,p=fe("AIcon"),g=K,b=ee,x=te,d=oe,m=ae,W=le,Y=re;return f(),_e("div",ge,[n(s,{value:e(o),"onUpdate:value":r[0]||(r[0]=u=>w(o)?o.value=u:null),placeholder:"请选择来源",style:{flex:"1 1 0","min-width":"0"},options:e(U),dropdownStyle:{zIndex:1071},getPopupContainer:u=>e(V)||u,disabled:i.disabled,onChange:z},null,8,["value","options","getPopupContainer","disabled"]),e(o)!="manual"&&!e(I)?(f(),S(e(A),{key:0,visible:e(c),"onUpdate:visible":r[1]||(r[1]=u=>w(c)?c.value=u:null),bodyStyle:{width:"450px",height:e(o)==="rule"?"300px":"92px"},placement:"bottomRight",onOk:O},{content:l(()=>[e(o)?(f(),S(y,{key:0},{default:l(()=>[R("div",be,[e(c)?(f(),S(E,{key:0,source:e(o),value:i.record,isProduct:i.isProduct,dataSource:e(N),ref_key:"virtualRuleRef",ref:_},null,8,["source","value","isProduct","dataSource"])):P("",!0)])]),_:1})):P("",!0)]),default:l(()=>[n(g,{style:{padding:"0"},type:"link",disabled:i.disabled,onClick:M},{icon:l(()=>{var u;return[n(p,{type:"EditOutlined",class:ye({"table-form-required-aicon":!((u=i.value.type)!=null&&u.length)})},null,8,["class"])]}),_:1},8,["disabled"])]),_:1},8,["visible","bodyStyle"])):P("",!0),e(o)==="rule"&&i.target==="device"&&e(I)?(f(),S(Y,{key:1,placement:"bottom",trigger:"click",getPopupContainer:u=>e(V)||u},{overlay:l(()=>[n(W,null,{default:l(()=>[n(x,null,{default:l(()=>[n(e(A),{visible:e(c),"onUpdate:visible":r[2]||(r[2]=u=>w(c)?c.value=u:null),bodyStyle:{width:"450px",height:e(o)==="rule"?"300px":"80px"},placement:"bottomRight",onOk:O},{content:l(()=>[e(o)?(f(),S(y,{key:0},{default:l(()=>[R("div",xe,[n(E,{source:e(o),value:i.record,isProduct:i.isProduct,dataSource:e(N),ref_key:"virtualRuleRef",ref:_},null,8,["source","value","isProduct","dataSource"])])]),_:1})):P("",!0)]),default:l(()=>[n(b,{style:{padding:"4px 8px"},type:"link"},{default:l(()=>[j(" 编辑 ")]),_:1})]),_:1},8,["visible","bodyStyle"])]),_:1}),n(d),n(x,null,{default:l(()=>[R("div",Se,[n(b,{style:{padding:"4px 8px"},type:"link",onClick:D},{default:l(()=>[j(" 重置 ")]),_:1}),n(m,null,{title:l(()=>[j("重置为产品属性规则")]),default:l(()=>[n(p,{type:"QuestionCircleOutlined",style:{"margin-top":"10px"}})]),_:1})])]),_:1})]),_:1})]),default:l(()=>[n(g,{style:{padding:"0"},type:"link",onClick:M},{icon:l(()=>[n(p,{type:"MoreOutlined"})]),_:1})]),_:1},8,["getPopupContainer"])):P("",!0)])}}});export{Me as _};
