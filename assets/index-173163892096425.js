import{o as x,aH as Pe,Z as xe,dv as we,I as ke,v as je,a0 as Ne,$ as Se,aD as Le,a6 as Ae,a1 as De,K as Be,M as Ue,af as Ee,aI as qe,d as Oe,a9 as $e,F as Re,aR as Fe,g as Je}from"./index-1731638920964.js";import"./index-1731638920964288.js";import"./index-1731638920964276.js";import"./index-1731638920964283.js";import Qe from"./doc-1731638920964.js";import{d as Ve,g as Te,q as ze,a as Me,s as Ze,_ as He,b as Xe,c as Ye}from"./alicloud-1731638920964.js";import{_ as Ge}from"./index.vue_vue_type_script_setup_true_lang-17316389209646.js";import{_ as We}from"./product-17316389209644.js";import{l as se}from"./lodash.default-1731638920964.js";import{d as et,k as I,r as tt,e as at,w as st,ab as ot,u as d,U as _,Z as N,_ as v,f as t,V as h,X as a,$ as S,E as m,Y as F,F as B,a1 as U,J as nt,af as lt,ag as dt}from"./vue-1731638920964.js";import"./index-1731638920964298.js";import"./throttle-1731638920964.js";import"./min-1731638920964.js";import"./isNil-1731638920964.js";import"./isUndefined-1731638920964.js";import"./difference-1731638920964.js";import"./flattenDeep-1731638920964.js";import"./sortBy-1731638920964.js";import"./unionBy-1731638920964.js";import"./uniqBy-1731638920964.js";import"./toLower-1731638920964.js";const ct=g=>(lt("data-v-496f46c6"),g=g(),dt(),g),rt={key:0,class:"box"},it={class:"left"},ut={class:"left-content"},pt={style:{display:"flex","justify-content":"space-between","align-items":"center"}},_t={style:{width:"calc(100% - 100px)","text-align":"center"}},ft=ct(()=>v("p",null,"产品映射",-1)),mt={class:"right"},gt={class:"control"},vt=et({__name:"index",props:{data:{type:Object}},emits:["refreshList"],setup(g,{emit:L}){const y=g,E=I(),k=I(new Set),q=I(!1),o=tt({id:void 0,name:void 0,accessConfig:{regionId:void 0,instanceId:void 0,accessKeyId:void 0,accessSecret:void 0,apiEndpoint:void 0},bridgeProductKey:void 0,bridgeProductName:void 0,mappings:[{productKey:void 0,productId:void 0}],description:void 0}),oe=()=>{w.value.push(String(o.mappings.length)),o.mappings.push({productKey:void 0,productId:void 0})},ne=e=>{o.mappings.splice(e,1)},A=I([]),J=I([]),K=I([]),O=I(!1),w=I(["0"]),le=async()=>{const e=await Te();e.status===200&&(J.value=e.result)},Q=async()=>{const e=await ze({paging:!1,sorts:[{name:"createTime",order:"desc"}]});e.status===200&&(A.value=e==null?void 0:e.result)},V=async e=>{var s;if(e.regionId&&e.accessKeyId&&e.accessSecret){const l=await Me(e).catch(()=>{K.value=[],o.bridgeProductKey=void 0});l.status===200&&(K.value=(s=l==null?void 0:l.result)==null?void 0:s.data)}},D=()=>{const e=o.accessConfig;V(e)},de=e=>{const s=o.mappings.map(c=>c==null?void 0:c.productId)||[],l=se.cloneDeep(s),u=l.findIndex(c=>c===e);return l.splice(u,1),A.value.filter(c=>!l.includes(c==null?void 0:c.id))||[]},ce=e=>{var c;const s=o.mappings.map(r=>r==null?void 0:r.productKey)||[],l=se.cloneDeep(s),u=l.findIndex(r=>r===e);return l.splice(u,1),((c=K.value)==null?void 0:c.filter(r=>!l.includes(r==null?void 0:r.productKey)))||[]},re=e=>{w.value=e},T=at(()=>k.value.size?"当前选择的部分产品为禁用状态":""),ie=e=>{o.accessConfig.apiEndpoint=`https://iot.${e}.aliyuncs.com`},ue=async()=>{[...k.value.values()].forEach(async e=>{const s=await We(e).catch(l=>{x("操作失败","error")});(s==null?void 0:s.status)===200&&(k.value.delete(e),x("操作成功！"))}),await Q()},pe=e=>{const s=A.value.find(l=>l.id===e);e&&s&&!(s!=null&&s.state)&&k.value.add(e)},_e=(e,s)=>new Promise((l,u)=>{const p=A.value.find(c=>c.id===s);return!o.id||o.id===":id"?l(""):!p&&s?u("关联产品已被删除，请重新选择"):l("")}),fe=()=>{E.value.validate().then(async e=>{var u;console.log(e,"data");const s=(K.value||[]).find(p=>(p==null?void 0:p.productKey)===(e==null?void 0:e.bridgeProductKey));e.bridgeProductName=(s==null?void 0:s.productName)||"",e.accessConfig.apiEndpoint=o.accessConfig.apiEndpoint,O.value=!0,(await Ze({...nt(o),...e}).finally(()=>{O.value=!1})).status===200&&(x("操作成功！"),(u=y.data)!=null&&u.id?L("refreshList",!0):L("refreshList"))}).catch(e=>{e.errorFields.map(l=>l.name).map(l=>{l.length===3&&!w.value.includes(l[1])&&w.value.push(l[1])})})},me=()=>{var s,l,u,p;let e;return((l=(s=y.data)==null?void 0:s.state)==null?void 0:l.value)!=="disabled"?e=He((u=y.data)==null?void 0:u.id):e=Xe((p=y.data)==null?void 0:p.id),e.then(c=>{c&&c.status===200?(x("操作成功！"),L("refreshList",!0)):x("操作失败！","error")}),e},ge=()=>{var s;const e=Ye((s=y.data)==null?void 0:s.id);return e.then(l=>{l.status===200?(x("操作成功！"),L("refreshList")):x("操作失败！","error")}),e};return st(()=>y.data,async()=>{var e,s,l,u,p,c;if((e=k.value)==null||e.clear(),q.value=!1,(s=E.value)==null||s.resetFields(),(l=y.data)!=null&&l.id){le(),await Q();const i=(await Ve((u=y.data)==null?void 0:u.id)).result;i&&V(i==null?void 0:i.accessConfig),Object.assign(o,i),w.value=((i==null?void 0:i.mappings)||[]).map((b,P)=>P)}else((p=y.data)==null?void 0:p.type)==="add"?(o.id=void 0,o.name=void 0,o.accessConfig={regionId:void 0,instanceId:void 0,accessKeyId:void 0,accessSecret:void 0,apiEndpoint:void 0},o.bridgeProductKey=void 0,o.bridgeProductName=void 0,o.mappings=[{productKey:void 0,productId:void 0}],o.description=void 0,K.value=[]):((c=y.data)==null?void 0:c.type)==="noData"&&(q.value=!0)},{immediate:!0,deep:!0}),(e,s)=>{var Z;const l=Pe,u=xe,p=we,c=ke,r=je,i=Ne,b=ot("AIcon"),P=Se,$=Le,R=Ae,z=De,ve=Be,ye=Ue,M=Ee,he=qe,Ce=Oe,be=$e,Ie=Re,Ke=Fe;return d(q)?(_(),h(M,{key:1,style:{height:"calc(100vh - 300px)","padding-top":"200px"}})):(_(),N("div",rt,[v("div",it,[v("div",ut,[t(l,{data:"基本信息"}),d(T)&&((Z=d(o))!=null&&Z.id)?(_(),h(p,{key:0,style:{margin:"10px 0"},type:"warning"},{message:a(()=>[v("div",pt,[v("span",_t,S(d(T)),1),t(u,{popConfirm:{title:"确认启用",onConfirm:ue},size:"small",hasPermission:"device/Product:action"},{default:a(()=>[m(" 立即启用 ")]),_:1},8,["popConfirm"])])]),_:1})):F("",!0),t(Ie,{layout:"vertical",ref_key:"formRef",ref:E,model:d(o)},{default:a(()=>[t(z,{gutter:24},{default:a(()=>[t(i,{span:24},{default:a(()=>[t(r,{label:"名称",name:"name",rules:[{required:!0,message:"请输入名称"},{max:64,message:"最多输入64个字符"}]},{default:a(()=>[t(c,{placeholder:"请输入名称",value:d(o).name,"onUpdate:value":s[0]||(s[0]=n=>d(o).name=n)},null,8,["value"])]),_:1})]),_:1}),t(i,{span:24},{default:a(()=>[t(r,{name:["accessConfig","regionId"],rules:[{required:!0,message:"请选择服务地址"}]},{label:a(()=>[v("span",null,[m(" 服务地址 "),t(P,{title:"阿里云内部给每台机器设置的唯一编号"},{default:a(()=>[t(b,{type:"QuestionCircleOutlined",style:{"margin-left":"2px"}})]),_:1})])]),default:a(()=>[t(R,{placeholder:"请选择服务地址",value:d(o).accessConfig.regionId,"onUpdate:value":s[1]||(s[1]=n=>d(o).accessConfig.regionId=n),"show-search":"",onChange:ie,onBlur:D},{default:a(()=>[(_(!0),N(B,null,U(d(J),n=>(_(),h($,{key:n.id,value:n.id,label:n.name},{default:a(()=>[m(S(n.name),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["value"])]),_:1})]),_:1}),t(i,{span:24},{default:a(()=>[t(r,{name:["accessConfig","instanceId"]},{label:a(()=>[v("span",null,[m(" 实例ID "),t(P,{title:"阿里云物联网平台中的实例ID,没有则不填"},{default:a(()=>[t(b,{type:"QuestionCircleOutlined",style:{"margin-left":"2px"}})]),_:1})])]),default:a(()=>[t(c,{placeholder:"请输入实例ID",value:d(o).accessConfig.instanceId,"onUpdate:value":s[2]||(s[2]=n=>d(o).accessConfig.instanceId=n),onBlur:D},null,8,["value"])]),_:1})]),_:1}),t(i,{span:24},{default:a(()=>[t(r,{name:["accessConfig","accessKeyId"],rules:[{required:!0,message:"请输入accessKey"},{max:64,message:"最多输入64个字符"}]},{label:a(()=>[v("span",null,[m(" accessKey "),t(P,{title:"用于程序通知方式调用云服务API的用户标识"},{default:a(()=>[t(b,{type:"QuestionCircleOutlined",style:{"margin-left":"2px"}})]),_:1})])]),default:a(()=>[t(c,{placeholder:"请输入accessKey",value:d(o).accessConfig.accessKeyId,"onUpdate:value":s[3]||(s[3]=n=>d(o).accessConfig.accessKeyId=n),onBlur:D},null,8,["value"])]),_:1})]),_:1}),t(i,{span:24},{default:a(()=>[t(r,{name:["accessConfig","accessSecret"],rules:[{required:!0,message:"请输入accessSecret"},{max:64,message:"最多输入64个字符"}]},{label:a(()=>[v("span",null,[m(" accessSecret "),t(P,{title:"用于程序通知方式调用云服务费API的秘钥标识"},{default:a(()=>[t(b,{type:"QuestionCircleOutlined",style:{"margin-left":"2px"}})]),_:1})])]),default:a(()=>[t(c,{placeholder:"请输入accessSecret",value:d(o).accessConfig.accessSecret,"onUpdate:value":s[4]||(s[4]=n=>d(o).accessConfig.accessSecret=n),onBlur:D},null,8,["value"])]),_:1})]),_:1}),t(i,{span:24},{default:a(()=>[t(r,{name:"bridgeProductKey",rules:{required:!0,message:"请选择网桥产品"}},{label:a(()=>[v("span",null,[m(" 网桥产品 "),t(P,{title:"物联网平台对应的阿里云产品"},{default:a(()=>[t(b,{type:"QuestionCircleOutlined",style:{"margin-left":"2px"}})]),_:1})])]),default:a(()=>[t(R,{placeholder:"请选择网桥产品",value:d(o).bridgeProductKey,"onUpdate:value":s[5]||(s[5]=n=>d(o).bridgeProductKey=n),"show-search":""},{default:a(()=>[(_(!0),N(B,null,U(d(K),n=>(_(),h($,{key:n.productKey,value:n.productKey,label:n.productName},{default:a(()=>[m(S(n.productName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["value"])]),_:1})]),_:1}),t(i,{span:24},{default:a(()=>[ft,d(o).mappings.length?(_(),h(ye,{key:0,activeKey:d(w),onChange:re},{default:a(()=>[(_(!0),N(B,null,U(d(o).mappings,(n,C)=>{var j;return _(),h(ve,{key:C,forceRender:!1,header:n.productKey?((j=d(K).find(f=>f.productKey===n.productKey))==null?void 0:j.productName)||`产品映射${C+1}`:`产品映射${C+1}`},{extra:a(()=>[t(b,{type:"DeleteOutlined",onClick:f=>ne(C)},null,8,["onClick"])]),default:a(()=>[t(z,{gutter:24},{default:a(()=>[t(i,{span:12},{default:a(()=>[t(r,{label:"阿里云产品",name:["mappings",C,"productKey"],rules:{required:!0,message:"请选择阿里云产品"}},{default:a(()=>[t(R,{placeholder:"请选择阿里云产品",value:n.productKey,"onUpdate:value":f=>n.productKey=f,"show-search":""},{default:a(()=>[(_(!0),N(B,null,U(ce((n==null?void 0:n.productKey)||""),f=>(_(),h($,{key:f.productKey,value:f.productKey,label:f.productName},{default:a(()=>[m(S(f.productName),1)]),_:2},1032,["value","label"]))),128))]),_:2},1032,["value","onUpdate:value"])]),_:2},1032,["name"])]),_:2},1024),t(i,{span:12},{default:a(()=>[t(r,{label:"平台产品",name:["mappings",C,"productId"],rules:[{required:!0,message:"请选择平台产品"},{validator:_e,trigger:"change"}]},{default:a(()=>[t(Ge,{value:n.productId,"onUpdate:value":f=>n.productId=f,options:de(n.productId||""),onError:pe},null,8,["value","onUpdate:value","options"])]),_:2},1032,["name","rules"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["header"])}),128))]),_:1},8,["activeKey"])):(_(),h(he,{key:1},{default:a(()=>[t(M)]),_:1}))]),_:1}),t(i,{span:24},{default:a(()=>[t(Ce,{type:"dashed",style:{width:"100%","margin-top":"10px"},onClick:oe},{default:a(()=>[t(b,{type:"PlusOutlined",style:{"margin-left":"2px"}}),m("添加 ")]),_:1})]),_:1}),t(i,{span:24,style:{"margin-top":"20px"}},{default:a(()=>[t(r,{label:"说明",name:"description",rules:{max:200,message:"最多输入200个字符"}},{default:a(()=>[t(be,{value:d(o).description,"onUpdate:value":s[6]||(s[6]=n=>d(o).description=n),placeholder:"请输入说明",showCount:"",maxlength:200},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])])]),v("div",mt,[t(Qe)]),v("div",gt,[t(Ke,null,{default:a(()=>{var n,C,j,f,H,X,Y,G,W,ee;return[(n=g.data)!=null&&n.id?(_(),h(u,{key:0,hasPermission:"Northbound/AliCloud:delete",danger:"",disabled:((j=(C=g.data)==null?void 0:C.state)==null?void 0:j.value)!=="disabled",tooltip:{title:((H=(f=g.data)==null?void 0:f.state)==null?void 0:H.value)!=="disabled"?"请先禁用该数据，再删除。":"删除"},popConfirm:{title:"确认删除",onConfirm:ge}},{default:a(()=>[m("删除 ")]),_:1},8,["disabled","tooltip","popConfirm"])):F("",!0),(X=g.data)!=null&&X.id?(_(),h(u,{key:1,type:"primary",ghost:"",hasPermission:"Northbound/AliCloud:action",tooltip:{title:((G=(Y=g.data)==null?void 0:Y.state)==null?void 0:G.value)!=="disabled"?"禁用":"启用"},popConfirm:{title:`确认${((ee=(W=g.data)==null?void 0:W.state)==null?void 0:ee.value)!=="disabled"?"禁用":"启用"}?`,onConfirm:me}},{default:a(()=>{var te,ae;return[m(S(((ae=(te=g.data)==null?void 0:te.state)==null?void 0:ae.value)!=="disabled"?"禁用":"启用"),1)]}),_:1},8,["tooltip","popConfirm"])):F("",!0),t(u,{type:"primary",loading:d(O),onClick:fe,hasPermission:["Northbound/AliCloud:add","Northbound/AliCloud:update"]},{default:a(()=>[m(" 保存 ")]),_:1},8,["loading"])]}),_:1})])]))}}});const $t=Je(vt,[["__scopeId","data-v-496f46c6"]]);export{$t as default};
