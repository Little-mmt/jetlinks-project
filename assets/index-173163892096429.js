import{d as Ae,k as b,r as qe,e as E,w as Be,ab as $e,u as m,U as f,Z as x,_ as h,f as t,V as g,X as e,$ as j,E as y,Y as B,F as U,a1 as N,v as Ve,A as Fe,B as fe,af as Le,ag as Ke}from"./vue-1731638920964.js";import{a4 as Je,o as k,aH as Re,Z as Ee,dv as Qe,I as Ze,v as ze,a0 as He,$ as Xe,aD as Ye,a6 as Ge,aO as We,a1 as et,K as tt,M as at,af as nt,aI as ot,d as st,a9 as pt,F as lt,aR as rt,g as it}from"./index-1731638920964.js";import"./index-1731638920964288.js";import"./index-1731638920964276.js";import"./index-1731638920964283.js";import dt from"./doc-17316389209642.js";import ut from"./index-173163892096428.js";import{d as ct,q as mt,a as _t,s as ft,_ as vt,b as gt,c as yt}from"./dueros-1731638920964.js";import{_ as ve}from"./index.vue_vue_type_script_setup_true_lang-17316389209646.js";import{_ as ht}from"./product-17316389209644.js";import{l as ge}from"./lodash.default-1731638920964.js";import"./index-1731638920964284.js";import"./index-1731638920964298.js";import"./EditTable.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./index-1731638920964282.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import"./throttle-1731638920964.js";import"./min-1731638920964.js";import"./isNil-1731638920964.js";import"./isUndefined-1731638920964.js";import"./difference-1731638920964.js";import"./flattenDeep-1731638920964.js";import"./sortBy-1731638920964.js";import"./unionBy-1731638920964.js";import"./uniqBy-1731638920964.js";import"./toLower-1731638920964.js";const ye=C=>(Le("data-v-81991fc3"),C=C(),Ke(),C),Ct={key:0,class:"box"},Mt={class:"left"},Tt={class:"left-content"},bt={style:{display:"flex","justify-content":"space-between","align-items":"center"}},wt={style:{width:"calc(100% - 100px)","text-align":"center"}},Dt=ye(()=>h("p",null,"动作映射",-1)),xt=ye(()=>h("p",{style:{"margin-top":"20px"}},"属性映射",-1)),kt={class:"right"},Ot={class:"control"},Pt=Ae({__name:"index",props:{data:{type:Object}},emits:["refreshList"],setup(C,{emit:A}){const M=C,$=b(),V=b(!1),n=qe({id:void 0,name:void 0,applianceType:void 0,productName:void 0,actionMappings:[{actionType:void 0,action:void 0,command:{messageType:void 0,message:{properties:void 0,functionId:void 0,inputs:[]}}}],propertyMappings:[{source:void 0,target:void 0}],description:void 0}),O=b([]),F=b([]),L=b([]),K=b(!1),D=b(["0"]),P=b(["0"]),S=b(""),he=a=>{P.value=a},Ce=a=>{D.value=a},Me=a=>{n.actionMappings[a].command={messageType:void 0,message:{properties:void 0,functionId:void 0,inputs:[],value:void 0}}},Q=()=>{D.value.push(String(n.actionMappings.length)),n.actionMappings.push({actionType:void 0,action:void 0,command:{messageType:void 0,message:{properties:void 0,functionId:void 0,inputs:[]}}})},Te=a=>{n.actionMappings.splice(a,1),n.actionMappings.length||Q()},Z=()=>{P.value.push(String(n.propertyMappings.length)),n.propertyMappings.push({source:void 0,target:void 0})},be=a=>{n.propertyMappings.splice(a,1),n.propertyMappings.length||Z()},z=a=>{var s,r;n.propertyMappings=(s=n.propertyMappings)==null?void 0:s.map(i=>({source:i.source,target:void 0})),n.actionMappings=(r=n.actionMappings)==null?void 0:r.map(i=>({...i,command:{messageType:void 0,message:{properties:void 0,functionId:void 0,inputs:[],value:void 0}}}));const o=O.value.find(i=>i.id===a);o&&(n.productName=o.name)},we=()=>{var a,o;n.propertyMappings=(a=n.propertyMappings)==null?void 0:a.map(s=>({source:void 0,target:s.target})),n.actionMappings=(o=n.actionMappings)==null?void 0:o.map(s=>({...s,action:void 0}))},H=E(()=>{if(n.applianceType)return F.value.find(a=>a.id===n.applianceType)}),X=E(()=>{var o;return n.id?(o=O.value)==null?void 0:o.find(s=>s.id===n.id):void 0}),Y=E(()=>{var a,o;if(n.id)return((a=X.value)==null?void 0:a.metadata)&&JSON.parse(((o=X.value)==null?void 0:o.metadata)||"{}")}),G=async a=>{const o=await mt(a);o.status===200&&(O.value=o==null?void 0:o.result)},De=async()=>{const a=await _t();a.status===200&&(F.value=a==null?void 0:a.result)},W=a=>{var d,_;const o=((d=n.propertyMappings)==null?void 0:d.map(p=>p==null?void 0:p.source))||[],s=ge.cloneDeep(o),r=s.findIndex(p=>p===a);s.splice(r,1);const i=(_=H.value)==null?void 0:_.properties;return(i==null?void 0:i.filter(p=>!(s!=null&&s.includes(p==null?void 0:p.id))))||[]},xe=a=>{var d,_;const s=(((d=n.propertyMappings)==null?void 0:d.map(p=>p==null?void 0:p.target))||[]).filter(p=>p),r=[];s==null||s.map(p=>{a!=null&&a.includes(p)||r.push(p)});const i=(_=Y.value)==null?void 0:_.properties;return(i==null?void 0:i.filter(p=>!(r!=null&&r.includes(p.id))))||[]},ee=a=>{var d,_;const o=((d=n.actionMappings)==null?void 0:d.map(p=>p==null?void 0:p.action))||[],s=ge.cloneDeep(o),r=s.findIndex(p=>p===a);s.splice(r,1);const i=((_=H.value)==null?void 0:_.actions)||[];return(i==null?void 0:i.filter(p=>!(s!=null&&s.includes(p==null?void 0:p.id))))||[]},ke=()=>{if(n.id){const a=ht(n.id);return a.then(o=>{o.status===200&&(k("操作成功！"),G(n.id),S.value="")}),a}},Oe=(a,o)=>new Promise((s,r)=>{const i=O.value.find(u=>u.id===o);return n.id?!i&&o?(z(o),r("关联产品已被删除，请重新选择")):(i!=null&&i.state?S.value="":S.value=`当前选择的${i.name}产品为禁用状态`,s("")):s("")}),Pe=async()=>{var o;const a=[];for(let s=0;s<L.value.length;s++){const r=await((o=L.value[s])==null?void 0:o.saveBtn());!r||r!=null&&r.errorFields&&r.errorFields.length?(D.value.push(String(s)),a.push(!1)):a.push(r)}$.value.validate().then(async s=>{var r,i;a.every(u=>u)&&s&&(K.value=!0,s.propertyMappings=(r=s.propertyMappings)==null?void 0:r.map(d=>({source:d.source,target:Array.isArray(d==null?void 0:d.target)?d==null?void 0:d.target:[d==null?void 0:d.target]})),(await ft(s).finally(()=>{K.value=!1})).status===200&&(k("操作成功！"),(i=M.data)!=null&&i.id?A("refreshList",!0):A("refreshList")))}).catch(s=>{var i;const r=(i=s.errorFields)==null?void 0:i.map(u=>u.name);r==null||r.map(u=>{var d;u.length>=3&&(u[0]==="propertyMappings"&&!((d=P.value)!=null&&d.includes(u[1]))&&P.value.push(u[1]),u[0]==="actionMappings"&&!D.value.includes(u[1])&&D.value.push(u[1]))})})},Se=()=>{var o,s,r,i;let a;return((s=(o=M.data)==null?void 0:o.state)==null?void 0:s.value)!=="disabled"?a=vt((r=M.data)==null?void 0:r.id):a=gt((i=M.data)==null?void 0:i.id),a.then(u=>{u&&u.status===200?(k("操作成功！"),A("refreshList",!0)):k("操作失败！","error")}),a},Ie=()=>{var o;const a=yt((o=M.data)==null?void 0:o.id);return a.then(s=>{s.status===200?(k("操作成功！"),A("refreshList")):k("操作失败！","error")}),a};return Be(()=>M.data,async()=>{var a,o,s,r,i,u,d;if(V.value=!1,(a=$.value)==null||a.resetFields(),(o=M.data)!=null&&o.id){await G((s=M.data)==null?void 0:s.id),De();const p=(await ct((r=M.data)==null?void 0:r.id)).result,T=Je(p);p&&(T.applianceType=(i=T==null?void 0:T.applianceType)==null?void 0:i.value),Object.assign(n,T)}else((u=M.data)==null?void 0:u.type)==="add"?(n.id=void 0,n.name=void 0,n.applianceType=void 0,n.productName=void 0,n.actionMappings=[{actionType:void 0,action:void 0,command:{messageType:void 0,message:{properties:void 0,functionId:void 0,inputs:[]}}}],n.propertyMappings=[{source:void 0,target:void 0}],n.description=void 0):((d=M.data)==null?void 0:d.type)==="noData"&&(V.value=!0)},{immediate:!0,deep:!0}),(a,o)=>{var pe;const s=Re,r=Ee,i=Qe,u=Ze,d=ze,_=He,p=$e("AIcon"),T=Xe,I=Ye,q=Ge,te=We,J=et,ae=tt,ne=at,R=nt,oe=ot,se=st,je=pt,Ue=lt,Ne=rt;return m(V)?(f(),g(R,{key:1,style:{height:"calc(100vh - 300px)","padding-top":"200px"}})):(f(),x("div",Ct,[h("div",Mt,[h("div",Tt,[t(s,{data:"基本信息"}),m(S)&&((pe=m(n))!=null&&pe.id)?(f(),g(i,{key:0,style:{margin:"10px 0"},type:"warning"},{message:e(()=>[h("div",bt,[h("span",wt,j(m(S)),1),t(r,{popConfirm:{title:"确认启用",onConfirm:ke},size:"small",hasPermission:"device/Product:action"},{default:e(()=>[y(" 立即启用 ")]),_:1},8,["popConfirm"])])]),_:1})):B("",!0),t(Ue,{layout:"vertical",ref_key:"formRef",ref:$,model:m(n)},{default:e(()=>[t(J,{gutter:24},{default:e(()=>[t(_,{span:24},{default:e(()=>[t(d,{label:"名称",name:"name",rules:[{required:!0,message:"请输入名称"},{max:64,message:"最多输入64个字符"}]},{default:e(()=>[t(u,{placeholder:"请输入名称",value:m(n).name,"onUpdate:value":o[0]||(o[0]=l=>m(n).name=l)},null,8,["value"])]),_:1})]),_:1}),t(_,{span:12},{default:e(()=>[t(d,{label:"产品",name:"id",rules:[{required:!0,message:"请选择产品"},{validator:Oe,trigger:"change"}]},{default:e(()=>[t(ve,{value:m(n).id,"onUpdate:value":o[1]||(o[1]=l=>m(n).id=l),options:m(O),onChange:z},null,8,["value","options"])]),_:1},8,["rules"])]),_:1}),t(_,{span:12},{default:e(()=>[t(d,{name:"applianceType",rules:{required:!0,message:"请选择设备类型"}},{label:e(()=>[h("span",null,[y(" 设备类型 "),t(T,{title:"DuerOS平台拟定的规范"},{default:e(()=>[t(p,{type:"QuestionCircleOutlined",style:{"margin-left":"2px"}})]),_:1})])]),default:e(()=>[t(q,{placeholder:"请选择设备类型",value:m(n).applianceType,"onUpdate:value":o[2]||(o[2]=l=>m(n).applianceType=l),"show-search":"",onChange:we},{default:e(()=>[(f(!0),x(U,null,N(m(F),l=>(f(),g(I,{key:l.id,value:l.id,label:l.name},{default:e(()=>[y(j(l.name),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["value"])]),_:1}),Ve(t(d,{name:"productName",label:"产品名称"},{default:e(()=>[t(u,{value:m(n).productName,"onUpdate:value":o[3]||(o[3]=l=>m(n).productName=l)},null,8,["value"])]),_:1},512),[[Fe,!1]])]),_:1}),t(_,{span:24},{default:e(()=>[Dt,m(n).actionMappings.length?(f(),g(ne,{key:0,activeKey:m(D),onChange:Ce},{default:e(()=>[(f(!0),x(U,null,N(m(n).actionMappings,(l,v)=>{var w;return f(),g(ae,{key:v,header:l.action?(w=ee(l.action).find(c=>c.id===l.action))==null?void 0:w.name:`动作映射${v+1}`},{extra:e(()=>[h("div",{style:{width:"20px"},onClick:o[4]||(o[4]=fe(()=>{},["stop"]))},[t(te,{title:"确认删除？",onConfirm:()=>Te(v)},{default:e(()=>[t(p,{type:"DeleteOutlined"})]),_:2},1032,["onConfirm"])])]),default:e(()=>[t(J,{gutter:24},{default:e(()=>[t(_,{span:12},{default:e(()=>[t(d,{name:["actionMappings",v,"action"],rules:{required:!0,message:"请选择动作"}},{label:e(()=>[h("span",null,[y(" 动作 "),t(T,{title:"DuerOS平台拟定的设备类型具有的相关动作"},{default:e(()=>[t(p,{type:"QuestionCircleOutlined"})]),_:1})])]),default:e(()=>[t(q,{placeholder:"请选择动作",value:l.action,"onUpdate:value":c=>l.action=c,"show-search":""},{default:e(()=>[(f(!0),x(U,null,N(ee(l.action||""),c=>(f(),g(I,{key:c.id,value:c.id,label:c.name},{default:e(()=>[y(j(c.name),1)]),_:2},1032,["value","label"]))),128))]),_:2},1032,["value","onUpdate:value"])]),_:2},1032,["name"])]),_:2},1024),t(_,{span:12},{default:e(()=>[t(d,{name:["actionMappings",v,"actionType"],rules:{required:!0,message:"请选择操作"}},{label:e(()=>[h("span",null,[y(" 操作 "),t(T,{title:"映射物联网平台中所选产品具备的动作"},{default:e(()=>[t(p,{type:"QuestionCircleOutlined"})]),_:1})])]),default:e(()=>[t(q,{placeholder:"请选择操作",value:l.actionType,"onUpdate:value":c=>l.actionType=c,"show-search":"",onChange:()=>Me(v)},{default:e(()=>[t(I,{value:"command"},{default:e(()=>[y("下发指令")]),_:1}),t(I,{value:"latestData"},{default:e(()=>[y("获取历史数据")]),_:1})]),_:2},1032,["value","onUpdate:value","onChange"])]),_:2},1032,["name"])]),_:2},1024),l.actionType?(f(),g(_,{key:0,span:24},{default:e(()=>[t(d,{name:["actionMappings",v,"command"]},{default:e(()=>[t(ut,{ref_for:!0,ref_key:"command",ref:L,metadata:m(Y),modelValue:l.command,"onUpdate:modelValue":c=>l.command=c,actionType:l.actionType},null,8,["metadata","modelValue","onUpdate:modelValue","actionType"])]),_:2},1032,["name"])]),_:2},1024)):B("",!0)]),_:2},1024)]),_:2},1032,["header"])}),128))]),_:1},8,["activeKey"])):(f(),g(oe,{key:1},{default:e(()=>[t(R)]),_:1}))]),_:1}),t(_,{span:24},{default:e(()=>[t(se,{type:"dashed",style:{width:"100%","margin-top":"10px"},onClick:Q},{default:e(()=>[t(p,{type:"PlusOutlined",style:{"margin-left":"2px"}}),y("新增动作 ")]),_:1})]),_:1}),t(_,{span:24},{default:e(()=>[xt,m(n).propertyMappings.length?(f(),g(ne,{key:0,activeKey:m(P),onChange:he},{default:e(()=>[(f(!0),x(U,null,N(m(n).propertyMappings,(l,v)=>{var w;return f(),g(ae,{key:v,header:l.source?(w=W(l.source).find(c=>c.id===l.source))==null?void 0:w.name:`属性映射${v+1}`},{extra:e(()=>[h("div",{style:{width:"20px"},onClick:o[5]||(o[5]=fe(()=>{},["stop"]))},[t(te,{title:"确认删除？",onConfirm:()=>be(v)},{default:e(()=>[t(p,{type:"DeleteOutlined"})]),_:2},1032,["onConfirm"])])]),default:e(()=>[t(J,{gutter:24},{default:e(()=>[t(_,{span:12},{default:e(()=>[t(d,{label:"DuerOS属性",name:["propertyMappings",v,"source"],rules:{required:!0,message:"请选择DuerOS属性"}},{default:e(()=>[t(q,{placeholder:"请选择DuerOS属性",value:l.source,"onUpdate:value":c=>l.source=c,"show-search":""},{default:e(()=>[(f(!0),x(U,null,N(W(l.source||""),c=>(f(),g(I,{key:c.id,value:c.id},{default:e(()=>[y(j(c.name),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"])]),_:2},1032,["name"])]),_:2},1024),t(_,{span:12},{default:e(()=>[t(d,{label:"平台属性",name:["propertyMappings",v,"target"],rules:[{required:!0,message:"请选择平台属性"}]},{default:e(()=>[t(ve,{value:l.target,"onUpdate:value":c=>l.target=c,type:"target",options:xe(l.target)},null,8,["value","onUpdate:value","options"])]),_:2},1032,["name"])]),_:2},1024)]),_:2},1024)]),_:2},1032,["header"])}),128))]),_:1},8,["activeKey"])):(f(),g(oe,{key:1},{default:e(()=>[t(R)]),_:1}))]),_:1}),t(_,{span:24},{default:e(()=>[t(se,{type:"dashed",style:{width:"100%","margin-top":"10px"},onClick:Z},{default:e(()=>[t(p,{type:"PlusOutlined",style:{"margin-left":"2px"}}),y("新增属性 ")]),_:1})]),_:1}),t(_,{span:24,style:{"margin-top":"20px"}},{default:e(()=>[t(d,{label:"说明",name:"description",rules:{max:200,message:"最多输入200个字符"}},{default:e(()=>[t(je,{value:m(n).description,"onUpdate:value":o[6]||(o[6]=l=>m(n).description=l),placeholder:"请输入说明",showCount:"",maxlength:200},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])])]),h("div",kt,[t(dt)]),h("div",Ot,[t(Ne,null,{default:e(()=>{var l,v,w,c,le,re,ie,de,ue,ce;return[(l=C.data)!=null&&l.id?(f(),g(r,{key:0,hasPermission:"Northbound/DuerOS:delete",danger:"",disabled:((w=(v=C.data)==null?void 0:v.state)==null?void 0:w.value)!=="disabled",tooltip:{title:((le=(c=C.data)==null?void 0:c.state)==null?void 0:le.value)!=="disabled"?"请先禁用该数据，再删除。":"删除"},popConfirm:{title:"确认删除",onConfirm:Ie}},{default:e(()=>[y("删除 ")]),_:1},8,["disabled","tooltip","popConfirm"])):B("",!0),(re=C.data)!=null&&re.id?(f(),g(r,{key:1,type:"primary",ghost:"",hasPermission:"Northbound/DuerOS:action",tooltip:{title:((de=(ie=C.data)==null?void 0:ie.state)==null?void 0:de.value)!=="disabled"?"禁用":"启用"},popConfirm:{title:`确认${((ce=(ue=C.data)==null?void 0:ue.state)==null?void 0:ce.value)!=="disabled"?"禁用":"启用"}?`,onConfirm:Se}},{default:e(()=>{var me,_e;return[y(j(((_e=(me=C.data)==null?void 0:me.state)==null?void 0:_e.value)!=="disabled"?"禁用":"启用"),1)]}),_:1},8,["tooltip","popConfirm"])):B("",!0),t(r,{type:"primary",loading:m(K),onClick:Pe,hasPermission:["Northbound/DuerOS:add","Northbound/DuerOS:update"]},{default:e(()=>[y(" 保存 ")]),_:1},8,["loading"])]}),_:1})])]))}}});const oa=it(Pt,[["__scopeId","data-v-81991fc3"]]);export{oa as default};
