import{Z as R,h as ie,cv as U,o as E,d as ae,aL as le,aM as re,aN as ce,e as de,a0 as pe,a1 as ue,$ as me,a2 as _e,ax as fe,a3 as ye,g as he}from"./index-1731638920964.js";import"./index-1731638920964278.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import"./index-1731638920964282.js";import"./index-1731638920964283.js";import ge from"./AddDeviceOrProductDialog-1731638920964.js";import we from"./EditPermissionDialog-1731638920964.js";import{_ as ke}from"./NextDialog.vue_vue_type_script_setup_true_lang-1731638920964.js";import{i as xe,a as ve,j as Se,c as be,k as Ce}from"./department-17316389209642.js";import{u as Ie}from"./department-1731638920964.js";import{d as Z,k as F,r as J,w as $,ab as D,U as h,Z as K,f as i,X as n,u as r,E as P,W as V,R as Re,_ as g,$ as w,V as k,F as z,a1 as M,Y as B,q as Pe,af as Le,ag as De}from"./vue-1731638920964.js";import"./index-1731638920964291.js";const H=b=>(Le("data-v-bfc5c68e"),b=b(),De(),b),Ke={class:"product-container"},Be=["src"],Te={class:"card-item-content-title",style:{"margin-bottom":"18px"}},je=H(()=>g("div",{class:"card-item-content-text"},"ID",-1)),Ee={style:{cursor:"pointer"},class:"card-item-content-value"},$e=H(()=>g("div",{class:"card-item-content-text"}," 资产权限 ",-1)),Ae={style:{cursor:"pointer"},class:"card-item-content-value"},Oe={key:0},qe={class:"dialogs"},Ne=Z({name:"product"}),Ue=Z({...Ne,props:{parentId:{}},emits:["openDeviceBind"],setup(b,{emit:W}){const x=b,C="system/Department",X=Ie(),T=[{title:"ID",dataIndex:"id",key:"id",ellipsis:!0,fixed:"left",search:{type:"string"}},{title:"名称",dataIndex:"name",key:"name",ellipsis:!0,search:{type:"string",first:!0}},{title:"资产权限",dataIndex:"permission",key:"permission",ellipsis:!0,scopedSlots:!0},{title:"说明",dataIndex:"describe",key:"describe",ellipsis:!0},{title:"状态",dataIndex:"state",key:"state",ellipsis:!0,width:80,search:{type:"select",options:[{label:"正常",value:1},{label:"禁用",value:0}]},scopedSlots:!0},{title:"操作",dataIndex:"action",key:"action",fixed:"right",width:100,scopedSlots:!0}],A=F({}),O=F(),s=J({_selectedRowKeys:[],selectedRows:[],permissionList:[],defaultPermission:[]}),l={init:()=>{l.getPermissionDict(),$(()=>x.parentId,()=>{l.refresh()})},getActions:(e,t)=>e?[{permission:`${C}:assert`,key:"edit",tooltip:{title:"编辑"},icon:"EditOutlined",onClick:()=>l.clickEdit(e)},{permission:`${C}:bind`,key:"unbind",tooltip:{title:"解除绑定"},popConfirm:{title:"确认解除绑定？",onConfirm:()=>l.clickUnBind(e)},icon:"DisconnectOutlined"}]:[],getPermissionDict:()=>{xe().then(e=>{s.permissionList=e.result})},getPermissLabel:e=>{const t=s.permissionList;return t.length<1||e.length<1?"":e.map(o=>{var p;return(p=t.find(m=>m.id===o))==null?void 0:p.name}).join(",")},onSelectChange:e=>{const t=s._selectedRowKeys.indexOf(e.id);t===-1?(s._selectedRowKeys.push(e.id),s.selectedRows.push(e)):(s._selectedRowKeys.splice(t,1),s.selectedRows.splice(t,1))},cancelSelect:()=>{s._selectedRowKeys=[],s.selectedRows=[]},onSelect:(e,t)=>{const o=[...s._selectedRowKeys].findIndex(p=>p===(e==null?void 0:e.id));t?o>-1||(s._selectedRowKeys.push(e.id),s.selectedRows.push(e)):o>-1&&(s._selectedRowKeys.splice(o,1),s.selectedRows.splice(o,1))},onSelectAll:(e,t,c)=>{if(e)c.map(o=>{s._selectedRowKeys.includes(o.id)||(s._selectedRowKeys.push(o.id),s.selectedRows.push(o))});else{const o=c.map(f=>f.id),p=[],m=[];[...s.selectedRows].map(f=>{o.includes(f==null?void 0:f.id)||(p.push(f),m.push(f.id))}),s._selectedRowKeys=m,s.selectedRows=p}},getData:(e,t)=>new Promise(c=>{ve(e).then(o=>{const{pageIndex:p,pageSize:m,total:f,data:v}=o.result,L=v.map(S=>S.id);Se("product",L,t).then(S=>{const I={};S.result.forEach(y=>{I[y.assetId]=y.grantedPermissions}),v.forEach(y=>{y.permission=I[y.id],y.state={value:y.state===1?"online":y.state===0?"offline":"",text:y.state===1?"正常":y.state===0?"禁用":""}}),c({code:200,result:{data:v,pageIndex:p,pageSize:m,total:f},status:200})})})}),requestFun:async e=>{if(x.parentId){const t={...e,sorts:[{name:"createTime",order:"desc"}],terms:[...e.terms,{column:"id",termType:"dim-assets",value:{assetType:"product",targets:[{type:"org",id:x.parentId}]}}]},c=await l.getData(t,x.parentId);return{code:c.status,result:c.result,status:c.status}}else return{code:200,result:{data:[],pageIndex:0,pageSize:0,total:0},status:200}},queryPermissionList:async e=>{const t=await be("product",e);if(t.status===200){const c=t.result.map(o=>{var p;return(p=o==null?void 0:o.permissionInfoList)==null?void 0:p.map(m=>m==null?void 0:m.id)});return U(...c)}return[]},clickEdit:async e=>{const t=e?[e.id]:[...s._selectedRowKeys];if(t.length<1)return E("请勾选需要编辑的数据","warning");s.defaultPermission=e?e==null?void 0:e.permission:U(...s.selectedRows.map(o=>o.permission));const c=await l.queryPermissionList(t);d.selectIds=t,d.permissList=c,d.editShow=!0},clickUnBind:e=>{const t=e?[e.id]:[...s._selectedRowKeys];if(t.length<1)return E("请勾选需要解绑的数据","warning");const c=[{targetType:"org",targetId:x.parentId,assetType:"product",assetIdList:t}],o=Ce("product",c);return o.then(()=>{s._selectedRowKeys=[],E("操作成功"),l.refresh()}),o},refresh:()=>{Pe(()=>{O.value.reload(),l.cancelSelect()})},addConfirm:()=>{l.refresh(),d.nextShow=!0}};l.init();const d=J({selectIds:[],permissList:[],addShow:!1,editShow:!1,nextShow:!1});$(()=>x.parentId,()=>{s._selectedRowKeys=[],s.selectedRows=[]}),$(()=>d.addShow,e=>{e||(s.selectedRows=[])});let q="";const Y=e=>{q=e},G=()=>{X.setProductId(q),W("openDeviceBind")};return(e,t)=>{const c=D("pro-search"),o=D("AIcon"),p=ae,m=le,f=re,v=ce,L=de,S=D("Ellipsis"),I=pe,y=ue,Q=me,ee=_e,te=fe,se=ye,ne=D("FullPage");return h(),K("div",Ke,[i(c,{columns:T,target:"category-product",onSearch:t[0]||(t[0]=a=>A.value={...a}),style:{"margin-bottom":"0"}}),i(ne,{extraHeight:24},{default:n(()=>[i(se,{ref_key:"tableRef",ref:O,request:l.requestFun,gridColumn:2,scroll:{x:!0,y:610},params:r(A),rowSelection:{selectedRowKeys:r(s)._selectedRowKeys,onSelect:l.onSelect,onSelectAll:l.onSelectAll,onSelectNone:l.cancelSelect},columns:T},{headerTitle:n(()=>[i(L,null,{default:n(()=>[i(R,{hasPermission:`${C}:assert`,type:"primary",onClick:t[1]||(t[1]=a=>r(d).addShow=!0)},{default:n(()=>[i(o,{type:"PlusOutlined"}),P("资产分配 ")]),_:1},8,["hasPermission"]),i(v,{trigger:"hover"},{overlay:n(()=>[i(f,null,{default:n(()=>[i(m,null,{default:n(()=>[i(R,{hasPermission:`${C}:bind`,popConfirm:{title:"确认批量解除绑定？",onConfirm:()=>l.clickUnBind()}},{default:n(()=>[i(o,{type:"DisconnectOutlined"}),P("批量解绑 ")]),_:1},8,["hasPermission","popConfirm"])]),_:1}),i(m,null,{default:n(()=>[i(R,{hasPermission:`${C}:assert`,onClick:t[2]||(t[2]=()=>l.clickEdit())},{default:n(()=>[i(o,{type:"EditOutlined"}),P("批量编辑 ")]),_:1},8,["hasPermission"])]),_:1})]),_:1})]),default:n(()=>[i(p,null,{default:n(()=>[P("批量操作")]),_:1})]),_:1})]),_:1})]),card:n(a=>{var _,N;return[i(ee,V({value:a,actions:l.getActions(a,"card")},a,{active:r(s)._selectedRowKeys.includes(a.id),onClick:l.onSelectChange,status:(_=a.state)==null?void 0:_.value,statusText:(N=a.state)==null?void 0:N.text,statusNames:{online:"processing",offline:"error"}}),{img:n(()=>[Re(e.$slots,"img",{},()=>[g("img",{src:r(ie)("/device-product.png"),style:{cursor:"pointer"}},null,8,Be)],!0)]),content:n(()=>[g("h3",Te,w(a.name),1),i(y,null,{default:n(()=>[i(I,{span:12},{default:n(()=>[je,i(S,{style:{width:"calc(100% - 20px)"}},{default:n(()=>[g("div",Ee,w(a.id),1)]),_:2},1024)]),_:2},1024),i(I,{span:12},{default:n(()=>[$e,i(S,{style:{width:"calc(100% - 20px)"}},{default:n(()=>[g("div",Ae,w(r(s).permissionList.length&&l.getPermissLabel(a.permission)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),actions:n(u=>[i(Q,V(u.tooltip,{title:u.disabled&&u.tooltip.title}),{default:n(()=>[u.key==="others"?(h(),k(v,{key:0,placement:"bottomRight"},{overlay:n(()=>[i(f,null,{default:n(()=>[(h(!0),K(z,null,M(u.children,(j,oe)=>(h(),k(m,{key:oe},{default:n(()=>[i(p,{type:"link",onClick:j.onClick},{default:n(()=>[i(o,{type:j.icon},null,8,["type"]),g("span",null,w(j.text),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:2},1024)]),default:n(()=>[i(p,null,{default:n(()=>[i(o,{type:u.icon},null,8,["type"]),g("span",null,w(u.text),1)]),_:2},1024)]),_:2},1024)):(h(),k(R,{key:1,hasPermission:u.permission,tooltip:u.tooltip,"pop-confirm":u.popConfirm,onClick:u.onClick,disabled:u.disabled},{default:n(()=>[i(o,{type:u.icon},null,8,["type"]),u.key!=="delete"?(h(),K("span",Oe,w(u.text),1)):B("",!0)]),_:2},1032,["hasPermission","tooltip","pop-confirm","onClick","disabled"]))]),_:2},1040,["title"])]),_:2},1040,["value","actions","active","onClick","status","statusText"])]}),permission:n(a=>[P(w(r(s).permissionList.length&&l.getPermissLabel(a.permission)),1)]),state:n(a=>[i(te,{status:a.state.value,text:a.state.text,statusNames:{online:"processing",offline:"error"}},null,8,["status","text"])]),action:n(a=>[i(L,{size:16},{default:n(()=>[(h(!0),K(z,null,M(l.getActions(a,"table"),_=>(h(),k(R,{hasPermission:_.permission,type:"link",key:_.key,tooltip:_==null?void 0:_.tooltip,"pop-confirm":_.popConfirm,onClick:_.onClick,disabled:_==null?void 0:_.disabled},{default:n(()=>[i(o,{type:_.icon},null,8,["type"])]),_:2},1032,["hasPermission","tooltip","pop-confirm","onClick","disabled"]))),128))]),_:2},1024)]),_:3},8,["request","params","rowSelection"])]),_:3}),g("div",qe,[r(d).addShow?(h(),k(ge,{key:0,visible:r(d).addShow,"onUpdate:visible":t[3]||(t[3]=a=>r(d).addShow=a),"query-columns":T,"parent-id":e.parentId,"all-permission":r(s).permissionList,"asset-type":"product",onConfirm:l.addConfirm,onNext:Y},null,8,["visible","parent-id","all-permission","onConfirm"])):B("",!0),r(d).editShow?(h(),k(we,{key:1,visible:r(d).editShow,"onUpdate:visible":t[4]||(t[4]=a=>r(d).editShow=a),ids:r(d).selectIds,"permission-list":r(d).permissList,"parent-id":e.parentId,"all-permission":r(s).permissionList,"asset-type":"product",defaultPermission:r(s).defaultPermission,onConfirm:l.refresh},null,8,["visible","ids","permission-list","parent-id","all-permission","defaultPermission","onConfirm"])):B("",!0),r(d).nextShow?(h(),k(ke,{key:2,visible:r(d).nextShow,"onUpdate:visible":t[5]||(t[5]=a=>r(d).nextShow=a),onConfirm:G},null,8,["visible"])):B("",!0)])])}}});const st=he(Ue,[["__scopeId","data-v-bfc5c68e"]]);export{st as default};
