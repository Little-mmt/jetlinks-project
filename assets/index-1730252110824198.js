import{g as K,h as f,o as c,a3 as R,aa as V}from"./index-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import{a as g}from"./scene-1730252110824.js";import{q as J,_ as N}from"./configuration-1730252110824.js";import j from"./CardBox-1730252110824.js";import{u as O}from"./useRequest-1730252110824.js";import{k as h,ab as A,U as D,V as H,X as T,f as i,_ as L,u as l}from"./vue-1730252110824.js";import"./BranchesTabs-1730252110824.js";import"./Actions-1730252110824.js";import"./util-1730252110824.js";import"./config-17302521108242.js";import"./util-17302521108242.js";import"./scene-17302521108242.js";import"./util-17302521108243.js";import"./utils-17302521108243.js";const U={style:{height:"500px","overflow-y":"auto"}},X={__name:"index",props:{data:{type:Object,default:()=>{}}},emits:["close","save"],setup(x,{emit:u}){var m,p,v;const n=x,b=[{title:"场景名称",dataIndex:"name",key:"name",search:{type:"select",options:async()=>{var a;const e=await g({sorts:[{name:"createTime",order:"desc"}],terms:[{column:"id",termType:"alarm-bind-rule",value:(a=n.data)==null?void 0:a.id},{column:"triggerType",termType:"eq",value:"manual"}]});return e.status===200?e.result.data.map(t=>({label:t.name,value:t.id})):[]}}},{title:"触发方式",dataIndex:"triggerType",key:"triggerType"},{title:"状态",dataIndex:"state",key:"state",search:{type:"select",options:[{label:"正常",value:"started"},{label:"禁用",value:"disable"}]}}],I=[{terms:[{column:"id",termType:"alarm-bind-rule",value:(m=n.data)==null?void 0:m.id},{column:"triggerType",termType:"eq",value:(p=n.data)==null?void 0:p.sceneTriggerType}]},{terms:[{column:"features",termType:"in",value:["alarmTrigger","alarmReliever"]},{column:"features",termType:"isnull",value:1,type:"or"}],type:"and"}],d=h();new Map().set("manual",{text:"手动触发",img:f("/scene/scene-hand.png"),icon:f("/scene/trigger-type-icon/manual.png"),tip:"适用于第三方平台向物联网平台下发指令控制设备"});const r=h([]),k=e=>{var a;if(((a=e.state)==null?void 0:a.value)==="disable"){c("该场景为禁用状态，无法触发告警","error");return}if(r.value.includes(e.id)){const t=r.value.findIndex(s=>s===e.id);r.value.splice(t,1)}else r.value=[...r.value,e.id]},C=()=>{r.value=[]},w=e=>{d.value=e},S=async()=>{if(r.value.length>0){const e=r.value.map(a=>({id:a}));N(e).then(a=>{a.status===200?(c("操作成功"),u("save")):c("操作失败","error")})}else c("请选择至少一条数据","error")},q=()=>{u("close")},{data:M}=O(J,{defaultParams:{terms:[{column:"alarmId",value:(v=n.data)==null?void 0:v.id}]},onSuccess(e){return e.result.data.reduce((t,s)=>(t[s.ruleId]?t[s.ruleId].push(s.branchIndex):t[s.ruleId]=[s.branchIndex],t),{})||{}},defaultValue:{}});return(e,a)=>{const t=A("pro-search"),s=R,B=V;return D(),H(B,{visible:"",title:"选择触发场景",okText:"确定",cancelText:"取消",width:1e3,onCancel:q,onOk:S},{default:T(()=>[i(t,{columns:b,onSearch:w}),L("div",U,[i(s,{model:"CARD",request:l(g),rowSelection:{selectedRowKeys:l(r),onSelectNone:C},gridColumns:[1,1,1],defaultParams:{sorts:[{name:"createTime",order:"desc"}],terms:I},params:l(d)},{card:T(o=>{var y,_;return[i(j,{value:o,status:(y=o.state)==null?void 0:y.value,statusText:(_=o.state)==null?void 0:_.text,alarmId:n.data.id,activeKeys:l(M)[o.id],selected:l(r).includes(o.id),onClick:()=>k(o)},null,8,["value","status","statusText","alarmId","activeKeys","selected","onClick"])]}),_:1},8,["request","rowSelection","defaultParams","params"])])]),_:1})}}},de=K(X,[["__scopeId","data-v-52d09bb6"]]);export{de as default};
