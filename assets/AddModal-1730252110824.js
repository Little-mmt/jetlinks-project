import{F as G,o as w,an as J,ao as L,x as P,d as A,aa as z,dG as E,g as R}from"./index-1730252110824.js";import"./index-1730252110824287.js";import"./index-1730252110824286.js";import q from"./Product-17302521108242.js";import Q from"./DeviceSelect-1730252110824.js";import X from"./Type-17302521108243.js";import{h as Y}from"./WhenOption-1730252110824.js";import{d as j,k as D,r as $,q as H,U as p,V as d,X as c,_ as M,u as o,E as f,f as v,Y as W}from"./vue-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import"./product-17302521108244.js";import"./category-1730252110824.js";import"./department-17302521108242.js";import"./setting-17302521108242.js";import"./TopCard-17302521108247.js";import"./TopCard.vue_vue_type_style_index_0_scoped_47c4fbf1_lang-1730252110824.js";import"./DeviceList-1730252110824.js";import"./OrgList-1730252110824.js";import"./util-17302521108244.js";import"./index.vue_vue_type_script_setup_true_name_Timer_lang-1730252110824.js";import"./Calendar-1730252110824.js";import"./useRequest-1730252110824.js";import"./index-1730252110824235.js";import"./index-1730252110824309.js";import"./TriggerWay.vue_vue_type_style_index_0_scoped_1bb0f74d_lang-1730252110824.js";import"./FunctionCall.vue_vue_type_script_setup_true_name_FunctionCall_lang-1730252110824.js";import"./ReadProperties.vue_vue_type_script_setup_true_name_ReadProperties_lang-1730252110824.js";import"./WriteProperty.vue_vue_type_script_setup_true_name_WriteProperties_lang-1730252110824.js";import"./InvokeFunction.vue_vue_type_script_setup_true_name_InvokeFunction_lang-1730252110824.js";const Z={class:"steps-content"},ee={class:"steps-action"},te=j({name:"AddModel"}),oe=j({...te,props:{value:{type:Object,default:()=>({productId:"",selector:"fixed",selectorValues:[]})},options:{type:Object,default:()=>({})}},emits:["cancel","change","save"],setup(K,{emit:I}){const l=K,O=G.useInjectFormItemContext(),g=D(),e=$({productId:l.value.productId||"",selector:l.value.selector||"fixed",selectorValues:l.value.selectorValues||[],stepNumber:0,deviceKeys:l.value.selectorValues||[],orgId:l.value.selectorValues||[],productDetail:{},metadata:{},operator:l.value.operation||{operator:"online"}}),V=D(l.options),T=r=>{var u,m;const t={name:"",extraName:"",onlyName:!1,type:"",typeIcon:{writeProperty:"icon-bianji1",invokeFunction:"icon-widgets",reportEvent:"icon-shijian",readProperty:"icon-Group"}[r.operator],productName:"",selectorIcon:"",time:void 0,when:void 0,extraTime:void 0,action:(u=V.value)==null?void 0:u.action};if(e.selector==="fixed"){let s=!1,i=0;const n=e.selectorValues.reduce((y,h,C)=>y.length<=30?(i=C,C===0?h.name:y+"、"+h.name):(s=!0,y),"");t.name=n,s&&e.selectorValues.length>i&&(t.extraName=`等${e.selectorValues.length}台设备`),t.selectorIcon="icon-shebei1"}else e.selector==="org"?(t.name=((m=e.selectorValues)==null?void 0:m[0].name)+"的",t.productName=e.productDetail.name,t.selectorIcon="icon-zuzhi"):t.name="所有的"+e.productDetail.name;if(r.timer){const s=r.timer,{time:i,extraTime:n,when:y}=Y(s);t.when=y,t.time=i,t.extraTime=n}return r.operator==="online"&&(t.type="上线",t.action="",t.typeIcon="icon-a-Group4713"),r.operator==="offline"&&(t.type="离线",t.action="",t.typeIcon="icon-a-Group4892"),r.operator==="reportProperty"&&(t.type="属性上报",t.action="",t.typeIcon="icon-file-upload-outline"),t},U=()=>{e.stepNumber=e.stepNumber-1},x=()=>{I("cancel")},N=r=>{try{e.metadata=JSON.parse(r||"{}")}catch(a){console.warn("handleMetadata: "+a)}},F=()=>{e.deviceKeys=[],e.orgId=[],e.selector="fixed",e.operator={operator:"online"},e.selectorValues=[]},b=async r=>{var t;return(t=(await E(r)).result)==null?void 0:t.metadata},_=async r=>{var t,u,m;let a=r!==void 0?r:e.stepNumber;if(a===0)e.productId?e.stepNumber=1:w("请选择产品","error");else if(a===1){const s=e.selector==="fixed";if(["fixed","org"].includes(e.selector)&&!((t=e.selectorValues)!=null&&t.length))return w(s?"请选择设备":"请选择部门","error");const i=s&&((u=e.selectorValues)==null?void 0:u.length)===1;N(i?await b(e.selectorValues[0].value):(m=e.productDetail)==null?void 0:m.metadata),e.stepNumber=2}else{const s=await g.value.vail();if(s){V.value.action=s.action;const i=T(s.data),n={operation:s.data,selector:e.selector,selectorValues:e.selectorValues,productId:e.productId,source:"fixed"};I("save",n,i),O.onFieldChange()}}},k=()=>_(),B=r=>{r!==0?_(r-1):e.stepNumber=0},S=async()=>{var r;l.value.selector==="fixed"&&((r=l.value.selectorValues)!=null&&r.length)&&N(await b(l.value.selectorValues[0].value))};return H(()=>{S()}),(r,a)=>{const t=J,u=L,m=P,s=A,i=z;return p(),d(i,{title:"触发规则",visible:"",width:950,onOk:_,onCancel:x,maskClosable:!1},{footer:c(()=>[M("div",ee,[o(e).stepNumber===0?(p(),d(s,{key:0,onClick:x},{default:c(()=>[f("取消")]),_:1})):(p(),d(s,{key:1,onClick:U},{default:c(()=>[f("上一步")]),_:1})),o(e).stepNumber<2?(p(),d(s,{key:2,type:"primary",onClick:k},{default:c(()=>[f("下一步")]),_:1})):(p(),d(s,{key:3,type:"primary",onClick:k},{default:c(()=>[f("确定")]),_:1}))])]),default:c(()=>[v(u,{current:o(e).stepNumber,onChange:B},{default:c(()=>[v(t,null,{title:c(()=>[f("选择产品")]),_:1}),v(t,null,{title:c(()=>[f("选择设备")]),_:1}),v(t,null,{title:c(()=>[f("触发类型")]),_:1})]),_:1},8,["current"]),v(m,{style:{"margin-bottom":"0px"}}),M("div",Z,[o(e).stepNumber===0?(p(),d(q,{key:0,rowKey:o(e).productId,"onUpdate:rowKey":a[0]||(a[0]=n=>o(e).productId=n),detail:o(e).productDetail,"onUpdate:detail":a[1]||(a[1]=n=>o(e).productDetail=n),onChange:F},null,8,["rowKey","detail"])):o(e).stepNumber===1?(p(),d(Q,{key:1,productId:o(e).productId,deviceKeys:o(e).deviceKeys,"onUpdate:deviceKeys":a[2]||(a[2]=n=>o(e).deviceKeys=n),orgId:o(e).orgId,"onUpdate:orgId":a[3]||(a[3]=n=>o(e).orgId=n),selector:o(e).selector,"onUpdate:selector":a[4]||(a[4]=n=>o(e).selector=n),selectorValues:o(e).selectorValues,"onUpdate:selectorValues":a[5]||(a[5]=n=>o(e).selectorValues=n)},null,8,["productId","deviceKeys","orgId","selector","selectorValues"])):o(e).stepNumber===2?(p(),d(X,{key:2,ref_key:"typeRef",ref:g,metadata:o(e).metadata,operator:o(e).operator},null,8,["metadata","operator"])):W("",!0)])]),_:1})}}});const Be=R(oe,[["__scopeId","data-v-ec164203"]]);export{Be as default};
