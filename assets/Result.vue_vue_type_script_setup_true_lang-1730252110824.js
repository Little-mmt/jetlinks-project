import{fo as B,B as C,L as J,T as L,au as N,d as x,a0 as A,a1 as T,a9 as Y,aa as D}from"./index-1730252110824.js";import{d as M,k as m,w as R,U as w,V as $,X as d,f as u,_ as j,$ as f,u as s,E as g,Y as k,Z as V}from"./vue-1730252110824.js";const I={key:0},K=M({__name:"Result",props:{data:{type:Object,default:()=>{}},list:{type:Array,default:()=>[]}},emits:["close"],setup(b,{emit:h}){const o=b,v=m(0),y=m(0),E=m(!0),i=m([]),O=()=>{var p;let n=0,a=0;const l=[],e={deviceId:(o.list||[]).map(t=>t==null?void 0:t.id),params:JSON.stringify({name:o.data.name,targetId:o.data.targetId,targetType:o.data.targetType,category:o.data.category,metadata:(p=o.data)==null?void 0:p.metadata})},r=new URLSearchParams;Object.keys(e).forEach(t=>{Array.isArray(e[t])&&e[t].length?e[t].map(_=>{r.append(t,_)}):r.append(t,e[t])});const c=new B.EventSourcePolyfill(`${C}/edge/operations/entity-template-save/invoke/_batch?:X_Access_Token=${J.get(L)}&${r}`);c.onmessage=t=>{const _=JSON.parse(t.data);_.successful?(n+=1,v.value=n):(a+=1,y.value=a,E.value=!1,l.length<5&&(l.push({..._}),i.value=[...l]))},c.onerror=()=>{c.close()},c.onopen=()=>{}},S=(n,a,l)=>{const e=document.createElement("a");e.download=`${a?"":n==null?void 0:n.name}${a}_${N(new Date).format(l||"YYYY_MM_DD")}.txt`,e.style.display="none";const r=new Blob([JSON.stringify(n)]);e.href=URL.createObjectURL(r),document.body.appendChild(e),e.click(),document.body.removeChild(e)};return R(()=>o.data.id,n=>{n&&O()},{immediate:!0}),(n,a)=>{const l=x,e=A,r=T,c=Y,p=D;return w(),$(p,{visible:"",title:"下发结果",width:900,onOk:a[1]||(a[1]=t=>h("close")),onCancel:a[2]||(a[2]=t=>h("close"))},{default:d(()=>[u(r,null,{default:d(()=>[u(e,{span:8},{default:d(()=>[j("div",null,"成功："+f(s(v)),1),j("div",null,[g(" 失败："+f(s(y))+" ",1),s(i).length?(w(),$(l,{key:0,onClick:a[0]||(a[0]=t=>S(s(i)||"","下发失败原因")),type:"link"},{default:d(()=>[g("下载")]),_:1})):k("",!0)])]),_:1}),u(e,{span:8},{default:d(()=>[g("下发设备数量："+f(b.list.length||0),1)]),_:1}),u(e,{span:8},{default:d(()=>[g("已下发数量："+f(s(y)+s(v)),1)]),_:1})]),_:1}),s(E)?k("",!0):(w(),V("div",I,[u(c,{rows:10,value:JSON.stringify(s(i))},null,8,["value"])]))]),_:1})}}});export{K as _};
