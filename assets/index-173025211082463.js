import{a as re,dM as ie,dU as Z,dR as ue,o as B,dN as G,a4 as ce,d as pe,e as _e,$ as me,aD as fe,a6 as ve,v as Ie,ds as ye,Z as ge,aT as he,ea as ke,F as Se,aI as Ce,A as be,af as xe,g as we}from"./index-1730252110824.js";import"./index-1730252110824288.js";import"./index-1730252110824282.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import{u as je}from"./instance-1730252110824.js";import{_ as Q}from"./MSelect.vue_vue_type_script_setup_true_lang-17302521108242.js";import Ee from"./PatchMapping-17302521108242.js";import{d as Y,k as h,r as Me,w as Ne,o as Ve,ab as Ue,u as _,U as d,V as m,X as r,f as p,E as U,Z as k,F as j,Y as y,$ as O,a1 as Pe,_ as Le,G as X,J as Be}from"./vue-1730252110824.js";import"./index-1730252110824301.js";const Oe={key:0},Ae={key:1,style:{color:"red"}},Je={class:"pagination"},Re=Y({name:"EdgeMap"}),$e=Y({...Re,setup(De){var D;const H=[{title:"名称",dataIndex:"metadataName",key:"metadataName",width:"20%"},{title:"通道",dataIndex:"channelId",key:"channelId",width:"20%"},{title:"采集器",dataIndex:"collectorId",key:"collectorId",width:"20%"},{title:"点位",key:"pointId",dataIndex:"pointId",width:"20%"},{title:"状态",key:"id",dataIndex:"id",width:"10%"},{title:"操作",key:"action",width:"10%"}];re();const b=h([]),x=h(1),E=h(10),i=je(),M=JSON.parse(((D=i.current)==null?void 0:D.metadata)||"{}"),g=h(!1),A=h([]),f=Me({dataSource:[]}),P=h(),N=h(!1),K=async()=>{var e,a,n;if((e=i.current)!=null&&e.parentId){const t=await ie(i.current.parentId);t.status===200&&(A.value=(n=(a=t.result)==null?void 0:a[0])==null?void 0:n.map(o=>({label:o.name,value:o.id,provider:o.provider})))}},J=async()=>{var n,t,o;g.value=!0;const e=new Map,a=M.properties.map(c=>{const u={metadataId:c.id,metadataName:`${c.name}(${c.id})`,metadataType:"property",name:c.name};return e.set(c.id,u),u});if(a&&a.length){const c=await Z(((n=i.current)==null?void 0:n.parentId)||"",{deviceId:i.current.id,query:{}}).catch(()=>{f.dataSource=a,g.value=!1});c.status===200&&((o=(t=c.result)==null?void 0:t[0])==null||o.forEach(u=>{e.has(u.metadataId)?e.set(u.metadataId,Object.assign(e.get(u.metadataId),u)):e.set(u.metadataId,u)}),b.value=[...e.values()],$())}g.value=!1},W=e=>{var n;const a=i.current.id;if(e&&a){const t=ue(((n=i.current)==null?void 0:n.parentId)||"",{deviceId:a,idList:[e]});return t.then(o=>{o.status===200&&(B("操作成功！","success"),J())}),t}},ee=()=>{N.value=!1,L()},R=(e,a)=>{a==="channel"&&(f.dataSource[e].collectorId=void 0),f.dataSource[e].pointId=void 0},$=()=>{var e;(e=P.value)==null||e.validate().then(()=>{const a=x.value>=1?x.value:1,n=E.value,t=b.value.slice((a-1)*n,a*n)||[];f.dataSource=t})},ae=()=>{P.value.validate().then(async e=>{var n;const a=Be(b.value).filter(t=>t.channelId).map(t=>{var o;return((o=i.current.state)==null?void 0:o.value)==="notActive"&&(t.state="disabled"),t});if(a&&a.length!==0){const t={deviceId:i.current.id,provider:(n=a[0])==null?void 0:n.provider,requestList:a};(await G(i.current.parentId||"",t)).status===200&&(B("操作成功！","success"),L())}}).catch(e=>{console.log("error",e)})},te=e=>{var S,C;const a=(S=f.dataSource||[])==null?void 0:S.filter(I=>I.channelId),t={...a.find(I=>I.id===(e==null?void 0:e.id)),state:(e==null?void 0:e.state.value)==="enabled"?"disabled":"enabled"},o=a.filter(I=>I.id!==(e==null?void 0:e.id)),c={deviceId:i.current.id,provider:(C=a[0])==null?void 0:C.provider,requestList:[...o,t]},u=G(i.current.parentId||"",c);return u.then(I=>{I.status===200&&(B("操作成功！","success"),L())}),u},L=async()=>{var e;if(g.value=!0,f.dataSource&&f.dataSource.length){const a=await Z(((e=i.current)==null?void 0:e.parentId)||"",{deviceId:i.current.id,query:{}}).catch(()=>{g.value=!1});if(a.status===200){const t=ce(f.dataSource).map(o=>{var u;const c=(u=a.result)==null?void 0:u[0].find(S=>S.metadataId===o.metadataId);return c?{...o,...c}:o});f.dataSource=t}}g.value=!1};return Ne(()=>f.dataSource,e=>{const a=new Map;e.forEach(n=>{a.set(n.metadataId,n)}),b.value.forEach((n,t)=>{a.has(n.metadataId)&&(b.value[t]=n)})},{deep:!0}),Ve(()=>{K(),J()}),(e,a)=>{var z;const n=pe,t=_e,o=Ue("AIcon"),c=me,u=fe,S=ve,C=Ie,I=ye,T=ge,ne=he,se=ke,oe=Se,q=Ce,de=be,le=xe;return(z=_(M).properties)!=null&&z.length?(d(),m(de,{key:0,spinning:_(g)},{default:r(()=>[p(q,{bordered:!1,style:{padding:"0"}},{extra:r(()=>[p(t,null,{default:r(()=>[p(n,{onClick:a[0]||(a[0]=V=>N.value=!0)},{default:r(()=>[U("批量映射")]),_:1}),p(n,{type:"primary",onClick:ae},{default:r(()=>[U("保存")]),_:1})]),_:1})]),default:r(()=>[p(oe,{ref_key:"formRef",ref:P,model:_(f)},{default:r(()=>{var V,F;return[p(ne,{dataSource:_(f).dataSource,columns:H,pagination:!1},{headerCell:r(({column:l})=>[l.key==="collectorId"?(d(),k(j,{key:0},[U(" 采集器 "),p(c,{title:"边缘网关代理的真实物理设备"},{default:r(()=>[p(o,{type:"QuestionCircleOutlined"})]),_:1})],64)):y("",!0)]),bodyCell:r(({column:l,record:s,index:w})=>[l.dataIndex==="metadataName"?(d(),k(j,{key:0},[s.metadataName?(d(),k("span",Oe,O(s.metadataName),1)):(d(),k("span",Ae,O(s.metadataId),1))],64)):y("",!0),l.dataIndex==="channelId"?(d(),m(C,{key:1,name:["dataSource",w,"channelId"]},{default:r(()=>[p(S,{style:{width:"100%"},value:s[l.dataIndex],"onUpdate:value":v=>s[l.dataIndex]=v,placeholder:"请选择",allowClear:"",onChange:()=>R(w,"channel")},{default:r(()=>[(d(!0),k(j,null,Pe(_(A),v=>(d(),m(u,{key:v.value,value:v.value,label:v.label},{default:r(()=>[U(O(v.label),1)]),_:2},1032,["value","label"]))),128))]),_:2},1032,["value","onUpdate:value","onChange"])]),_:2},1032,["name"])):y("",!0),l.dataIndex==="collectorId"?(d(),m(C,{key:2,name:["dataSource",w,"collectorId"],rules:[{required:!!s.channelId,message:"请选择采集器"}]},{default:r(()=>[p(Q,{modelValue:s[l.dataIndex],"onUpdate:modelValue":v=>s[l.dataIndex]=v,id:s.channelId,type:"COLLECTOR",edgeId:_(i).current.parentId,provider:s.provider,"onUpdate:provider":v=>s.provider=v,onChange:v=>R(w,"collector")},null,8,["modelValue","onUpdate:modelValue","id","edgeId","provider","onUpdate:provider","onChange"])]),_:2},1032,["name","rules"])):y("",!0),l.dataIndex==="pointId"?(d(),m(C,{key:3,name:["dataSource",w,"pointId"],rules:[{required:!!s.channelId,message:"请选择点位"}]},{default:r(()=>[p(Q,{modelValue:s[l.dataIndex],"onUpdate:modelValue":v=>s[l.dataIndex]=v,id:s.collectorId,type:"POINT",edgeId:_(i).current.parentId},null,8,["modelValue","onUpdate:modelValue","id","edgeId"])]),_:2},1032,["name","rules"])):y("",!0),l.dataIndex==="id"?(d(),k(j,{key:4},[s[l.dataIndex]?(d(),k(j,{key:0},[s.state.value==="enabled"?(d(),m(I,{key:0,status:"success",text:"启用"})):(d(),m(I,{key:1,status:"warning",text:"禁用"}))],64)):(d(),m(I,{key:1,status:"error",text:"未绑定"}))],64)):y("",!0),l.key==="action"?(d(),m(t,{key:5},{default:r(()=>[p(T,{type:"link",disabled:!s.id,tooltip:{title:"解绑"},popConfirm:{title:"确认解绑？",onConfirm:()=>W(s.id)},hasPermission:"device/Instance:update"},{default:r(()=>[p(o,{type:"icon-jiebang"})]),_:2},1032,["disabled","popConfirm"]),s.id?(d(),m(T,{key:0,type:"link",hasPermission:"device/Instance:update",tooltip:{title:s.state.value==="enabled"?"禁用":"启用"},popConfirm:{title:s.state.value==="enabled"?"确认禁用？":"确认启用?",onConfirm:()=>te(s)}},{default:r(()=>[s.state.value==="enabled"?(d(),m(o,{key:0,type:"StopOutlined"})):(d(),m(o,{key:1,type:"PlayCircleOutlined"}))]),_:2},1032,["tooltip","popConfirm"])):y("",!0)]),_:2},1024)):y("",!0)]),_:1},8,["dataSource"]),Le("div",Je,[p(se,{pageSize:_(E),"onUpdate:pageSize":a[1]||(a[1]=l=>X(E)?E.value=l:null),current:_(x),"onUpdate:current":a[2]||(a[2]=l=>X(x)?x.value=l:null),total:((F=(V=_(M))==null?void 0:V.properties)==null?void 0:F.length)||0,onChange:$},null,8,["pageSize","current","total"])])]}),_:1},8,["model"])]),_:1}),_(N)?(d(),m(Ee,{key:0,deviceId:_(i).current.id,onClose:a[3]||(a[3]=V=>N.value=!1),onSave:ee,metaData:_(M).properties,edgeId:_(i).current.parentId},null,8,["deviceId","metaData","edgeId"])):y("",!0)]),_:1},8,["spinning"])):(d(),m(q,{key:1,bordered:!1,style:{padding:"0"}},{default:r(()=>[p(le,{description:"暂无数据，请配置物模型",style:{margin:"10% 0"}})]),_:1}))}}});const We=we($e,[["__scopeId","data-v-67f869e0"]]);export{We as default};
