import{d as W,ai as ve,r as pe,k as b,c as de,e as D,w as U,o as he,ab as be,U as T,Z as $,f as C,u as o,Y as j,_ as Z,V as M,X as ye,B as fe}from"./vue-1730252110824.js";import{F as Ne,b4 as G,g6 as Te,a4 as Ce,a5 as H,cL as J,aC as _,aO as ke}from"./index-1730252110824.js";import S from"./DropdownButton-1730252110824.js";import"./Menus-1730252110824.js";import"./Time.vue_vue_type_style_index_0_lang-1730252110824.js";import{g as Q}from"./util-17302521108243.js";import we from"./index-1730252110824223.js";import"./Array.vue_vue_type_style_index_0_scoped_59b5dd9b_lang-1730252110824.js";import{_ as Oe}from"./Double.vue_vue_type_script_setup_true_name_DoubleParamsDropdown_lang-1730252110824.js";import{u as ge}from"./scene-17302521108242.js";import{t as A}from"./util-17302521108245.js";import{E as Se}from"./util-17302521108242.js";import{c as Ae}from"./scene-1730252110824.js";import{u as Ve,h as y,c as xe}from"./util-1730252110824.js";import{f as Ie}from"./flattenDeep-1730252110824.js";const Be={class:"terms-params-item"},Fe={key:0,class:"term-type-warp"},De=["onClick"],Ue={class:"terms-content"},$e=W({name:"FilterCondition"}),Qe=W({...$e,props:{isFirst:{type:Boolean,default:!0},isLast:{type:Boolean,default:!0},showDeleteBtn:{type:Boolean,default:!0},name:{type:Number,default:0},termsName:{type:Number,default:0},actionName:{type:Number,default:0},thenName:{type:Number,default:0},branchName:{type:Number,default:0},value:{type:Object,default:()=>({column:"",type:"and",termType:"eq",value:{source:"fixed",value:void 0}})}},emits:["update:value"],setup(V,{emit:d}){const e=V,ee=ge(),{data:c}=ve(ee),t=pe({column:e.value.column,type:e.value.type,termType:e.value.termType,value:e.value.value,alarm:void 0});Ne.useInjectFormItemContext();const x=b(!1),k=de("filter-params"),I=b(),B=b([]),h=b([]),F=["nbtw","btw","in","nin","contains_all","contains_any","not_contains"],w=b([]),q=["lastAlarmTime","firstAlarm","alarmTime","level"],E=["alarmConfigId","alarmName"],v=b([{label:"手动输入",key:"fixed",component:"string"},{label:"内置参数",key:"upper",component:"tree"}]),O=b([]),ae=Ve(),te=D(()=>t.termType?F.includes(t.termType):!1),f=D(()=>{var a,n;return q.includes((n=(a=t.column)==null?void 0:a.split("."))==null?void 0:n[1])}),K=D(()=>{var a,n;return E.includes((n=(a=t.column)==null?void 0:a.split("."))==null?void 0:n[1])}),N=()=>{ae.onFieldChange()},L=a=>{var n,u,m,l;if(a){B.value=a.termTypes||[];const i=E.includes((u=(n=a.column)==null?void 0:n.split("."))==null?void 0:u[1])?"select":a.type;v.value[0].component=i,I.value=a.type;const r=a.options;if(i==="boolean")if(G(r)){const s=r==null?void 0:r.bool;h.value=[{label:s.falseText,name:s.falseText,value:s.falseValue,id:s.falseValue},{label:s.trueText,name:s.trueText,value:s.trueValue,id:s.trueValue}]}else h.value=(r==null?void 0:r.map(s=>({...s,label:s.name,value:s.id})))||[{label:"是",name:"是",value:"true",id:"true"},{label:"否",name:"否",value:"false",id:"false"}];else i==="enum"?h.value=((m=r==null?void 0:r.elements)==null?void 0:m.map(s=>({...s,label:s.text,value:s.value})))||[]:h.value=((l=G(r)?[]:r)==null?void 0:l.map(s=>({...s,label:s.name,value:s.id})))||[];w.value=Te(Ce(k.value),i,"type")}else h.value=[],w.value=[];t.termType&&I.value==="date"&&(A.includes(t.termType)?(v.value[0].component,v.value[0].component="int"):!A.includes(t.termType)&&v.value[0].component=="int"&&(v.value[0].component="date"))},ne=()=>{e.showDeleteBtn&&(x.value=!0)},le=()=>{e.showDeleteBtn&&(x.value=!1)},P=(a,n)=>{c.value.branches[e.branchName].then[e.thenName].actions[e.name].options.termsColumns=a;let m=[...new Set(Ie(a)).values()];n!=null&&n.otherColumns&&(m=[...n==null?void 0:n.otherColumns,...m]),c.value.branches[e.branchName].then[e.thenName].actions[e.name].options.columns=m},oe=a=>{var s,X,Y;const u=a.type!==v.value[0].component;let m=!1;q.includes((X=(s=t.column)==null?void 0:s.split("."))==null?void 0:X[1])?t.alarm||(t.alarm=void 0):(delete t.alarm,delete t.terms);const l=a.termTypes;if(l.some(g=>t.termType===g.id)||(m=!0,t.termType=l!=null&&l.length?l[0].id:"eq"),u)t.termType=l!=null&&l.length?l[0].id:"eq",t.value={source:v.value[0].key,value:void 0};else if(m){const g=H(t.value.value)?t.value.value[0]:t.value.value,ie=F.includes(a.key)?[g,void 0]:g;t.value={source:((Y=t.value)==null?void 0:Y.source)||v.value[0].key,value:ie}}const p=a.metadata===!0?[a.column]:[],i=c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].options,r=(i==null?void 0:i.termsColumns)||[];J(r,[e.termsName,e.name],p),P(r,i),d("update:value",y({...t})),B.value=a.termTypes,N(),c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].options.terms[e.termsName].terms[e.name][0]=a.name},se=a=>{var l;const n=H(t.value.value)?t.value.value[0]:t.value.value;let u=F.includes(a.key)?[n,void 0]:n;I.value==="date"&&(A.includes(a.key)?(v.value[0].component!=="int"&&(u=void 0),v.value[0].component="int"):!A.includes(a.key)&&v.value[0].component=="int"&&(u=void 0,v.value[0].component="date")),t.value={source:((l=t.value)==null?void 0:l.source)||v.value[0].key,value:u};const m=_(t,f.value?[]:["alarm","terms"]);d("update:value",y({...m})),N(),c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].options.terms[e.termsName].terms[e.name][1]=a.name},ue=a=>{d("update:value",y({...t})),N(),c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].options.terms[e.termsName].terms[e.name][4]=a.label},z=(a,n,u)=>{const m=_(t,f.value?[]:["alarm","terms"]);console.log(m,f.value),d("update:value",y({...m})),N(),c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].options.terms[e.termsName].terms[e.name][2]=u},me=a=>{t.type=a.value;const n=_(t,f.value?[]:["alarm","terms"]);d("update:value",y({...n})),c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].options.terms[e.termsName].terms[e.name][3]=a.label},re=()=>{var n,u,m,l,p,i,r,s;const a={column:void 0,value:{source:"fixed",value:void 0},termType:void 0,type:"and",key:`params_${new Date().getTime()}`};c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].terms[e.termsName].terms.push(a),(s=(r=(i=(p=(l=(m=(u=(n=c.value.branches)==null?void 0:n[e.branchName])==null?void 0:u.then)==null?void 0:m[e.thenName])==null?void 0:l.actions)==null?void 0:p[e.actionName].options)==null?void 0:i.terms)==null?void 0:r[e.termsName].terms)==null||s.push(["","eq","","and"])},ce=()=>{var u;(u=c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].terms[e.termsName].terms)==null||u.splice(e.name,1);const a=c.value.branches[e.branchName].then[e.thenName].actions[e.name].options,n=(a==null?void 0:a.termsColumns)||[];J(n,[e.termsName,e.name],[]),P(n,a)},R=()=>{var m;const a=(m=c.value.branches[e.branchName].then[e.thenName].actions[e.actionName])==null?void 0:m.actionId,n=c.value.branches[e.branchName].branchId,u=c.value.id;Ae({sorts:[{name:"createTime",order:"desc"}],terms:[{terms:[{column:"id$rule-bind-alarm",value:`${u}:${a||n}`},{column:"id$rule-bind-alarm",value:`${u}:-1`,type:"or"}]}]}).then(l=>{var p;l.success&&(O.value=((p=l.result)==null?void 0:p.map(i=>({...i,label:i.name,value:i.id})))||[])})};return(()=>{const n=c.value.branches[e.branchName].then[e.thenName].actions[e.actionName].actionId||c.value.branches[e.branchName].branchId;Se.subscribe([`${n}_alarm`],()=>{console.log("subscribe"),R()})})(),U([f.value,K.value],a=>{a&&!O.value.length&&R()},{immediate:!0}),U(()=>[k.value,t.column],()=>{if(t.column){const a=Q(k.value,t.column,"id");a&&Object.keys(a).length?(L(a),e.value.error&&(d("update:value",y({...e.value,error:!1})),N())):(d("update:value",y({...e.value,error:!0})),N())}},{deep:!0}),U(()=>e.value,()=>{const a=xe(e.value);console.log(e.value,a),t.value=a.value,t.column=a.column,t.type=a.type,t.termType=a.termType,a.hasOwnProperty("alarm")&&(t.alarm=a.alarm)},{immediate:!0,deep:!0}),he(()=>{if(t.column){const a=Q(k.value,t.column,"id");a&&Object.keys(a).length&&L(a)}}),(a,n)=>{const u=be("AIcon"),m=ke;return T(),$("div",Be,[V.isFirst?j("",!0):(T(),$("div",Fe,[C(o(S),{options:[{label:"并且",value:"and"},{label:"或者",value:"or"}],type:"type",value:o(t).type,"onUpdate:value":n[0]||(n[0]=l=>o(t).type=l),onSelect:me},null,8,["value"])])),Z("div",{class:"params-item_button",onMouseover:ne,onMouseout:le},[C(o(S),{options:o(k),icon:"icon-zhihangdongzuoxie-1",type:"column","value-name":"id","label-name":"fullName",placeholder:"请选择参数",value:o(t).column,"onUpdate:value":n[1]||(n[1]=l=>o(t).column=l),component:"treeSelect",onSelect:oe},null,8,["options","value"]),o(f)?(T(),M(o(S),{key:0,options:o(O),type:"alarm",placeholder:"请选择告警配置",value:o(t).alarm,"onUpdate:value":n[2]||(n[2]=l=>o(t).alarm=l),onSelect:ue},null,8,["options","value"])):j("",!0),C(o(S),{options:o(B),type:"termType","value-name":"id","label-name":"name",placeholder:"操作符",value:o(t).termType,"onUpdate:value":n[3]||(n[3]=l=>o(t).termType=l),onSelect:se},null,8,["options","value"]),o(te)?(T(),M(o(Oe),{key:1,icon:"icon-canshu",placeholder:"参数值","value-name":"id","label-name":"name",options:o(h),metricOptions:o(w),tabsOptions:o(v),value:o(t).value.value,"onUpdate:value":n[4]||(n[4]=l=>o(t).value.value=l),source:o(t).value.source,"onUpdate:source":n[5]||(n[5]=l=>o(t).value.source=l),onSelect:z},null,8,["options","metricOptions","tabsOptions","value","source"])):(T(),M(o(we),{key:2,icon:"icon-canshu",placeholder:"参数值","value-name":"id","label-name":"name",options:o(K)?o(O):o(h),metricOptions:o(w),tabsOptions:o(v),value:o(t).value.value,"onUpdate:value":n[6]||(n[6]=l=>o(t).value.value=l),source:o(t).value.source,"onUpdate:source":n[7]||(n[7]=l=>o(t).value.source=l),onSelect:z},null,8,["options","metricOptions","tabsOptions","value","source"])),C(m,{title:"确认删除？",onConfirm:ce,show:o(x),className:"button-delete"},{default:ye(()=>[C(u,{type:"CloseOutlined"})]),_:1},8,["show"])],32),V.isLast?(T(),$("div",{key:1,class:"term-add",onClick:fe(re,["stop"])},[Z("div",Ue,[C(u,{type:"PlusOutlined",style:{"font-size":"12px"}})])],8,De)):j("",!0)])}}});export{Qe as _};
