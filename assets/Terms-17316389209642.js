import{aF as x,a4 as X,d2 as A,d3 as E,aH as Y,cU as Z,_ as Q,f as W,g as ee}from"./index-1731638920964.js";import"./index-1731638920964291.js";import{d as L,ai as te,k as b,p as ne,s as F,ab as ae,U as d,Z as v,_ as f,f as y,X as w,F as I,a1 as $,u,V as N,E as oe,$ as re,a0 as se,Y as K,G as le,af as ie,ag as ce}from"./vue-1731638920964.js";import{u as pe}from"./scene-17316389209642.js";import{C as me,h as de}from"./util-17316389209645.js";import{g as ue}from"./scene-1731638920964.js";import he from"./Branches-1731638920964.js";import ve from"./TermsTabPane-1731638920964.js";import fe from"./BranchesNameEdit-1731638920964.js";import{q as _e,i as be}from"./configuration-1731638920964.js";import"./WhenItem.vue_vue_type_script_setup_true_name_WhenItem_lang-1731638920964.js";import"./TermsItem.vue_vue_type_script_setup_true_name_TermsItem_lang-1731638920964.js";import"./ParamsItem.vue_vue_type_script_setup_true_name_ParamsItem_lang-1731638920964.js";import"./DropdownButton-1731638920964.js";import"./DropdownButton.vue_vue_type_style_index_0_scoped_011bae6b_lang-1731638920964.js";import"./index-1731638920964281.js";import"./Menus-1731638920964.js";import"./util-17316389209643.js";import"./isUndefined-1731638920964.js";import"./Time.vue_vue_type_style_index_0_lang-1731638920964.js";import"./index-1731638920964223.js";import"./typings-1731638920964.js";import"./Array-1731638920964.js";import"./Array.vue_vue_type_style_index_0_scoped_59b5dd9b_lang-1731638920964.js";import"./Double.vue_vue_type_script_setup_true_name_DoubleParamsDropdown_lang-1731638920964.js";import"./index-1731638920964222.js";import"./index-1731638920964276.js";import"./index-1731638920964224.js";import"./index-1731638920964279.js";import"./List-1731638920964.js";import"./index-1731638920964219.js";import"./ActionTypeComponent.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./index.vue_vue_type_script_setup_true_lang-173163892096430.js";import"./index-1731638920964220.js";import"./index-1731638920964286.js";import"./NotifyWay-1731638920964.js";import"./config-17316389209642.js";import"./NotifyConfig.vue_vue_type_style_index_0_lang-1731638920964.js";import"./index-1731638920964278.js";import"./index-1731638920964280.js";import"./index-1731638920964282.js";import"./index-1731638920964283.js";import"./const-17316389209642.js";import"./NotifyTemplate.vue_vue_type_style_index_0_lang-1731638920964.js";import"./template-1731638920964.js";import"./VariableDefinitions.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./BuildIn.vue_vue_type_script_setup_true_name_NotifyBuildIn_lang-1731638920964.js";import"./Org.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./Tag.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./InputFile.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./User.vue_vue_type_script_setup_true_name_NotifyUser_lang-1731638920964.js";import"./unionBy-1731638920964.js";import"./index-1731638920964218.js";import"./index-1731638920964287.js";import"./Product-17316389209643.js";import"./product-17316389209644.js";import"./category-1731638920964.js";import"./department-17316389209642.js";import"./setting-17316389209642.js";import"./index.vue_vue_type_script_setup_true_name_Device_lang-1731638920964.js";import"./TopCard-17316389209646.js";import"./Device-1731638920964.js";import"./Tag-1731638920964.js";import"./RelationSelect.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./util-17316389209642.js";import"./lodash.default-1731638920964.js";import"./throttle-1731638920964.js";import"./min-1731638920964.js";import"./isNil-1731638920964.js";import"./difference-1731638920964.js";import"./flattenDeep-1731638920964.js";import"./sortBy-1731638920964.js";import"./uniqBy-1731638920964.js";import"./toLower-1731638920964.js";import"./index.vue_vue_type_script_setup_true_name_ActionDeviceActions_lang-1731638920964.js";import"./EditTable.vue_vue_type_script_setup_true_lang-17316389209642.js";import"./FunctionItem.vue_vue_type_script_setup_true_name_FunctionItem_lang-1731638920964.js";import"./index-1731638920964310.js";import"./WriteProperty.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./CardSelect-1731638920964.js";import"./Item-17316389209643.js";import"./index-1731638920964221.js";import"./AlarmModal-1731638920964.js";import"./useRequest-1731638920964.js";import"./useAlarmLevel-1731638920964.js";import"./config-1731638920964.js";import"./util-1731638920964.js";import"./FilterGroup.vue_vue_type_script_setup_true_name_FilterGroup_lang-1731638920964.js";import"./FilterCondition.vue_vue_type_script_setup_true_name_FilterCondition_lang-1731638920964.js";import"./CheckFilterItem-1731638920964.js";import"./CheckItem.vue_vue_type_script_setup_true_name_ActionCheckItem_lang-1731638920964.js";const V=g=>(ie("data-v-c76ee80a"),g=g(),ce(),g),ye={class:"actions-terms"},Ie={class:"filterConditionSwitch"},ge=V(()=>f("span",null,"执行",-1)),ke=V(()=>f("div",{class:"actions-terms-title",style:{padding:"0","margin-bottom":"24px"}}," 否则 ",-1)),xe={class:"actions-terms-options no-when"},we=L({name:"Terms"}),Ce=L({...we,setup(g,{expose:q}){const O=pe(),{data:l}=te(O),T=b([]),c=b([]),p=b(""),k=b(!1),B=b();ne(me,T);const P=(n,t,r)=>{var o;const e=t.start,a=t.len;n?(l.value.branches.splice(e+1,0,null),l.value.branches[e].when=[{terms:[{column:void 0,value:{source:"fixed",value:void 0},termType:void 0,key:`params_${x()}`,type:"and"}],type:"and",key:`terms_${x()}`}]):((o=l.value.branches)==null||o.splice(e+1,a-1),l.value.branches[e].when=[],l.value.options.when[e].terms=[{terms:[["","eq","","and"]]}])},U=n=>{var r;const t=X(n);t.branches=(r=t.branches)==null?void 0:r.filter(e=>!!e),ue(t).then(e=>{T.value=de(e.result,"column")})},j=n=>{var e;const t=A(),r={when:[],key:t,shakeLimit:{enabled:!1,time:1,threshold:1,alarmFirst:!1},then:[],branchId:t};(e=l.value.branches)==null||e.splice(n-1,1,r),l.value.options.when.splice(n-1,1,{terms:[],key:t})},G=n=>{S({start:n,len:1},-1)},D=(n,t)=>{var r;if(t==="add"){const e=c.value[c.value.length-1],a=((e==null?void 0:e.groupIndex)||c.value.length)+1,o=A(),i={when:[{terms:[{column:void 0,value:{source:"fixed",value:void 0},termType:void 0,key:`params_${x()}`,type:"and"}],type:"and",key:`terms_${x()}`}],key:o,shakeLimit:{enabled:!1,time:1,threshold:1,alarmFirst:!1},then:[],executeAnyway:!0,branchId:o,branchName:""};(r=l.value.branches)==null||r.push(i,null),p.value=o,l.value.options.when.push({terms:[{terms:[["","eq","","and"]]}],branchName:"",key:o,executeAnyway:!0,groupIndex:a})}else{const e=c.value.findIndex(a=>a.branchId===n);S(c.value[e],e)}},R=()=>{},S=async(n,t)=>{var a;let r=0,e=[];for(let o=n.start;o<n.start+n.len;o++){const i=l.value.branches[o];i&&((a=i.then)==null||a.forEach(s=>{r+=s.actions.length,s.actions&&s.actions.forEach(h=>{const m=h.actionId;h.executor==="alarm"&&e.push({column:"branchIndex",value:m||i.branchId,type:"or"})})}))}if(r)if(e.length){const o=await _e({terms:e});E.confirm({title:`已关联 ${o.result.total} 条告警，删除该条件会同步解除对应的关联告警，确认删除？`,onOk(){const i=o.result.data.map(s=>({alarmId:s.alarmId,ruleId:s.ruleId,branchIndex:s.branchIndex}));be(i),C(n,t)}})}else E.confirm({title:"该条件下有执行动作，确认删除？",onOk(){C(n,t)}});else C(n,t)},C=(n,t)=>{var e;if(l.value.branches.splice(n.start,n.len).forEach(a=>{if(a){let o=l.value.options.when.findIndex(i=>i.key===a.branchId);o!==-1&&(o=a.branches_Index),l.value.options.when.splice(o,1)}}),t>=0){if(c.value.splice(t,1),n.id===p.value){let a=t-1;a<0&&(a=0),p.value=c.value[a].id}}else{const a=c.value.find(i=>i.id===p.value);a.len-=1;const o=l.value.branches[n.start];(o===void 0||o!=null&&o.executeAnyway)&&((e=l.value.branches)==null||e.splice(n.start,0,null))}},z=()=>{},M=n=>{var t;n===p.value&&(k.value=!0,B.value=(t=c.value.find(r=>r.branchId===n))==null?void 0:t.branchName)},H=n=>{var e;let t=p.value;(e=l.value.branches)==null||e.forEach(a=>{(a==null?void 0:a.branchId)===t&&(a.branchName=n)});let r=l.value.options.when.find(a=>a.key===t);if(r)r.branchName=n;else{const a=c.value.findIndex(o=>o.branchId===t);a!==-1&&(l.value.options.when[a].branchName=n)}k.value=!1},J=n=>{const t=c.value.find(r=>r.start>=n&&n<r.start+r.len);t&&(p.value=t.branchId)};return F(()=>{var n;(n=l.value.trigger)!=null&&n.device&&U({trigger:l.value.trigger})}),F(()=>{const n=l.value.branches;let t=[],r=0;n&&(n.forEach((e,a)=>{const o=t.length-1;let i=l.value.options.when.find(s=>(e==null?void 0:e.branchId)===s.key);i||(i=l.value.options.when[r]),a===0||e!=null&&e.executeAnyway?t[o+1]={id:e.branchId,len:1,start:a,branchKey:e.key,branchId:e.branchId,branchName:e.branchName||(i==null?void 0:i.branchName)||"条件",groupIndex:r,openFilter:!!e.when.length}:t[o].len+=1,e&&(e.branches_Index=r,r+=1)}),c.value=t,p.value||(p.value=t[0].id))}),q({changePaneIndex:J}),(n,t)=>{const r=Y,e=Z,a=ae("AIcon"),o=Q,i=W;return d(),v(I,null,[f("div",ye,[y(r,{data:"执行动作",style:{"font-size":"14px"}}),f("div",null,[y(i,{type:"editable-card",activeKey:u(p),"onUpdate:activeKey":t[0]||(t[0]=s=>le(p)?p.value=s:null),onEdit:D,onTabClick:M},{default:w(()=>[(d(!0),v(I,null,$(u(c),(s,h)=>(d(),N(o,{key:s.id,closable:!1,forceRender:!0},{tab:w(()=>[y(ve,{showClose:u(c).length>1,onClose:()=>D(s.id,"close")},{default:w(()=>[oe(re(s.branchName||`条件${h+1}`),1)]),_:2},1032,["showClose","onClose"])]),default:w(()=>[f("div",Ie,[ge,y(e,{checked:s.openFilter,"onUpdate:checked":m=>s.openFilter=m,onChange:m=>P(m,s,h),checkedChildren:"开",unCheckedChildren:"关",style:{"margin-left":"4px"}},null,8,["checked","onUpdate:checked","onChange"])]),(d(!0),v(I,null,$(u(l).branches,(m,_)=>(d(),v(I,null,[_>=s.start&&_<s.start+s.len?(d(),v(I,{key:0},[m?(d(),N(he,{data:m,isFirst:_===s.start,name:_,branches_Index:m.branches_Index,groupLen:s.start+s.len,groupIndex:h+1,key:m.key,showGroupDelete:u(c).length!==1,onDelete:Ne=>G(_),onDeleteAll:R,onAdd:z},null,8,["data","isFirst","name","branches_Index","groupLen","groupIndex","showGroupDelete","onDelete"])):(d(),v("div",{key:1,class:"actions-terms-warp",style:se({marginTop:u(l).branches.length===2?0:24})},[ke,f("div",xe,[y(a,{type:"PlusOutlined",class:"when-add-button",onClick:()=>j(s.start+s.len)},null,8,["onClick"])])],4))],64)):K("",!0)],64))),256))]),_:2},1024))),128))]),_:1},8,["activeKey"])])]),u(k)?(d(),N(fe,{key:0,name:u(B),onCancel:t[1]||(t[1]=s=>k.value=!1),onOk:H},null,8,["name"])):K("",!0)],64)}}});const mn=ee(Ce,[["__scopeId","data-v-c76ee80a"]]);export{mn as default};
