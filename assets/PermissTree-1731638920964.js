import{k,w as G,d as ee,ac as se,g as te,ab as ne,U as o,Z as r,f as v,X as h,u as _,G as N,E as I,v as ae,A as ce,_ as j,$ as U,F as O,a1 as F,V as q,Y as P,af as le,ag as oe}from"./vue-1731638920964.js";import{U as R,i as z,a4 as de,gK as ue,C as re,$ as ie,a6 as pe,dD as fe,aK as he,aT as _e,g as ge}from"./index-1731638920964.js";import"./index-1731638920964282.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import{g as ve}from"./role-1731638920964.js";import{u as ke}from"./uniqBy-1731638920964.js";const J=(f,i,A=[])=>{f.forEach(y=>{y.children?J(y.children,i,A.concat(y.id)):i.set(y.id,{parentIds:A,name:y.name})})},Ae=f=>{const i=k(new Map);return G(()=>f.value,()=>{var A;i.value.clear(),(A=f.value)!=null&&A.length&&J(f.value,i.value)},{immediate:!0}),{PermissionsMap:i}},ye=f=>(le("data-v-974645ab"),f=f(),oe(),f),be={class:"permiss-tree-container"},Ce={key:0},Ie={key:1},Se=ye(()=>j("span",{style:{}},"数据权限",-1)),me={key:2},Ee=["id"],xe={key:0},Ue={key:1},Te={key:0},Ne={key:2},Pe={key:0},Re={key:1},je={key:2},Be=ee({__name:"PermissTree",props:{selectItems:Array},emits:["update:selectItems"],setup(f,{emit:i}){const A=se(),y=k();let{ctx:Le,proxy:S}=te();const d=[],B=[{title:"菜单权限",dataIndex:"menu",key:"menu",width:"260px"},{title:"操作权限",dataIndex:"action",key:"action",width:"260px"}];z&&B.push({title:"数据权限",dataIndex:"data",key:"data",width:"50%"});const m=k([]),p=k(!1),b=k(!1),Q=()=>{d.forEach(e=>{var t,s;e.granted=p.value,e.indeterminate=!1,(t=e.buttons)==null||t.forEach(n=>{n.granted=p.value}),p.value?e.selectAccesses="creator":e.selectAccesses="",e.accessSupport&&e.accessSupport.value==="support"&&((s=e.assetAccesses)==null||s.forEach(n=>{n.supportId===e.selectAccesses?n.granted=!0:n.granted=!1}))}),b.value=!1,i("update:selectItems",d.filter(e=>e.granted))},E=k(!1),L=k(),g=k(""),X=()=>{g&&(d.forEach(e=>{var t;e.accessSupport&&e.accessSupport.value==="support"&&(e.selectAccesses=g.value,(t=e.assetAccesses)==null||t.forEach(s=>{s.supportId===g.value?s.granted=!0:s.granted=!1}))}),i("update:selectItems",d.filter(e=>e.granted)))},M=()=>{g.value="",E.value=!1};(()=>{Y(),G(m,()=>{const e=de(d).filter(t=>t.indeterminate&&t.buttons||t.granted);e.forEach(t=>{var s;t.accessSupport&&t.accessSupport.value==="support"&&t.selectAccesses&&((s=t.assetAccesses)==null||s.forEach(n=>{n.supportId===t.selectAccesses?n.granted=!0:n.granted=!1}),delete t.selectAccesses),delete t.indeterminate,t.granted=!0}),i("update:selectItems",e)},{deep:!0})})(),Ae(m);function Y(){const e=A.params.id;ve(e).then(t=>{const s=t.result;m.value=s.filter(c=>(c.code===R&&(c.buttons=c.buttons.map(l=>(l.id==="view"&&(l.granted=!0),l))),c.code!==ue)),$(m.value);const n=d.filter(c=>c.granted);i("update:selectItems",n),n.length===d.length?(p.value=!0,b.value=!1):n.length>0&&(b.value=!0,p.value=!1)})}function T(e,t=!0){var n;if(t&&(e.buttons&&e.buttons.length>0&&e.buttons.forEach(c=>{c.granted=e.granted}),e.children&&D(e.children,e.granted)),x(e,e.buttons&&e.buttons.length>0?"buttons":"children"),V(e),e.parentId){const c=d.find(l=>l.id===e.parentId);if(x(c,"children"),c.parentId)return T(c,!1)}M();const s=d.filter(c=>c.granted);s.length===d.length?(p.value=!0,b.value=!1):s.length>0?(b.value=!0,p.value=!1):(p.value=!1,b.value=!1),i("update:selectItems",s),(n=S==null?void 0:S.$forceUpdate)==null||n.call(S)}const V=e=>{var t,s;e.accessSupport&&e.accessSupport.value==="support"&&(e.selectAccesses&&!e.granted&&!e.indeterminate?e.selectAccesses="":!e.selectAccesses&&(e.granted||e.indeterminate)&&(e.selectAccesses="creator")),((t=e.children)==null?void 0:t.length)>0&&((s=e.children)==null||s.forEach(n=>{n.accessSupport&&n.accessSupport.value==="support"&&(n.selectAccesses&&!n.granted&&!n.indeterminate?n.selectAccesses="":!n.selectAccesses&&(n.granted||n.indeterminate)&&(n.selectAccesses="creator")),n.children&&V(n.children)}))};function Z(e){x(e,"buttons"),T(e,!1)}function $(e){var t;if(e.forEach(s=>{var n;if(s.accessSupport&&s.accessSupport.value==="support"){const c=((n=s.assetAccesses)==null?void 0:n.find(l=>l.granted))||{};s.selectAccesses=c.supportId||""}s.buttons&&s.buttons.length>0?x(s,"buttons"):x(s,"children"),s.children&&$(s.children),d.push(s)}),z){let s=[];d==null||d.forEach(n=>{s=[...s,...n.assetAccesses]}),L.value=(t=ke(s,"supportId"))==null?void 0:t.map(n=>({label:n.name,value:n.supportId}))}}function D(e,t){e.length<1||e.forEach(s=>{var n,c;s.granted=t,s.indeterminate=!1,s.buttons&&s.buttons.length>0&&s.buttons.forEach(l=>{l.granted=t}),((n=s.assetAccesses)==null?void 0:n.length)>0&&((c=s.assetAccesses)==null||c.forEach(l=>{l.supportId==="creator"&&(l.granted=!0)})),s.children&&D(s.children,t)})}function x(e,t="children"){const s=e[t];if(s&&s instanceof Array){if(s.filter(l=>l==null?void 0:l.indeterminate).length>0){e.granted=!1,e.indeterminate=!0;return}const c=s.filter(l=>l.granted).length;c===s.length?(e.granted=!0,e.indeterminate=!1):c>0?(e.granted=!1,e.indeterminate=!0):(e.granted=!1,e.indeterminate=!1)}}return(e,t)=>{const s=re,n=ne("AIcon"),c=ie,l=pe,H=fe,W=he,w=_e;return o(),r("div",be,[v(w,{columns:B,"data-source":_(m),pagination:!1,rowKey:"id",scroll:{y:"500px"},ref_key:"treeRef",ref:y},{headerCell:h(({column:C})=>[C.key==="menu"?(o(),r("div",Ce,[v(s,{checked:_(p),"onUpdate:checked":t[0]||(t[0]=a=>N(p)?p.value=a:null),indeterminate:_(b),onChange:Q},{default:h(()=>[I("菜单权限")]),_:1},8,["checked","indeterminate"])])):C.key==="data"?(o(),r("div",Ie,[Se,v(c,null,{title:h(()=>[I("勾选任意数据权限均能看到自己创建的数据权限")]),default:h(()=>[v(n,{type:"QuestionCircleOutlined"})]),_:1}),v(s,{checked:_(E),"onUpdate:checked":t[1]||(t[1]=a=>N(E)?E.value=a:null),onChange:t[2]||(t[2]=a=>g.value=""),style:{"margin-left":"10px"}},{default:h(()=>[I("批量设置")]),_:1},8,["checked"]),ae(v(l,{value:_(g),"onUpdate:value":t[3]||(t[3]=a=>N(g)?g.value=a:null),size:"middle",style:{width:"200px"},options:_(L),onChange:X,placeholder:"请选择"},null,8,["value","options"]),[[ce,_(E)]])])):(o(),r("div",me,[j("span",null,U(C.title),1)]))]),bodyCell:h(({column:C,record:a})=>[j("div",{id:a.id},null,8,Ee),C.key==="menu"?(o(),r("div",xe,[v(s,{checked:a.granted,"onUpdate:checked":u=>a.granted=u,indeterminate:a.indeterminate,disabled:a.code===_(R),onChange:u=>T(a,!0)},{default:h(()=>[I(U(a.name),1)]),_:2},1032,["checked","onUpdate:checked","indeterminate","disabled","onChange"])])):C.key==="action"?(o(),r("div",Ue,[a.buttons&&a.buttons.length>0?(o(),r("div",Te,[(o(!0),r(O,null,F(a.buttons,u=>(o(),q(s,{checked:u.granted,"onUpdate:checked":K=>u.granted=K,onChange:K=>Z(a),disabled:a.code===_(R)&&u.id==="view",key:u.id},{default:h(()=>[I(U(u.name),1)]),_:2},1032,["checked","onUpdate:checked","onChange","disabled"]))),128))])):P("",!0)])):C.key==="data"?(o(),r("div",Ne,[a.accessSupport===void 0?(o(),r("span",Pe," 不支持数据权限配置，默认可查看全部数据 ")):a.accessSupport.value==="support"?(o(),r("div",Re,[v(W,{value:a.selectAccesses,"onUpdate:value":u=>a.selectAccesses=u,onChange:M},{default:h(()=>[(o(!0),r(O,null,F(a.assetAccesses,u=>(o(),q(H,{value:u.supportId,key:u.name},{default:h(()=>[I(U(u.name),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"])])):a.accessSupport.value==="indirect"||a.accessSupport.value==="unsupported"?(o(),r("span",je,U(a.accessDescription),1)):P("",!0)])):P("",!0)]),_:1},8,["data-source"])])}}});const Ge=ge(Be,[["__scopeId","data-v-974645ab"]]);export{Ge as default};
