import{d as G,k as y,e as O,w as H,ab as L,U as W,V as X,X as p,_ as u,f as d,E as B,u as _,G as N,v as Q,A as Z,W as ee,R as se,$ as E,af as te,ag as ae}from"./vue-1730252110824.js";import{o as P,h as oe,au as ne,cU as ie,aG as le,a0 as ce,a1 as re,a2 as de,ax as ue,a3 as pe,aa as me,g as _e}from"./index-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import"./index-1730252110824291.js";import{a as ve,b as fe,c as ge,d as he}from"./department-17302521108242.js";import{u as ye}from"./department-1730252110824.js";const q=w=>(te("data-v-c343a292"),w=w(),ae(),w),we={class:"row"},xe={style:{display:"flex","margin-left":"24px"}},be={class:"row"},Re=q(()=>u("span",{style:{"margin-right":"8px"}},"批量配置",-1)),Ie={style:{"margin-left":"30px"}},Te=["src"],Se={class:"card-item-content-title",style:{"margin-bottom":"18px"}},ke=q(()=>u("div",{class:"card-item-content-text"},"ID",-1)),Ce={style:{cursor:"pointer"},class:"card-item-content-value"},De=q(()=>u("div",{class:"card-item-content-text"}," 资产权限 ",-1)),Ke=G({__name:"AddDeviceOrProductDialog",props:{visible:{type:Boolean},queryColumns:{},parentId:{},allPermission:{},assetType:{}},emits:["confirm","update:visible","next"],setup(w,{emit:T}){const l=w,x=ye(),C=y(!1),U=y(0),V=()=>{if(s.selectedRows.length<1)return P("请先勾选数据","warning");const e=s.selectedRows.map(t=>({targetType:"org",targetId:l.parentId,assetType:l.assetType,assetIdList:[t.id],permission:t.selectPermissions.filter(n=>t.permissionList.map(o=>o.value).includes(n))}));C.value=!0,he(l.assetType,e).then(()=>{P("操作成功"),T("confirm"),T("next",s.selectedRows.map(t=>t.id)),l.assetType==="device"&&x.setProductId(void 0),T("update:visible",!1)}).finally(()=>{C.value=!1})},g=y(!0),S=y(["read"]),j=O(()=>l.allPermission.map(e=>({label:e.name,value:e.id,disabled:e.id==="read"}))),J=l.queryColumns.filter(e=>e.dataIndex!=="action"),M=O(()=>l.queryColumns.map(e=>(x.productId?e.dataIndex==="productName"?(e.search.first=!0,e.search.componentProps={mode:"multiple","max-tag-count":"responsive"},e.search.defaultTermType="eq",e.search.defaultOnceValue=x.productId):e.search&&"first"in e.search&&delete e.search.first:e.dataIndex==="productName"&&(e.search.defaultOnceValue=""),e))),A=y({}),s={_selectedRowKeys:y([]),backRowKeys:[],selectedRows:[],tableData:[],init:()=>{H([g,S,()=>s._selectedRowKeys],e=>{const t=e[2].value,n=s.backRowKeys;s.selectedRows.forEach(o=>{g.value?(o.selectPermissions=e[1],o.permissionList.forEach(i=>{i.disabled=!0})):o.permissionList.forEach(i=>{i.disabled=i.value==="read"})}),t&&t.length<n.length&&n.filter(i=>!t.includes(i)).forEach(i=>{const v=s.tableData.find(r=>r.id===i);v.permissionList.forEach(r=>r.disabled=!0),v.selectPermissions=["read"]}),t.length||s.tableData.forEach(o=>{o.selectPermissions=["read"]})},{deep:!0})},onSelectChange:e=>{if(!e.permissionList.find(o=>o.value==="share")){P("该资产不支持共享","warning");return}const t=s._selectedRowKeys.value,n=t.indexOf(e.id);s.backRowKeys=[...t],n===-1?(t.push(e.id),s.selectedRows.push(e)):(t.splice(n,1),s.selectedRows.splice(n,1)),s._selectedRowKeys.value=t},cancelSelect:()=>{s.backRowKeys=[...s._selectedRowKeys.value],s._selectedRowKeys.value=[],s.selectedRows=[]},getData:(e,t)=>new Promise(n=>{(l.assetType==="product"?ve:fe)(e).then(i=>{const{pageIndex:v,pageSize:r,total:k,data:b}=i.result,D=b.map(R=>R.id),K={read:0,save:1,delete:2,share:3};ge(l.assetType,D).then(R=>{b.forEach(c=>{var a,f,I,h;c.permissionList=(f=(a=R.result.find(m=>(m==null?void 0:m.assetId)===c.id))==null?void 0:a.permissionInfoList)==null?void 0:f.map(m=>({label:m.name,value:m.id,disabled:!0})),c.selectPermissions=["read"],c.permissionList=(h=(I=c.permissionList)==null?void 0:I.map(m=>({...m,idx:K[m.value]})))==null?void 0:h.sort((m,F)=>m.idx-F.idx),l.assetType==="product"&&(c.state={value:c.state===1?"online":c.state===0?"offline":"",text:c.state===1?"正常":c.state===0?"禁用":""})}),n({code:200,result:{data:b.sort((c,a)=>a.createTime-c.createTime),pageIndex:v,pageSize:r,total:k},status:200})})})}),requestFun:async e=>{if(U.value+=1,l.parentId){let t=[{column:"id",termType:"dim-assets$not",value:{assetType:l.assetType,targets:[{type:"org",id:l.parentId}]},type:"and"}];e.terms&&e.terms.length>0&&(t=[...e.terms,...t]);const n={...e,sorts:[{name:"createTime",order:"desc"}],terms:t},o=await s.getData(n,l.parentId);return s.tableData=o.result.data,{code:o.status,result:o.result,status:o.status}}else return{code:200,result:{data:[],pageIndex:0,pageSize:0,total:0},status:200}}};s.init();const $=(e,t,n)=>{if(e)n.map(o=>{s._selectedRowKeys.value.includes(o.id)||(s._selectedRowKeys.value.push(o.id),s.selectedRows.push(o))});else{const o=n.map(r=>r.id),i=[],v=[];s.selectedRows.map(r=>{o.includes(r.id)||(i.push(r.id),v.push(r))}),s._selectedRowKeys.value=i,s.selectedRows=v}},Y=()=>{x.setProductId(void 0),console.log(x.productId),T("update:visible",!1)},z=e=>{A.value=e};return(e,t)=>{const n=L("AIcon"),o=ie,i=le,v=L("pro-search"),r=L("Ellipsis"),k=ce,b=re,D=de,K=ue,R=pe,c=me;return W(),X(c,{class:"add-device-or-product-dialog-container",title:"绑定",width:"1440px",maskClosable:!1,onOk:V,confirmLoading:_(C),onCancel:Y,visible:""},{default:p(()=>[u("h5",we,[d(n,{type:"ExclamationCircleOutlined",style:{"margin-right":"6px"}}),B(" 只能分配有“共享”权限的资产数据 ")]),u("div",xe,[u("div",be,[Re,d(o,{checked:_(g),"onUpdate:checked":t[0]||(t[0]=a=>N(g)?g.value=a:null),"checked-children":"开","un-checked-children":"关",style:{width:"56px"}},null,8,["checked"])]),Q(u("div",Ie,[d(i,{value:_(S),"onUpdate:value":t[1]||(t[1]=a=>N(S)?S.value=a:null),options:_(j)},null,8,["value","options"])],512),[[Z,_(g)]])]),d(R,{ref:"tableRef",request:s.requestFun,gridColumn:2,params:_(A),rowSelection:{selectedRowKeys:s._selectedRowKeys.value,onSelect:s.onSelectChange,onSelectNone:s.cancelSelect,onSelectAll:$},columns:_(J),style:{"max-height":"500px",overflow:"auto"}},{headerTitle:p(()=>[d(v,{type:"simple",columns:_(M),target:"category-bind-modal",onSearch:z,style:{width:"75%","margin-bottom":"0"}},null,8,["columns"])]),card:p(a=>{var f,I;return[d(D,ee({value:a,actions:[{key:1}]},a,{active:s._selectedRowKeys.value.includes(a.id),onClick:s.onSelectChange,status:(f=a.state)==null?void 0:f.value,statusText:(I=a.state)==null?void 0:I.text,statusNames:{online:"processing",offline:"error",notActive:"warning"}}),{img:p(()=>[se(e.$slots,"img",{},()=>[u("img",{src:_(oe)("/device-product.png"),style:{cursor:"pointer"}},null,8,Te)],!0)]),content:p(()=>[u("h3",Se,[d(r,{style:{width:"calc(100% - 100px)"}},{default:p(()=>[B(E(a.name),1)]),_:2},1024)]),d(b,null,{default:p(()=>[d(k,{span:12},{default:p(()=>[ke,u("div",Ce,E(a.id),1)]),_:2},1024),d(k,{span:12},{default:p(()=>[De,u("div",{style:{cursor:"pointer"},class:"card-item-content-value",onClick:t[2]||(t[2]=h=>h.stopPropagation())},[d(i,{value:a.selectPermissions,"onUpdate:value":h=>a.selectPermissions=h,options:a.permissionList},null,8,["value","onUpdate:value","options"])])]),_:2},1024)]),_:2},1024)]),_:2},1040,["value","active","onClick","status","statusText"])]}),permission:p(a=>[u("div",{style:{cursor:"pointer"},class:"card-item-content-value",onClick:t[3]||(t[3]=f=>f.stopPropagation())},[d(i,{value:a.selectPermissions,"onUpdate:value":f=>a.selectPermissions=f,options:a.permissionList},null,8,["value","onUpdate:value","options"])])]),state:p(a=>[d(K,{status:a.state.value,text:a.state.text,statusNames:{online:"processing",offline:"error",notActive:"warning"}},null,8,["status","text"])]),registryTime:p(a=>[u("span",null,E(_(ne)(a.registryTime).format("YYYY-MM-DD HH:mm:ss")),1)]),_:3},8,["request","params","rowSelection","columns"])]),_:3},8,["confirmLoading"])}}});const Je=_e(Ke,[["__scopeId","data-v-c343a292"]]);export{Je as default};
