import{X as ye,i as fe,ab as he,h as _e,ax as ke,au as Ce,fu as xe,e1 as Ie,o as h,dG as ge,d3 as Te,fv as be,Z as Se,e as we,a0 as $e,a1 as Ae,a2 as Oe,a3 as De,B as X,L as H,T as z,fw as Pe,fx as Ne}from"./index-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import{_ as Ee}from"./modal.vue_vue_type_script_setup_true_name_DeviceImport_lang-1730252110824.js";import{_ as Ve}from"./index.vue_vue_type_script_setup_true_lang-173025211082422.js";import{_ as qe}from"./index.vue_vue_type_script_setup_true_lang-173025211082424.js";import{_ as Be}from"./index.vue_vue_type_script_setup_true_lang-173025211082417.js";import{q as je,n as Re,o as Je,p as Fe}from"./product-17302521108244.js";import{q as Me}from"./category-1730252110824.js";import{_ as Ye}from"./index.vue_vue_type_script_setup_true_lang-17302521108245.js";import{u as Le}from"./useParams-1730252110824.js";import{a as Ue}from"./setting-17302521108242.js";import{d as Ge,k as d,o as Ke,ab as b,U as y,Z as j,f as c,X as r,u,E as Z,G as Xe,_ as k,$ as S,V as x,F as R,a1 as He,Y as D}from"./vue-1730252110824.js";import"./index-1730252110824290.js";import"./product-1730252110824.js";import"./file-1730252110824.js";import"./plugin-1730252110824.js";import"./index-173025211082499.js";import"./accessConfig-1730252110824.js";import"./encodeQuery-1730252110824.js";const ze=["src"],Ze={style:{"font-size":"16px","font-weight":"600"}},Qe=k("div",{class:"card-item-content-text"}," 设备类型 ",-1),We=k("div",{class:"card-item-content-text"}," 产品名称 ",-1),At=Ge({__name:"index",setup(et){const _=d({}),C=d({}),o=d([]),w=d(!1),P=d(!1),I=d(!1),N=d({}),$=d(!1),E=d(""),V=d(""),g=d(!1),J=Le(),Q=ye(),W=d(!1),q=d(""),A=d(!1),F=d("确认删除？"),M=e=>Array.isArray(e)&&e.length?(e||[]).map(t=>({...t,id:`classifiedId is ${t.id}`,children:M(t.children)})):[],O=d([{title:"ID",dataIndex:"id",key:"id",ellipsis:!0,search:{type:"string",defaultTermType:"eq"}},{title:"设备名称",dataIndex:"name",key:"name",ellipsis:!0,search:{type:"string",first:!0}},{title:"产品名称",dataIndex:"productName",key:"productName",ellipsis:!0,search:{type:"select",rename:"productId",options:()=>new Promise(e=>{je({paging:!1}).then(t=>{e(t.result.map(a=>({label:a.name,value:a.id})))})})}},{title:"创建时间",dataIndex:"createTime",key:"createTime",scopedSlots:!0,width:200,search:{type:"date"}},{title:"状态",dataIndex:"state",key:"state",scopedSlots:!0,search:{type:"select",options:[{label:"禁用",value:"notActive"},{label:"离线",value:"offline"},{label:"在线",value:"online"}]}},{key:"classifiedId",dataIndex:"classifiedId",title:"产品分类",hideInTable:!0,search:{type:"treeSelect",options:()=>new Promise(e=>{Me({paging:!1}).then(t=>{e(M(t.result))})})}},{key:"accessProvider",title:"网关类型",dataIndex:"accessProvider",valueType:"select",hideInTable:!0,search:{type:"select",options:()=>new Promise(e=>{Re().then(t=>{const a=t.result||[];e(Ue(a).map(s=>({...s,value:`accessProvider is ${s.id}`})))})})}},{key:"accessId",dataIndex:"accessId",title:"接入方式",hideInTable:!0,search:{type:"select",options:()=>new Promise(e=>{Je({paging:!1,sorts:[{name:"createTime",order:"desc"}]}).then(t=>{e(t.result.map(a=>({label:a.name,value:`accessId is ${a.id}`})))})})}},{dataIndex:"deviceType",title:"设备类型",valueType:"select",hideInTable:!0,search:{type:"select",options:[{label:"直连设备",value:"device"},{label:"网关子设备",value:"childrenDevice"},{label:"网关设备",value:"gateway"}]}},{title:"说明",dataIndex:"describe",key:"describe",ellipsis:!0,search:{type:"string"}},{title:"操作",key:"action",fixed:"right",width:200,scopedSlots:!0}]),Y=(e,t,a)=>{e!=null&&e.terms&&Array.isArray(e.terms)&&(e==null?void 0:e.terms.length)>0?((e==null?void 0:e.terms)||[]).map((s,n)=>{s!=null&&s.type&&(t[`${a?`${a}.`:""}terms[${n}].type`]=s.type),Y(s,t,`${a?`${a}.`:""}terms[${n}]`)}):!(e!=null&&e.terms)&&Object.keys(e).length>0&&Object.keys(e).forEach(s=>{e[s]&&(t[`${a?`${a}.`:""}${s}`]=e[s])})},L=e=>{const t={};if(Y(e,t),Object.keys(t).length){const a=new URLSearchParams;return Object.keys(t).forEach(s=>{console.log(t[s]),a.append(s,t[s])}),a.toString()}else return""},U=()=>{I.value=!0,N.value={}},G=e=>{Q.jumpPage("device/Instance/Detail",{id:e})},K=(e,t)=>{var s,n,i;if(!e)return[];const a=[{key:"view",text:"查看",tooltip:{title:"查看"},icon:"EyeOutlined",onClick:()=>{G(e.id)}},{key:"update",text:"编辑",tooltip:{title:"编辑"},icon:"EditOutlined",onClick:()=>{I.value=!0,N.value=e}},{key:"action",text:((s=e.state)==null?void 0:s.value)!=="notActive"?"禁用":"启用",tooltip:{title:((n=e.state)==null?void 0:n.value)!=="notActive"?"禁用":"启用"},icon:e.state.value!=="notActive"?"StopOutlined":"CheckCircleOutlined",popConfirm:{title:`确认${e.state.value!=="notActive"?"禁用":"启用"}?`,onConfirm:async()=>{var f;let m;e.state.value!=="notActive"?m=await xe(e.id):m=await Ie(e.id),m&&m.status===200?(h("操作成功！"),(f=_.value)==null||f.reload()):h("操作失败！","error")}}},{key:"delete",text:"删除",disabled:((i=e.state)==null?void 0:i.value)!=="notActive",tooltip:{title:e.state.value!=="notActive"?"已启用的设备不能删除":"删除"},onClick:async()=>{var f;if(A.value)return;A.value=!0,q.value=e.id;const m=await ge(e.id).finally(()=>{W.value=!0});m.success&&(F.value=((f=m.result)==null?void 0:f.accessProvider)==="Ctwing"?"该操作仅可删除物联网平台数据Ctwing平台数据需另行删除":"确认删除？"),Te.confirm({title:F.value,onOk(){return ce()},onCancel(){A.value=!1}})},icon:"DeleteOutlined"}];return t==="card"?a.filter(m=>m.key!=="view"):a},ee=(e,t)=>{const a=new Set(o.value);t?a.add(e.id):a.delete(e.id),o.value=[...a.values()]},te=(e,t,a)=>{if(e)a.map(s=>{o.value.includes(s.id)||o.value.push(s.id)});else{const s=a.map(i=>i.id),n=[];o.value.map(i=>{s.includes(i)||n.push(i)}),o.value=n}},ae=e=>{if(g.value)if(o.value.includes(e.id)){const t=o.value.findIndex(a=>a===e.id);o.value.splice(t,1)}else o.value=[...o.value,e.id];else G(e.id)},se=()=>{o.value=[]},ne=e=>(e==null||e.terms.map(t=>t.terms.map(a=>(a.column.includes("$product-info")&&(a.column="productId",a.termType="product-info"),a))),e),le=[{key:"export",text:"批量导出设备",permission:"device/Instance:export",icon:"ExportOutlined",onClick:()=>{P.value=!0}},{key:"import",text:"批量导入设备",permission:"device/Instance:import",icon:"ImportOutlined",onClick:()=>{w.value=!0}},{key:"activeAll",text:"启用全部设备",ghost:!0,type:"primary",permission:"device/Instance:action",icon:"CheckCircleOutlined",popConfirm:{title:"确认启用全部设备？",onConfirm:()=>{V.value="active";const e=`${X}/device-instance/deploy?:X_Access_Token=${H.get(z)}&${L(ne(C.value))}`;E.value=e,$.value=!0}}},{key:"sync",text:"同步设备状态",type:"primary",ghost:!0,icon:"SyncOutlined",onClick:()=>{V.value="sync";const e=`${X}/device-instance/state/_sync?:X_Access_Token=${H.get(z)}&${L(C.value)}`;E.value=e,$.value=!0}},{key:"delete",text:"批量删除设备",danger:!0,permission:"device/Instance:delete",icon:"DeleteOutlined",selected:{popConfirm:{title:"已启用的设备无法删除，确认删除选中的禁用状态设备？",onConfirm:()=>{if(!o.value.length){h("请选择设备","error");return}const e=Pe(o.value);return e.then(t=>{var a;t.status===200&&(h("操作成功！"),o.value=[],(a=_.value)==null||a.reload())}),e}}}},{key:"disable",text:"批量禁用设备",danger:!0,icon:"StopOutlined",permission:"device/Instance:action",selected:{popConfirm:{title:"确认禁用选中设备?",onConfirm:()=>{if(!o.value.length){h("请选择设备","error");return}const e=Ne(o.value);return e.then(t=>{var a;t.status===200&&(h("操作成功！"),o.value=[],(a=_.value)==null||a.reload())}),e}}}}],oe=()=>{var e;I.value=!1,(e=_.value)==null||e.reload()},ie=e=>{let t="";return e.value.forEach((a,s)=>{s>0?t+=","+a.slice((e.column+" is ").length):t+=e.column+" in "+a.slice((e.column+" is ").length)}),t},re=e=>{var a;const t=(a=e==null?void 0:e.terms)==null?void 0:a.map(s=>(s.terms=s.terms.map(n=>{if(n.column==="id$dim-assets"){if(n.termType==="not"){const i=JSON.parse(n.value);i.not=!0,n.value=JSON.stringify(i)}delete n.termType}if(n.column&&["classifiedId","accessId","accessProvider"].includes(n.column)){const i=n.termType==="nin"?"not":n.termType;return console.log(n.termType,"termType"),delete n.termType,{...n,column:`productId$product-info$${i}`,value:Array.isArray(n.value)?ie(n):n.value}}return n}),s));C.value={terms:t||[]}},B=()=>{var e;(e=_.value)==null||e.reload()},ce=async()=>{var t;if((await be(q.value)).status===200){h("操作成功！");const a=o.value.findIndex(s=>s===q.value);a!==-1&&o.value.splice(a,1),(t=_.value)==null||t.reload()}else h("操作失败！","error");A.value=!1};return Ke(()=>{J.params.value.type==="add"&&U(),J.params.value.type==="import"&&(w.value=!0),fe&&O.value.splice(O.value.length-3,0,{dataIndex:"id$dim-assets",title:"所属组织",hideInTable:!0,search:{type:"treeSelect",termOptions:["eq"],options:()=>new Promise(e=>{Fe({}).then(t=>{const a=s=>{const n=[];return s.forEach(i=>{i.children&&(i.children=a(i.children)),n.push({...i,id:JSON.stringify({assetType:"device",targets:[{type:"org",id:i.id}]})})}),n};e(a(t.result))})})}})}),(e,t)=>{const a=b("pro-search"),s=b("AIcon"),n=Se,i=we,m=b("Ellipsis"),f=$e,ue=Ae,de=Oe,pe=De,ve=b("FullPage"),me=b("page-container");return y(),j(R,null,[c(me,null,{default:r(()=>[c(a,{columns:u(O),target:"device-instance",onSearch:re},null,8,["columns"]),c(ve,null,{default:r(()=>[c(pe,{ref_key:"instanceRef",ref:_,columns:u(O),request:u(he),defaultParams:{sorts:[{name:"createTime",order:"desc"},{name:"name",order:"desc"}]},rowSelection:u(g)?{selectedRowKeys:u(o),onSelect:ee,onSelectAll:te,onSelectNone:()=>o.value=[]}:!1,params:u(C)},{headerTitle:r(()=>[c(i,null,{default:r(()=>[c(n,{type:"primary",onClick:U,hasPermission:"device/Instance:add"},{icon:r(()=>[c(s,{type:"PlusOutlined"})]),default:r(()=>[Z(" 新增 ")]),_:1}),c(Ye,{isCheck:u(g),"onUpdate:isCheck":t[0]||(t[0]=l=>Xe(g)?g.value=l:null),actions:le,onChange:se},null,8,["isCheck"])]),_:1})]),card:r(l=>{var p,T;return[c(de,{value:l,onClick:ae,actions:K(l,"card"),active:u(o).includes(l.id),status:(p=l.state)==null?void 0:p.value,statusText:(T=l.state)==null?void 0:T.text,statusNames:{online:"processing",offline:"error",notActive:"warning"}},{img:r(()=>[k("img",{width:80,height:80,src:(l==null?void 0:l.photoUrl)||u(_e)("/device/instance/device-card.png")},null,8,ze)]),content:r(()=>[c(m,{style:{width:"calc(100% - 100px)","margin-bottom":"18px"}},{default:r(()=>[k("span",Ze,S(l.name),1)]),_:2},1024),c(ue,null,{default:r(()=>[c(f,{span:12},{default:r(()=>{var v;return[Qe,k("div",null,S((v=l.deviceType)==null?void 0:v.text),1)]}),_:2},1024),c(f,{span:12},{default:r(()=>[We,c(m,{style:{width:"100%"}},{default:r(()=>[Z(S(l.productName),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),actions:r(v=>[c(n,{disabled:v.disabled,popConfirm:v.popConfirm,tooltip:{...v.tooltip},onClick:v.onClick,hasPermission:"device/Instance:"+v.key},{default:r(()=>[v.key==="delete"?(y(),x(s,{key:0,type:"DeleteOutlined"})):(y(),j(R,{key:1},[c(s,{type:v.icon},null,8,["type"]),k("span",null,S(v==null?void 0:v.text),1)],64))]),_:2},1032,["disabled","popConfirm","tooltip","onClick","hasPermission"])]),_:2},1032,["value","actions","active","status","statusText"])]}),state:r(l=>{var p,T;return[c(ke,{status:(p=l.state)==null?void 0:p.value,text:(T=l.state)==null?void 0:T.text,statusNames:{online:"processing",offline:"error",notActive:"warning"}},null,8,["status","text"])]}),createTime:r(l=>[k("span",null,S(l!=null&&l.createTime?u(Ce)(l.createTime).format("YYYY-MM-DD HH:mm:ss"):""),1)]),action:r(l=>[c(i,{size:16},{default:r(()=>[(y(!0),j(R,null,He(K(l,"table"),p=>(y(),x(n,{key:p.key,disabled:p.disabled,popConfirm:p.popConfirm,tooltip:{...p.tooltip},onClick:p.onClick,type:"link",style:{padding:"0 5px"},danger:p.key==="delete",hasPermission:p.key==="view"?!0:"device/Instance:"+p.key},{icon:r(()=>[c(s,{type:p.icon},null,8,["type"])]),_:2},1032,["disabled","popConfirm","tooltip","onClick","danger","hasPermission"]))),128))]),_:2},1024)]),_:1},8,["columns","request","rowSelection","params"])]),_:1})]),_:1}),u(w)?(y(),x(Ee,{key:0,onCancel:t[1]||(t[1]=l=>w.value=!1),onSave:B})):D("",!0),u(P)?(y(),x(Ve,{key:1,onClose:t[2]||(t[2]=l=>P.value=!1),data:u(C),onSave:B},null,8,["data"])):D("",!0),u($)?(y(),x(qe,{key:2,onClose:t[3]||(t[3]=l=>$.value=!1),api:u(E),type:u(V),data:u(C),onSave:B},null,8,["api","type","data"])):D("",!0),u(I)?(y(),x(Be,{key:3,data:u(N),onClose:t[4]||(t[4]=l=>I.value=!1),onSave:oe},null,8,["data"])):D("",!0)],64)}}});export{At as default};
