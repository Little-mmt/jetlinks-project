import{v as X,f8 as le,$ as re,aD as ae,a6 as ue,a7 as ne,F as oe}from"./index-1730252110824.js";import{_ as ie}from"./Rule.vue_vue_type_script_setup_true_name_Rule_lang-1730252110824.js";import{h as se,k as de}from"./product-17302521108244.js";import{u as pe}from"./instance-1730252110824.js";import{u as ve}from"./product-17302521108245.js";import{d as Y}from"./context-1730252110824.js";import{d as j,k as F,w as L,ab as Z,U as R,V,X as i,f as n,u as l,G as ce,c as Q,r as ge,e as O,o as ye,Y as A,Z as B,F as $,E as N,a1 as me,$ as fe,_ as H}from"./vue-1730252110824.js";const Re=j({name:"ReadType"}),we=j({...Re,props:{disabled:{type:Boolean,default:!1},value:{type:Array,default:()=>[]},options:{type:Array,default:()=>[]}},emits:["update:value","change"],setup(p,{emit:S}){const u=p,c=F([]);Y();const C=w=>{c.value=w,S("update:value",w),S("change",w)};return L(()=>u.value,()=>{c.value=u.value},{immediate:!0}),(w,_)=>{const P=Z("CheckButton"),q=X;return R(),V(q,{name:"type",label:"读写类型",rules:[{required:!0,message:"请选择读写类型"}],style:{"margin-bottom":"0"}},{default:i(()=>[n(P,{value:l(c),"onUpdate:value":_[0]||(_[0]=k=>ce(c)?c.value=k:null),multiple:!0,options:p.options,disabled:p.disabled,onChange:C},null,8,["value","options","disabled"])]),_:1})}}}),_e=H("div",null,"选择当前产品物模型下的属性作为触发属性",-1),be=H("div",null,"任意属性值更新时将触发下方计算规则",-1),Pe=j({name:"VirtualRule"}),ke=j({...Pe,props:{value:{type:Object,default:()=>{}},dataSource:{type:Array,default:()=>[]},source:{type:String,default:"device"},record:{type:Object,default:()=>({})}},setup(p,{expose:S}){var E;const u=p,c={triggerProperties:["*"],type:void 0,script:"",isVirtualRule:!1,windowType:"undefined",aggType:void 0,window:{span:void 0,every:void 0}},C=pe(),w=ve(),_=Y(),P=F([]),q=F(void 0),k=Q("_metadataType","product"),e=ge({type:((E=u.value)==null?void 0:E.expands.type)||[],virtualRule:void 0}),I=Q("metadataSource"),K=()=>{e.virtualRule.window={span:void 0,every:void 0}},D=O(()=>u.source==="manual"?[{value:"write",label:"写"}]:u.source==="rule"?[{value:"report",label:"上报"}]:[{value:"read",label:"读"},{value:"write",label:"写"},{value:"report",label:"上报"}]),z=O(()=>((I==null?void 0:I.value)||[]).filter(r=>{var t;return(r==null?void 0:r.id)!==((t=u.value)==null?void 0:t.id)&&r.id})),U=()=>{var r,t,o,d,g,v,s,y,f;e.virtualRule={...c,...((t=(r=u.value)==null?void 0:r.expands)==null?void 0:t.virtualRule)||{},triggerProperties:(v=(g=(d=(o=u.value)==null?void 0:o.expands)==null?void 0:d.virtualRule)==null?void 0:g.triggerProperties)!=null&&v.length?(f=(y=(s=u.value)==null?void 0:s.expands)==null?void 0:y.virtualRule)==null?void 0:f.triggerProperties:["*"]}},ee=async()=>{var t,o,d,g,v,s,y,f,x,T,h,a;let r;try{if(k==="product"?r=await se((t=w.current)==null?void 0:t.id,(o=u.value)==null?void 0:o.id):r=await le((d=C.current)==null?void 0:d.productId,(g=C.current)==null?void 0:g.id,(v=u.value)==null?void 0:v.id),r&&r.status===200&&r.result){const m=(x=(f=(y=(s=u.value)==null?void 0:s.expands)==null?void 0:y.virtualRule)==null?void 0:f.triggerProperties)!=null&&x.length?(a=(h=(T=u.value)==null?void 0:T.expands)==null?void 0:h.virtualRule)==null?void 0:a.triggerProperties:r.result.triggerProperties;e.virtualRule={triggerProperties:m!=null&&m.length?m:["*"],...r.result.rule}}else U()}catch{U()}},te=()=>{de().then(r=>{r.status===200&&(P.value=r.result.map(t=>({label:t==null?void 0:t.text,value:t==null?void 0:t.value})))})};ye(()=>{te()}),L(()=>JSON.stringify(u.value),()=>{var r;e.type=(r=u.value)==null?void 0:r.expands.type},{immediate:!0}),L(()=>u.source,r=>{r==="rule"?(e.virtualRule=c,ee(),U()):e.virtualRule=void 0},{immediate:!0});const J=O(()=>{var t,o,d;const r=((t=e==null?void 0:e.virtualRule)==null?void 0:t.windowType)!=="undefined";return{type:e==null?void 0:e.type,virtualRule:{...e==null?void 0:e.virtualRule,type:r?"window":"script",isVirtualRule:r,triggerProperties:(o=e==null?void 0:e.virtualRule)!=null&&o.triggerProperties.includes("*")?[]:(d=e==null?void 0:e.virtualRule)==null?void 0:d.triggerProperties}}});return S({onSave:()=>new Promise(async(r,t)=>{const o=await q.value.validate().catch(()=>{t()});o&&(o.virtualRule?r(J.value):r({type:o.type}))})}),(r,t)=>{const o=Z("AIcon"),d=re,g=ae,v=ue,s=X,y=ne,f=oe;return R(),V(f,{ref_key:"formRef",ref:q,layout:"vertical",model:l(e)},{default:i(()=>{var x,T,h;return[p.source!=="rule"?(R(),V(l(we),{key:0,value:l(e).type,"onUpdate:value":t[0]||(t[0]=a=>l(e).type=a),disabled:p.source!=="device",options:l(D)},null,8,["value","disabled","options"])):A("",!0),p.source==="rule"?(R(),B($,{key:1},[n(s,{name:["virtualRule","triggerProperties"],rules:[{required:!0,message:"请选择触发属性"}]},{label:i(()=>[N(" 触发属性 "),n(d,null,{title:i(()=>[_e,be]),default:i(()=>[n(o,{type:"QuestionCircleOutlined",style:{"margin-left":"2px"}})]),_:1})]),default:i(()=>[n(v,{value:l(e).virtualRule.triggerProperties,"onUpdate:value":t[1]||(t[1]=a=>l(e).virtualRule.triggerProperties=a),mode:"multiple",placeholder:"请选择触发属性","show-search":"","max-tag-count":"responsive",getPopupContainer:a=>l(_)||a,dropdownStyle:{zIndex:1071},virtual:!0},{default:i(()=>{var a,m,W;return[n(g,{disabled:((m=(a=l(e).virtualRule)==null?void 0:a.triggerProperties)==null?void 0:m.length)&&!((W=l(e).virtualRule.triggerProperties)!=null&&W.includes("*")),value:"*"},{default:i(()=>[N("任意属性")]),_:1},8,["disabled"]),(R(!0),B($,null,me(l(z),b=>{var G,M;return R(),V(g,{disabled:(M=(G=l(e).virtualRule)==null?void 0:G.triggerProperties)==null?void 0:M.includes("*"),key:b==null?void 0:b.id},{default:i(()=>[N(fe(b==null?void 0:b.name),1)]),_:2},1032,["disabled"])}),128))]}),_:1},8,["value","getPopupContainer"])]),_:1}),n(s,{name:["virtualRule","script"],label:"计算规则",required:""},{default:i(()=>[n(ie,{value:l(e).virtualRule.script,"onUpdate:value":t[2]||(t[2]=a=>l(e).virtualRule.script=a),virtualRule:l(J).virtualRule,propertiesOptions:l(z),id:p.value.id,aggList:l(P)},null,8,["value","virtualRule","propertiesOptions","id","aggList"])]),_:1}),n(s,{label:"窗口",name:["virtualRule","windowType"],rules:[{required:!0,message:"请选择窗口类型"}]},{default:i(()=>[n(v,{"show-search":"",placeholder:"请选择窗口类型",value:l(e).virtualRule.windowType,"onUpdate:value":t[3]||(t[3]=a=>l(e).virtualRule.windowType=a),options:[{label:"无",value:"undefined"},{label:"时间窗口",value:"time"},{label:"频次窗口",value:"num"}],getPopupContainer:a=>l(_)||a,dropdownStyle:{zIndex:1071},onSelect:K},null,8,["value","getPopupContainer"])]),_:1}),((x=l(e).virtualRule)==null?void 0:x.windowType)!=="undefined"?(R(),B($,{key:0},[n(s,{label:"聚合函数",name:["virtualRule","aggType"],rules:[{required:!0,message:"请选择聚合函数"}]},{default:i(()=>[n(v,{placeholder:"请选择聚合函数",value:l(e).virtualRule.aggType,"onUpdate:value":t[4]||(t[4]=a=>l(e).virtualRule.aggType=a),options:l(P),getPopupContainer:a=>l(_)||a,dropdownStyle:{zIndex:1071}},null,8,["value","options","getPopupContainer"])]),_:1}),n(s,{label:((T=l(e).virtualRule)==null?void 0:T.windowType)==="time"?"窗口长度(s)":"窗口长度(次)",name:["virtualRule","window","span"],required:"",rules:[{required:!0,message:"请输入窗口长度"},{pattern:/^\d+$/,message:"请输入1-999999之间的正整数"}]},{default:i(()=>[n(y,{value:l(e).virtualRule.window.span,"onUpdate:value":t[5]||(t[5]=a=>l(e).virtualRule.window.span=a),max:999999,min:1,placeholder:"请输入窗口长度",style:{width:"100%"}},null,8,["value"])]),_:1},8,["label"]),n(s,{label:((h=l(e).virtualRule)==null?void 0:h.windowType)==="time"?"步长(s)":"步长(次)",name:["virtualRule","window","every"],required:"",rules:[{required:!0,message:"请输入步长"},{pattern:/^\d+$/,message:"请输入1-999999之间的正整数"}]},{default:i(()=>[n(y,{style:{width:"100%"},value:l(e).virtualRule.window.every,"onUpdate:value":t[6]||(t[6]=a=>l(e).virtualRule.window.every=a),placeholder:"请输入步长",max:999999,min:1},null,8,["value"])]),_:1},8,["label"])],64)):A("",!0)],64)):A("",!0)]}),_:1},8,["model"])}}});export{ke as _};
