import{dM as V,dK as J,dL as T,o as y,dN as M,dO as q,dI as E,dg as U,aI as $,d as z,aO as G,dP as Q,dQ as X,A as F,aa as H,g as W}from"./index-1731638920964.js";import"./index-1731638920964301.js";import"./index-1731638920964288.js";import"./index-1731638920964281.js";import{d as Y,k as p,o as Z,ab as N,U as ee,V as ae,X as l,_ as x,f as i,u,G as te,E as j,$ as ne,af as se,ag as oe}from"./vue-1731638920964.js";const de=f=>(se("data-v-6a6e4a01"),f=f(),oe(),f),ce={class:"map-tree"},le=de(()=>x("div",{class:"map-tree-top"}," 采集器的点位名称与属性名称一致时将自动映射绑定；有多个采集器点位名称与属性名称一致时以第1个采集器的点位数据进行绑定 ",-1)),ie={class:"map-tree-content"},re={style:{width:"100px"}},pe=Y({__name:"PatchMapping",props:{metaData:{type:Array,default:()=>[]},deviceId:{type:String,default:""},edgeId:{type:String,default:""},deviceData:{type:Object},text:{type:String}},emits:["close","save"],setup(f,{emit:C}){const o=f,L=p([]),m=p([]),c=p([]);p([]);const w=p(!1),b=p(!1),I=p([]),K=(e,a)=>{L.value=[...e],I.value.push(a.node.id),m.value=(a==null?void 0:a.checkedNodes)||[]},P=()=>{console.log(c.value,m.value),c.value=m.value},g=p([]),S=async()=>{var e,a;if(o.edgeId){w.value=!0;const t=await V(o.edgeId);w.value=!1,t.status===200&&(g.value=(a=(e=t.result)==null?void 0:e[0])==null?void 0:a.map(d=>({...d,title:d.name,key:d.id,checkable:!1,type:"channel",parentId:"",provider:d.provider})))}},A=e=>(console.log(e),new Promise(async a=>{var _,v;if((_=e.dataRef)!=null&&_.children){a();return}const t={terms:[{terms:[{column:e.type==="channel"?"channelId":"collectorId",value:e.key}]}]},d=e.type==="channel"?await J(o.edgeId,t):await T(o.edgeId,t);e.dataRef.children=(v=d.result)==null?void 0:v[0].map(n=>({...n,title:n.name,key:n.id,type:e.type==="channel"?"collector":"point",parentId:e.key,checkable:e.type==="channel",isLeaf:e.type!=="channel"})),g.value=[...g.value],a()})),O=e=>{const a=c.value.findIndex(t=>t.key===e);c.value.splice(a,1),L.value=c.value.map(t=>t.key),m.value=c.value},B=async()=>{var e,a,t,d,_;if(b.value=!0,!c.value.length)y("请选择采集器","warning");else{const v=[];c.value.map(s=>{const D=(s.children||[]).map(h=>{var k;return{channelId:s.parentId,collectorId:h.collectorId,pointId:h.id,metadataType:"property",metadataId:(k=o.metaData.find(r=>r.name===h.name))==null?void 0:k.metadataId,provider:g.value.find(r=>r.id===s.parentId).provider,state:o.deviceData.state.value==="notActive"?"disabled":null}});v.push(...D)});const n=v.filter(s=>!!s.metadataId);if(o.deviceId)n&&n.length!==0?(await M(o.edgeId,{deviceId:o.deviceId,provider:(e=n[0])==null?void 0:e.provider,requestList:n})).status===200&&(y("操作成功"),C("save")):y("暂无对应属性的映射","error");else if(n&&n.length!==0){const s=await q(o.deviceData);s.status===200&&(await M(o.edgeId,{deviceId:(a=s.result)==null?void 0:a.id,provider:(t=n[0])==null?void 0:t.provider,requestList:n}),await E(o.edgeId,{info:[{deviceId:(d=s.result)==null?void 0:d.id,deviceName:(_=s.result)==null?void 0:_.name}]}),s.status===200&&(y("操作成功"),C("save")))}else y("暂无对应属性的映射","error")}b.value=!1},R=()=>{C("close")};return Z(()=>{o.edgeId&&S()}),(e,a)=>{const t=U,d=$,_=z,v=N("AIcon"),n=G,s=Q,D=X,h=F,k=H;return ee(),ae(k,{width:"900px",title:"批量映射",visible:"",onOk:B,onCancel:R,confirmLoading:u(b)},{default:l(()=>[x("div",ce,[le,i(h,{spinning:u(w)},{default:l(()=>[x("div",ie,[i(d,{class:"map-tree-content-card",title:"源数据"},{default:l(()=>[i(t,{checkable:"",height:300,"tree-data":u(g),checkedKeys:u(L),"load-data":A,onCheck:K,expandedKeys:u(I),"onUpdate:expandedKeys":a[0]||(a[0]=r=>te(I)?I.value=r:null)},null,8,["tree-data","checkedKeys","expandedKeys"])]),_:1}),x("div",re,[i(_,{disabled:u(c).length>=u(m).length,onClick:P},{default:l(()=>[j("加入右侧")]),_:1},8,["disabled"])]),i(d,{class:"map-tree-content-card",title:"采集器"},{default:l(()=>[i(D,{size:"small","data-source":u(c),class:"map-tree-content-card-list"},{renderItem:l(({item:r})=>[i(s,null,{actions:l(()=>[i(n,{title:"确认删除？",onConfirm:()=>O(r.key)},{default:l(()=>[i(v,{type:"DeleteOutlined"})]),_:2},1032,["onConfirm"])]),default:l(()=>[j(ne(r.title)+" ",1)]),_:2},1024)]),_:1},8,["data-source"])]),_:1})])]),_:1},8,["spinning"])])]),_:1},8,["confirmLoading"])}}});const ge=W(pe,[["__scopeId","data-v-6a6e4a01"]]);export{ge as default};
