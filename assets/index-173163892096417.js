import{d as pe,k as g,r as Re,w as W,b as Le,ab as V,U as d,V as _,X as r,f as u,u as s,E as B,Y as p,G as de,Z as w,R as Ye,_ as h,$ as S,B as ue}from"./vue-1731638920964.js";import{h as j,au as Fe,a4 as q,o as R,dh as Ve,aS as qe,cC as Je,dk as Ge,Z as We,e as ze,C as He,J as Ke,a3 as Ze,y as Qe,A as Xe,g as et}from"./index-1731638920964.js";import"./index-1731638920964278.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import"./index-1731638920964282.js";import"./index-1731638920964283.js";import{l as tt,m as at,n as nt,o as ot,r as st,p as ct,t as it}from"./collector-1731638920964.js";import lt from"./index-173163892096415.js";import{_ as rt}from"./index.vue_vue_type_script_setup_true_lang-17316389209644.js";import dt from"./index-173163892096413.js";import{_ as ut}from"./SaveModBus.vue_vue_type_script_setup_true_lang-1731638920964.js";import{_ as pt}from"./SaveOPCUA.vue_vue_type_script_setup_true_lang-1731638920964.js";import mt from"./index-173163892096411.js";import vt from"./index-173163892096412.js";import{_ as ft}from"./SaveBACNet.vue_vue_type_script_setup_true_lang-1731638920964.js";import{a as _t}from"./data-17316389209642.js";import ht from"./SaveS7-1731638920964.js";import{_ as Ct}from"./SaveIEC104.vue_vue_type_script_setup_true_lang-1731638920964.js";import gt from"./index-173163892096414.js";import{_ as yt}from"./index.vue_vue_type_script_setup_true_lang-17316389209645.js";import{t as kt}from"./throttle-1731638920964.js";import{m as xt}from"./map-17316389209642.js";import"./index-1731638920964290.js";import"./validate-1731638920964.js";import"./regular-1731638920964.js";import"./index-1731638920964291.js";import"./Table-1731638920964.js";import"./Tree-1731638920964.js";import"./index-1731638920964292.js";import"./index-1731638920964293.js";import"./Table-17316389209642.js";import"./PropertyId.vue_vue_type_script_setup_true_name_propertyId_lang-1731638920964.js";import"./index-1731638920964294.js";import"./index-1731638920964296.js";import"./context-1731638920964.js";import"./columns-1731638920964.js";import"./data-17316389209643.js";import"./index-1731638920964295.js";import"./sortBy-1731638920964.js";import"./Tree-17316389209642.js";import"./index-1731638920964288.js";import"./DeathArea-1731638920964.js";const bt={key:0,style:{"margin-top":"15px"}},It={class:"card-box-title"},St={class:"card-box-action"},Dt={style:{"font-size":"20px","margin-top":"-10px"}},Bt={style:{"font-size":"20px"}},wt=["src"],Ot={class:"card-box-content"},At={class:"card-box-content-left"},Mt={class:"card-box-content-left-1"},$t={key:0,class:"ard-box-content-left-1-title"},Ut={key:1,class:"ard-box-content-left-1-title"},Et=["onClick"],Tt=["onClick"],Nt={key:0,class:"card-box-content-right-2"},Pt={class:"card-box-content-right"},jt={key:0,class:"card-box-content-right-1"},Rt={class:"card-box-content-right-2"},Lt={key:0},Yt=pe({name:"PointPage"}),Ft=pe({...Yt,props:{data:{type:Object,default:{}}},setup(k){var le;const n=k,m=g({}),z=g({}),me=j("/DataCollect/device-opcua.png"),ve=j("/DataCollect/device-modbus.png"),fe=j("/DataCollect/s7.png"),_e=j("/DataCollect/gateway.png"),he=j("/DataCollect/IEC104.png"),M=new Map;M.set("OPC_UA",me),M.set("MODBUS_TCP",ve),M.set("snap7",fe),M.set("iec104",he),M.set("COLLECTOR_GATEWAY",_e);const l=Re({saveModBus:!1,saveOPCUA:!1,writePoint:!1,batchUpdate:!1,scan:!1,saveS7:!1,import:!1,saveIEC104:!1,scanBacnet:!1,saveBACNet:!1}),v=g({}),H=g(),f=g([]),x=g(!1),J=g(!1),$=new Map,U=g(!1),K=g(),Z=g({sorts:[{name:"id",order:"desc"}],terms:[{terms:[{column:"collectorId",termType:"eq",value:(le=n.data)!=null&&le.id?n.data.id==="*"?void 0:n.data.id:"undefined"}]}]}),Q=[{label:"读",value:"read"},{label:"写",value:"write"}],X=[{title:"点位名称",dataIndex:"name",key:"name",search:{type:"string"}},{title:"通讯协议",dataIndex:"provider",key:"provider",search:{type:"select",options:async()=>{const e=await at();return e.success?e.result.map(t=>({label:t.name,value:t.id})):[]}}},{title:"访问类型",dataIndex:"accessModes$in$any",key:"accessModes$in$any",search:{type:"select",options:H}},{title:"运行状态",dataIndex:"runningState",key:"runningState",search:{type:"select",options:async()=>{const e=await nt();return e.status===200?e.result.map(t=>({label:t.text,value:t.value})):[]}}},{title:"说明",dataIndex:"description",key:"description",search:{type:"string"}}],G=g(),E=g(new Map),ee=g([]),Ce=()=>{var e,t,a,o,i,C,b,y,I;((e=n.data)==null?void 0:e.provider)==="snap7"?(l.saveS7=!0,v.value={collectorId:(t=n.data)==null?void 0:t.id,provider:(a=n.data)==null?void 0:a.provider,deviceType:(o=n.data)==null?void 0:o.configuration.type}):((i=n.data)==null?void 0:i.provider)==="iec104"?(l.saveIEC104=!0,v.value={collectorId:(C=n.data)==null?void 0:C.id,provider:(b=n.data)==null?void 0:b.provider}):(l.saveModBus=!0,v.value={collectorId:(y=n.data)==null?void 0:y.id,provider:((I=n.data)==null?void 0:I.provider)||"MODBUS_TCP"})},ge=e=>{var t,a,o,i;(e==null?void 0:e.provider)==="OPC_UA"?l.saveOPCUA=!0:(e==null?void 0:e.provider)==="snap7"?l.saveS7=!0:(e==null?void 0:e.provider)==="iec104"?l.saveIEC104=!0:(e==null?void 0:e.provider)==="BACNetIp"?l.saveBACNet=!0:l.saveModBus=!0,v.value=q({...e,deviceType:((a=(t=n.data)==null?void 0:t.configuration)==null?void 0:a.type)||((i=(o=n.data)==null?void 0:o.configuration)==null?void 0:i.valueType)})},te=(e=void 0)=>{J.value=!0;const t=e?st(e).catch(()=>{}):ot(f.value).catch(()=>{});return t.then(a=>{var o;(a==null?void 0:a.status)===200&&(L(),(o=m.value)==null||o.reload(),R("操作成功","success")),J.value=!1}),t},ye=()=>{f.value=[],x.value=!1},ae=()=>{if(!f.value.length){R("至少选择一条数据","error");return}te()},ke=()=>{var a;if(!f.value.length){R("至少选择一条数据","error");return}const e=new Set(f.value),t=new Map;(a=m==null?void 0:m.value)==null||a._dataSource.forEach(o=>{e.has(o.id)&&t.set(o.id,o)}),v.value=[...t.values()],l.batchUpdate=!0},xe=()=>{var e,t;((e=n.data)==null?void 0:e.provider)==="OPC_UA"?l.scan=!0:((t=n.data)==null?void 0:t.provider)==="BACNetIp"&&(l.scanBacnet=!0),v.value=q(n.data)},be=()=>{l.import=!0,v.value=q(n.data)},Ie=async()=>{var a,o,i,C,b;const e=((a=n==null?void 0:n.data)==null?void 0:a.provider)==="COLLECTOR_GATEWAY"?(i=(o=n==null?void 0:n.data)==null?void 0:o.configuration)==null?void 0:i.collectorProvider:(C=n==null?void 0:n.data)==null?void 0:C.provider,t=await ct(n.data.collectorId,e);if(t){const y=new Blob([t],{type:"xlsx"}),I=URL.createObjectURL(y);Ve(I,`${(b=n==null?void 0:n.data)==null?void 0:b.channelName}点位数据`,"xlsx")}},Se=async e=>{l.writePoint=!0,v.value=q(e)},De=async e=>{var a;const t=await it(e==null?void 0:e.collectorId,[e==null?void 0:e.id]);if(t.status===200){const o=t.result[0],i=$.get(e==null?void 0:e.id);$.set(e==null?void 0:e.id,{...i,...o}),console.log("====",$.get(e.id)),L(),(a=m.value)==null||a.reload(),R("操作成功","success")}},ne=e=>{var a;const{quantity:t}=((a=e.configuration)==null?void 0:a.parameter)||"";return t?t+"(寄存器数量)":""},oe=e=>{var a;const{address:t}=((a=e.configuration)==null?void 0:a.parameter)||"";return t||t===0?t+"(地址)":""},se=e=>{var a,o;const{scaleFactor:t}=((o=(a=e.configuration)==null?void 0:a.codec)==null?void 0:o.configuration)||"";return t?t+"(缩放因子)":""},Be=e=>!!ne(e)||oe(e)||se(e),we=e=>((e==null?void 0:e.accessModes)||[]).map(t=>t==null?void 0:t.text).join(","),ce=e=>{const{interval:t}=e.configuration||"";return t?"采集频率"+t+"ms":""},ie=e=>{var t;return(t=e==null?void 0:e.accessModes)==null?void 0:t.map(a=>a==null?void 0:a.value)},Oe=e=>{const{parseData:t,dataType:a}=E.value.get(e.id);return`${qe(t)?t||0:t}(${a}) `},Ae=e=>{let t="--";if($.has(e.id)){const{parseData:a,dataType:o}=$.get(e.id);Je(a)?t=`${a}(${o||"-"}) `:t=a?`${a}(${o||"-"}) `:"--"}return t},D=e=>{var t;for(let a in l)l[a]=!1;v.value={},e&&((t=m.value)==null||t.reload(),R("操作成功","success"))},L=()=>{f.value=[]},Me=e=>{var t;if(U.value)if(f.value.includes(e.id)){const a=f.value.findIndex(o=>o===e.id);f.value.splice(a,1),x.value=!1}else f.value=[...f.value,e.id],f.value.length===((t=m.value)==null?void 0:t._dataSource.length)&&(x.value=!0)},$e=kt(e=>{E.value.set(e.pointId,e)}),Ue=e=>{var i,C,b,y,I,Y,F;const t=e.map(O=>O.id),a=`collector-${((i=n.data)==null?void 0:i.channelId)||"channel"}-${(C=n.data)!=null&&C.id||n.data&&n.data.id==="*"?"point":(b=n.data)==null?void 0:b.id}-data-${t.join("-")}`,o=`/collector/${((y=n.data)==null?void 0:y.channelId)||"*"}/${(I=n.data)!=null&&I.id||n.data&&n.data.id==="*"?"*":(Y=n.data)==null?void 0:Y.id}/data`;G.value=(F=Ge(a,o,{pointId:t.join(",")}))==null?void 0:F.pipe(xt(O=>O.payload)).subscribe(O=>{$e(O)})},Ee=e=>{var t;e.target.checked?f.value=[...(t=m.value)==null?void 0:t._dataSource.map(a=>a.id)]:(L(),x.value=!1)},Te=()=>{l.import=!1,m.value.reload()};W(()=>{var e;return(e=m==null?void 0:m.value)==null?void 0:e._dataSource},e=>{var t;(t=G.value)==null||t.unsubscribe(),e.length!==0&&setTimeout(()=>{Ue(e),e.forEach(a=>{var o;(o=a==null?void 0:a.accessModes)==null||o.forEach(i=>{(i==null?void 0:i.value)==="read"&&$.set(a.id,a)})})},100),L(),x.value=!1}),W(()=>f.value,e=>{e.length===0&&(x.value=!1)}),W(()=>n.data,e=>{var t,a,o,i,C;e&&(H.value=(e==null?void 0:e.provider)==="MODBUS_TCP"?Q:Q.concat({label:"订阅",value:"subscribe"}),Z.value.terms[0].terms[0].value=e.id?e.id==="*"?void 0:e.id:"undefined",(t=m==null?void 0:m.value)!=null&&t.reload&&((a=m==null?void 0:m.value)==null||a.reload()),x.value=!1,(o=K.value)==null||o.reload(),ee.value=((i=n==null?void 0:n.data)==null?void 0:i.provider)==="OPC_UA"||((C=n==null?void 0:n.data)==null?void 0:C.provider)==="BACNetIp"?[{key:"update",text:"批量编辑",permission:"DataCollect/Collector:update",icon:"FormOutlined",selected:{onClick:ke}},{key:"delete",text:"批量删除",danger:!0,permission:"DataCollect/Collector:delete",icon:"DeleteOutlined",selected:{popConfirm:{title:"确认删除？",onConfirm:ae}}}]:[{key:"delete",text:"批量删除",danger:!0,permission:"DataCollect/Collector:delete",icon:"DeleteOutlined",selected:{popConfirm:{title:"确认删除？",onConfirm:ae}}}])},{immediate:!0,deep:!0}),Le(()=>{var e;(e=G.value)==null||e.unsubscribe()});const Ne=e=>{z.value=e};return(e,t)=>{const a=V("pro-search"),o=V("AIcon"),i=We,C=ze,b=He,y=V("Ellipsis"),I=Ke,Y=Ze,F=Qe,O=V("FullPage"),Pe=Xe;return d(),_(Pe,{spinning:s(J)},{default:r(()=>[u(a,{columns:X,target:"search-point",onSearch:Ne}),u(O,null,{default:r(()=>[u(F,{height:"680"},{default:r(()=>[u(Y,{ref_key:"tableRef",ref:m,model:"CARD",columns:X,gridColumn:2,gridColumns:[1,2],request:s(tt),defaultParams:s(Z),rowSelection:s(U)?{selectedRowKeys:s(f),onSelectNone:()=>f.value=[]}:!1,params:s(z)},{headerTitle:r(()=>[u(C,null,{default:r(()=>{var c,N,P,T,A,re;return[["MODBUS_TCP","COLLECTOR_GATEWAY","snap7","iec104"].includes((c=k.data)==null?void 0:c.provider)?(d(),_(i,{key:0,type:"primary",onClick:Ce,hasPermission:"DataCollect/Collector:add"},{icon:r(()=>[u(o,{type:"PlusOutlined"})]),default:r(()=>[B(" 新增点位 ")]),_:1})):p("",!0),((N=k.data)==null?void 0:N.provider)==="OPC_UA"||((P=k.data)==null?void 0:P.provider)==="BACNetIp"?(d(),_(i,{key:1,type:"primary",onClick:xe,hasPermission:"DataCollect/Collector:add"},{icon:r(()=>[u(o,{type:"PlusOutlined"})]),default:r(()=>[B(" 扫描 ")]),_:1})):p("",!0),(T=k.data)!=null&&T.id&&k.data.id!=="*"?(d(),_(i,{key:2,type:"primary",onClick:be,hasPermission:"DataCollect/Collector:add"},{default:r(()=>[B(" 批量导入 ")]),_:1})):p("",!0),(A=k.data)!=null&&A.id&&k.data.id!=="*"?(d(),_(i,{key:3,type:"primary",onClick:Ie,hasPermission:"DataCollect/Collector:add"},{default:r(()=>[B(" 数据导出 ")]),_:1})):p("",!0),(re=k.data)!=null&&re.id&&k.data.id!=="*"?(d(),_(yt,{key:4,ref_key:"batchRef",ref:K,isCheck:s(U),"onUpdate:isCheck":t[0]||(t[0]=je=>de(U)?U.value=je:null),actions:s(ee),onChange:ye},null,8,["isCheck","actions"])):p("",!0)]}),_:1}),s(U)?(d(),w("div",bt,[u(b,{checked:s(x),"onUpdate:checked":t[1]||(t[1]=c=>de(x)?x.value=c:null),onChange:Ee},{default:r(()=>[B("全选")]),_:1},8,["checked"])])):p("",!0)]),card:r(c=>{var N,P;return[u(lt,{showStatus:!0,value:c,onClick:Me,active:s(f).includes(c.id),class:"card-box",status:(N=c==null?void 0:c.runningState)==null?void 0:N.value,statusText:(P=c==null?void 0:c.runningState)==null?void 0:P.text,statusNames:Object.fromEntries(s(_t).entries())},{title:r(()=>[Ye(e.$slots,"title",{},()=>[u(y,{style:{width:"calc(100% - 10px)"}},{default:r(()=>[h("div",It,S(c.name),1)]),_:2},1024)],!0)]),action:r(()=>[h("div",St,[u(i,{type:"text",tooltip:{title:"删除"},hasPermission:"DataCollect/Collector:delete",popConfirm:{title:"确认删除？",onConfirm:()=>te(c.id)}},{default:r(()=>[h("a",Dt,[u(o,{type:"DeleteOutlined"})])]),_:2},1032,["popConfirm"]),u(i,{type:"text",onClick:T=>ge(c),hasPermission:"DataCollect/Collector:update"},{default:r(()=>[h("a",Bt,[u(o,{type:"FormOutlined"})])]),_:2},1032,["onClick"])])]),img:r(()=>[h("img",{src:s(M).get(c.provider)},null,8,wt)]),content:r(()=>{var T;return[h("div",Ot,[h("div",At,[h("div",Mt,[s(E).has(c.id)?(d(),w("div",$t,[u(I,{style:{"max-width":"150px"}},{default:r(()=>[B(S(Oe(c)),1)]),_:2},1024)])):(d(),w("div",Ut,[u(I,{style:{"max-width":"150px"}},{default:r(()=>[B(S(Ae(c)),1)]),_:2},1024)])),ie(c).includes("write")?(d(),w("a",{key:2,onClick:ue(A=>Se(c),["stop"])},[u(o,{type:"EditOutlined"})],8,Et)):p("",!0),ie(c).includes("read")?(d(),w("a",{key:3,onClick:ue(A=>De(c),["stop"])},[u(o,{type:"RedoOutlined"})],8,Tt)):p("",!0)]),s(E).has(c.id)?(d(),w("div",Nt,[u(y,null,{default:r(()=>{var A;return[B(S(((A=s(E).get(c.id))==null?void 0:A.hex)||""),1)]}),_:2},1024),h("p",null,S(s(Fe)((T=s(E).get(c.id))==null?void 0:T.timestamp).format("YYYY-MM-DD HH:mm:ss")),1)])):p("",!0)]),h("div",Pt,[u(y,{style:{width:"calc(100% - 10px)","margin-bottom":"10px"}},{default:r(()=>[Be(c)?(d(),w("div",jt,[h("span",null,S(ne(c)),1),h("span",null,S(oe(c)),1),h("span",null,S(se(c)),1)])):p("",!0)]),_:2},1024),u(y,{style:{width:"calc(100% - 10px)","margin-bottom":"10px"}},{default:r(()=>[h("div",Rt,[h("span",null,S(we(c)),1),ce(c)?(d(),w("span",Lt,S(ce(c)),1)):p("",!0)])]),_:2},1024)])])]}),_:2},1032,["value","active","status","statusText","statusNames"])]}),_:3},8,["request","defaultParams","rowSelection","params"])]),_:3})]),_:3}),s(l).saveModBus?(d(),_(ut,{key:0,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).saveOPCUA?(d(),_(pt,{key:1,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).writePoint?(d(),_(rt,{key:2,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).batchUpdate?(d(),_(dt,{key:3,data:s(v),provider:k.data.provider,onChange:D},null,8,["data","provider"])):p("",!0),s(l).saveS7?(d(),_(ht,{key:4,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).saveIEC104?(d(),_(Ct,{key:5,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).saveBACNet?(d(),_(ft,{key:6,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).scan?(d(),_(mt,{key:7,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).scanBacnet?(d(),_(vt,{key:8,data:s(v),onChange:D},null,8,["data"])):p("",!0),s(l).import?(d(),_(gt,{key:9,data:s(v),onCloseImport:Te},null,8,["data"])):p("",!0)]),_:3},8,["spinning"])}}});const Ua=et(Ft,[["__scopeId","data-v-d07d59be"]]);export{Ua as default};
