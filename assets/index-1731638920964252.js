import{gf as G,U as H,gn as X,i as Z,Y as $,a4 as D,o as T,dg as Q,y as W,aI as ee,d as ne,Z as te,aa as se,g as oe}from"./index-1731638920964.js";import"./index-1731638920964288.js";import"./index-1731638920964281.js";import{e as re,f as N}from"./initHome-1731638920964.js";import{U as P,B as ce}from"./baseMenu-1731638920964.js";import{g as ae}from"./channel-1731638920964.js";import{u as b}from"./unionBy-1731638920964.js";import{d as O,k as C,o as le,ab as K,U as B,V as L,X as y,f as g,_ as w,u as S,$ as de,Y as ie,E as k,af as ue,ag as pe}from"./vue-1731638920964.js";const fe=s=>{const e=[],n=i=>{i.forEach(t=>{var a;t.title=t.code,t.key=t.code,((a=t==null?void 0:t.options)==null?void 0:a.show)===!1||e.push(t.code),t!=null&&t.children&&n(t==null?void 0:t.children)})};return n(s),{checkedKeys:e}},U=(s,e)=>{const n={parents:[],children:[]};function i(a){if(a.code===e)return a.children&&(n.children=a.children.flatMap(c=>c.children?[c.code,...t(c.children)]:[c.code])),!0;if(a.children){for(let c of a.children)if(i(c))return n.parents.push(a.code),!0}return!1}function t(a){return a.flatMap(c=>c.children?[c.code,...t(c.children)]:[c.code])}for(let a of s)if(i(a))break;return n},he=(s,e,n)=>{const{node:i,selected:t}=e,{parents:a,children:c}=U(n,i.code),h=new Set(s);return(t?[...a,...c]:[...c]).forEach(l=>{h[t?"add":"delete"](l)}),[...h]},_e=(s,e)=>{const n=s.node.key,i=s.dragNode.key,t=s.node.pos.split("-"),a=s.dropPosition-Number(t[t.length-1]),c=(l,_,x)=>{l.forEach((v,E)=>{if(v.key===_)return x(v,E,l);if(v.children)return c(v.children,_,x)})},h=[...e];let m;if(c(h,i,(l,_,x)=>{x.splice(_,1),m=l}),!s.dropToGap)c(h,n,l=>{l.children=l.children||[],l.children.unshift(m)});else if((s.node.children||[]).length>0&&s.node.expanded&&a===1)c(h,n,l=>{l.children=l.children||[],l.children.unshift(m)});else{let l=[],_=0;c(h,n,(x,v,E)=>{l=E,_=v}),a===-1?l.splice(_,0,m):l.splice(_+1,0,m)}return h},ve=s=>{let e=0;return s.forEach(n=>{const i=j(n);i>e&&(e=i)}),e},j=s=>{let e=1;return s.children&&s.children.forEach(n=>{const i=j(n)+1;i>e&&(e=i)}),e},R=s=>s?s.map((e,n)=>(e.index!==n&&(e.sortIndex=n+1,e.children&&(e.children=R(e.children).sort((i,t)=>i.sortIndex-t.sortIndex))),e)):[],V=s=>s?s.sort((e,n)=>e.sortIndex-n.sortIndex).map(e=>(e.children&&(e.children=V(e.children)),e)):[],ye=s=>(ue("data-v-cc7a2769"),s=s(),pe(),s),ge={class:"top"},me=ye(()=>w("span",null,"单击可切换菜单未选中/选中状态；操作父级菜单时，对应子菜单状态将默认与其同步，可以单独操作调整；支持拖拽菜单调整展示顺序。 ",-1)),xe={class:"content"},Ce={class:"tree"},we={class:"tree-content"},De={class:"tree-content-title"},Ee={style:{"margin-left":"8px"}},Se=O({name:"MenuSetting"}),Me=O({...Se,setup(s){const e=C([]),n=C([]),i=C([]);C([]);const t=C(!1),a=C(!1),c=C(!1),h={paging:!1,terms:[{terms:[{column:"owner",termType:"eq",value:"iot"},{column:"owner",termType:"isnull",value:"1",type:"or"}]}]};(async()=>{if(Z){const p=await ae();$.filter(o=>{var d;return(d=p.result)==null?void 0:d.find(u=>o.alias==u.id)})}else return})();const l=(p,o,d)=>{const u=[];for(let f=0;f<p.length;f++){const r=p[f];r.code&&(r.parentId=d&&void 0,r!=null&&r.options?r.options.show=!1:r.options={show:!1},o.indexOf(r.code)!==-1?(r.options.show=!0,r.children&&(r.children=l(r.children,o,r.id))):r.children?(r.children=l(r.children,o,r.id),r.children.filter(M=>{M.options.show}).length>0&&(r.options.show=!0)):r.options.show=!1,u.push(r))}return u},_=async()=>{const p=l(D(n.value),e.value),o=R(p);a.value=!0,o.push(P);const d=await N(o).catch(()=>{});(d==null?void 0:d.status)===200&&(a.value=!1,t.value=!1,T("操作成功","success"),setTimeout(()=>{location.reload()},100))},x=()=>{t.value=!1},v=(p,o)=>{e.value=he(p,o,D(n.value))},E=p=>{const o=D(n.value),d=_e(p,n.value);ve(d)>3?(T("仅支持3级菜单","error"),c.value=!1,n.value=o):(c.value=!0,n.value=d)},J=p=>{const{node:o}=p,{children:d}=U(D(n.value),o.code),u=[o.code,...d],f=new Set(D(e.value));u.forEach(r=>{f.has(r)&&f.delete(r)}),c.value&&(e.value=[...f])},z=async()=>{const p=I(D(i.value),ce);p.push(P);const o=await N(p).catch(()=>{});(o==null?void 0:o.status)===200&&(T("操作成功","success"),location.reload())},I=(p,o)=>{const d=p.map(u=>(o.find(f=>{u.id===f.id&&(u.buttons=b(u.buttons,f.buttons,"id"),u.permissions=b(u.permissions,f.permissions,"permission"),f.children&&u.children&&(u.children=I(u.children,f.children)))}),u));return b(d,o,"code")};return le(()=>{re().then(p=>{G(h).then(o=>{var d;if(o.status==200){i.value=(d=o.result)==null?void 0:d.filter(f=>![H,X].includes(f.code));const u=fe(i.value);e.value=u.checkedKeys,n.value=V(i.value)}})})}),(p,o)=>{const d=K("AIcon"),u=Q,f=W,r=ee,A=ne,M=te,F=se,Y=K("page-container");return B(),L(Y,null,{default:y(()=>[g(r,null,{default:y(()=>[w("div",ge,[g(d,{style:{padding:"12px"},type:"ExclamationCircleOutlined"}),me]),w("div",xe,[g(r,{title:"菜单配置",style:{width:"80%"}},{default:y(()=>[w("div",Ce,[g(f,null,{default:y(()=>[S(n).length!==0?(B(),L(u,{key:0,defaultExpandAll:"",multiple:"",draggable:"","tree-data":S(n),onSelect:v,selectedKeys:S(e),onDrop:E,onDragend:J},{title:y(q=>[w("div",we,[w("div",De,[g(d,{type:"HolderOutlined"}),w("div",Ee,de(q.name),1)])])]),_:1},8,["tree-data","selectedKeys"])):ie("",!0)]),_:1})])]),_:1})]),g(A,{type:"primary",onClick:o[0]||(o[0]=()=>t.value=!0),style:{"margin-left":"10%"}},{default:y(()=>[k("保存")]),_:1}),g(M,{type:"primary",popConfirm:{title:"确认同步系统菜单权限？",okText:" 确定",cancelText:"取消",onConfirm:z},style:{"margin-left":"20px"}},{default:y(()=>[k("同步系统菜单权限 ")]),_:1},8,["popConfirm"])]),_:1}),g(F,{modalType:"message",visible:S(t),confirmLoading:S(a),onOk:_,onCancel:x},{default:y(()=>[k(" 保存后当前系统菜单数据将被覆盖，确认操作？ ")]),_:1},8,["visible","confirmLoading"])]),_:1})}}});const Be=oe(Me,[["__scopeId","data-v-cc7a2769"]]);export{Be as default};
