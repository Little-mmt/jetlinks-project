import{a4 as X,$ as Y,an as Z,ao as H,I as j,v as ee,F as ne,d as te,e as ae,aa as oe,o as k,g as re}from"./index-1731638920964.js";import"./index-1731638920964286.js";import ie from"./NotifyWay-17316389209642.js";import le from"./NotifyConfig-17316389209642.js";import se from"./NotifyTemplate-17316389209642.js";import{_ as ue}from"./VariableDefinitions.vue_vue_type_script_setup_true_lang-17316389209642.js";import ce from"./index-1731638920964257.js";import{T as pe}from"./template-1731638920964.js";import{v as fe}from"./data-17316389209647.js";import{d as de,k as I,r as me,e as O,s as ve,ab as _e,U as o,V as p,X as i,f,u as t,E as _,_ as g,Z as y,F as $,a1 as ge,$ as h,Y as d,G as ye,af as he,ag as Ce}from"./vue-1731638920964.js";import"./noticeRule-1731638920964.js";import"./index-1731638920964278.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import"./index-1731638920964282.js";import"./index-1731638920964283.js";import"./config-17316389209642.js";import"./const-17316389209642.js";import"./BuildIn.vue_vue_type_script_setup_true_name_NotifyBuildIn_lang-17316389209642.js";import"./Tag.vue_vue_type_script_setup_true_lang-17316389209642.js";import"./InputFile.vue_vue_type_script_setup_true_lang-17316389209642.js";const ke=m=>(he("data-v-4d139846"),m=m(),Ce(),m),Ie={style:{"background-color":"#f8f9fc",padding:"25px 100px"}},Se=ke(()=>g("br",null,null,-1)),Te={key:0},xe={key:1},be={key:2},Pe={style:{margin:"20px"}},we={class:"alert"},Ne={key:5},Ve={class:"alert"},De={style:{margin:"50px 200px"}},Be=de({__name:"index",props:{data:{type:Object,default:()=>{}},loading:{type:Boolean,default:!1},provider:{type:String,default:""},name:{type:String,default:""}},emits:["close","save"],setup(m,{emit:P}){const w=m,D=["选择通知方式","选择通知配置","选择通知模板","配置模板变量","配置用户权限","完成"],r=I(0),S=I([]),n=me({name:"",channelProvider:"",grant:{permissions:[],role:{}},channelConfiguration:{}}),N=I(),B=I(),C=I("钉钉"),F=O(()=>{var e;return["notifier-dingTalk"].includes((e=w.data)==null?void 0:e.channelProvider)?["user","tag"]:["user","org","tag"]}),V=O(()=>S.value.filter(e=>{var s;const a=((s=e.expands)==null?void 0:s.businessType)||e.type||"";return!["user","org","tag"].includes(a)})),L=e=>{const a=S.value.filter(l=>{var T;const v=((T=l.expands)==null?void 0:T.businessType)||l.type||"";return F.value.includes(v)}).map(l=>l==null?void 0:l.id),s=fe.get(n.channelProvider),u={};[...new Set([...a,s]).values()].map(l=>{u[l]={source:"relation",relation:{objectType:"user",objectSource:{source:"upper",upperKey:"subscriber"}}}}),n.channelConfiguration.variables={...u,...e}},R=async e=>{var a,s;if(e>=1&&!n.channelProvider){k("请选择通知方式","error");return}if(e>=2&&!n.channelConfiguration.notifierId){k("请选择通知配置","error");return}if(e>=3)if(n.channelConfiguration.templateId){const u=await pe.getTemplateDetail(n.channelConfiguration.templateId);u.status===200&&(S.value=((a=u.result)==null?void 0:a.variableDefinitions)||[])}else{k("请选择通知模板","error");return}if(e>=4&&S.value.length)if(V.value.length){if(N.value){const u=await((s=N.value)==null?void 0:s.onSave());if(u)L(u);else{k("请配置模版变量","error");return}}else if(!V.value.every(l=>{const v=n.channelConfiguration.variables[l.id];return v?v.source==="fixed"?v.value!==void 0:v.source==="upper"?v.upperKey!==void 0:!0:!1})){k("请配置模版变量","error");return}}else L({});r.value=e},J=e=>{n.channelProvider!==e.value&&(n.channelConfiguration.notifierId="",n.channelConfiguration.templateId="",n.channelConfiguration.variables={}),n.channelProvider=e==null?void 0:e.value},M=e=>{var a;((a=n.channelConfiguration)==null?void 0:a.notifierId)!==(e==null?void 0:e.value)&&(n.channelConfiguration.templateId="",n.channelConfiguration.variables={}),n.channelConfiguration.notifierId=e==null?void 0:e.value},U=e=>{var a;((a=n.channelConfiguration)==null?void 0:a.templateId)!==(e==null?void 0:e.value)&&(n.channelConfiguration.variables={}),n.channelConfiguration.templateId=e==null?void 0:e.value};ve(()=>{Object.assign(n,X(w.data))});const E=()=>{r.value-=1},q=()=>{R(r.value+1)},A=e=>{R(e)},K=async()=>{var e;await((e=B.value)==null?void 0:e.validate()),n.grant.permissions=w.provider==="alarm"?[{id:"alarm-config",actions:["query"]}]:[],P("save",n)};return(e,a)=>{const s=_e("AIcon"),u=Y,l=Z,v=H,T=j,W=ee,z=ne,x=te,G=ae,Q=oe;return o(),p(Q,{width:1056,visible:"",title:"配置通知方式",onCancel:a[4]||(a[4]=c=>P("close")),bodyStyle:{padding:0},maskClosable:!1},{footer:i(()=>[f(G,null,{default:i(()=>[t(r)===0?(o(),p(x,{key:0,onClick:a[3]||(a[3]=c=>P("close"))},{default:i(()=>[_("取消")]),_:1})):(o(),p(x,{key:1,onClick:E},{default:i(()=>[_("上一步")]),_:1})),t(r)!==D.length-1?(o(),p(x,{key:2,type:"primary",onClick:q},{default:i(()=>[_("下一步")]),_:1})):(o(),p(x,{key:3,loading:m.loading,type:"primary",onClick:K},{default:i(()=>[_("确认")]),_:1},8,["loading"]))]),_:1})]),default:i(()=>[g("div",Ie,[f(v,{current:t(r),size:"small",onChange:A},{default:i(()=>[(o(),y($,null,ge(D,(c,b)=>f(l,{key:c},{title:i(()=>[_(h(c),1),b===4?(o(),p(u,{key:0},{title:i(()=>[g("span",null,[_(" 通过角色控制【"+h(m.name)+"】下的【"+h(t(C))+"通知】可被哪些用户订阅。",1),Se,_(" 注意：当前配置会被外层【"+h(m.name)+"】中的权限控制覆盖。 ",1)])]),default:i(()=>[f(s,{type:"QuestionCircleOutlined"})]),_:1})):d("",!0)]),description:i(()=>[t(r)===b?(o(),y("span",Te,"进行中")):d("",!0),t(r)<b?(o(),y("span",xe,"未开始")):d("",!0),t(r)>b?(o(),y("span",be,"已完成")):d("",!0)]),_:2},1024)),64))]),_:1},8,["current"])]),g("div",Pe,[t(r)===0?(o(),p(ie,{key:0,value:t(n).channelProvider,name:t(C),"onUpdate:name":a[0]||(a[0]=c=>ye(C)?C.value=c:null),onChange:J},null,8,["value","name"])):d("",!0),t(r)===1?(o(),p(le,{key:1,value:t(n).channelConfiguration.notifierId,notifyType:t(n).channelProvider,onChange:M},null,8,["value","notifyType"])):d("",!0),t(r)===2?(o(),p(se,{key:2,value:t(n).channelConfiguration.templateId,notifyType:t(n).channelProvider,notifierId:t(n).channelConfiguration.notifierId,onChange:U},null,8,["value","notifyType","notifierId"])):d("",!0),t(r)===3?(o(),p(ue,{key:3,variableDefinitions:t(V),value:t(n).channelConfiguration.variables,notify:t(n),ref_key:"variableRef",ref:N},null,8,["variableDefinitions","value","notify"])):d("",!0),t(r)===4?(o(),y($,{key:4},[g("div",we,[f(s,{type:"InfoCircleOutlined"}),_(" 通过角色控制哪些用户可以订阅从【"+h(m.name)+"】接收到【"+h(t(C))+"】通知 ",1)]),f(ce,{type:"add",modelValue:t(n).grant.role.idList,"onUpdate:modelValue":a[1]||(a[1]=c=>t(n).grant.role.idList=c)},null,8,["modelValue"])],64)):d("",!0),t(r)===5?(o(),y("div",Ne,[g("div",Ve,[f(s,{type:"InfoCircleOutlined"}),_(" 被分配了接收权限的用户将根据名称判断是否订阅该通知 ")]),g("div",De,[f(z,{ref_key:"formRef",ref:B,model:t(n),layout:"vertical"},{default:i(()=>[f(W,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"},{max:8,message:"最多可输入8个字符"}]},{default:i(()=>[f(T,{value:t(n).name,"onUpdate:value":a[2]||(a[2]=c=>t(n).name=c),placeholder:"请输入名称"},null,8,["value"])]),_:1})]),_:1},8,["model"])])])):d("",!0)])]),_:1})}}});const nn=re(Be,[["__scopeId","data-v-4d139846"]]);export{nn as default};
