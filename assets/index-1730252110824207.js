import{X as W,h as k,au as L,a0 as G,a1 as K,Z as Q,a2 as P,a3 as ee,g as te}from"./index-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import{g as ae,f as le,i as ne}from"./log-17302521108243.js";import{a as oe}from"./alarm-1730252110824.js";import{d as se,k as x,ai as re,e as ie,o as ce,ab as h,U as w,Z as ue,f as n,u as i,X as o,W as de,_ as s,$ as _,E as me,V as N,Y as M,af as pe,ag as ve}from"./vue-1730252110824.js";import{_ as _e}from"./index.vue_vue_type_script_setup_true_lang-17302521108247.js";import ge from"./DetailDrawer-1730252110824.js";import ye from"./Duration-1730252110824.js";import{u as fe}from"./useAlarmLevel-1730252110824.js";import"./index-1730252110824299.js";import"./Record-17302521108242.js";import"./Log-1730252110824.js";import"./LogDetail-1730252110824.js";import"./index-1730252110824284.js";import"./vue-json-viewer-1730252110824.js";import"./useRequest-1730252110824.js";import"./config-1730252110824.js";const C=g=>(pe("data-v-d9535f37"),g=g(),ve(),g),he={class:"alarm-log-card"},Te=["src"],ke={class:"alarmTitle"},xe={class:"alarmName"},we={style:{"font-weight":"500","font-size":"16px"}},Ce={style:{display:"flex","max-width":"50%"}},Ie=C(()=>s("div",{class:"content-title"},"告警维度",-1)),be=C(()=>s("div",{class:"content-title"}," 最近告警时间 ",-1)),Ne=C(()=>s("div",{class:"content-title"}," 告警持续时长 ",-1)),Me=C(()=>s("div",{class:"content-title"},"告警原因",-1)),Se=se({__name:"index",props:{type:{},id:{}},setup(g){const l=g,S=W(),I=x(),{levelMap:D,levelList:V}=fe(),Y=oe(),{data:v}=re(Y),A=x(),b=x(!1),y=new Map;y.set("product",k("/alarm/product.png")),y.set("device",k("/alarm/device.png")),y.set("other",k("/alarm/other.png")),y.set("org",k("/alarm/org.png"));const f=new Map;f.set("product","产品"),f.set("device","设备"),f.set("other","其他"),f.set("org","组织");const T=[{title:"配置名称",dataIndex:"alarmName",key:"alarmName"},{title:"类型",dataIndex:"targetType",key:"targetType",scopedSlots:!0},{title:"关联场景联动",dataIndex:"sourceName",key:"sourceName"},{title:"告警级别",dataIndex:"level",key:"level",width:200,search:{type:"select",options:async()=>V.value},scopedSlots:!0},{title:"最近告警时间",dataIndex:"alarmTime",key:"alarmTime",search:{type:"date"},scopedSlots:!0},{title:"状态",dataIndex:"state",key:"state",search:{type:"select",options:[{label:"告警中",value:"warning"},{label:"无告警",value:"normal"}]},scopedSlots:!0},{title:"操作",dateIndex:"actions",key:"actions",scopedSlots:!0,width:200}],E=ie(()=>{const t={title:"产品名称",dataIndex:"targetName",key:"targetName",search:{type:"string"}};switch(l.type){case"device":t.title="设备名称";break;case"org":t.title="组织名称";break;case"other":t.title="场景名称";break}return l.type==="device"?[t,{title:"产品名称",dataIndex:"product_id",key:"product_id",search:{type:"select",options:async()=>{const a=await ae({paging:!1,sorts:[{name:"alarmTime",order:"desc"}],terms:[{column:"id$alarm-record",value:[{column:"targetType",termType:"eq",value:"device"}]}]}),m=new Map;return a.status===200?(a.result.forEach(r=>{r.productId&&m.set(r.productId,{label:r.productName,value:r.productId})}),[...m.values()]):[]}}},...T]:["all","detail"].includes(l.type)?T:[t,...T]});let u=x({sorts:[{name:"alarmTime",order:"desc"}],terms:[]});const R=async t=>{const d=await le(t);if(d.status===200){const p=await ne();if(p.status===200)return d.result.data.map(a=>{a.targetType==="org"&&p.result.forEach(m=>{m.id===a.targetId&&(a.targetName=m.name),a.targetId===a.targetName&&(a.targetName="无")})}),d}},q=t=>{u.value.terms=[...t==null?void 0:t.terms],l.type!=="all"&&!l.id&&u.value.terms.push({termType:"eq",column:"targetType",value:l.type,type:"and"}),l.type==="device"&&(t==null||t.terms.forEach((d,p)=>{d.terms.forEach((a,m)=>{var r;a.column==="product_id"&&(u.value.terms[p].terms[m]={column:"targetId$dev-instance",value:[(r=t==null?void 0:t.terms[0])==null?void 0:r.terms[0]]})})})),l.id&&u.value.terms.push({termType:"eq",column:"alarmConfigId",value:l.id,type:"and"})},B=(t,d)=>{var a;return t?[{key:"solve",text:"告警处理",tooltip:{title:((a=t.state)==null?void 0:a.value)==="normal"?"无告警":"告警处理"},icon:"ToolOutlined",onClick:()=>{v.value.current=t,v.value.solveVisible=!0}},{key:"log",text:"告警日志",tooltip:{title:"告警日志"},icon:"FileOutlined",onClick:()=>{S.jumpPage("rule-engine/Alarm/Log/Detail",{id:t.id})}},{key:"detail",text:"处理记录",tooltip:{title:"处理记录"},icon:"FileTextOutlined",onClick:()=>{S.jumpPage("rule-engine/Alarm/Log/Record",{},{id:t.id})}}]:[]},$=()=>{v.value.solveVisible=!1},j=()=>{v.value.solveVisible=!1,I.value.reload(u.value)},F=()=>{I.value.reload(u.value)},H=t=>{t.targetType==="device"&&(A.value=t,b.value=!0)};return ce(()=>{l.type!=="all"&&!l.id&&(u.value.terms=[{termType:"eq",column:"targetType",value:l.type,type:"and"}]),l.id&&(u.value.terms=[{termType:"eq",column:"alarmConfigId",value:l.id,type:"and"}]),l.type==="all"&&(u.value.terms=[])}),(t,d)=>{const p=h("pro-search"),a=h("Ellipsis"),m=h("LevelIcon"),r=G,J=K,O=h("AIcon"),X=Q,Z=P,z=ee,U=h("FullPage");return w(),ue("div",he,[n(p,{columns:i(E),target:`alarm-log-${l.type}`,onSearch:q},null,8,["columns","target"]),n(U,null,{default:o(()=>[n(z,{columns:T,request:R,params:i(u),gridColumns:[1,1,1],gridColumn:1,model:"CARD",ref_key:"tableRef",ref:I},{card:o(e=>[n(Z,de({value:e},e,{actions:B(e,"card"),status:e.state.value,statusNames:{warning:"error",normal:"default"},statusText:e.state.text,onClick:()=>H(e)}),{img:o(()=>[s("img",{src:i(y).get(e.targetType),alt:""},null,8,Te)]),content:o(()=>[s("div",ke,[s("div",xe,[n(a,{style:{width:"100%"}},{default:o(()=>[s("span",we,_(e.alarmName),1)]),_:2},1024)]),s("div",Ce,[n(m,{level:e.level},null,8,["level"]),n(a,null,{default:o(()=>[me(_(i(D)[e.level]),1)]),_:2},1024)])]),n(J,{gutter:24},{default:o(()=>[n(r,{span:l.type==="device"||e.targetType==="device"?6:8,class:"content-left"},{default:o(()=>[Ie,n(a,null,{default:o(()=>[s("div",null,_(e==null?void 0:e.targetName),1)]),_:2},1024)]),_:2},1032,["span"]),n(r,{span:l.type==="device"||e.targetType==="device"?6:8},{default:o(()=>[be,n(a,null,{default:o(()=>{var c;return[s("div",null,_(i(L)(e==null?void 0:e.alarmTime).format("YYYY-MM-DD HH:mm:ss")+"至"+(((c=e==null?void 0:e.state)==null?void 0:c.value)==="warning"?"当前时间":i(L)(e==null?void 0:e.handleTime).format("YYYY-MM-DD HH:mm:ss"))),1)]}),_:2},1024)]),_:2},1032,["span"]),n(r,{span:l.type==="device"||e.targetType==="device"?6:8},{default:o(()=>[Ne,n(a,null,{default:o(()=>[n(ye,{data:e},null,8,["data"])]),_:2},1024)]),_:2},1032,["span"]),l.type==="device"||e.targetType==="device"?(w(),N(r,{key:0,span:6},{default:o(()=>[Me,n(a,null,{default:o(()=>[s("div",null,_((e==null?void 0:e.actualDesc)||"--"),1)]),_:2},1024)]),_:2},1024)):M("",!0)]),_:2},1024)]),actions:o(c=>[n(X,{disabled:c.key==="solve"&&e.state.value==="normal",tooltip:{...c.tooltip},onClick:c.onClick,hasPermission:c.key=="solve"?"rule-engine/Alarm/Log:action":"rule-engine/Alarm/Log:view"},{default:o(()=>[n(O,{type:c.icon},null,8,["type"]),s("span",null,_(c==null?void 0:c.text),1)]),_:2},1032,["disabled","tooltip","onClick","hasPermission"])]),_:2},1040,["value","actions","status","statusText","onClick"])]),_:1},8,["params"])]),_:1}),i(v).solveVisible?(w(),N(_e,{key:0,data:i(v).current,onCloseSolve:$,onRefresh:j},null,8,["data"])):M("",!0),i(b)?(w(),N(ge,{key:1,logData:i(A),typeMap:i(f),levelMap:i(D),onCloseDrawer:d[0]||(d[0]=e=>b.value=!1),onRefreshTable:F},null,8,["logData","typeMap","levelMap"])):M("",!0)])}}});const Qe=te(Se,[["__scopeId","data-v-d9535f37"]]);export{Qe as default};
