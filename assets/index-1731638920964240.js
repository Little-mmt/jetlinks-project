import{cv as $,o as L,Z as v,h as Y,au as z,d as H,aL as Z,aM as W,aN as X,e as G,a0 as Q,a1 as ee,a2 as te,ax as se,a3 as ie,g as ne}from"./index-1731638920964.js";import"./index-1731638920964278.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import"./index-1731638920964282.js";import"./index-1731638920964283.js";import oe from"./AddDeviceOrProductDialog-1731638920964.js";import ae from"./EditPermissionDialog-1731638920964.js";import{i as le,b as re,j as ce,c as de,k as pe,l as ue}from"./department-17316389209642.js";import{u as me}from"./department-1731638920964.js";import{d as O,k as P,w as _e,q as fe,r as ye,s as ge,ab as R,U as x,Z as A,f as a,X as n,u as m,E as b,W as he,R as ve,_ as f,$ as I,F as we,a1 as ke,V as T,Y as j,af as Se,ag as xe}from"./vue-1731638920964.js";import"./index-1731638920964291.js";const N=w=>(Se("data-v-263103d8"),w=w(),xe(),w),be={class:"product-container"},Ie=["src"],Ce={class:"card-item-content-title",style:{"margin-bottom":"18px"}},Pe=N(()=>f("div",{class:"card-item-content-text"},"ID",-1)),Re={style:{cursor:"pointer"},class:"card-item-content-value"},De=N(()=>f("div",{class:"card-item-content-text"}," 资产权限 ",-1)),Le={style:{cursor:"pointer"},class:"card-item-content-value"},Te={class:"dialogs"},Be=O({name:"device"}),Ee=O({...Be,props:{parentId:{},bindBool:{type:Boolean}},emits:["update:bindBool"],setup(w,{emit:q}){const _=w,U=me(),y="system/Department",D=[{title:"ID",dataIndex:"id",key:"id",ellipsis:!0,fixed:"left",search:{type:"string"}},{title:"名称",dataIndex:"name",key:"name",ellipsis:!0,search:{type:"string",first:!0}},{title:"所属产品",dataIndex:"productName",key:"productName",ellipsis:!0,search:{rename:"productId$product-info",type:"select",handleValue(t,s){return t&&t.length?[{column:"id",termType:(s==null?void 0:s.termType)==="not"?"nin":"in",value:`${t.toString()}`}]:void 0},options:()=>new Promise(t=>{ue({paging:!1,"sorts[0].name":"createTime","sorts[0].order":"desc"}).then(l=>{const i=l.result.map(r=>({label:r.name,value:r.id}));t(i)})})}},{title:"资产权限",dataIndex:"permission",key:"permission",ellipsis:!0,width:300,scopedSlots:!0},{title:"注册时间",dataIndex:"registryTime",key:"registryTime",ellipsis:!0,scopedSlots:!0,search:{type:"date"}},{title:"状态",dataIndex:"state",key:"state",ellipsis:!0,search:{type:"select",options:[{label:"禁用",value:"notActive"},{label:"离线",value:"offline"},{label:"在线",value:"online"}]},scopedSlots:!0,width:80},{title:"操作",dataIndex:"action",key:"action",fixed:"right",width:150,scopedSlots:!0}],B=P({}),E=P(),e={_selectedRowKeys:P([]),selectedRows:[],permissionList:P([]),defaultPermission:[],init:()=>{e.getPermissionDict(),_e(()=>_.parentId,()=>{e.refresh()})},getActions:(t,s)=>t?[{permission:`${y}:assert`,key:"edit",tooltip:{title:"编辑"},icon:"EditOutlined",onClick:()=>e.clickEdit(t)},{permission:`${y}:bind`,key:"unbind",tooltip:{title:"解除绑定"},popConfirm:{title:"确认解除绑定？",onConfirm:()=>e.clickUnBind(t)},icon:"DisconnectOutlined"}]:[],getPermissionDict:()=>{le().then(t=>{e.permissionList.value=t.result})},getPermissLabel:t=>{const s=e.permissionList.value;return s.length<1||t.length<1?"":t.map(i=>{var r;return(r=s.find(c=>c.id===i))==null?void 0:r.name}).join(",")},onSelectChange:t=>{const s=e._selectedRowKeys.value,l=s.indexOf(t.id);l===-1?(s.push(t.id),e.selectedRows.push(t)):(s.splice(l,1),e.selectedRows.splice(l,1))},cancelSelect:()=>{e._selectedRowKeys.value=[],e.selectedRows=[]},onSelect:(t,s)=>{const i=[...e._selectedRowKeys.value].findIndex(r=>r===(t==null?void 0:t.id));s?i>-1||(e._selectedRowKeys.value.push(t.id),e.selectedRows.push(t)):i>-1&&(e._selectedRowKeys.value.splice(i,1),e.selectedRows.splice(i,1))},onSelectAll:(t,s,l)=>{if(t)l.map(i=>{e._selectedRowKeys.value.includes(i.id)||(e._selectedRowKeys.value.push(i.id),e.selectedRows.push(i))});else{const i=l.map(u=>u.id),r=[],c=[];[...e.selectedRows].map(u=>{i.includes(u==null?void 0:u.id)||(r.push(u),c.push(u.id))}),e._selectedRowKeys.value=c,e.selectedRows=r}},getData:(t,s)=>new Promise(l=>{re(t).then(i=>{const{pageIndex:r,pageSize:c,total:u,data:k}=i.result,C=k.map(h=>h.id);ce("device",C,s).then(h=>{const S={};h.result.forEach(g=>{S[g.assetId]=g.grantedPermissions}),k.forEach(g=>g.permission=S[g.id]),l({code:200,result:{data:k,pageIndex:r,pageSize:c,total:u},status:200})})})}),requestFun:async t=>{if(_.parentId){const s={...t,sorts:[{name:"createTime",order:"desc"}],terms:[...t.terms,{column:"id",termType:"dim-assets",value:{assetType:"device",targets:[{type:"org",id:_.parentId}]}}]},l=await e.getData(s,_.parentId);return{code:l.status,result:l.result,status:l.status}}else return{code:200,result:{data:[],pageIndex:0,pageSize:0,total:0},status:200}},clickAdd:t=>{U.setType(t),p.addShow=!0},queryPermissionList:async t=>{const s=await de("device",t);if(s.status===200){const l=s.result.map(i=>{var r;return(r=i==null?void 0:i.permissionInfoList)==null?void 0:r.map(c=>c==null?void 0:c.id)});return $(...l)}return[]},clickEdit:async t=>{const s=t?[t.id]:[...e._selectedRowKeys.value];if(s.length<1)return L("请勾选需要编辑的数据","warning");e.defaultPermission=t?t==null?void 0:t.permission:$(...e.selectedRows.map(i=>i.permission));const l=await e.queryPermissionList(s);p.selectIds=s,p.permissList=l,p.editShow=!0},clickUnBind:t=>{const s=t?[t.id]:[...e._selectedRowKeys.value];if(s.length<1)return L("请勾选需要解绑的数据","warning");const l=[{targetType:"org",targetId:_.parentId,assetType:"device",assetIdList:s}],i=pe("device",l);return i.then(()=>{L("操作成功"),e.refresh()}),i},refresh:()=>{fe(()=>{E.value.reload(),e.cancelSelect()})}},p=ye({selectIds:[],permissList:[],addShow:!1,editShow:!1});return e.init(),ge(()=>{_.bindBool&&e.clickAdd(),q("update:bindBool",!1)}),(t,s)=>{const l=R("pro-search"),i=R("AIcon"),r=H,c=Z,u=W,k=X,C=G,h=R("Ellipsis"),S=Q,g=ee,F=te,V=se,J=ie,M=R("FullPage");return x(),A("div",be,[a(l,{columns:D,target:"category-device",onSearch:s[0]||(s[0]=o=>B.value={...o}),style:{"margin-bottom":"0"}}),a(M,{extraHeight:24},{default:n(()=>[a(J,{ref_key:"tableRef",ref:E,request:e.requestFun,gridColumn:2,scroll:{x:!0,y:610},params:m(B),rowSelection:{selectedRowKeys:e._selectedRowKeys.value,onSelect:e.onSelect,onSelectAll:e.onSelectAll,onSelectNone:e.cancelSelect},columns:D},{headerTitle:n(()=>[a(C,null,{default:n(()=>[a(v,{hasPermission:`${y}:assert`,type:"primary",onClick:s[1]||(s[1]=o=>e.clickAdd("handle"))},{default:n(()=>[a(i,{type:"PlusOutlined"}),b("资产分配 ")]),_:1},8,["hasPermission"]),a(k,{trigger:"hover"},{overlay:n(()=>[a(u,null,{default:n(()=>[a(c,null,{default:n(()=>[a(v,{hasPermission:`${y}:bind`,popConfirm:{title:"确认批量解除绑定？",onConfirm:()=>e.clickUnBind()}},{default:n(()=>[a(i,{type:"DisconnectOutlined"}),b("批量解绑 ")]),_:1},8,["hasPermission","popConfirm"])]),_:1}),a(c,null,{default:n(()=>[a(v,{hasPermission:`${y}:assert`,onClick:s[2]||(s[2]=o=>e.clickEdit())},{default:n(()=>[a(i,{type:"EditOutlined"}),b("批量编辑 ")]),_:1},8,["hasPermission"])]),_:1})]),_:1})]),default:n(()=>[a(r,null,{default:n(()=>[b("批量操作")]),_:1})]),_:1})]),_:1})]),card:n(o=>{var d,K;return[a(F,he({value:o,actions:[{key:1}]},o,{active:e._selectedRowKeys.value.includes(o.id),onClick:e.onSelectChange,status:(d=o.state)==null?void 0:d.value,statusText:(K=o.state)==null?void 0:K.text,statusNames:{online:"processing",offline:"error",notActive:"warning"}}),{img:n(()=>[ve(t.$slots,"img",{},()=>[f("img",{src:m(Y)("/device-product.png"),style:{cursor:"pointer"}},null,8,Ie)],!0)]),content:n(()=>[f("h3",Ce,I(o.name),1),a(g,null,{default:n(()=>[a(S,{span:12},{default:n(()=>[Pe,a(h,{style:{width:"calc(100% - 20px)"}},{default:n(()=>[f("div",Re,I(o.id),1)]),_:2},1024)]),_:2},1024),a(S,{span:12},{default:n(()=>[De,a(h,{style:{width:"calc(100% - 20px)"}},{default:n(()=>[f("div",Le,I(e.permissionList.value.length&&e.getPermissLabel(o.permission)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),actions:n(()=>[a(v,{hasPermission:`${y}:assert`,onClick:Ke=>e.clickEdit(o)},{default:n(()=>[a(i,{type:"EditOutlined"})]),_:2},1032,["hasPermission","onClick"]),a(v,{hasPermission:`${y}:bind`,popConfirm:{title:"确认解除绑定？",onConfirm:()=>e.clickUnBind(o)}},{default:n(()=>[a(i,{type:"DisconnectOutlined"})]),_:2},1032,["hasPermission","popConfirm"])]),_:2},1040,["value","active","onClick","status","statusText"])]}),permission:n(o=>[b(I(e.permissionList.value.length&&e.getPermissLabel(o.permission)),1)]),state:n(o=>[a(V,{status:o.state.value,text:o.state.text,statusNames:{online:"processing",offline:"error",notActive:"warning"}},null,8,["status","text"])]),registryTime:n(o=>[f("span",null,I(o.registryTime?m(z)(o.registryTime).format("YYYY-MM-DD HH:mm:ss"):"-"),1)]),action:n(o=>[a(C,{size:16},{default:n(()=>[(x(!0),A(we,null,ke(e.getActions(o,"table"),d=>(x(),T(v,{hasPermission:d.permission,type:"link",tooltip:d==null?void 0:d.tooltip,"pop-confirm":d.popConfirm,onClick:d.onClick,disabled:d==null?void 0:d.disabled},{default:n(()=>[a(i,{type:d.icon},null,8,["type"])]),_:2},1032,["hasPermission","tooltip","pop-confirm","onClick","disabled"]))),256))]),_:2},1024)]),_:3},8,["request","params","rowSelection"])]),_:3}),f("div",Te,[m(p).addShow?(x(),T(oe,{key:0,visible:m(p).addShow,"onUpdate:visible":s[3]||(s[3]=o=>m(p).addShow=o),"query-columns":D,"parent-id":_.parentId,"all-permission":e.permissionList.value,"asset-type":"device",onConfirm:e.refresh},null,8,["visible","parent-id","all-permission","onConfirm"])):j("",!0),m(p).editShow?(x(),T(ae,{key:1,visible:m(p).editShow,"onUpdate:visible":s[4]||(s[4]=o=>m(p).editShow=o),ids:m(p).selectIds,"permission-list":m(p).permissList,"parent-id":_.parentId,"all-permission":e.permissionList.value,"asset-type":"device",defaultPermission:e.defaultPermission,onConfirm:e.refresh},null,8,["visible","ids","permission-list","parent-id","all-permission","defaultPermission","onConfirm"])):j("",!0)])])}}});const He=ne(Ee,[["__scopeId","data-v-263103d8"]]);export{He as default};
