import{d as Ce,ac as Ie,e as L,k as p,w as Se,ab as X,U as f,Z as B,f as l,X as c,V as $,E as Y,Y as b,_ as i,a4 as U,u as s,B as Z,F as K,G as N,a0 as Te,af as Me,ag as be}from"./vue-1731638920964.js";import{k as xe,o as Ae,d as Re,$ as ze,aL as Oe,aM as Le,aN as Be,aO as Ve,e as $e,aa as De,g as je}from"./index-1731638920964.js";import{L as qe}from"./index-1731638920964289.js";import{M as Ee}from"./mediaTool-1731638920964.js";import{R as W}from"./RadioButton-1731638920964.js";import{c as _}from"./channel-17316389209642.js";import Pe from"./Share-1731638920964.js";import{_ as Ue}from"./Preset.vue_vue_type_script_setup_true_lang-1731638920964.js";import"./index-1731638920964282.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import"./unionBy-1731638920964.js";const h=new Map;h.set("onvif-record","onvif-record");h.set("onvif-ptz","onvif-ptz");h.set("fixed-media-record","fix-record");h.set("fixed-media-ptz","fix-ptz");h.set("gb28181-2016-ptz","gb-ptz");h.set("gb28181-2016-record","gb-record");h.set("media-plugin-ptz","plugin-ptz");h.set("media-plugin-record","plugin-record");let j,V,w,F=0;const te=(a,y)=>{setTimeout(()=>{_.broadcastStart(a,y,{hideError:!0}).catch(e=>{F<=10&&(te(a,y),F+=1)}).then(()=>{F=0})},300)},Ne=()=>{w=new RTCPeerConnection},Fe=(a,y,e)=>{Ne(),navigator.mediaDevices.getUserMedia({audio:!0}).then(async d=>{j=d;const C={direction:"sendrecv",sendEncodings:[]};d.getAudioTracks().length>0?w.addTransceiver(d.getAudioTracks()[0],C):(C.direction="recvonly",w.addTransceiver("audio",C)),w.createOffer().then(u=>{w.setLocalDescription(u).then(()=>{_.broadcastPush(a,y,u.sdp).then(x=>{let S={};S.sdp=x.sdp,S.type="answer",w.setRemoteDescription(S).then(()=>{te(a,y)})})})});const n=window.AudioContext||window.webkitAudioContext,g=new n,r=g.createMediaStreamSource(d);r.connect(g.destination);const k=g.createAnalyser();r.connect(k);function I(){const u=new Uint8Array(k.frequencyBinCount);k.getByteFrequencyData(u);const x=Math.sqrt(u.reduce((S,R)=>S+R*R,0)/u.length);e.volume&&e.volume(x)}V&&(window.clearInterval(V),V=null),V=setInterval(I,50)})},Je=()=>{w&&(w.close(),w=null),j&&(j.getTracks().forEach(function(a){a.stop()}),window.clearInterval(V),V=null,j=null)};let m,D=[];const Qe=()=>{m=new RTCPeerConnection},Ge=(a,y,e)=>{Qe();const d={direction:"recvonly",sendEncodings:[]},C={direction:"recvonly",sendEncodings:[]};m.addTransceiver("video",C),m.addTransceiver("audio",d),m.createOffer().then(n=>{m.setLocalDescription(n).then(()=>{_.ptzStartPlay(a,y,"rtc",n.sdp).then(g=>{let r={};r.sdp=g.sdp,r.type="answer",m.setRemoteDescription(r)})})}),m.ontrack=n=>{if(console.log("[ontrack]",n),D.push(n.track),n.streams&&n.streams.length>0)e==null||e(n.streams[0]);else if(m.getReceivers().length===D.length){const g=new MediaStream(D);e==null||e(g)}}},ee=()=>{m&&(m.close(),m=null),D.length&&D.forEach(a=>{a.stop()})},A=a=>(Me("data-v-a5ff6aa2"),a=a(),be(),a),He={class:"media-live"},Xe={key:0,class:"tool-item"},Ye=A(()=>i("div",null,"开始录像",-1)),Ze=A(()=>i("span",{style:{"padding-right":"12px"}},"本地存储",-1)),Ke=A(()=>i("span",{style:{"padding-right":"12px"}},"云端存储",-1)),We={key:1},et=["onClick"],tt=["onClick"],ot=A(()=>i("div",{class:"tool-item"}," 重置 ",-1)),at={key:0,class:"media-live-actions"},st=A(()=>i("div",{class:"title"}," 预置点位 ",-1)),nt={class:"media-preset"},lt=A(()=>i("div",{class:"title"}," 视频格式 ",-1)),it={class:"media-live-tool"},ct=A(()=>i("div",{class:"title"}," 转速控制 ",-1)),dt={class:"media-live-tool"},rt={class:"actions-tool"},ut=Ce({__name:"index",props:{visible:{type:Boolean,default:!1},data:{type:Object,default:()=>({})},type:{type:String,default:"normal"}},emits:["update:visible","refresh"],setup(a,{emit:y}){const e=a,d=Ie(),C=xe(),n=L({get:()=>e.visible,set:o=>y("update:visible",o)}),g=p(),r=p(""),k=p(!1),I=p("rtc"),u=p(!1),x=p(!1),S=p(!1),R=p(0),q=L(()=>d.query.type!=="fixed-media"),oe=L(()=>{var t,M;const o=h.get(d.query.type+"-record");return((M=(t=C.configInfo)==null?void 0:t.media)==null?void 0:M[o])!="false"}),ae=L(()=>{var M,O;const o=h.get(d.query.type+"-ptz");return((O=(M=C.configInfo)==null?void 0:M.media)==null?void 0:O[o])!="false"}),J=[{label:"高",value:180},{label:"中",value:90},{label:"低",value:45}],z=p(90),E=p();L(()=>{var o;return(o=J.find(t=>t.value===z.value))==null?void 0:o.label});const se=()=>{k.value===!1?(Fe(e.data.deviceId,e.data.channelId,{volume(o){R.value=o}}),k.value=!0):(Je(),R.value=0,k.value=!1)},ne=o=>{z.value=o.key},le=()=>{x.value||(u.value=!1)},ie=()=>{u.value=!0},ce=L(()=>({"media-tool":!0,"media-tool-show":u.value})),P=()=>{const o=_.ptzStart(e.data.deviceId,e.data.channelId,I.value);I.value!=="rtc"?r.value=o:Ge(e.data.deviceId,e.data.channelId,t=>{r.value=t})},T=p(0),de=async()=>{const{result:o}=await _.ptzIsRecord(e.data.deviceId,e.data.channelId);T.value=o?2:0},re=async({key:o})=>{x.value=!1,u.value=!1,T.value=1,E.value=o==="true",(await _.recordStart(e.data.deviceId,e.data.channelId,{local:E.value}).catch(()=>({success:!1}))).success?T.value=2:T.value=0},ue=async()=>{(await _.recordStop(e.data.deviceId,e.data.channelId,{local:E.value})).success&&(T.value=0)},ve=()=>{r.value="",setTimeout(()=>{P()},500)},pe=()=>{const o=_.mediaStop(e.data.deviceId,e.data.channelId);return o.then(t=>{t.success&&Ae("操作成功！")}),o},fe=o=>{_.ptzTool(e.data.deviceId,e.data.channelId,o,z.value)},me=()=>{_.ptzStop(e.data.deviceId,e.data.channelId)},ye=()=>{y("refresh")};return Se(()=>n.value,o=>{o?(setTimeout(()=>{P()},100),de()):(r.value="",ee(),ee())},{immediate:!0}),(o,t)=>{const M=X("AIcon"),O=Re,Q=X("a-icon"),G=ze,H=Oe,_e=Le,he=Be,ge=Ve,ke=$e,we=De;return f(),B(K,null,[l(we,{visible:s(n),"onUpdate:visible":t[6]||(t[6]=v=>N(n)?n.value=v:null),title:"播放",width:a.type==="share"?"100%":s(q)?1200:900,class:U({share:a.type==="share"}),maskClosable:!1,keyboard:!1,destroyOnClose:!0,onOk:t[7]||(t[7]=v=>n.value=!1)},{closeIcon:c(()=>[l(O,{disabled:a.type==="share",type:"text"},{default:c(()=>[l(M,{type:"CloseOutlined"})]),_:1},8,["disabled"])]),footer:c(()=>[a.type!=="share"?(f(),$(ke,{key:0},{default:c(()=>[l(O,{onClick:t[4]||(t[4]=v=>n.value=!1)},{default:c(()=>[Y("取消")]),_:1}),l(O,{onClick:t[5]||(t[5]=v=>n.value=!1),type:"primary"},{default:c(()=>[Y("确定")]),_:1})]),_:1})):b("",!0)]),default:c(()=>[i("div",He,[i("div",{class:"media-live-video",onMouseenter:ie,onMouseleave:le},[i("div",{class:U(s(ce)),onMouseenter:t[1]||(t[1]=v=>u.value=!0)},[a.type!=="share"&&s(oe)?(f(),B("div",Xe,[s(T)===0?(f(),$(he,{key:0,trigger:"click",onClick:t[0]||(t[0]=v=>x.value=!0)},{overlay:c(()=>[l(_e,{onClick:re},{default:c(()=>[s(q)&&s(d).query.type!=="onvif"?(f(),$(H,{key:"true"},{default:c(()=>[Ze,l(G,{title:"存储在设备本地"},{default:c(()=>[l(Q,{type:"QuestionCircleOutlined"})]),_:1})]),_:1})):b("",!0),l(H,{key:"false"},{default:c(()=>[Ke,l(G,{title:"存储在服务器中"},{default:c(()=>[l(Q,{type:"QuestionCircleOutlined"})]),_:1})]),_:1})]),_:1})]),default:c(()=>[Ye]),_:1})):s(T)===1?(f(),B("div",We,"请求录像中")):s(T)===2?(f(),B("div",{key:2,onClick:Z(ue,["stop"])}," 停止录像 ",8,et)):b("",!0)])):b("",!0),i("div",{class:"tool-item",onClick:Z(ve,["stop"])}," 刷新 ",8,tt),l(ge,{title:"重置将断开直播, 可能会影响其他播放者",onConfirm:pe},{default:c(()=>[ot]),_:1})],34),s(n)?(f(),$(qe,{key:0,ref_key:"player",ref:g,live:!0,url:s(r),protocol:s(I),autoplay:""},null,8,["url","protocol"])):b("",!0)],32),s(q)&&s(ae)?(f(),B("div",at,[(a.data.ptzType.value===0||a.data.ptzType.value===1)&&s(d).query.type!=="onvif"?(f(),B(K,{key:0},[st,i("div",nt,[l(Ue,{data:a.data,onRefresh:ye},null,8,["data"])])],64)):b("",!0),lt,i("div",it,[l(W,{value:s(I),"onUpdate:value":t[2]||(t[2]=v=>N(I)?I.value=v:null),columns:4,options:[{label:"RTC",value:"rtc"},{label:"MP4",value:"mp4"},{label:"FLV",value:"flv"},{label:"HLS",value:"m3u8"}],onSelect:P},null,8,["value"])]),ct,i("div",dt,[l(W,{value:s(z),"onUpdate:value":t[3]||(t[3]=v=>N(z)?z.value=v:null),options:J,onSelect:ne},null,8,["value"])]),i("div",rt,[l(Ee,{onOnMouseDown:fe,onOnMouseUp:me},{center:c(()=>[i("div",{class:U({center:!0,"center-active":s(k)}),onClick:se},[i("div",{class:"center-volume",style:Te({height:`${s(R)}%`})},null,4),l(M,{type:s(k)?"AudioOutlined":"AudioMutedOutlined"},null,8,["type"])],2)]),_:1})])])):b("",!0)])]),_:1},8,["visible","width","class"]),s(S)?(f(),$(Pe,{key:0,data:a.data,onClose:t[8]||(t[8]=v=>S.value=!1)},null,8,["data"])):b("",!0)],64)}}});const Tt=je(ut,[["__scopeId","data-v-a5ff6aa2"]]);export{Tt as default};
