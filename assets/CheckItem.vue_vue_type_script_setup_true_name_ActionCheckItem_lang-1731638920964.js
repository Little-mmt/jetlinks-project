import{u as M}from"./scene-17316389209642.js";import{d as S,ai as W,k as Y,R as $,u as z}from"./vue-1731638920964.js";import{l as B}from"./product-17316389209644.js";import{C as T}from"./config-17316389209642.js";import{T as R}from"./template-1731638920964.js";import{F as H,g4 as Q,dG as X}from"./index-1731638920964.js";import{b as Z,E as ee,g as ae}from"./util-17316389209642.js";import{g as te}from"./util-17316389209643.js";import{g as K,b as se}from"./util-1731638920964.js";const ne=S({name:"ActionCheckItem"}),de=S({...ne,props:{branchesName:{type:Number,default:0},thenName:{type:Number,default:0},name:{type:Number,default:0}},setup(U,{expose:j}){const e=U,F=M(),{data:t}=W(F),A=H.useInjectFormItemContext(),G=Y(),h=()=>{A.onFieldChange()},J=async()=>{var I,D,w,N,_,g,b,k,v,m,f,n,s,l,x,O,P,q,C,E;const a=t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device,i=await B({terms:[{column:"id",termType:"eq",value:a.productId}]});if(i.success&&((I=i.result)==null?void 0:I.total)===0&&a&&a.productId){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.productId=void 0,h();return}const p=(w=(D=i==null?void 0:i.result)==null?void 0:D.data)==null?void 0:w[0];let c=JSON.parse((p==null?void 0:p.metadata)||"{}");if((a==null?void 0:a.selector)==="fixed"){let r=!1;if(a.selectorValues){const o=((N=a.selectorValues)==null?void 0:N.map(d=>d.value))||[],u=await Q({terms:[{terms:[{column:"id",termType:"in",value:o.toString()}]}]});if(r=u.success&&u.result.length===(((_=a.selectorValues)==null?void 0:_.length)||0),a.selectorValues.length===1&&r){const y=(await X(o[0])).result;c=JSON.parse((y==null?void 0:y.metadata)||(p==null?void 0:p.metadata)||"{}")}}if(!r){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.selectorValues=void 0,t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}}else if(a.selector==="context"){const r=a.upperKey,o={branch:e.thenName,branchGroup:e.branchesName,action:e.name-1},u=await ae(o,z(t.value));if(!te(u,r,"id")){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.upperKey=void 0,t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}}else if(a.selector==="relation"){const r=(k=(b=(g=a.selectorValues)==null?void 0:g[0])==null?void 0:b.value)==null?void 0:k.relation;if(!((v=(await T.getRelationUsers({paging:!1,sorts:[{name:"createTime",order:"desc"}],terms:[{termType:"eq",column:"objectTypeName",value:"设备"},{termType:"eq",column:"relation",value:r}]}).catch(()=>({success:!1,result:[]}))).result)!=null&&v.length)){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.selectorValues=void 0,t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}}else if(a.selector==="tag"){let r=!1;if(a.selectorValues&&((m=c==null?void 0:c.tags)!=null&&m.length)){const o=((n=(f=a.selectorValues)==null?void 0:f[0])==null?void 0:n.value).map(d=>d.column);r=[...new Set(o).values()].every(d=>c==null?void 0:c.tags.some(y=>y.id===d))}if(!r){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.selectorValues=void 0,t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}}if(a.message.messageType==="READ_PROPERTY"){let r=!1;if(a.message.properties&&((s=c.properties)!=null&&s.length)){const o=(l=a.message.properties)==null?void 0:l[0];r=(x=c.properties)==null?void 0:x.some(u=>u.id===o)}if(!r){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.message.properties=[],t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}}if(a.message.messageType==="WRITE_PROPERTY"){let r=!1;const o=(O=Object.keys(a.message.properties))==null?void 0:O[0];if(a.message.properties&&((P=c.properties)!=null&&P.length)&&(r=(q=c.properties)==null?void 0:q.some(d=>d.id===o)),!r){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.message.properties=void 0,t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}const u=(C=a.message.properties)==null?void 0:C[o];if(u.source==="upper"){const d={branch:e.thenName,branchGroup:e.branchesName,action:e.name-1};if(!(await K(d,t.value))(u==null?void 0:u.value,"id")){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.message.properties[o]=void 0,t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}}}if(a.message.messageType==="INVOKE_FUNCTION"&&a.message.functionId&&c.functions){const r=a.message.functionId;let o=!1;if(r&&c.functions.length&&(o=(E=c.functions)==null?void 0:E.some(u=>u.id===r)),!o){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.message.functionId=void 0,t.value.branches[e.branchesName].then[e.thenName].actions[e.name].device.changeData=!0,h();return}}},L=async()=>{var D,w;const a=t.value.branches[e.branchesName].then[e.thenName].actions[e.name].notify,i=t.value.triggerType,p=await T.list({terms:[{terms:[{column:"id",termType:"eq",value:a.notifierId}]}]});if(p.success&&((D=p.result)==null?void 0:D.total)===0){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].notify.notifierId="",h();return}const c=await R.list({terms:[{terms:[{column:"id",termType:"eq",value:a.templateId}]}]});if(c.success&&((w=c.result)==null?void 0:w.total)===0){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].notify.templateId="",h();return}const I=await R.getTemplateDetail(a.templateId);if(I.success){const N=new Map,_=Object.keys(a.variables),g=a.notifyType;I.result.variableDefinitions.map(v=>{var m;N.set(v.id,(m=v.expands)==null?void 0:m.businessType)});let b=null;const k=_.every(async v=>{if(N.has(v)){const m=a.variables[v];if(m.source==="upper"){if(!b){const n={branch:e.thenName,branchGroup:e.branchesName,action:e.name-1};b=await K(n,t.value)}return!!(b==null?void 0:b(m.upperKey,"id"))}else if(m.source==="fixed"){const f=N.get(v);let n=!1;if(f==="user"){let s;return["dingTalk","weixin"].includes(g)?s=g==="dingTalk"?await T.queryDingTalkUsers(a.notifierId):await T.queryWechatUsers(a.notifierId):n=!0,s&&s.success&&(n=s.result.some(l=>l.id===m.value)),n}if(f==="tag"){const s=await R.getTags(a.notifierId);return s&&s.success&&(n=s.result.some(l=>l.id===m.value)),n}if(f==="org"){let s;return["dingTalk","weixin"].includes(g)?s=g==="dingTalk"?await T.dingTalkDept(a.notifierId):await T.weChatDept(a.notifierId):n=!0,s&&s.success&&(n=s.result.some(l=>l.id===m.value)),n}}else if(m.source=="relation"){const f=await se(i==="device");let n=!1;return!n&&f.platform.length&&(n=f.platform.some(s=>{var l;return s.id===((l=m.relation)==null?void 0:l.objectId)})),!n&&f.relation.length&&(n=f.relation.some(s=>{var l;return s.id===((l=m.relation)==null?void 0:l.objectId)})),n}}else return!1;return!0});if(b=null,!k){t.value.branches[e.branchesName].then[e.thenName].actions[e.name].notify.changeData=!0,h();return}}},V=()=>{var a;if(t.value.branches[e.branchesName].then[e.thenName]){const i=(a=t.value.branches[e.branchesName].then[e.thenName].actions)==null?void 0:a[e.name],p=i==null?void 0:i.executor;p==="device"&&(i!=null&&i.device)?J():p==="notify"&&(i!=null&&i.notify)&&L()}};return(()=>{const a=Z({branch:e.branchesName,branchGroup:e.thenName,action:e.name});G.value=ee.subscribe(a,V)})(),V(),j({formTouchOff:h}),(a,i)=>$(a.$slots,"default")}});export{de as _};
