import{o as k,aD as $,a6 as B,v as E,dw as O,aT as q,F as M,aa as G,g as J}from"./index-1730252110824.js";import"./index-1730252110824282.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import{T as x}from"./template-1730252110824.js";import{_ as X}from"./ToUser.vue_vue_type_script_setup_true_lang-1730252110824.js";import{_ as Y}from"./ToOrg.vue_vue_type_script_setup_true_lang-1730252110824.js";import{_ as Z}from"./ToTag.vue_vue_type_script_setup_true_lang-1730252110824.js";import{p as z}from"./validate-1730252110824.js";import{d as A,e as H,k as _,w as K,U as n,V as p,X as r,f as v,u as o,Z as D,F as U,a1 as Q,E as W,$ as w,Y as ee,G as ae}from"./vue-1730252110824.js";import"./regular-1730252110824.js";const te={key:0},le=A({__name:"index",props:{visible:{type:Boolean,default:!1},data:{type:Object,default:()=>({})}},emits:["update:visible"],setup(c,{emit:V}){const m=c,f=H({get:()=>m.visible,set:i=>V("update:visible",i)}),y=_([]),C=[{title:"变量",dataIndex:"id",width:100,ellipsis:!0,scopedSlots:{customRender:"id"}},{title:"名称",dataIndex:"name",scopedSlots:{customRender:"name"}},{title:"值",dataIndex:"type",width:160,scopedSlots:{customRender:"type"}}],a=_({configId:"",variableDefinitions:"",templateDetailTable:[]}),b=_(),T=_(!1),L=async()=>{const i={terms:[{column:"type",value:m.data.type},{column:"provider",value:m.data.provider}]},{result:t}=await x.getConfig(i);y.value=t,y.value.length&&(a.value.configId=m.data.configId)},P=async()=>{const{result:i}=await x.getTemplateDetail(m.data.id);a.value.templateDetailTable=i.variableDefinitions.map(t=>{var l;return{...t,type:(l=t.expands)!=null&&l.businessType?t.expands.businessType:t.type,value:void 0,otherRules:t.id==="calledNumber"||t.id==="phoneNumber"?[{max:64,message:"最多可输入64个字符",trigger:"change"},{trigger:"change",validator(g,s){return s?z(s)?Promise.resolve():Promise.reject("请输入有效号码"):Promise.resolve()}}]:[]}})},R=()=>{console.log(a.value.templateDetailTable);const i=a.value.templateDetailTable.filter(l=>["user","org","tag","userIdList","departmentIdList"].includes(l.id)),t=i.length?i.some(l=>l.value):!0;if(!t&&m.data.type==="dingTalk"){k("收信人，收信人部门至少填写一个","warning");return}if(!t&&m.data.type==="weixin"){k("收信人，收信人部门，收信人标签至少填写一个","warning");return}b.value.validate().then(async()=>{var g;const l={};(g=a.value.templateDetailTable)==null||g.forEach(s=>{l[s.id]=s.value}),T.value=!0,x.debug(l,a.value.configId,m.data.id).then(s=>{s.success&&(k("操作成功"),I())}).finally(()=>{T.value=!1})}).catch(l=>{console.log("err: ",l)})},I=()=>{f.value=!1,b.value.resetFields(),a.value.templateDetailTable=[]};return K(()=>f.value,i=>{i&&(L(),P())}),(i,t)=>{const l=$,g=B,s=E,h=O,j=q,F=M,N=G;return n(),p(N,{visible:o(f),"onUpdate:visible":t[1]||(t[1]=d=>ae(f)?f.value=d:null),title:"调试",cancelText:"取消",okText:"确定",onOk:R,onCancel:I,confirmLoading:o(T)},{default:r(()=>[v(F,{ref_key:"formRef",ref:b,layout:"vertical",model:o(a)},{default:r(()=>[v(s,{label:"通知配置",name:"configId",rules:{required:!0,message:"请选择通知配置"}},{default:r(()=>[v(g,{value:o(a).configId,"onUpdate:value":t[0]||(t[0]=d=>o(a).configId=d),placeholder:"请选择通知配置",getPopupContainer:d=>d},{default:r(()=>[(n(!0),D(U,null,Q(o(y),(d,e)=>(n(),p(l,{key:e,value:d.id},{default:r(()=>[W(w(d.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"])]),_:1}),o(a).templateDetailTable&&o(a).templateDetailTable.length?(n(),p(s,{key:0,label:"变量"},{default:r(()=>[v(j,{"row-key":"id",columns:C,"data-source":o(a).templateDetailTable,pagination:!1,bordered:""},{bodyCell:r(({column:d,record:e,index:S})=>[["id","name"].includes(d.dataIndex)?(n(),D("span",te,w(e[d.dataIndex]),1)):(n(),p(s,{key:1,name:["templateDetailTable",S,"value"],rules:[{required:e.required,message:"该字段为必填字段"},...e.otherRules]},{default:r(()=>[c.data.type==="dingTalk"||c.data.type==="weixin"?(n(),D(U,{key:0},[e.type==="user"?(n(),p(X,{key:0,toUser:e.value,"onUpdate:toUser":u=>e.value=u,type:c.data.type,"config-id":o(a).configId},null,8,["toUser","onUpdate:toUser","type","config-id"])):e.type==="org"?(n(),p(Y,{key:1,type:c.data.type,"config-id":o(a).configId,toParty:e.value,"onUpdate:toParty":u=>e.value=u},null,8,["type","config-id","toParty","onUpdate:toParty"])):e.type==="tag"?(n(),p(Z,{key:2,type:c.data.type,"config-id":o(a).configId,toTag:e.value,"onUpdate:toTag":u=>e.value=u},null,8,["type","config-id","toTag","onUpdate:toTag"])):(n(),p(h,{key:3,modelValue:e.value,"onUpdate:modelValue":u=>e.value=u,itemType:e.type},null,8,["modelValue","onUpdate:modelValue","itemType"]))],64)):(n(),p(h,{key:1,modelValue:e.value,"onUpdate:modelValue":u=>e.value=u,itemType:e.type},null,8,["modelValue","onUpdate:modelValue","itemType"]))]),_:2},1032,["name","rules"]))]),_:1},8,["data-source"])]),_:1})):ee("",!0)]),_:1},8,["model"])]),_:1},8,["visible","confirmLoading"])}}});const _e=J(le,[["__scopeId","data-v-100ac34d"]]);export{_e as default};
