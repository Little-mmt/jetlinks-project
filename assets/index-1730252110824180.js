import{k as l,ac as me,c as ve,ab as V,U as c,Z as m,f as a,X as o,_ as y,$ as j,u as n,V as T,E as k,Y as h,G as E,F as N,a1 as _e,d as fe,af as he,ag as ye}from"./vue-1730252110824.js";import{g as Ie,ax as ge,a4 as Y,d3 as ke,o as be,cY as Ce,aR as xe,Z as Be,cW as Se,cX as Te,e as we,a3 as De,dB as $e}from"./index-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import"./index-1730252110824292.js";import"./index-1730252110824293.js";import qe from"./Bind-17302521108243.js";import Le from"./index-1730252110824158.js";import Oe from"./index-1730252110824186.js";import Re from"./index-1730252110824166.js";import{u as Ve}from"./useRequest-1730252110824.js";import{u as je,q as Z,b as Ee,a as Ne}from"./auto-1730252110824.js";import"./cascade-1730252110824.js";import"./index-1730252110824289.js";import"./mediaTool-1730252110824.js";import"./RadioButton-1730252110824.js";import"./channel-17302521108242.js";import"./Share-1730252110824.js";import"./Preset.vue_vue_type_script_setup_true_lang-1730252110824.js";import"./unionBy-1730252110824.js";import"./Preview-1730252110824.js";const Pe=b=>(he("data-v-9efe80e4"),b=b(),ye(),b),Ue={class:"channelControl"},Ae={class:"bind"},Fe={key:1},Je={class:"bound"},Me={class:"bound_device"},Xe={key:0},Ye={key:0,class:"bound_channel"},Ze={style:{padding:"12px 24px 0",display:"flex"}},ze=Pe(()=>y("div",{class:"catalogue"},"当前目录：",-1)),Ge={key:0},Ke={key:1,class:"video-unbind-tip"},We=fe({name:"Channel"}),He=Object.assign(We,{setup(b){const w=l(0),I=l(),C=l(),x=l(!1),D=l(!1);l(!1);const P=l(),v=me(),$=l(),g=l(!1),U=l(),B=l(!1),A=l(),r=l(),q=l(),p=l({}),S=l({}),F=l(),f=l(!1),L=l(!1),J=ve("video-tags"),{loading:z,run:G}=Ve(je,{immediate:!1,onSuccess:async()=>{await C.value.getDeviceList(),f.value=!1,w.value=0}}),M=[{title:"ID",dataIndex:"channelId",key:"channelId",ellipsis:!0,search:{type:"string"}},{title:"名称",dataIndex:"name",key:"name",ellipsis:!0,search:{type:"string",first:!0}},{title:"厂商",dataIndex:"manufacturer",key:"manufacturer",ellipsis:!0},{title:"安装地址",dataIndex:"address",ellipsis:!0,key:"address",search:{type:"string"}},{title:"状态",dataIndex:"status",key:"status",scopedSlots:!0,width:150,search:{type:"select",options:[{label:"已连接",value:"online"},{label:"未连接",value:"offline"}]}},{title:"操作",key:"action",width:100,scopedSlots:!0}],K=t=>{U.value=Y(t),B.value=!0},W=t=>{const e=p.value[r.value],i=e==null?void 0:e.channelIds;e&&i.includes(t.channelId)?p.value[r.value].channelIds=i.filter(d=>d!==t.channelId):S.value[t.channelId]=F.value,I.value.reload()},H=t=>{P.value=Y(t),D.value=!0},Q=t=>{J.terms=[{column:"channelId",termType:"eq",value:t.channelId}],J.tag.value="Log"},ee=()=>{x.value=!0},te=t=>{$.value=t},ne=()=>{ke.confirm({title:"清空操作不可撤销，确认清空所有通道？",onOk(){G(v.params.id),p.value={}}})},ae=t=>{var e;p.value={...t},C.value.getDeviceList({...t}),x.value=!1,(e=I.value)==null||e.reload()},se=t=>{const e=t,i={terms:[{terms:[{column:"channelId$media-record-schedule-bind-channel",value:[{column:"scheduleId",termType:"eq",value:v.params.id}]},{column:"deviceId$media-record-schedule-bind-device",value:[{column:"scheduleId",termType:"eq",value:v.params.id}]}]}]};r.value&&i.terms.push({column:"deviceId",value:r.value,type:"and"}),p.value[r.value]&&i.terms.push({column:"channelId",termType:"in",value:p.value[r.value].channelIds.toString(),type:"or"});const d=Object.keys(S.value);return d.length&&i.terms.push({column:"channelId",termType:"nin",value:d.toString(),type:"and"}),e.terms=[...i.terms,...e.terms],Z(e)},le=async()=>{const t=[];Object.values(p.value).forEach(({channelIds:d,channelCatalog:u,paths:_})=>{const[O]=_;t.push(...d.map(R=>({deviceId:O,channelId:R,others:{channelCatalog:u.join("/")}})))}),L.value=!0,(await Ee(v.params.id,t).finally(()=>{L.value=!1})).success&&(p.value={});const i=Object.keys(S.value);if(i.length){const d=i.map(u=>({deviceId:S.value[u],channelId:u}));await Ne(v.params.id,d)}C.value.getDeviceList(),await X(),be("操作成功"),g.value=!1},oe=({node:t})=>{const{paths:e,channelCatalog:i}=t;F.value=e[0],A.value=i,I.value.reload()},X=()=>{const t={terms:[{terms:[{column:"channelId$media-record-schedule-bind-channel",value:[{column:"scheduleId",termType:"eq",value:v.params.id}]},{column:"deviceId$media-record-schedule-bind-device",value:[{column:"scheduleId",termType:"eq",value:v.params.id}]}]}]};Z(t).then(e=>{e.success&&(w.value=e.result.total)})},ie=t=>{f.value=t.length};return X(),(t,e)=>{const i=Ce,d=xe,u=V("AIcon"),_=Be,O=Se,R=Te,ce=V("pro-search"),de=V("Ellipsis"),ue=we,re=De,pe=$e;return c(),m("div",null,[a(pe,{spinning:n(z)},{default:o(()=>[y("div",Ue,[y("div",Ae,"已绑定通道数："+j(n(w)),1),n(g)?(c(),T(d,{key:0},{default:o(()=>[a(i,{onClick:ne},{default:o(()=>[k("清空通道")]),_:1}),a(i,{onClick:ee},{default:o(()=>[k("绑定通道")]),_:1})]),_:1})):(c(),m("div",Fe,[a(_,{type:"link",hasPermission:"device/Instance:action",onClick:e[0]||(e[0]=s=>g.value=!0)},{default:o(()=>[a(u,{type:"EditOutlined"})]),_:1})]))]),y("div",Je,[y("div",Me,[n(f)?(c(),m("div",Xe,"选择设备及目录查看已绑定的通道：")):h("",!0),a(Le,{ref_key:"treeRef",ref:C,height:700,id:n(v).params.id,deviceId:n(r),"onUpdate:deviceId":e[1]||(e[1]=s=>E(r)?r.value=s:null),channelId:n(q),"onUpdate:channelId":e[2]||(e[2]=s=>E(q)?q.value=s:null),onSelect:oe,onLoad:ie},null,8,["id","deviceId","channelId"])]),n(f)?(c(),m("div",Ye,[y("div",Ze,[ze,a(R,null,{default:o(()=>[(c(!0),m(N,null,_e(n(A),s=>(c(),T(O,null,{default:o(()=>[k(j(s),1)]),_:2},1024))),256))]),_:1})]),a(ce,{columns:M,onSearch:te,params:n($),type:"simple",target:"capture-plan-channel",style:{"padding-bottom":"0","margin-bottom":"0"}},null,8,["params"]),a(re,{style:{"min-height":"calc(100% - 60px)"},ref_key:"tableRef",ref:I,model:"table",rowKey:"channelId",columns:M,request:se,params:n($)},{status:o(s=>[a(ge,{text:s.status.text,status:s.status.value,statusNames:{online:"success",offline:"error"}},null,8,["text","status"])]),channelId:o(s=>[a(de,null,{default:o(()=>[k(j(s.channelId),1)]),_:2},1024)]),action:o(s=>[a(ue,{size:16},{default:o(()=>[n(g)?(c(),m(N,{key:0},[a(_,{type:"link",style:{padding:"0px"},key:"play",tooltip:{title:"播放"},onClick:()=>{K(s)}},{default:o(()=>[a(u,{type:"VideoCameraOutlined"})]),_:2},1032,["onClick"]),a(_,{type:"link",key:"unbind",style:{padding:"0px"},tooltip:{title:"解绑"},popConfirm:{title:"确认解绑吗？",okText:"确定",cancelText:"取消",onConfirm:()=>{W(s)}}},{default:o(()=>[a(u,{type:"DisconnectOutlined"})]),_:2},1032,["popConfirm"])],64)):(c(),m(N,{key:1},[a(_,{type:"link",key:"picture",style:{padding:"0px"},tooltip:{title:"抓拍"},onClick:()=>{H(s)}},{default:o(()=>[a(u,{type:"PictureOutlined"})]),_:2},1032,["onClick"]),a(_,{type:"link",style:{padding:"0px"},key:"logs",tooltip:{title:"日志"},onClick:()=>{Q(s)}},{default:o(()=>[a(u,{type:"ExceptionOutlined"})]),_:2},1032,["onClick"])],64))]),_:2},1024)]),_:1},8,["params"])])):h("",!0)]),n(f)&&n(g)?(c(),m("div",Ge,[a(i,{type:"primary",loading:n(L),onClick:le},{default:o(()=>[k("保存")]),_:1},8,["loading"])])):h("",!0),n(f)?h("",!0):(c(),m("div",Ke,"请先绑定通道"))]),_:1},8,["spinning"]),n(x)?(c(),T(qe,{key:0,cacheDeviceIds:n(p),onCloseBind:e[3]||(e[3]=s=>x.value=!1),onSubmit:ae},null,8,["cacheDeviceIds"])):h("",!0),n(D)?(c(),T(Oe,{key:1,onClose:e[4]||(e[4]=s=>D.value=!1),data:n(P),viewType:"plan"},null,8,["data"])):h("",!0),a(Re,{visible:n(B),"onUpdate:visible":e[5]||(e[5]=s=>E(B)?B.value=s:null),data:n(U),onRefresh:e[6]||(e[6]=s=>n(I).reload())},null,8,["visible","data"])])}}}),xt=Ie(He,[["__scopeId","data-v-9efe80e4"]]);export{xt as default};
