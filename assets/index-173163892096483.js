import{ed as K,ee as W,o as J,ef as ee,d as te,e as ae,$ as ne,a6 as oe,v as de,ds as se,Z as le,aT as re,F as ie,aI as ce,A as pe,af as ue,eg as me,g as _e}from"./index-1731638920964.js";import"./index-1731638920964288.js";import"./index-1731638920964282.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import{u as fe}from"./instance-1731638920964.js";import{_ as L}from"./MSelect.vue_vue_type_script_setup_true_lang-17316389209643.js";import ye from"./PatchMapping-17316389209643.js";import{d as Ie,k as I,r as ve,o as ge,ab as he,u as l,U as r,V as c,X as n,f as s,E as w,Z as M,F as P,Y as p,J as ke}from"./vue-1731638920964.js";import"./index-1731638920964301.js";const be=Ie({__name:"index",props:{provider:{type:String,default:"MODBUS_TCP"}},setup(j){var O;const E=j,$=[{title:"名称",dataIndex:"metadataName",key:"metadataName",width:"20%"},{title:"通道",dataIndex:"channelId",key:"channelId",width:"20%"},{title:"采集器",dataIndex:"collectorId",key:"collectorId",width:"20%"},{title:"点位",key:"pointId",dataIndex:"pointId",width:"20%"},{title:"状态",key:"id",dataIndex:"id",width:"10%"},{title:"操作",key:"action",width:"10%"}],v=I(0),R=(t,e)=>e.label.toLowerCase().indexOf(t.toLowerCase())>=0,u=fe(),V=JSON.parse(((O=u.current)==null?void 0:O.metadata)||"{}"),C=I(!1),B=I([]),f=ve({dataSource:[]}),N=I(),g=I(!1),q=async()=>{var e;const t=await me({paging:!1});t.status===200&&(B.value=(e=t.result)==null?void 0:e.map(o=>({label:o.name,value:o.id,provider:o.provider})))},h=async()=>{var e,o;C.value=!0,q();const t=((o=(e=V.properties)==null?void 0:e.map)==null?void 0:o.call(e,i=>({metadataId:i.id,metadataName:`${i.name}(${i.id})`,metadataType:"property",name:i.name})))||[];if(t&&t.length){const i=await K("device",u.current.id);if(i.status===200){const k=i.result.reduce((b,y)=>{const m=t.find(x=>x.metadataId===y.metadataId);return m?Object.assign(m,y):b.push(y),b},t);f.dataSource=k}}C.value=!1},A=t=>{v.value=t.current-1},F=t=>{if(t){const e=W("device",u.current.id,[t]);return e.then(o=>{o.status===200&&(J("操作成功！"),h())}),e}},D=()=>{g.value=!1,h()};ge(()=>{h()});const Z=()=>{N.value.validate().then(async()=>{const t=ke(f).dataSource.filter(e=>e.channelId).map(e=>{var o;return((o=u.current.state)==null?void 0:o.value)==="notActive"&&(e.state="disabled"),e});t&&t.length!==0&&(console.log(t),(await ee(u.current.id,E.provider,t)).status===200&&(J("操作成功！"),h()))}).catch(t=>{console.log("error",t)})};return(t,e)=>{var U;const o=te,i=ae,k=he("AIcon"),b=ne,y=oe,m=de,x=se,Q=le,X=re,Y=ie,T=ce,z=pe,G=ue;return(U=l(V).properties)!=null&&U.length?(r(),c(z,{key:0,spinning:l(C)},{default:n(()=>[s(T,{bordered:!1,borderStyle:"padding: 0"},{extra:n(()=>[s(i,null,{default:n(()=>[s(o,{onClick:e[0]||(e[0]=a=>g.value=!0)},{default:n(()=>[w("批量映射")]),_:1}),s(o,{type:"primary",onClick:Z},{default:n(()=>[w("保存")]),_:1})]),_:1})]),default:n(()=>[s(Y,{ref_key:"formRef",ref:N,model:l(f)},{default:n(()=>[s(X,{columns:$,dataSource:l(f).dataSource,onChange:A},{headerCell:n(({column:a})=>[a.key==="collectorId"?(r(),M(P,{key:0},[w(" 采集器 "),s(b,{title:"数据采集中配置的真实物理设备"},{default:n(()=>[s(k,{type:"QuestionCircleOutlined"})]),_:1})],64)):p("",!0)]),bodyCell:n(({column:a,record:d,index:S})=>[a.dataIndex==="channelId"?(r(),c(m,{key:0,name:["dataSource",l(v)*10+S,"channelId"]},{default:n(()=>[s(y,{style:{width:"100%"},value:d[a.dataIndex],"onUpdate:value":_=>d[a.dataIndex]=_,placeholder:"请选择",allowClear:"","show-search":"","filter-option":R,options:l(B),onSelect:(_,H)=>{d.provider=H.provider}},null,8,["value","onUpdate:value","options","onSelect"])]),_:2},1032,["name"])):p("",!0),a.dataIndex==="collectorId"?(r(),c(m,{key:1,name:["dataSource",l(v)*10+S,"collectorId"],rules:[{required:!!d.channelId,message:"请选择采集器"}]},{default:n(()=>[s(L,{modelValue:d[a.dataIndex],"onUpdate:modelValue":_=>d[a.dataIndex]=_,id:d.channelId,type:"COLLECTOR"},null,8,["modelValue","onUpdate:modelValue","id"])]),_:2},1032,["name","rules"])):p("",!0),a.dataIndex==="pointId"?(r(),c(m,{key:2,name:["dataSource",l(v)*10+S,"pointId"],rules:[{required:!!d.channelId,message:"请选择点位"}]},{default:n(()=>[s(L,{modelValue:d[a.dataIndex],"onUpdate:modelValue":_=>d[a.dataIndex]=_,id:d.collectorId,type:"POINT"},null,8,["modelValue","onUpdate:modelValue","id"])]),_:2},1032,["name","rules"])):p("",!0),a.dataIndex==="id"?(r(),M(P,{key:3},[d[a.dataIndex]?(r(),c(x,{key:0,status:"success",text:"已绑定"})):(r(),c(x,{key:1,status:"error",text:"未绑定"}))],64)):p("",!0),a.key==="action"?(r(),c(Q,{key:4,type:"link",tooltip:{title:"解绑"},popConfirm:{title:"确认解绑",onConfirm:()=>F(d.id)},disabled:!d.id},{default:n(()=>[s(k,{type:"icon-jiebang"})]),_:2},1032,["popConfirm","disabled"])):p("",!0)]),_:1},8,["dataSource"])]),_:1},8,["model"])]),_:1}),l(g)?(r(),c(ye,{key:0,deviceId:l(u).current.id,onClose:e[1]||(e[1]=a=>g.value=!1),onSave:D,type:j.provider,metaData:l(f).dataSource},null,8,["deviceId","type","metaData"])):p("",!0)]),_:1},8,["spinning"])):(r(),c(T,{key:1,bordered:!1,borderStyle:"padding: 0"},{default:n(()=>[s(G,{description:"暂无数据，请配置物模型",style:{margin:"10% 0"}})]),_:1}))}}});const Je=_e(be,[["__scopeId","data-v-9b73bda6"]]);export{Je as default};
