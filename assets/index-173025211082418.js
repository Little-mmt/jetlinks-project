import{d as q,ac as re,k as m,e as L,w as P,s as ue,U as i,V as f,X as u,f as r,E as b,u as e,Y as p,Z as h,F as S,a1 as ie,$ as T,_ as N,af as se,ag as de}from"./vue-1730252110824.js";import{a4 as j,aC as R,a6 as ce,v as pe,I as fe,a7 as ve,aD as me,aJ as ge,aK as _e,a8 as ye,a9 as be,F as he,d as Ce,Z as Ie,aa as ke,g as Be}from"./index-1730252110824.js";import"./index-1730252110824290.js";import"./index-1730252110824279.js";import{m as Ae,v as we,x as Le}from"./collector-1730252110824.js";import{L as d}from"./data-17302521108242.js";import"./validate-1730252110824.js";import"./regular-1730252110824.js";const Se=_=>(se("data-v-801ed2b4"),_=_(),de(),_),Te={key:12,style:{color:"#616161"}},xe={key:15,style:{color:"#616161"}},Ee=Se(()=>N("p",null," 只有4字节数据类型(int32、ieee754 float) 具有4种内存布局，其它只有ABCD、DCBA两种内存布局(以双字配置为准) ",-1)),Ue=q({name:"CollectorTreeSave"}),Oe=q({...Ue,props:{data:{type:Object,default:()=>{}},channelListAll:{type:Array,default:()=>[]}},emits:["change"],setup(_,{emit:x}){const C=_,Y=re(),I=m(!1),k=m(!1),E=m(!1),W=m([{value:"S200",label:"S7-200"},{value:"S300",label:"S7-300"},{value:"S400",label:"S7-400"},{value:"S1200",label:"S7-1200"},{value:"S1500",label:"S7-1500"}]),y=C.data.id,U=m(),s=m(),B=m(),F=async()=>{const o=await Ae();o.success?B.value=o.result.map(a=>({label:a.name,value:a.id})):B.value=[]},A=L(()=>C.channelListAll||[]),M=L(()=>{const o=[];return A.value.forEach(a=>{var v;((v=a==null?void 0:a.state)==null?void 0:v.value)!=="disabled"&&o.push({provider:a.provider,value:a.id,label:a.name})}),o}),z=(o,a)=>{console.log(a),s.value=a.provider},J=L(()=>{const{endian:o,endianIn:a}=n.value.configuration;if(o)return a?o==="BIG"?a==="BIG"?"ABCD":"BADC":a==="BIG"?"CDAB":"DCBA":o==="BIG"?"ABCD":"DCBA"}),n=m({channelId:void 0,name:"",collectorProvider:void 0,configuration:{unitId:"",type:void 0,endian:"BIG",endianIn:"BIG",requestTimeout:2e3,serializable:!1,inheritBreakerSpec:{type:"LowerFrequency"}},circuitBreaker:{type:"Ignore"},description:""}),$=async()=>{var a;const o=await((a=U.value)==null?void 0:a.validate());if(o){const{name:v}=A.value.find(c=>c.id===n.value.channelId);let l=o;if(["COLLECTOR_GATEWAY"].includes(s.value)){const c=j(o);l=R(c,["configuration","collectorProvider"]),l.configuration={configuration:{...o.configuration,inheritBreakerSpec:{type:"Ignore"}},collectorProvider:o.collectorProvider}}const g={...l,provider:s.value,channelName:v,circuitBreaker:{type:"Ignore"}};I.value=!0;try{const c=y?await Le(y,{...C.data,...g}):await we(g);I.value=!1,c.success&&x("change",!0)}catch{I.value=!1}}},V=o=>{switch(o){case"LowerFrequency":return"连续20次采集异常后，降低采集频率至设定频率的1/10，故障处理后，采集频率将恢复至设定频率。";case"Break":return"连续20次采集异常后，降低采集频率至设定频率的1/10，10分钟内未排除故障，将停止采集。";case"Ignore":return"忽略异常，保持设定采集频率。";default:return""}},O=()=>{x("change",!1)},Z=o=>{n.value.configuration.inheritBreakerSpec.type=o[0]},K=o=>{n.value.configuration.endian=o[0]},X=o=>{n.value.configuration.endianIn=o[0]},D=(o,a)=>a.label.toLowerCase().indexOf(o.toLowerCase())>=0,H=o=>{(o=="S200"||o=="S1200")&&(n.value.configuration.slot=1)};return P(()=>n.value.channelId,o=>{const a=A.value.find(v=>v.id===o);E.value=k.value=(a==null?void 0:a.provider)&&["MODBUS_TCP","COLLECTOR_GATEWAY"].includes(a==null?void 0:a.provider)},{deep:!0}),P(()=>C.data,o=>{var a,v;if(o.id){let l=j(o);!((a=l==null?void 0:l.configuration)!=null&&a.inheritBreakerSpec)&&l.provider!=="COLLECTOR_GATEWAY"&&(l.configuration={...l.configuration,inheritBreakerSpec:{type:(v=o.circuitBreaker)==null?void 0:v.type}},l.circuitBreaker.type="Ignore"),l.provider==="COLLECTOR_GATEWAY"?n.value={...R(l,["configuration"]),...l.configuration}:n.value=l,s.value=l==null?void 0:l.provider}},{immediate:!0,deep:!0}),ue(()=>{s.value==="COLLECTOR_GATEWAY"&&F()}),(o,a)=>{const v=ce,l=pe,g=fe,c=ve,Q=me,G=ge,ee=_e,w=ye,ae=be,ne=he,te=Ce,le=Ie,oe=ke;return i(),f(oe,{title:_.data.id?"编辑":"新增",visible:!0,width:"700px",maskClosable:!1,onCancel:O},{footer:u(()=>[r(te,{key:"back",onClick:O},{default:u(()=>[b("取消")]),_:1}),r(le,{key:"submit",type:"primary",loading:e(I),onClick:$,style:{"margin-left":"8px"},hasPermission:`DataCollect/Collector:${e(y)?"update":"add"}`},{default:u(()=>[b(" 确认 ")]),_:1},8,["loading","hasPermission"])]),default:u(()=>[r(ne,{class:"form",layout:"vertical",model:e(n),name:"basic",autocomplete:"off",ref_key:"formRef",ref:U},{default:u(()=>[r(l,{label:"所属通道",name:"channelId",rules:e(d).channelId},{default:u(()=>[r(v,{style:{width:"100%"},value:e(n).channelId,"onUpdate:value":a[0]||(a[0]=t=>e(n).channelId=t),options:e(M),placeholder:"请选择所属通道",allowClear:"","show-search":"","filter-option":D,disabled:!!e(y),onSelect:z},null,8,["value","options","disabled"])]),_:1},8,["rules"]),r(l,{label:"采集器名称",name:"name",rules:e(d).name},{default:u(()=>[r(g,{placeholder:"请输入采集器名称",value:e(n).name,"onUpdate:value":a[1]||(a[1]=t=>e(n).name=t)},null,8,["value"])]),_:1},8,["rules"]),e(s)==="snap7"?(i(),f(l,{key:0,label:"IP",name:["configuration","host"],rules:e(d).host},{default:u(()=>[r(g,{value:e(n).configuration.host,"onUpdate:value":a[2]||(a[2]=t=>e(n).configuration.host=t),autocomplete:"off",placeholder:"请输入通道IP",disabled:!1},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(s)==="snap7"?(i(),f(l,{key:1,label:"端口",name:["configuration","port"],rules:e(d).port},{default:u(()=>[r(c,{style:{width:"100%"},value:e(n).configuration.port,"onUpdate:value":a[3]||(a[3]=t=>e(n).configuration.port=t),precision:0,autocomplete:"off",placeholder:"请输入通道端口"},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(s)==="snap7"?(i(),f(l,{key:2,label:"机架号",name:["configuration","rack"],rules:e(d).rack},{default:u(()=>[r(c,{style:{width:"100%"},value:e(n).configuration.rack,"onUpdate:value":a[4]||(a[4]=t=>e(n).configuration.rack=t),autocomplete:"off",placeholder:"请输入机架号",maxlength:64},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(s)==="snap7"?(i(),f(l,{key:3,label:"型号",name:["configuration","type"],rules:e(d).type},{default:u(()=>[r(v,{value:e(n).configuration.type,"onUpdate:value":a[5]||(a[5]=t=>e(n).configuration.type=t),placeholder:"请选择型号",onChange:H},{default:u(()=>[(i(!0),h(S,null,ie(e(W),t=>(i(),f(Q,{key:t.value,value:t.value},{default:u(()=>[b(T(t.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1},8,["rules"])):p("",!0),e(s)==="snap7"?(i(),f(l,{key:4,label:"槽位",name:["configuration","slot"],rules:e(d).slot},{default:u(()=>[r(c,{style:{width:"100%"},value:e(n).configuration.slot,"onUpdate:value":a[6]||(a[6]=t=>e(n).configuration.slot=t),autocomplete:"off",placeholder:"请输入槽位",maxlength:64,disabled:e(n).configuration.type=="S200"||e(n).configuration.type=="S1200"},null,8,["value","disabled"])]),_:1},8,["rules"])):p("",!0),e(s)==="snap7"?(i(),f(l,{key:5,label:"超时时间（毫秒）",name:["configuration","timeout"],rules:e(d).timeout},{default:u(()=>[r(c,{style:{width:"100%"},value:e(n).configuration.timeout,"onUpdate:value":a[7]||(a[7]=t=>e(n).configuration.timeout=t),autocomplete:"off",placeholder:"请输入超时时间",maxlength:64},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(s)==="snap7"?(i(),f(l,{key:6,label:"数据读取方式",name:["configuration","serializable"]},{default:u(()=>[r(ee,{value:e(n).configuration.serializable,"onUpdate:value":a[8]||(a[8]=t=>e(n).configuration.serializable=t)},{default:u(()=>[r(G,{value:!1},{default:u(()=>[b("并行")]),_:1}),r(G,{value:!0},{default:u(()=>[b("串行")]),_:1})]),_:1},8,["value"])]),_:1})):p("",!0),e(s)==="iec104"?(i(),h(S,{key:7},[r(l,{label:"从机地址",name:["configuration","host"],rules:e(d).host},{default:u(()=>[r(g,{value:e(n).configuration.host,"onUpdate:value":a[9]||(a[9]=t=>e(n).configuration.host=t),autocomplete:"off",placeholder:"请输入",disabled:!1},null,8,["value"])]),_:1},8,["rules"]),r(l,{label:"从机端口",name:["configuration","port"],rules:e(d).port},{default:u(()=>[r(c,{style:{width:"100%"},value:e(n).configuration.port,"onUpdate:value":a[10]||(a[10]=t=>e(n).configuration.port=t),min:1,max:65535,precision:0,autocomplete:"off",placeholder:"请输入从机端口"},null,8,["value"])]),_:1},8,["rules"]),r(l,{label:"分组地址",name:["configuration","terminnalAddress"],rules:e(d).terminnalAddress},{default:u(()=>[r(c,{style:{width:"100%"},min:0,max:65535,precision:0,value:e(n).configuration.terminnalAddress,"onUpdate:value":a[11]||(a[11]=t=>e(n).configuration.terminnalAddress=t),autocomplete:"off",placeholder:"请输入分组地址"},null,8,["value"])]),_:1},8,["rules"]),r(l,{label:"确认帧数量",name:["configuration","frameAmountMax"],rules:e(d).frameAmountMax},{default:u(()=>[r(c,{style:{width:"100%"},value:e(n).configuration.frameAmountMax,"onUpdate:value":a[12]||(a[12]=t=>e(n).configuration.frameAmountMax=t),placeholder:"请输入确认帧数量",min:1,maxlength:16,precision:0},null,8,["value"])]),_:1},8,["rules"])],64)):p("",!0),e(s)==="COLLECTOR_GATEWAY"?(i(),f(l,{key:8,label:"通讯协议",name:["collectorProvider"],rules:[{required:!0,message:"请选择通讯协议"}]},{default:u(()=>[r(v,{style:{width:"100%"},value:e(n).collectorProvider,"onUpdate:value":a[13]||(a[13]=t=>e(n).collectorProvider=t),options:e(B),placeholder:"请选择通讯协议",allowClear:"","show-search":"","filter-option":D,disabled:!!e(y)},null,8,["value","options","disabled"])]),_:1})):p("",!0),e(E)?(i(),f(l,{key:9,name:["configuration","unitId"],rules:e(d).unitId,label:"从机地址"},{default:u(()=>[r(c,{style:{width:"100%"},placeholder:"请输入从机地址",value:e(n).configuration.unitId,"onUpdate:value":a[14]||(a[14]=t=>e(n).configuration.unitId=t),min:0,max:255},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(s)==="BACNetIp"?(i(),h(S,{key:10},[r(l,{label:"设备实例号",name:["configuration","instanceNumber"],rules:[{required:!0,trigger:"change"}]},{default:u(()=>[r(c,{style:{width:"100%"},value:e(n).configuration.instanceNumber,"onUpdate:value":a[15]||(a[15]=t=>e(n).configuration.instanceNumber=t),placeholder:"请输入设备实例号",min:0,precision:0,disabled:!!e(Y).query.id},null,8,["value","disabled"])]),_:1}),r(l,{label:"地址",name:["configuration","address"],rules:e(d).address},{default:u(()=>[r(g,{style:{width:"100%"},value:e(n).configuration.address,"onUpdate:value":a[16]||(a[16]=t=>e(n).configuration.address=t),maxlength:64,placeholder:"请输入地址"},null,8,["value"])]),_:1},8,["rules"])],64)):p("",!0),e(s)!=="COLLECTOR_GATEWAY"?(i(),f(l,{key:11,name:["configuration","inheritBreakerSpec","type"],rules:e(d).type,label:"点位熔断处理"},{default:u(()=>[r(w,{showImage:!1,value:e(n).configuration.inheritBreakerSpec.type,"onUpdate:value":a[17]||(a[17]=t=>e(n).configuration.inheritBreakerSpec.type=t),options:[{label:"降频",value:"LowerFrequency"},{label:"断开",value:"Break"},{label:"忽略",value:"Ignore"}],onChange:Z},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(s)!=="COLLECTOR_GATEWAY"?(i(),h("p",Te,T(V(e(n).configuration.inheritBreakerSpec.type)),1)):p("",!0),e(k)?(i(),f(l,{key:13,name:["configuration","endian"],rules:e(d).endian,label:"双字高低位切换"},{default:u(()=>[r(w,{showImage:!1,value:e(n).configuration.endian,"onUpdate:value":a[18]||(a[18]=t=>e(n).configuration.endian=t),options:[{label:"AB",value:"BIG"},{label:"BA",value:"LITTLE"}],onChange:K,column:2},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(k)?(i(),f(l,{key:14,name:["configuration","endianIn"],rules:e(d).endianIn,label:"单字高低位切换"},{default:u(()=>[r(w,{showImage:!1,value:e(n).configuration.endianIn,"onUpdate:value":a[19]||(a[19]=t=>e(n).configuration.endianIn=t),options:[{label:"AB",value:"BIG"},{label:"BA",value:"LITTLE"}],onChange:X,column:2},null,8,["value"])]),_:1},8,["rules"])):p("",!0),e(k)?(i(),h("div",xe,[N("p",null,"当前内存布局: "+T(e(J)),1),Ee])):p("",!0),e(s)!=="snap7"?(i(),f(l,{key:16,name:["configuration","requestTimeout"],rules:e(d).requestTimeout,label:"请求超时时间"},{default:u(()=>[r(c,{style:{width:"100%"},placeholder:"请输入请求超时时间配置",value:e(n).configuration.requestTimeout,"onUpdate:value":a[20]||(a[20]=t=>e(n).configuration.requestTimeout=t),"addon-after":"ms",max:6e4,min:2e3},null,8,["value"])]),_:1},8,["rules"])):p("",!0),r(l,{label:"说明",name:"description"},{default:u(()=>[r(ae,{placeholder:"请输入说明",value:e(n).description,"onUpdate:value":a[21]||(a[21]=t=>e(n).description=t),maxlength:200,rows:3,showCount:""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])}}});const We=Be(Oe,[["__scopeId","data-v-801ed2b4"]]);export{We as default};
