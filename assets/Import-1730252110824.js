import{k as h,ac as X,ab as z,U as b,Z as T,f,X as i,E as k,u as p,V as A,_,$ as N,Y as G,F as Z,d as q,af as H,ag as Q}from"./vue-1730252110824.js";import{g as ee,T as j,L as te,d4 as ae,fc as oe,dh as se,fd as ne,P as le,o as C,fe as re,cY as ce,di as ue,v as de,d as pe,F as ie,d3 as fe}from"./index-1730252110824.js";import{j as _e}from"./product-17302521108244.js";import{s as ve,d as ye}from"./context-1730252110824.js";import{u as me}from"./product-17302521108245.js";import"./encodeQuery-1730252110824.js";const ge=e=>e.valueType.format?!0:(console.log("validateDate - error",e.valueType.format),!1),be=e=>{var t;return(t=e.valueType.elements)!=null&&t.length&&e.valueType.elements.every(a=>a.value&&a.text)?!0:(console.log("validateEnum - error",e.valueType),!1)},xe=e=>e.valueType.bodyType?!0:(console.log("validateFile - error",e.valueType.bodyType),!1),he=e=>{var a;const{valueType:t}=e;return(a=t.elementType)!=null&&a.type?I(t.elementType.type,t.elementType):(console.log("validateArray - error",t.elementType),!1)},Te=e=>{var a;const{valueType:t}=e;return(a=t.properties)!=null&&a.length?t.properties.every(s=>!s.id||!s.name||!s.valueType.type?(console.log("validateArray - error",s),!1):I(s.valueType.type,s)):!1},S={enum:be,date:ge,file:xe,array:he,object:Te},I=(e,t)=>Object.keys(S).includes(e)?S[e](t):!0,ke=e=>{var t,a,s,u;return!e||!e.id||!e.name||!((t=e.valueType)!=null&&t.type)||!((a=e.expands)!=null&&a.source)||!((u=(s=e.expands)==null?void 0:s.type)!=null&&u.length)?(console.log("validateItem - error",e),!1):(console.log(e.valueType.type),I(e.valueType.type,e))},Ce=(e,t,a)=>{const s=new Map,u=[];t.forEach((d,r)=>{s.set(d.id,r)});for(let d=e.length-1;d>=0;d--){const r=e[d],c=ke(r);c&&(s.has(r.id)?(t.splice(s.get(r.id),1,r),e.splice(d,1)):u.push(r)),a==null||a(c)}return[...t,...u]};const w=e=>(H("data-v-8d27f36e"),e=e(),Q(),e),Ie={class:"dragger-box"},we=w(()=>_("span",{style:{margin:"16px 0 8px 0"}},"点击或拖拽上传文件",-1)),Fe=w(()=>_("span",null,"格式：.xlsx, .csv",-1)),Oe={class:"file-download"},De={key:1},Ee=w(()=>_("span",null," 正在导入，请稍后... ",-1)),Ae=[Ee],Ne={key:2},je=q({name:"MetadataImport"}),Se=Object.assign(je,{props:{target:{type:String,default:void 0},metadata:{type:Array,default:()=>[]}},emits:["ok"],setup(e,{emit:t}){const a=e,{current:s}=me(),u=h(!1),d=h(0),r=h(0),c=h(1),x=ve(),M=ye();let F=[];const O=X(),V=o=>ae()&&M.value||document.body,K=()=>{c.value=1,d.value=0,r.value=0},P=()=>{K(),u.value=!0},U=()=>{u.value=!1},D=async o=>{if(o){const v=JSON.parse(o||"{}").properties,y=a.metadata.filter(l=>{var g;return l.id&&!((g=l.expands)!=null&&g.isProduct)}),m=v.map(l=>(l.expands?(l.expands.groupId=x.value,l.expands.groupName=x.label):l.expands={groupId:x.value,groupName:x.label},l));F=Ce(m,y,l=>{l?d.value+=1:r.value+=1}),c.value=3}else C("请先上传文件","error")},$=()=>{t("ok",F),u.value=!1},E=o=>{const n=a.target==="device"?oe(O.params.id,o):_e(O.params.id,o);se(n+`?${ne}=${le()}`,"物模型模版",o)},B=()=>{},L=o=>{const n=o.type==="text/csv",v=o.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";!n&&!v&&C("请上传.xlsx或.csv格式文件","warning");const y=new FormData;return y.append("file",o),c.value=2,re(s.id,y).then(m=>{m.success&&D(m.result)}),!1},Y=async o=>{if(o.file.status==="uploading"&&(c.value=2),o.file.status==="done"){const n=o.file.response||{result:{}};await D((n==null?void 0:n.result)||"")}o.file.status==="error"&&C("上传失败","error")};return(o,n)=>{const v=z("AIcon"),y=ce,m=ue,l=de,g=pe,R=ie,J=fe;return b(),T(Z,null,[f(y,{type:"primary",ghost:"",onClick:P},{icon:i(()=>[f(v,{type:"DownloadOutlined"})]),default:i(()=>[k(" 导入 ")]),_:1}),p(u)?(b(),A(J,{key:0,visible:"",title:p(c)===1?"批量导入":"导入结果",width:600,keyboard:!1,maskClosable:!1,okButtonProps:{disabled:p(c)!==3},getContainer:V,onCancel:U,onOk:$},{default:i(()=>[p(c)===1?(b(),A(R,{key:0,layout:"vertical"},{default:i(()=>[f(l,{label:"上传文件"},{default:i(()=>[f(m,{name:"file",headers:{[p(j)]:p(te).get(p(j))},maxCount:1,showUploadList:!1,accept:".xlsx,.csv","before-upload":L,onChange:Y,onDrop:B},{default:i(()=>[_("div",Ie,[f(v,{class:"icon",type:"PlusCircleFilled"}),we,Fe])]),_:1},8,["headers","accept"])]),_:1}),f(l,{label:"下载模版"},{default:i(()=>[_("div",Oe,[f(g,{class:"btn",onClick:n[0]||(n[0]=W=>E("xlsx"))},{default:i(()=>[k("模板格式.xlsx")]),_:1}),f(g,{class:"btn",onClick:n[1]||(n[1]=W=>E("csv"))},{default:i(()=>[k("模板格式.csv")]),_:1})])]),_:1})]),_:1})):p(c)===2?(b(),T("div",De,Ae)):(b(),T("div",Ne,[_("div",null," 导入成功： "+N(p(d))+"条 ",1),_("div",null," 导入失败： "+N(p(r))+"条 ",1)]))]),_:1},8,["title","okButtonProps"])):G("",!0)],64)}}}),Be=ee(Se,[["__scopeId","data-v-8d27f36e"]]);export{Be as default};
