import{h as P,dG as Q,v as w,aD as ee,a6 as se,F as ae}from"./index-1731638920964.js";import te from"./TopCard-17316389209646.js";import{_ as ne}from"./EditTable.vue_vue_type_script_setup_true_lang-17316389209642.js";import{_ as re}from"./WriteProperty.vue_vue_type_script_setup_true_lang-1731638920964.js";import{u as oe}from"./scene-17316389209642.js";import{d as Y,ai as ue,k as N,r as le,e as T,w as U,U as d,Z as I,f as g,X as m,u as o,F as C,a1 as F,V as b,E as M,$ as j,G as x,Y as L}from"./vue-1731638920964.js";import{g as pe}from"./util-17316389209642.js";const ie=Y({name:"ActionDeviceActions"}),ye=Y({...ie,props:{values:{type:Object,default:()=>{}},name:{type:Number,default:0},thenName:{type:Number,default:0},branchesName:{type:Number,default:0},productDetail:{type:Object,default:()=>{}},columnMap:{type:Object,default:()=>({})}},emits:["change"],setup(D,{expose:K,emit:O}){const p=D,V=oe(),{data:W}=ue(V),q=[{label:"功能调用",value:"INVOKE_FUNCTION",image:P("/scene/invoke-function.png"),tip:"",disabled:!1},{label:"读取属性",value:"READ_PROPERTY",image:P("/scene/read-property.png"),tip:"",disabled:!1},{label:"设置属性",value:"WRITE_PROPERTY",image:P("/scene/write-property.png"),tip:"",disabled:!1}],S=N(),i=N(p.columnMap||{}),t=le({message:{messageType:"INVOKE_FUNCTION",functionId:void 0,properties:void 0,inputs:[]},propertiesValue:""}),R=N(),A=(s,e)=>{i.value={},t.message.inputs=[],O("change",{propertiesName:e==null?void 0:e.label,propertiesValue:t.propertiesValue})},B=(s,e)=>{O("change",{propertiesName:e==null?void 0:e.label,propertiesValue:t.propertiesValue})},J=[{validator(s,e){const r=h.value.filter(n=>{var l;return(l=n==null?void 0:n.expands)==null?void 0:l.required});if(r.length)if(e!=null&&e.length){const n=e==null?void 0:e.find(l=>l.value===void 0);if(n){const l=r==null?void 0:r.find(c=>c.id===n.name);return Promise.reject(l!=null&&l.name?`请输入${l.name}值`:"请输入功能值")}}else return Promise.reject("请输入功能值");return Promise.resolve()},trigger:["change","blur"]}],f=N({functions:[],properties:[]}),v=T(()=>t.message.messageType),E=N([]),h=T(()=>{var e;const s=(((e=f.value)==null?void 0:e.functions)||[]).find(r=>{var n;return((n=t.message)==null?void 0:n.functionId)===r.id});return(s==null?void 0:s.inputs)||[]}),$=T(()=>{var e;return(((e=f.value)==null?void 0:e.properties)||[]).find(r=>{var n,l,c;return v.value==="WRITE_PROPERTY"?((n=Object.keys(t.message.properties||{}))==null?void 0:n[0])===r.id:((c=(l=t.message)==null?void 0:l.properties)==null?void 0:c[0])===r.id})}),G=T(()=>{var e;return(((e=f.value)==null?void 0:e.functions)||[]).find(r=>{var n;return((n=t.message)==null?void 0:n.functionId)===r.id})}),k=async()=>{const s={branch:p.thenName,branchGroup:p.branchesName,action:p.name-1},e=await pe(s,o(W));E.value=e},X=s=>{i.value={};const e=["WRITE_PROPERTY","INVOKE_FUNCTION"].includes(s);t.message={messageType:s,functionId:void 0,properties:e?void 0:[],inputs:[]},e&&k()},Z=(s,e)=>{var r,n;t.propertiesValue=s,O("change",{propertiesName:v.value==="INVOKE_FUNCTION"?(r=G.value)==null?void 0:r.name:(n=$.value)==null?void 0:n.name,propertiesValue:t.propertiesValue},e)},z=()=>new Promise((s,e)=>{S.value.validate().then(async r=>{var n;R.value&&(await((n=R.value)==null?void 0:n.onSave())||e(!1)),s({message:{...t.message,...r.message}})}).catch(r=>{e(r)})}),H=()=>i.value;return U(()=>p.productDetail,s=>{var e,r,n,l,c,u;if(s!=null&&s.id)if(((e=p.values)==null?void 0:e.selector)==="fixed"&&((n=(r=p.values)==null?void 0:r.selectorValues)==null?void 0:n.length)===1){const a=(u=(c=(l=p.values)==null?void 0:l.selectorValues)==null?void 0:c[0])==null?void 0:u.value;a&&Q(a).then(_=>{var y;_.status===200&&(f.value=JSON.parse(((y=_.result)==null?void 0:y.metadata)||"{}"))})}else f.value=JSON.parse((s==null?void 0:s.metadata)||"{}")},{immediate:!0}),U(()=>{var s;return(s=p.values)==null?void 0:s.message},s=>{s!=null&&s.messageType&&(t.message=JSON.parse(JSON.stringify(s)),["WRITE_PROPERTY","INVOKE_FUNCTION"].includes(s.messageType)?k():t.message.properties||(t.message=Object.assign(t.message,{properties:[]})))},{immediate:!0}),K({onFormSave:z,getColumnMap:H}),(s,e)=>{const r=w,n=ee,l=se,c=ae;return d(),I("div",null,[g(c,{layout:"vertical",ref_key:"formRef",ref:S,model:o(t)},{default:m(()=>[g(r,{name:["message","messageType"],label:"动作类型",rules:[{required:!0,message:"请选择动作类型"}]},{default:m(()=>[g(te,{typeList:q,value:o(t).message.messageType,"onUpdate:value":e[0]||(e[0]=u=>o(t).message.messageType=u),onChange:X},null,8,["value"])]),_:1}),o(v)==="INVOKE_FUNCTION"?(d(),I(C,{key:0},[g(r,{name:["message","functionId"],label:"功能调用",rules:[{required:!0,message:"请选择功能"}]},{default:m(()=>[g(l,{showSearch:"",placeholder:"请选择功能",value:o(t).message.functionId,"onUpdate:value":e[1]||(e[1]=u=>o(t).message.functionId=u),onChange:A},{default:m(()=>{var u;return[(d(!0),I(C,null,F(((u=o(f))==null?void 0:u.functions)||[],a=>(d(),b(n,{value:a==null?void 0:a.id,key:a==null?void 0:a.id,label:a==null?void 0:a.name},{default:m(()=>[M(j(a==null?void 0:a.name),1)]),_:2},1032,["value","label"]))),128))]}),_:1},8,["value"])]),_:1}),o(t).message.functionId&&o(h).length?(d(),b(r,{key:0,name:["message","inputs"],rules:J},{default:m(()=>[g(ne,{value:o(t).message.inputs,"onUpdate:value":e[2]||(e[2]=u=>o(t).message.inputs=u),columnMap:o(i),"onUpdate:columnMap":e[3]||(e[3]=u=>x(i)?i.value=u:null),functions:o(h),builtInList:o(E)},null,8,["value","columnMap","functions","builtInList"])]),_:1})):L("",!0)],64)):o(v)==="READ_PROPERTY"?(d(),b(r,{key:1,name:["message","properties"],label:"读取属性",rules:[{required:!0,message:"请选择读取属性"}]},{default:m(()=>[g(l,{showSearch:"",placeholder:"请选择属性",value:o(t).message.properties[0],"onUpdate:value":e[4]||(e[4]=u=>o(t).message.properties[0]=u),onChange:B},{default:m(()=>{var u;return[(d(!0),I(C,null,F((((u=o(f))==null?void 0:u.properties)||[]).filter(a=>{var _,y;return(y=(_=a==null?void 0:a.expands)==null?void 0:_.type)==null?void 0:y.includes("read")})||[],a=>(d(),b(n,{value:a==null?void 0:a.id,key:a==null?void 0:a.id,label:a==null?void 0:a.name},{default:m(()=>[M(j(a==null?void 0:a.name),1)]),_:2},1032,["value","label"]))),128))]}),_:1},8,["value"])]),_:1})):o(v)==="WRITE_PROPERTY"?(d(),b(re,{key:2,ref_key:"writeFormRef",ref:R,value:o(t).message.properties,"onUpdate:value":e[5]||(e[5]=u=>o(t).message.properties=u),columnMap:o(i),"onUpdate:columnMap":e[6]||(e[6]=u=>x(i)?i.value=u:null),metadata:o(f),builtInList:o(E),onChange:Z},null,8,["value","columnMap","metadata","builtInList"])):L("",!0)]),_:1},8,["model"])])}}});export{ye as _};
