import{aD as W,a6 as X,fz as Y,I as Z,fI as $}from"./index-1730252110824.js";import{d as E,ai as J,e as w,k as A,w as O,U as r,V as p,X as y,f as V,u as o,G as Q,E as g,Z as m,F as P,$ as h,_ as q,Y as ee}from"./vue-1730252110824.js";import{u as te}from"./scene-17302521108242.js";import{C as T}from"./config-17302521108242.js";import{u as ae}from"./unionBy-1730252110824.js";const le={key:0,style:{display:"flex","justify-content":"space-between","margin-right":"10px"}},ne={style:{color:"#cfcfcf"}},se={key:1},oe={key:0,style:{display:"flex","justify-content":"space-between","margin-right":"10px"}},re={style:{color:"#cfcfcf"}},ie={key:1},ue=E({name:"NotifyUser"}),ve=E({...ue,props:{notify:{type:Object,default:()=>{}},value:{type:[Object],default:()=>{}}},emits:["update:value","change"],setup(k,{emit:j}){const v=k,H=te(),{data:M}=J(H),c=w(()=>{var e;return(e=v.notify)==null?void 0:e.notifyType}),z=w(()=>{var e;return(e=v.notify)==null?void 0:e.notifierId}),f=w(()=>{var e;return v.value&&((e=v.value)==null?void 0:e.source)||"relation"}),R=w(()=>{var e,t;return(t=(e=M.value)==null?void 0:e.trigger)==null?void 0:t.type}),U=w(()=>{var t;const e=v.value;if(c.value==="email"){if(e&&Array.isArray(e)&&e.length&&e[0].source==="relation")return e.map(a=>{var l,d,s,u;return((l=a.relation)==null?void 0:l.objectType)==="user"?(d=a==null?void 0:a.relation)==null?void 0:d.objectId:(u=(s=a==null?void 0:a.relation)==null?void 0:s.related)==null?void 0:u.relation})}else if((e==null?void 0:e.source)==="relation"){const a=e==null?void 0:e.relation;if(a)return a.objectId?a.objectId:(t=a.related)==null?void 0:t.relation}}),N=A([]),I=A([{title:"平台用户",value:"p1",key:"p1",selectable:!1,children:[]}]),b=A("relation"),S=new Map,G=async(e,t)=>{let a;e==="dingTalk"?a=await T.queryDingTalkUsers(t):a=await T.queryWechatUsers(t),a&&a.status===200&&(N.value=ae(a.result,"id").map(l=>({value:l.id,label:l.name})))},D=async(e,t)=>{const a=[{title:"平台用户",value:"p1",key:"p1",selectable:!1,children:[]}];let l;const d=await T.getPlatformUsers({paging:!1,sorts:[{name:"name",order:"asc"}]});t&&t==="device"&&e==="relation"&&(l=await T.getRelationUsers({paging:!1,sorts:[{name:"name",order:"asc"}]})),d.status===200&&(a[0].children=d.result.map(s=>(S.set(s.id,s),{...s,value:s.id,key:s.id,title:s.name}))),l&&l.success&&a.push({title:"关系用户",value:"p2",key:"p2",selectable:!1,children:l.result.map(s=>{const u={...s,value:s.relation,key:s.id,title:s.name,isRelation:!0};return S.set(s.relation,u),u})}),I.value=a},K=e=>{j("update:value",{source:e}),j("change",void 0)},L=(e="fixed",t,a)=>{const l={source:e};return e==="relation"?a?l.relation={objectType:"device",objectSource:{source:"upper",upperKey:"scene.deviceId"},related:{objectType:"user",relation:t}}:l.relation={objectType:"user",objectId:t}:l.value=t,l},_=(e="fixed",t,a)=>{var s;let l;const d=Array.isArray(a)?a:[a||""];if(Array.isArray(t))((s=v==null?void 0:v.notify)==null?void 0:s.notifyType)==="email"&&(e==="fixed"?l={source:"fixed",value:t}:l={source:"relation",relation:{objectType:"user",objectId:t==null?void 0:t[0]}});else{const u=S.get(t),C=u==null?void 0:u.isRelation;l=L(e,t,C)}j("update:value",l),j("change",d.filter(u=>!!u).join(","))};return O(()=>R.value,e=>{e&&f.value==="relation"&&D(f.value,e)},{deep:!0,immediate:!0}),O(()=>f.value,e=>{const t=e;b.value=t,t==="fixed"&&["dingTalk","weixin"].includes(c.value)?G(c.value,z.value):D(t,R.value)},{deep:!0,immediate:!0}),(e,t)=>{const a=W,l=X,d=Y,s=Z,u=$;return r(),p(u,{compact:""},{default:y(()=>{var C,B,F;return[V(l,{style:{width:"120px"},value:o(b),"onUpdate:value":t[0]||(t[0]=n=>Q(b)?b.value=n:null),onChange:K},{default:y(()=>[V(a,{key:"5",value:"relation"},{default:y(()=>[g(" 平台用户 ")]),_:1}),o(c)==="dingTalk"?(r(),p(a,{key:"1",value:"fixed"},{default:y(()=>[g(" 钉钉用户 ")]),_:1})):o(c)==="weixin"?(r(),p(a,{key:"2",value:"fixed"},{default:y(()=>[g(" 微信用户 ")]),_:1})):o(c)==="email"?(r(),p(a,{key:"3",value:"fixed"},{default:y(()=>[g(" 固定邮箱 ")]),_:1})):(r(),p(a,{key:"4",value:"fixed"},{default:y(()=>[g(" 固定号码 ")]),_:1}))]),_:1},8,["value"]),o(f)==="relation"?(r(),m(P,{key:0},[["email"].includes(o(c))?(r(),p(d,{key:0,style:{width:"calc(100% - 120px)"},placeholder:"请选择收信人",onChange:t[1]||(t[1]=(n,i)=>_(o(f),n,i)),"tree-data":o(I),multiple:!0,"dropdown-style":{maxHeight:"400px",overflow:"auto"},value:o(U),showSearch:"",allowClear:"",treeNodeFilterProp:"title"},{title:y(({key:n,username:i,title:x})=>[n!=="p1"&&n!=="p2"?(r(),m("div",le,[g(h(x)+" ",1),q("span",ne,h(i),1)])):(r(),m("span",se,h(x),1))]),_:1},8,["tree-data","value"])):(r(),p(d,{key:1,style:{width:"calc(100% - 120px)"},placeholder:"请选择收信人",onChange:t[2]||(t[2]=(n,i)=>_(o(f),n,i)),"tree-data":o(I),"dropdown-style":{maxHeight:"400px",overflow:"auto"},value:o(U),showSearch:"",allowClear:"",treeNodeFilterProp:"title"},{title:y(({key:n,username:i,title:x})=>[n!=="p1"&&n!=="p2"?(r(),m("div",oe,[g(h(x)+" ",1),q("span",re,h(i),1)])):(r(),m("span",ie,h(x),1))]),_:1},8,["tree-data","value"]))],64)):(r(),m(P,{key:1},[["dingTalk","weixin"].includes(o(c))?(r(),p(l,{key:0,style:{width:"calc(100% - 120px)"},placeholder:"请选择收信人",value:(C=k.value)==null?void 0:C.value,showSearch:"",allowClear:"",onChange:t[3]||(t[3]=(n,i)=>_(o(f),n,(i==null?void 0:i.label)||(i==null?void 0:i.name))),options:o(N)},null,8,["value","options"])):["email"].includes(o(c))?(r(),p(l,{key:1,style:{width:"calc(100% - 120px)"},placeholder:"请输入收件人邮箱,多个收件人用换行分隔",value:(B=k.value)==null?void 0:B.value,mode:"tags","max-tag-count":"responsive",onChange:t[4]||(t[4]=n=>_(o(f),n,Array.isArray(n)?n.join(","):n))},null,8,["value"])):["sms","voice"].includes(o(c))?(r(),p(s,{key:2,style:{width:"calc(100% - 120px)"},placeholder:"请输入固定号码",value:(F=k.value)==null?void 0:F.value,onChange:t[5]||(t[5]=n=>_(o(f),n.target.value,n.target.value))},null,8,["value"])):ee("",!0)],64))]}),_:1})}}});export{ve as _};
