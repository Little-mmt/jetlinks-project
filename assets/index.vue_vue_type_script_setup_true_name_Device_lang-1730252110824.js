import{d as T,e as E,ai as P,k as b,r as A,w as x,U as v,Z as J,f as c,X as d,v as M,u as s,A as z,V as h,E as G,$ as I,_ as X}from"./vue-1730252110824.js";import{h as _,o as Z,v as w,e as H,fz as Q,F as W}from"./index-1730252110824.js";import{u as Y}from"./scene-17302521108242.js";import ee from"./TopCard-17302521108246.js";import{C as ae}from"./config-17302521108242.js";import te from"./Device-1730252110824.js";import se from"./Tag-1730252110824.js";import{_ as le}from"./RelationSelect.vue_vue_type_script_setup_true_lang-1730252110824.js";import{g as re}from"./util-17302521108242.js";import{h as oe}from"./util-17302521108245.js";import{l as ne}from"./lodash.default-1730252110824.js";const m={fixed:{label:"自定义",value:"fixed",image:_("/scene/device-custom.png"),tip:"自定义选择当前产品下的任意设备",disabled:!1},relation:{label:"按关系",value:"relation",image:_("/scene/device-relation.png"),tip:"选择与触发设备具有相同关系的设备",disabled:!1},tag:{label:"按标签",value:"tag",image:_("/scene/device-tag.png"),tip:"按标签选择产品下具有特定标签的设备",disabled:!1},context:{label:"按变量",value:"context",image:_("/scene/device-variable.png"),tip:"选择设备ID为上游变量值的设备",disabled:!1}},ie={style:{color:"grey","margin-left":"5px"}},ue=T({name:"Device"}),Ne=T({...ue,props:{values:{type:Object,default:()=>{}},name:{type:Number,default:0},thenName:{type:Number,default:0},branchesName:{type:Number,default:0},parallel:{type:Boolean},productDetail:{type:Object,default:()=>{}}},emits:["save","cancel"],setup(N,{expose:S,emit:g}){const i=N,k=E(()=>ne.map(y.value,"value").includes("tag")),j=Y(),{data:V}=P(j),C=b(),e=A({selector:"fixed",selectorValues:void 0,deviceId:"",source:"",upperKey:""}),y=b([]),f=b([]),D=b([]),K=t=>t!=null&&t.length?t.map(a=>(a.children,{...a,title:a.name,value:a.id,disabled:!!a.children})):t,U=async()=>{var l;const t={branch:i.thenName,branchGroup:i.branchesName,action:i.name-1},a=await re(t,s(V));f.value=oe(K(a),"id"),(l=i.productDetail)!=null&&l.id&&q(i.productDetail)},q=async t=>{var n,u,o;let a=[m.fixed,m.context,m.relation,m.tag];const l=(u=(n=s(V))==null?void 0:n.trigger)==null?void 0:u.type,r=(o=JSON.parse((t==null?void 0:t.metadata)||"{}"))==null?void 0:o.tags;if(D.value=r||[],(r==null?void 0:r.length)===0&&(a[3].disabled=!0),l==="device"){const p=await ae.getRelationUsers({paging:!1,sorts:[{name:"createTime",order:"desc"}],terms:[{termType:"eq",column:"objectTypeName",value:"设备"}]});p.success&&p.result.length!==0&&(a[2].disabled=!0),a[1].disabled=!f.value.length}else i.name===0?a=[m.fixed,m.tag]:(a.splice(2,1),a[1].disabled=!f.value.length);console.log(a),y.value=a},B=t=>{e.selectorValues=void 0,e.selector=t},L=t=>{t&&(t.id?(e.deviceId=t==null?void 0:t.id,e.selectorValues=[{value:t.id,name:t.name}]):(e.deviceId="",e.selectorValues=[]),e.upperKey="",g("save",s(e),{name:t.name}))},$=(t,a)=>{e.deviceId="deviceId",e.source="upper",e.selectorValues=t,e.upperKey="scene.deviceId",g("save",s(e),{relationName:a.label})},F=(t,a)=>{t&&(e.deviceId="deviceId",e.source="fixed");const l=a.map((r,n)=>`${n!==0&&n!==(a||[]).length&&r.type?r.type==="and"?"并且":"或者":""}${r.name}为${r.value}`);g("save",s(e),{tagName:l.join("")})},O=(t,a)=>{e.deviceId=t,e.source="upper",e.upperKey=t,e.selectorValues=void 0,g("save",s(e),{name:a.description})};return x(()=>i.values,t=>{Object.assign(e,t)},{immediate:!0,deep:!0}),x(()=>i.productDetail,t=>{U()},{immediate:!0,deep:!0}),x(()=>[i.values,f.value],([t,a])=>{var l,r,n;if(a&&a.length){const u=(r=(l=t==null?void 0:t.selectorValues)==null?void 0:l[0])==null?void 0:r.value;((n=a||[])==null?void 0:n.find(p=>p.children.find(R=>R.id===u)))&&(e.selector="context")}},{immediate:!0,deep:!0}),S({onFormSave:()=>new Promise((t,a)=>{C.value.validate().then(async l=>{var r,n;e.selector==="fixed"?(n=(r=e==null?void 0:e.selectorValues)==null?void 0:r[0])!=null&&n.value?t({...l,selectorValues:e.selectorValues}):(Z("请选择设备","error"),a(!1)):t({...l})}).catch(l=>{a(l)})})}),(t,a)=>{const l=w,r=H,n=Q,u=W;return v(),J("div",null,[c(u,{layout:"vertical",ref_key:"formRef",ref:C,model:s(e)},{default:d(()=>[M(c(l,{name:"selector",label:"选择方式",rules:[{required:!0,message:"请选择方式"}]},{default:d(()=>[c(ee,{typeList:s(y),value:s(e).selector,"onUpdate:value":a[0]||(a[0]=o=>s(e).selector=o),onChange:B},null,8,["typeList","value"])]),_:1},512),[[z,s(y).length!==1]]),s(e).selector==="fixed"?(v(),h(te,{key:0,productId:N.productDetail.id,value:s(e).selectorValues,"onUpdate:value":a[1]||(a[1]=o=>s(e).selectorValues=o),onChange:L},null,8,["productId","value"])):s(e).selector==="relation"?(v(),h(l,{key:1,label:"关系",name:"selectorValues",rules:[{required:!0,message:"请选择关系"}]},{default:d(()=>[c(le,{onChange:$,value:s(e).selectorValues,"onUpdate:value":a[2]||(a[2]=o=>s(e).selectorValues=o)},null,8,["value"])]),_:1})):s(e).selector==="tag"&&s(k)?(v(),h(l,{key:2,name:"selectorValues",rules:[{required:!0,message:"请选择标签"}]},{default:d(()=>[c(se,{value:s(e).selectorValues,"onUpdate:value":a[3]||(a[3]=o=>s(e).selectorValues=o),tagData:s(D),onChange:F},null,8,["value","tagData"])]),_:1})):(v(),h(l,{key:3,name:"upperKey",label:"变量",rules:[{required:!0,message:"请选择"}]},{default:d(()=>[c(n,{style:{width:"100%",height:"100%"},"tree-data":s(f),value:s(e).upperKey,"onUpdate:value":a[4]||(a[4]=o=>s(e).upperKey=o),placeholder:"请选择参数",onSelect:O,fieldNames:{label:"name",value:"id"}},{title:d(({name:o,description:p})=>[c(r,null,{default:d(()=>[G(I(o)+" ",1),X("span",ie,I(p),1)]),_:2},1024)]),_:1},8,["tree-data","value"])]),_:1}))]),_:1},8,["model"])])}}});export{Ne as _};
