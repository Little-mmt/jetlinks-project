import{d as W,ac as oe,k as J,e as se,r as ue,o as pe,ab as ne,U as E,V as w,X as _,_ as R,f as d,Z as B,F,E as b,u as y,Y as N,a1 as le,$ as ae,G as K,af as fe,ag as ce}from"./vue-1731638920964.js";import{o as s,ap as ye,P as ve,aC as ie,eW as Y,aa as G,aD as Te,a6 as _e,v as $e,d as de,as as ge,$ as he,e as ke,ec as Ee,F as Se,g as be}from"./index-1731638920964.js";import{a as we,q as De,c as Oe,m as Q}from"./product-17316389209644.js";import{u as Ce}from"./instance-1731638920964.js";import{u as Je}from"./product-17316389209645.js";import{u as Ne}from"./metadata-1731638920964.js";import"./encodeQuery-1731638920964.js";const U=(u,c,n,l)=>{var g;if(u.type==="array"&&!n&&!l)return u!=null&&u.elementType?U(u.elementType,c,!0):(s(`方法定义inputs第${c+1}个数组ValueType中缺失elementType属性`,"error"),!0);if(u.type==="file"&&!n&&!l&&!(u!=null&&u.bodyType))return s(`方法定义inputs第${c+1}个数组ValueType中缺失fileType属性`,"error"),!0;if(u.type==="object"&&!n&&!l)return((g=u==null?void 0:u.properties)==null?void 0:g.length)>0?X(u.properties,c):(s(`方法定义inputs第${c+1}个数组ValueType中缺失properties属性`,"error"),!0)},X=(u,c)=>{let n=!1;return u.forEach(l=>{var g;if(!(l!=null&&l.id)){s(`方法定义inputs第${c+1}个数组中缺失id属性`,"error"),n=!0;return}if(!(l!=null&&l.name)){s(`方法定义inputs第${c+1}个数组中缺失name属性`,"error"),n=!0;return}if((g=l==null?void 0:l.valueType)!=null&&g.type){n=U(l,c,!1,!0);return}else{s(`方法定义inputs第${c+1}个数组中缺失valueType.type属性`,"error"),n=!0;return}}),n},Z=(u,c,n,l)=>{var g,V,k,j,D,O,f,C,q,M;if(u.dataType.type==="boolean"&&(!((g=u==null?void 0:u.dataType)!=null&&g.trueText)||!((V=u==null?void 0:u.dataType)!=null&&V.trueValue)||!((k=u==null?void 0:u.dataType)!=null&&k.falseText)||!((j=u==null?void 0:u.dataType)!=null&&j.falseValue)))return s(`方法定义inputs第${c+1}个数组dataType中缺失必填属性`,"error"),!0;if(u.dataType.type==="enum"&&!l)if(((O=(D=u.dataType)==null?void 0:D.elements)==null?void 0:O.length)>0)u.dataType.elements.forEach((I,H)=>{if(!I.value||!I.text)return s(`方法定义inputs第${c+1}个数组dataType中elements缺失必填属性`,"error"),!0});else return s(`方法定义inputs第${c+1}个数组dataType中缺失elements属性`,"error"),!0;if(u.dataType.type==="array"&&!n&&!l)if((f=u.dataType)!=null&&f.elementType)U(u.dataType.elementType,c,!0);else return s(`方法定义inputs第${c+1}个数组dataType中缺失elementType属性`,"error"),!0;if(u.dataType.type==="file"&&!n&&!l&&!((C=u.dataType)!=null&&C.bodyType))return s(`方法定义inputs第${c+1}个数组dataType中缺失fileType属性`,"error"),!0;if(u.dataType.type==="object"&&!n&&!l)return((M=(q=u==null?void 0:u.dataType)==null?void 0:q.properties)==null?void 0:M.length)>0?z(u.dataType.properties,c):(s(`方法定义inputs第${c+1}个数组dataType中缺失properties属性`,"error"),!0)},z=(u,c)=>{let n=!1;return u.forEach(l=>{var g;if(!(l!=null&&l.identifier)){s(`方法定义inputs第${c+1}个数组中缺失id属性`,"error"),n=!0;return}if(!(l!=null&&l.name)){s(`方法定义inputs第${c+1}个数组中缺失name属性`,"error"),n=!0;return}if((g=l==null?void 0:l.dataType)!=null&&g.type){n=Z(l,c,!1,!0);return}else{s(`方法定义inputs第${c+1}个数组中缺失dataType.type属性`,"error"),n=!0;return}}),n},Ve=u=>(fe("data-v-dcf77c33"),u=u(),ce(),u),je={class:"import-content"},Me={class:"import-tip"},Ie=Ve(()=>R("div",{style:{"margin-left":"10px",color:"rgba(0, 0, 0, 0.6)"}}," 支持扩展名：.json ",-1)),Ue=W({name:"Import"}),qe=W({...Ue,props:{visible:{type:Boolean},type:{}},emits:["update:visible","submit"],setup(u,{emit:c}){const n=u,l=oe(),g=Ce(),V=Je(),k=J(!1),j=J([]),D=se({get:()=>n.visible,set:o=>{c("update:visible",o)}}),O=()=>{c("update:visible",!1)},f=ue({type:"import",metadata:"jetlinks",metadataType:"script"}),C=J([]),q=J(!1),M=J(),I=J([]);(async()=>{const{id:o}=l.params||{},t=await De({paging:!1,sorts:[{name:"createTime",order:"desc"}],terms:[{column:"id$not",value:o}]});I.value=t.result.filter(e=>e==null?void 0:e.metadata).map(e=>({label:e.name,value:e.metadata,key:e.id}))})();const P=o=>{let t=!1;return o!=null&&o.properties&&!t&&o.properties.some((e,r)=>{var a,p,v,T,i;if(!(e!=null&&e.id)){s(`属性定义第${r+1}个数组中缺失id属性`,"error"),t=!0;return}if(/[\u4e00-\u9fa5]/.test(e.id)){s(`属性定义第${r+1}个数组中id属性不能包含中文`,"error"),t=!0;return}if(!(e!=null&&e.name)){s(`属性定义第${r+1}个数组中缺失name属性`,"error"),t=!0;return}if((a=e==null?void 0:e.valueType)!=null&&a.type)t=U(e.valueType,r);else{s(`标签定义第${r+1}个数组中缺失valueType.type属性`,"error"),t=!0;return}if(!((p=e==null?void 0:e.expands)!=null&&p.source)){s(`属性定义第${r+1}个数组中缺失expands.source属性`,"error"),t=!0;return}if((((v=e==null?void 0:e.expands)==null?void 0:v.source)==="device"||((T=e==null?void 0:e.expands)==null?void 0:T.source)==="rule")&&!((i=e==null?void 0:e.expands)!=null&&i.type)){s(`属性定义第${r+1}个数组中缺失type属性`,"error"),t=!0;return}}),o!=null&&o.functions&&!t&&(o==null||o.functions.forEach((e,r)=>{if(!(e!=null&&e.id)){s(`方法定义第${r+1}个数组中缺失id属性`,"error"),t=!0;return}if(/[\u4e00-\u9fa5]/.test(e.id)){s(`方法定义第${r+1}个数组中id属性不能包含中文`,"error"),t=!0;return}if(!(e!=null&&e.name)){s(`方法定义第${r+1}个数组中缺失name属性`,"error"),t=!0;return}e!=null&&e.inputs&&X(e.inputs,r)})),o!=null&&o.events&&!t&&(o==null||o.events.forEach((e,r)=>{var a,p,v,T;if(!(e!=null&&e.id)){s(`事件定义第${r+1}个数组中缺失id属性`,"error"),t=!0;return}if(/[\u4e00-\u9fa5]/.test(e.id)){s(`事件定义第${r+1}个数组中id属性不能包含中文`,"error"),t=!0;return}if(!(e!=null&&e.name)){s(`事件定义第${r+1}个数组中缺失name属性`,"error"),t=!0;return}if(!((a=e==null?void 0:e.valueType)!=null&&a.type)){s(`事件定义第${r+1}个数组中缺失valueType.type属性`,"error"),t=!0;return}if(!((p=e==null?void 0:e.expands)!=null&&p.level)){s(`事件定义第${r+1}个数组中缺失expands.level属性`,"error"),t=!0;return}if(!t)if((v=e==null?void 0:e.valueType)!=null&&v.properties)(T=e==null?void 0:e.valueType)==null||T.properties.forEach((i,h)=>{var S;if(!(i!=null&&i.id)){s(`事件定义第${r+1}个数组中缺失valueType.properties数组第${h+1}项的id属性`,"error"),t=!0;return}if(!(i!=null&&i.name)){s(`事件定义第${r+1}个数组中缺失valueType.properties数组第${h+1}项的name属性`,"error"),t=!0;return}if(!((S=i==null?void 0:i.valueType)!=null&&S.type)){s(`事件定义第${r+1}个数组中缺失valueType.properties数组第${h+1}项的valueType.type属性`,"error"),t=!0;return}});else{s(`事件定义第${r+1}个数组中缺失valueType.properties数组`,"error"),t=!0;return}})),o!=null&&o.tags&&!t&&(o==null||o.tags.forEach((e,r)=>{var a;if(!(e!=null&&e.id)){s(`标签定义第${r+1}个数组中缺失id属性`,"error"),t=!0;return}if(/[\u4e00-\u9fa5]/.test(e.id)){s(`标签定义第${r+1}个数组中id属性不能包含中文`,"error"),t=!0;return}if(!(e!=null&&e.name)){s(`标签定义第${r+1}个数组中缺失name属性`,"error"),t=!0;return}if((a=e==null?void 0:e.valueType)!=null&&a.type)U(e==null?void 0:e.valueType,r);else{s(`标签定义第${r+1}个数组中缺失valueType.type属性`,"error"),t=!0;return}})),t},m=o=>{let t=!1;return o!=null&&o.properties&&!t&&o.properties.some((e,r)=>{var a;if(!(e!=null&&e.identifier)){s(`属性定义第${r+1}个数组中缺失identifier属性`,"error"),t=!0;return}if(!(e!=null&&e.name)){s(`属性定义第${r+1}个数组中缺失name属性`,"error"),t=!0;return}if((a=e==null?void 0:e.dataType)!=null&&a.type)Z(e,r);else{s(`属性定义第${r+1}个数组中缺失dataType.type属性`,"error"),t=!0;return}}),o!=null&&o.functions&&!t&&(o==null||o.functions.forEach((e,r)=>{if(!(e!=null&&e.identifier)){s(`方法定义第${r+1}个数组中缺失identifier属性`,"error"),t=!0;return}if(!(e!=null&&e.name)){s(`方法定义第${r+1}个数组中缺失name属性`,"error"),t=!0;return}if(!(e!=null&&e.callType)){s(`方法定义第${r+1}个数组中缺失callType属性`,"error"),t=!0;return}e!=null&&e.inputData&&z(e.inputData,r)})),o!=null&&o.events&&!t&&(o==null||o.events.forEach((e,r)=>{var a;if(!(e!=null&&e.identifier)){s(`事件定义第${r+1}个数组中缺失identifier属性`,"error"),t=!0;return}if(!(e!=null&&e.name)){s(`事件定义第${r+1}个数组中缺失name属性`,"error"),t=!0;return}if(!(e!=null&&e.type)){s(`事件定义第${r+1}个数组中缺失type属性`,"error"),t=!0;return}if(!t)if(e!=null&&e.outputData)(a=e==null?void 0:e.outputData)==null||a.forEach((p,v)=>{var T,i;if(!(p!=null&&p.identifier)){s(`事件定义第${r+1}个数组中缺失outputData数组第${v+1}项的id属性`,"error"),t=!0;return}if(!(p!=null&&p.name)){s(`事件定义第${r+1}个数组中缺失outputData数组第${v+1}项的name属性`,"error"),t=!0;return}if(!((T=p==null?void 0:p.dataType)!=null&&T.type)){s(`事件定义第${r+1}个数组中缺失outputData数组第${v+1}项的dataType.type属性`,"error"),t=!0;return}if(!((i=p==null?void 0:p.dataType)!=null&&i.specs)){s(`事件定义第${r+1}个数组中缺失outputData数组第${v+1}项的dataType.specs属性`,"error"),t=!0;return}});else{s(`事件定义第${r+1}个数组中缺失outputData数组`,"error"),t=!0;return}})),t},x=o=>{if(o.type==="application/json"){const t=new FileReader;t.readAsText(o),t.onload=e=>{var r,a,p;if((r=e.target)!=null&&r.result){const v=JSON.parse((a=e.target)==null?void 0:a.result);(f.metadata==="jetlinks"?P(v):m(v))||(s("操作成功！"),f.import=(p=e.target)==null?void 0:p.result)}else s("文件内容不能为空","error")}}else s("请上传json格式的文件","error")},ee=o=>{if(o.file.status==="done"){const{response:t}=o.file;t.status===200&&(f.upload=t.result)}},A=Ne(),re=async()=>{M.value.validate().then(async o=>{let t;if((n.type==="device"||f.type==="import")&&f.metadataType==="script"&&(t=f.metadata==="jetlinks"?P(JSON.parse(f.import)):m(JSON.parse(f.import))),!t){const{id:e}=l.params||{};if(o.metadata==="alink")try{console.log(JSON.parse(o.import));const r=ie(JSON.parse(o.import),["schema","profile"]);Object.keys(r).forEach(p=>{const v=new Map;r[p].forEach(T=>v.set(T.identifier,T)),r[p]=[...v.values()]}),k.value=!0;const a=await Oe("from","alink",r).catch(p=>p);if(a.status===200){const p=a.result;let v;(n==null?void 0:n.type)==="device"?v=await Y(e,p).catch(T=>T):v=await Q(e,{id:e,metadata:JSON.stringify(p)}).catch(T=>T),v.success&&s("导入成功"),k.value=!1}else{k.value=!1;return}(n==null?void 0:n.type)==="device"?await g.refresh(e):await V.getDetail(e),A.set("importMetadata",!0),O()}catch(r){s(r==="error"?"物模型数据不正确":"上传json格式的物模型文件","error")}else try{const r=JSON.parse(o[(o==null?void 0:o.type)==="copy"?"copy":"import"]||"{}");if((o==null?void 0:o.type)!=="copy"&&Object.keys(r).forEach(i=>{const h=new Map;r[i].forEach(S=>h.set(S.id,S)),r[i]=[...h.values()]}),!(r!=null&&r.properties||r!=null&&r.events||r!=null&&r.functions||r!=null&&r.tags)){s("物模型数据不正确","error"),k.value=!1;return}const{id:a}=l.params||{};Object.keys(r).forEach(i=>{i==="functions"&&r[i].forEach(h=>{var S;(S=h==null?void 0:h.inputs)==null||S.forEach(L=>{L.expands={required:!1}})})});const p={id:a,metadata:JSON.stringify(r)},v=r;let T;k.value=!0,(n==null?void 0:n.type)==="device"?T=await Y(a,v):T=await Q(a,p),k.value=!1,T.success&&(s("导入成功"),q.value&&setTimeout(()=>{G.info({title:"导入数据存在虚拟属性，请及时添加虚拟属性计算规则。",okText:"确认"})},300)),(n==null?void 0:n.type)==="device"?await g.refresh(a):await V.getDetail(a),A.set("importMetadata",!0),O()}catch(r){if(k.value=!1,(r==null?void 0:r.name)==="AxiosError")return;s(r==="error"?"物模型数据不正确":"上传json格式的物模型文件","error")}}})};return pe(async()=>{const o=await we();o.status===200&&(j.value=[{id:"jetlinks",name:"标准物模型"}].concat(o.result))}),(o,t)=>{const e=ne("AIcon"),r=Te,a=_e,p=$e,v=de,T=ge,i=he,h=ke,S=Ee,L=Se,te=G;return E(),w(te,{"mask-closable":!1,title:"导入物模型","destroy-on-close":"",visible:y(D),"onUpdate:visible":t[7]||(t[7]=$=>K(D)?D.value=$:null),onCancel:O,onOk:re,"confirm-loading":y(k)},{default:_(()=>[R("div",je,[R("p",Me,[d(e,{type:"ExclamationCircleOutlined",style:{"margin-right":"5px"}}),o.type==="product"?(E(),B(F,{key:0},[b(" 导入的物模型会覆盖原来的属性、功能、事件、标签，请谨慎操作。 ")],64)):(E(),B(F,{key:1},[b(" 导入时会根据标识跳过继承自产品物模型的属性、功能、事件、标签。 ")],64))])]),d(L,{layout:"vertical",ref_key:"formRef",ref:M,model:y(f)},{default:_(()=>[o.type==="product"?(E(),w(p,{key:0,label:"导入方式",name:"type",rules:[{required:!0,message:"请选择导入方式"}]},{default:_(()=>[d(a,{value:y(f).type,"onUpdate:value":t[0]||(t[0]=$=>y(f).type=$)},{default:_(()=>[d(r,{value:"copy"},{default:_(()=>[b("拷贝产品")]),_:1}),d(r,{value:"import"},{default:_(()=>[b("导入物模型")]),_:1})]),_:1},8,["value"])]),_:1})):N("",!0),y(f).type==="copy"?(E(),w(p,{key:1,label:"选择产品",rules:[{required:!0,message:"请选择产品"}],name:"copy"},{default:_(()=>[d(a,{options:y(I),value:y(f).copy,"onUpdate:value":t[1]||(t[1]=$=>y(f).copy=$),"option-filter-prop":"label",placeholder:"请选择产品",showSearch:""},null,8,["options","value"])]),_:1})):N("",!0),o.type==="device"||y(f).type==="import"?(E(),w(p,{key:2,label:"物模型类型",rules:[{required:!0,message:"请选择物模型类型"}],name:"metadata"},{default:_(()=>[d(a,{value:y(f).metadata,"onUpdate:value":t[2]||(t[2]=$=>y(f).metadata=$)},{default:_(()=>[(E(!0),B(F,null,le(y(j),$=>(E(),w(r,{value:$.id},{default:_(()=>[b(ae($.name),1)]),_:2},1032,["value"]))),256))]),_:1},8,["value"])]),_:1})):N("",!0),o.type==="device"||y(f).type==="import"?(E(),w(p,{key:3,label:"导入类型",rules:[{required:!0,message:"请选择导入类型"}],name:"metadataType"},{default:_(()=>[d(a,{value:y(f).metadataType,"onUpdate:value":t[3]||(t[3]=$=>y(f).metadataType=$),onChange:t[4]||(t[4]=$=>y(f).import=void 0)},{default:_(()=>[d(r,{value:"file"},{default:_(()=>[b("文件上传")]),_:1}),d(r,{value:"script"},{default:_(()=>[b("脚本")]),_:1})]),_:1},8,["value"])]),_:1})):N("",!0),y(f).type==="import"&&y(f).metadataType==="file"?(E(),w(p,{key:4,label:"文件上传",name:"import",rules:[{required:!0,message:"请上传文件"}]},{default:_(()=>[d(T,{"file-list":y(C),"onUpdate:fileList":t[5]||(t[5]=$=>K(C)?C.value=$:null),"before-upload":x,accept:".json","show-upload-list":!1,action:y(ye),onChange:ee,headers:{[o.TOKEN_KEY]:y(ve)()}},{default:_(()=>[d(v,null,{icon:_(()=>[d(e,{type:"UploadOutlined"})]),default:_(()=>[b(" 上传文件 ")]),_:1})]),_:1},8,["file-list","action","headers"]),Ie]),_:1})):N("",!0),(o.type==="device"||y(f).type==="import")&&y(f).metadataType==="script"?(E(),w(p,{key:5,rules:[{required:!0,message:"请输入物模型"}],name:"import"},{label:_(()=>[d(h,null,{default:_(()=>[b(" 物模型 "),d(i,{title:"在编辑器中编写物模型脚本"},{default:_(()=>[d(e,{type:"QuestionCircleOutlined",style:{color:"rgb(136, 136, 136)"}})]),_:1})]),_:1})]),default:_(()=>[d(S,{modelValue:y(f).import,"onUpdate:modelValue":t[6]||(t[6]=$=>y(f).import=$),theme:"vs",style:{height:"300px"},lang:"json"},null,8,["modelValue"])]),_:1})):N("",!0)]),_:1},8,["model"])]),_:1},8,["visible","confirm-loading"])}}});const Ke=be(qe,[["__scopeId","data-v-dcf77c33"]]);export{Ke as default};
