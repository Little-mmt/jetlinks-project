import{a as se,h as te,cK as oe,o as ne,a6 as le,v as re,F as ce,I as de,w as ue,d as pe,af as ie,a0 as ve,ds as _e,a1 as me,a2 as fe,aa as ge,g as ye}from"./index-1731638920964.js";import{d as N}from"./device-17316389209643.js";import{b as he,s as we}from"./plugin-17316389209642.js";import{p as be}from"./const-1731638920964.js";import{x as ke}from"./product-17316389209644.js";import{d as xe,e as Pe,k as w,r as Ce,w as Ie,ab as Te,U as r,V as m,X as n,f as c,u as t,Y as z,Z as P,F as U,a1 as G,_ as $,E as C,$ as I,W as Se,R as je,G as Re}from"./vue-1731638920964.js";const Ue={class:"gateway-box"},qe=["src"],Be={class:"subtitle"},De=xe({__name:"SaveProduct",props:{visible:{type:Boolean,default:!1},productId:{type:String,default:""},channel:{type:String,default:""},deviceType:{type:String,default:"device"}},emits:["update:visible","update:productId","close","save","update:password"],setup(K,{emit:T}){const f=K,Z=se().hasPermission("link/AccessConfig:add"),S=Pe({get:()=>f.visible,set:s=>T("update:visible",s)}),q=w([]),p=Ce({id:void 0,metadata:{}}),L=w([]),F=w(),V=w(),l=w({accessId:"",accessName:"",accessProvider:"",configuration:{access_pwd:"",stream_mode:"UDP"},deviceType:f.deviceType,messageProtocol:"",name:"",protocolName:"",transportProtocol:"",metadata:""}),M=async()=>{const s={pageSize:100,sorts:[{name:"createTime",order:"desc"}],terms:[{column:"provider",value:f.channel}]},{result:a}=await N.queryProvider(s);q.value=a.data},J=w([]),B=w(),W=async s=>{var a,i,b,j;if(J.value=[s.id],l.value.accessId=s.id,l.value.accessName=s.name,l.value.accessProvider=s.provider,l.value.messageProtocol=s.protocolDetail.id,l.value.protocolName=s.protocolDetail.name,l.value.transportProtocol=s.transport,f.channel==="media-plugin"){const g=await he(s.channelId);g.success&&(L.value=(a=g.result)==null?void 0:a.map(o=>({...o,label:o.name,value:o.id})));const v=await ke("empty",s.id);if(v.success){const o=v.result;B.value=(b=(i=o==null?void 0:o[0])==null?void 0:i.properties)==null?void 0:b.map(d=>{var _,u,k,y,x;return{name:["configuration",d.property],label:d.name,type:(_=d.type)==null?void 0:_.type,value:(u=d.type.expands)==null?void 0:u.defaultValue,options:(k=d.type.elements)==null?void 0:k.map(D=>({label:D.text,value:D.value})),required:!!((y=d.type.expands)!=null&&y.required),message:((x=d.type)==null?void 0:x.type)==="enum"?`请选择${d.name}`:`请输入${d.name}`}})}}else{const g=await N.getConfiguration(s.protocol,s.transport);if(g.success){const v=g.result;if(s.protocol==="onvif"&&!v.scopes.find(o=>o==="product"))return"";B.value=(j=v==null?void 0:v.properties)==null?void 0:j.map(o=>{var d,_,u,k,y;return{name:["configuration",o.property],label:o.name,type:(d=o.type)==null?void 0:d.type,value:(_=o.type.expands)==null?void 0:_.defaultValue,options:(u=o.type.elements)==null?void 0:u.map(x=>({label:x.text,value:x.value})),required:!!((k=o.type.expands)!=null&&k.required),message:((y=o.type)==null?void 0:y.type)==="enum"?`请选择${o.name}`:`请输入${o.name}`}})}}},H=(s,a)=>{p.metadata=a!=null&&a.metadata?oe(a.metadata,["functions","properties","events","tags"]):{}};Ie(()=>S.value,s=>{s?M():(J.value=[],B.value=[],T("close"))});const E=w(!1),Q=async()=>{var s;F.value&&!await F.value.validate()||(s=V.value)==null||s.validate().then(async()=>{E.value=!0,p.metadata&&Object.keys(p.metadata).length&&(l.value.metadata=JSON.stringify(p.metadata));const a=await N.saveProduct(l.value);a.success&&(T("update:productId",a.result.id),T("update:password",a.result.configuration.access_pwd),f.channel==="media-plugin"&&p.id&&await we("product",l.value.accessId,a.result.id,p.id).catch(()=>({})),(await N.deployProductById(a.result.id)).success&&(T("save",{...a.result}),ne("操作成功"),X())),E.value=!1}).catch(a=>{console.log("err: ",a)})},X=()=>{S.value=!1,V.value.resetFields()},ee=()=>{const s=window.open(`${origin}/#/iot/link/accessConfig/detail/:id?save=true&view=false&type=${f.channel}`);s.onTabSaveSuccess=async a=>{var i;await M(),W((i=q.value)==null?void 0:i[0])}};return(s,a)=>{const i=le,b=re,j=ce,g=de,v=ue,o=pe,d=ie,_=Te("Ellipsis"),u=ve,k=_e,y=me,x=fe,D=ge;return r(),m(D,{visible:t(S),"onUpdate:visible":a[2]||(a[2]=e=>Re(S)?S.value=e:null),title:"快速添加",cancelText:"取消",okText:"确定",onOk:Q,onCancel:X,confirmLoading:t(E),width:"660px"},{default:n(()=>[c(j,{ref_key:"formRef",ref:V,model:t(l),layout:"vertical"},{default:n(()=>[t(L).length?(r(),m(j,{key:0,ref_key:"pluginFormRef",ref:F,model:t(p),layout:"vertical"},{default:n(()=>[c(b,{name:"id",label:"产品类型",rules:[{required:!0,message:"请选择产品类型"}]},{default:n(()=>[c(i,{value:t(p).id,"onUpdate:value":a[0]||(a[0]=e=>t(p).id=e),options:t(L),onChange:H,placeholder:"请选择产品类型"},null,8,["value","options"])]),_:1})]),_:1},8,["model"])):z("",!0),c(b,{label:"产品名称",name:"name",rules:[{required:!0,message:"请输入产品名称"},{max:64,message:"最多输入64个字符"}]},{default:n(()=>[c(g,{value:t(l).name,"onUpdate:value":a[1]||(a[1]=e=>t(l).name=e),placeholder:"请输入名称"},null,8,["value"])]),_:1}),K.deviceType!=="gateway"?(r(!0),P(U,{key:1},G(t(B),(e,A)=>(r(),m(b,{key:A,name:e.name,label:e.label,rules:[{required:e.required,message:e.message,trigger:"change"},{max:64,message:"最多输入64个字符"}]},{default:n(()=>[e.type==="enum"?(r(),m(i,{key:0,value:t(l)[e.name[0]][e.name[1]],"onUpdate:value":h=>t(l)[e.name[0]][e.name[1]]=h,options:e.options,placeholder:e.message},null,8,["value","onUpdate:value","options","placeholder"])):e.type==="password"?(r(),m(v,{key:1,value:t(l)[e.name[0]][e.name[1]],"onUpdate:value":h=>t(l)[e.name[0]][e.name[1]]=h,placeholder:e.message},null,8,["value","onUpdate:value","placeholder"])):(r(),m(g,{key:2,value:t(l)[e.name[0]][e.name[1]],"onUpdate:value":h=>t(l)[e.name[0]][e.name[1]]=h,placeholder:e.message},null,8,["value","onUpdate:value","placeholder"]))]),_:2},1032,["name","label","rules"]))),128)):z("",!0),c(b,{label:"接入网关",name:"accessId",rules:{required:!0,message:"请选择接入网关"}},{default:n(()=>[$("div",Ue,[t(q).length?z("",!0):(r(),m(d,{key:0,style:{"margin-top":"50px"}},{description:n(()=>[t(Z)?(r(),P(U,{key:1},[C(" 暂无数据，请先 "),c(o,{type:"link",style:{padding:"0"},onClick:ee},{default:n(()=>[C(" 添加"+I(t(be)[f.channel])+"接入网关 ",1)]),_:1})],64)):(r(),P(U,{key:0},[C("暂无数据, 请联系管理员")],64))]),_:1})),(r(!0),P(U,null,G(t(q),(e,A)=>{var h,Y;return r(),P("div",{class:"gateway-item",key:A},[c(x,Se({onClick:W,active:t(J).includes(e.id),value:e},e,{status:(h=e.state)==null?void 0:h.value,statusText:(Y=e.state)==null?void 0:Y.text,statusNames:{enabled:"processing",disabled:"error"}}),{img:n(()=>[je(s.$slots,"img",{},()=>[$("img",{src:t(te)("/device-access.png")},null,8,qe)],!0)]),content:n(()=>[c(_,{style:{cursor:"pointer","font-size":"16px","font-weight":"700",color:"#1d39c4",width:"calc(100% - 100px)"}},{default:n(()=>[C(I(e.name),1)]),_:2},1024),c(_,{style:{"margin-top":"10px",color:"#666","font-weight":"400","font-size":"12px"}},{default:n(()=>[C(I(e.description),1)]),_:2},1024),f.channel==="gb28181-2016"?(r(),m(y,{key:0},{default:n(()=>[c(u,{span:12},{default:n(()=>{var R;return[C(I((R=e.channelInfo)==null?void 0:R.name),1)]}),_:2},1024),c(u,{span:12},{default:n(()=>[C(I(e.protocolDetail.name),1)]),_:2},1024),c(u,{span:12},{default:n(()=>{var R;return[(r(!0),P(U,null,G((R=e.channelInfo)==null?void 0:R.addresses,(O,ae)=>(r(),P("p",{key:`${O.address}_address${ae}`},[c(_,null,{default:n(()=>[c(k,{text:O.address,color:O.health===-1?"red":"green"},null,8,["text","color"])]),_:2},1024)]))),128))]}),_:2},1024)]),_:2},1024)):(r(),m(y,{key:1},{default:n(()=>[c(u,{span:24},{default:n(()=>[$("div",Be,I(e.protocolDetail.name),1),$("p",null,I(e.protocolDetail.description),1)]),_:2},1024)]),_:2},1024))]),_:2},1040,["active","value","status","statusText"])])}),128))])]),_:3})]),_:3},8,["model"])]),_:3},8,["visible","confirmLoading"])}}});const Ee=ye(De,[["__scopeId","data-v-9e3b8fa5"]]);export{Ee as default};
