import{k as l,ac as pe,c as me,ab as M,U as d,Z as v,f as n,X as i,_ as f,$ as X,u as a,V as T,E as S,Y as h,G as V,F as j,a1 as ve,d as _e,af as ye,ag as he}from"./vue-1730252110824.js";import{g as fe,ax as Ie,a4 as Y,d3 as ke,o as be,cY as ge,aR as Ce,Z as xe,cW as Be,cX as Te,e as Se,a3 as $e,dB as qe}from"./index-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import"./index-1730252110824292.js";import"./index-1730252110824293.js";import De from"./Bind-17302521108242.js";import we from"./index-1730252110824158.js";import Le from"./index-1730252110824159.js";import Oe from"./index-1730252110824166.js";import{u as Re,q as Z,b as Ve,a as je}from"./auto-1730252110824.js";import{u as Ne}from"./useRequest-1730252110824.js";import"./cascade-1730252110824.js";import"./index-1730252110824289.js";import"./mediaTool-1730252110824.js";import"./RadioButton-1730252110824.js";import"./channel-17302521108242.js";import"./Share-1730252110824.js";import"./Preset.vue_vue_type_script_setup_true_lang-1730252110824.js";import"./unionBy-1730252110824.js";import"./playback-1730252110824.js";import"./timeLine-1730252110824.js";import"./iconNode.vue_vue_type_script_setup_true_lang-1730252110824.js";const Pe=b=>(ye("data-v-a9855b71"),b=b(),he(),b),Ee={class:"channelControl"},Ue={class:"bind"},Ae={key:1},Fe={class:"bound"},Je={class:"bound_device"},Me={key:0},Xe={key:0,class:"bound_channel"},Ye={style:{padding:"12px 24px 0",display:"flex"}},Ze=Pe(()=>f("div",{class:"catalogue"},"当前目录：",-1)),ze={key:0},Ge={key:1,class:"video-unbind-tip"},He=_e({name:"Channel"}),Ke=Object.assign(He,{setup(b){const $=l(0),I=l(),g=l(),C=l(!1),q=l(!1);l(!1);const N=l(),u=pe(),k=l(!1),P=l(),x=l(!1),E=l(),r=l(),D=l(),m=l({}),B=l({}),U=l(),y=l(!1),w=l(!1),A=me("video-tags"),{loading:z,run:G}=Ne(Re,{immediate:!1,onSuccess:async()=>{await g.value.getDeviceList(),y.value=!1,$.value=0}}),L=l({terms:[{terms:[{column:"channelId$media-record-schedule-bind-channel",value:[{column:"scheduleId",termType:"eq",value:u.params.id}]},{column:"deviceId$media-record-schedule-bind-device",value:[{column:"scheduleId",termType:"eq",value:u.params.id}]}]},{column:"deviceId",value:r.value}]}),F=[{title:"ID",dataIndex:"channelId",key:"channelId",ellipsis:!0,search:{type:"string"}},{title:"名称",dataIndex:"name",key:"name",ellipsis:!0,search:{type:"string",first:!0}},{title:"厂商",dataIndex:"manufacturer",key:"manufacturer",ellipsis:!0},{title:"安装地址",dataIndex:"address",ellipsis:!0,key:"address",search:{type:"string"}},{title:"状态",dataIndex:"status",key:"status",scopedSlots:!0,width:150,search:{type:"select",options:[{label:"已连接",value:"online"},{label:"未连接",value:"offline"}]}},{title:"操作",key:"action",width:100,scopedSlots:!0}],H=t=>{P.value=Y(t),x.value=!0},K=t=>{const e=m.value[r.value],o=e==null?void 0:e.channelIds;e&&o.includes(t.channelId)?m.value[r.value].channelIds=o.filter(c=>c!==t.channelId):B.value[t.channelId]=U.value,I.value.reload()},W=t=>{console.log("onPlayBack",t),N.value=Y(t),q.value=!0},Q=t=>{A.terms=[{column:"channelId",termType:"eq",value:t.channelId}],A.tag.value="Log"},ee=()=>{C.value=!0},te=t=>{L.value=t},ae=()=>{ke.confirm({title:"清空操作不可撤销，确认清空所有通道？",onOk(){G(u.params.id),m.value={}}})},ne=t=>{var e;m.value={...t},g.value.getDeviceList({...t}),C.value=!1,(e=I.value)==null||e.reload()},se=t=>{const e=t,o={terms:[{terms:[{column:"channelId$media-record-schedule-bind-channel",value:[{column:"scheduleId",termType:"eq",value:u.params.id}]},{column:"deviceId$media-record-schedule-bind-device",value:[{column:"scheduleId",termType:"eq",value:u.params.id}]}]}]};r.value&&o.terms.push({column:"deviceId",value:r.value,type:"and"}),m.value[r.value]&&o.terms.push({column:"channelId",termType:"in",value:m.value[r.value].channelIds.toString(),type:"or"});const c=Object.keys(B.value);return c.length&&o.terms.push({column:"channelId",termType:"nin",value:c.toString(),type:"and"}),e.terms=[...o.terms,...e.terms],Z(e)},le=async()=>{const t=[];Object.values(m.value).forEach(({channelIds:c,channelCatalog:p,paths:_})=>{const[O]=_;t.push(...c.map(R=>({deviceId:O,channelId:R,others:{channelCatalog:p.join("/")}})))}),w.value=!0,(await Ve(u.params.id,t).finally(()=>{w.value=!1})).success&&(m.value={});const o=Object.keys(B.value);if(o.length){const c=o.map(p=>({deviceId:B.value[p],channelId:p}));await je(u.params.id,c)}g.value.getDeviceList(),await J(),be("操作成功"),k.value=!1},oe=({node:t})=>{var c;const{paths:e,channelCatalog:o}=t;U.value=e[0],E.value=o,(c=I.value)==null||c.reload()},J=()=>{const t={terms:[{terms:[{column:"channelId$media-record-schedule-bind-channel",value:[{column:"scheduleId",termType:"eq",value:u.params.id}]},{column:"deviceId$media-record-schedule-bind-device",value:[{column:"scheduleId",termType:"eq",value:u.params.id}]}]}]};Z(t).then(e=>{e.success&&($.value=e.result.total)})},ie=t=>{y.value=t.length};return J(),(t,e)=>{const o=ge,c=Ce,p=M("AIcon"),_=xe,O=Be,R=Te,ce=M("pro-search"),de=Se,ue=$e,re=qe;return d(),v("div",null,[n(re,{spinning:a(z)},{default:i(()=>[f("div",Ee,[f("div",Ue,"已绑定通道数："+X(a($)),1),a(k)?(d(),T(c,{key:0},{default:i(()=>[n(o,{onClick:ae},{default:i(()=>[S("清空通道")]),_:1}),n(o,{onClick:ee},{default:i(()=>[S("绑定通道")]),_:1})]),_:1})):(d(),v("div",Ae,[n(_,{type:"link",hasPermission:"device/Instance:action",onClick:e[0]||(e[0]=s=>k.value=!0)},{default:i(()=>[n(p,{type:"EditOutlined"})]),_:1})]))]),f("div",Fe,[f("div",Je,[a(y)?(d(),v("div",Me,"选择设备及目录查看已绑定的通道：")):h("",!0),n(we,{ref_key:"treeRef",ref:g,height:700,id:a(u).params.id,deviceId:a(r),"onUpdate:deviceId":e[1]||(e[1]=s=>V(r)?r.value=s:null),channelId:a(D),"onUpdate:channelId":e[2]||(e[2]=s=>V(D)?D.value=s:null),onSelect:oe,onLoad:ie},null,8,["id","deviceId","channelId"])]),a(y)?(d(),v("div",Xe,[f("div",Ye,[Ze,n(R,null,{default:i(()=>[(d(!0),v(j,null,ve(a(E),s=>(d(),T(O,null,{default:i(()=>[S(X(s),1)]),_:2},1024))),256))]),_:1})]),n(ce,{columns:F,params:a(L),type:"simple",style:{"padding-bottom":"0","margin-bottom":"0"},onSearch:te},null,8,["params"]),n(ue,{style:{"min-height":"calc(100% - 60px)"},ref_key:"tableRef",ref:I,model:"table",rowKey:"channelId",columns:F,request:se,params:a(L)},{status:i(s=>[n(Ie,{text:s.status.text,status:s.status.value,statusNames:{online:"success",offline:"error"}},null,8,["text","status"])]),action:i(s=>[n(de,{size:16},{default:i(()=>[a(k)?(d(),v(j,{key:0},[n(_,{type:"link",style:{padding:"0px"},key:"play",tooltip:{title:"播放"},onClick:()=>{H(s)}},{default:i(()=>[n(p,{type:"VideoCameraOutlined"})]),_:2},1032,["onClick"]),n(_,{type:"link",style:{padding:"0px"},key:"unbind",tooltip:{title:"解绑"},popConfirm:{title:"确认解绑吗？",okText:"确定",cancelText:"取消",onConfirm:()=>{K(s)}}},{default:i(()=>[n(p,{type:"DisconnectOutlined"})]),_:2},1032,["popConfirm"])],64)):(d(),v(j,{key:1},[n(_,{type:"link",style:{padding:"0px"},key:"playback",tooltip:{title:"回放"},onClick:()=>{W(s)}},{default:i(()=>[n(p,{type:"HistoryOutlined"})]),_:2},1032,["onClick"]),n(_,{type:"link",style:{padding:"0px"},key:"logs",tooltip:{title:"日志"},onClick:()=>{Q(s)}},{default:i(()=>[n(p,{type:"ExceptionOutlined"})]),_:2},1032,["onClick"])],64))]),_:2},1024)]),_:1},8,["params"])])):h("",!0)]),a(y)&&a(k)?(d(),v("div",ze,[n(o,{type:"primary",loading:a(w),onClick:le},{default:i(()=>[S("保存")]),_:1},8,["loading"])])):h("",!0),a(y)?h("",!0):(d(),v("div",Ge,"请先绑定通道"))]),_:1},8,["spinning"]),a(C)?(d(),T(De,{key:0,cacheDeviceIds:a(m),onCloseBind:e[3]||(e[3]=s=>C.value=!1),onSubmit:ne},null,8,["cacheDeviceIds"])):h("",!0),a(q)?(d(),T(Le,{key:1,data:a(N),scheduleId:a(u).params.id,onClose:e[4]||(e[4]=s=>q.value=!1)},null,8,["data","scheduleId"])):h("",!0),n(Oe,{visible:a(x),"onUpdate:visible":e[5]||(e[5]=s=>V(x)?x.value=s:null),data:a(P),onRefresh:e[6]||(e[6]=s=>a(I).reload())},null,8,["visible","data"])])}}}),Bt=fe(Ke,[["__scopeId","data-v-a9855b71"]]);export{Bt as default};
