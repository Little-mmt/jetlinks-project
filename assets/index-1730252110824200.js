import{o as h,a3 as K,aa as R,g as B}from"./index-1730252110824.js";import"./index-1730252110824278.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import"./index-1730252110824282.js";import"./index-1730252110824283.js";import{a as V}from"./scene-1730252110824.js";import{q as j,b as J}from"./configuration-1730252110824.js";import O from"./CardBox-17302521108242.js";import{u as A}from"./useRequest-1730252110824.js";import{d as b,k as d,r as N,ab as z,U as D,V as L,X as g,f as m,_ as U,u as n}from"./vue-1730252110824.js";import"./Title-17302521108242.js";import"./Title-1730252110824.js";import"./AddButton-1730252110824.js";import"./BranchesTabs-17302521108242.js";import"./index-1730252110824295.js";import"./Terms-1730252110824.js";import"./WhenItem-1730252110824.js";import"./utils-17302521108243.js";import"./Actions-17302521108242.js";import"./util-1730252110824.js";import"./config-17302521108242.js";import"./util-17302521108242.js";import"./scene-17302521108242.js";import"./util-17302521108243.js";import"./tags-1730252110824.js";const X={style:{height:"500px","overflow-y":"auto"}},$=b({name:"SceneSave"}),E=b({...$,props:{id:{type:String},type:{type:String}},emits:["closeSave","saveScene"],setup(u,{emit:p}){const l=u,S=[{title:"场景名称",dataIndex:"name",key:"name",search:{type:"string"}},{title:"触发方式",dataIndex:"triggerType",key:"triggerType",search:{type:"select",options:[{label:"手动触发",value:"manual"},{label:"定时触发",value:"timer"},{label:"设备触发",value:"device"}]}},{title:"状态",dataIndex:"state",key:"state",search:{type:"select",options:[{label:"正常",value:"started"},{label:"禁用",value:"disable"}]}}];l.id,l.type;const y=d(),v=d(),o=N({}),c=d(!1),{data:T}=A(j,{defaultParams:{terms:[{column:"alarmId",value:l.id}]},onSuccess(a){return a.result.data.reduce((e,t)=>(e[t.ruleId]?e[t.ruleId].push(t.branchIndex):e[t.ruleId]=[t.branchIndex],e),{})||{}},defaultValue:{}}),I=a=>{y.value=a},k=async()=>{if(Object.keys(o).length>0){const a=Object.keys(o).reduce((e,t)=>{const s=o[t].map(r=>({alarmId:l.id,ruleId:t,branchIndex:r}));return e.push(...s),e},[]);c.value=!0,(await J(a).finally(()=>{c.value=!1})).success&&(h("操作成功"),p("saveScene"))}else h("请选择至少一条数据","error")},x=()=>{p("closeSave")},C=()=>{var a;(a=v.value)==null||a.reload()},q=(a,i,e)=>{const t=o[e.id],s=new Set(t);i?s.add(a):s.delete(a),s.size===0&&delete o[e.id],o[e.id]=[...s.values()]};return(a,i)=>{const e=z("pro-search"),t=K,s=R;return D(),L(s,{visible:"",title:"新增",okText:"确定",cancelText:"取消",maskClosable:!1,width:1e3,loading:n(c),onCancel:x,onOk:k},{default:g(()=>[m(e,{columns:S,type:"simple",onSearch:I}),U("div",X,[m(t,{model:"CARD",ref_key:"tableRef",ref:v,request:n(V),gridColumns:[1,1,1],defaultParams:{sorts:[{name:"createTime",order:"desc"}],terms:[{column:"triggerType",value:l.type==="other"?null:"device"},{terms:[{column:"features",termType:"in",value:["alarmTrigger","alarmReliever"]},{column:"features",termType:"isnull",value:1,type:"or"}],type:"and"}]},params:n(y)},{card:g(r=>{var f,_;return[m(O,{value:r,status:(f=r.state)==null?void 0:f.value,statusText:(_=r.state)==null?void 0:_.text,alarmId:u.id,activeKeys:n(T)[r.id],selectedKeys:n(o)[r.id],showMask:!0,onChange:(M,w)=>q(M,w,r),onReload:C},null,8,["value","status","statusText","alarmId","activeKeys","selectedKeys","onChange"])]}),_:1},8,["request","defaultParams","params"])])]),_:1},8,["loading"])}}});const ge=B(E,[["__scopeId","data-v-1d254739"]]);export{ge as default};
