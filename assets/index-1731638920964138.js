import{d as pe,ac as Fe,k as v,r as Re,e as Ve,o as re,w as Ae,ab as le,U as n,Z as p,f as a,X as i,F as T,a1 as M,u as t,V as g,_,E as x,$ as L,Y as w,a0 as Je,W as ie,af as Oe,ag as Ue}from"./vue-1731638920964.js";import{X as He,F as ce,o as E,an as Ee,ao as Qe,dp as Ge,Z as Ke,ds as Xe,$ as Ze,a0 as ze,a1 as We,af as Ye,y as et,aH as tt,I as ot,v as st,a9 as at,aT as nt,d as rt,g as lt}from"./index-1731638920964.js";import"./index-1731638920964282.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import"./index-1731638920964286.js";import{c as it,e as ct,s as dt,u as ut,f as pt,h as _t}from"./accessConfig-1731638920964.js";import{d as vt,N as de,P as Q,C as mt,a as ht}from"./data-17316389209646.js";import ue from"./index-1731638920964133.js";import"./index-1731638920964288.js";const G=y=>(Oe("data-v-a5566285"),y=y(),Ue(),y),ft={class:"steps-content"},gt={key:0,class:"steps-box"},yt={class:"alert"},wt={class:"search"},kt={class:"other"},xt={key:0},Ct={key:1,class:"steps-box"},bt={class:"alert"},St={class:"search"},Tt={key:2,class:"steps-box"},Lt={class:"doc"},Pt=G(()=>_("h1",null,"接入方式",-1)),jt=G(()=>_("h1",null,"消息协议",-1)),It={key:0},Nt={key:1},Mt=G(()=>_("h1",null,"网络组件",-1)),Bt={key:2},$t={class:"steps-action"},qt=pe({name:"AccessNetwork"}),Dt=pe({...qt,props:{provider:{type:Object,default:()=>{}},data:{type:Object,default:()=>{}},bindProduct:{type:Boolean,default:!1}},setup(y){const r=y,K=He();function _e(){var e=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var l=(e+Math.random()*16)%16|0;return e=Math.floor(e/16),(o==="x"?l:l&3|8).toString(16)})}const X=document.body.clientHeight,B=r.provider.channel,R=Fe(),ve=R.query.view,P=R.params.id,me=v(),he=ce.useForm,c=v(0),Z=v(0),j=v(["网络组件","消息协议","完成"]),C=v([]),V=v([]),I=v([]),A=v([]),m=v(""),h=v(""),k=v({}),z=v([]),W=v([]),b=v({name:"",description:""}),J=v(!1),{resetFields:Ft,validate:fe,validateInfos:Y}=he(b,Re({name:[{required:!0,message:"请输入名称",trigger:"blur"},{max:64,message:"最多可输入64个字符",trigger:"blur"}],description:[{max:200,message:"最多可输入200个字符"}]})),ee=Ve(()=>R.query.view==="false"&&!r.bindProduct),O=async(e,o,l={})=>{const d=await it(de.get(e),o,l);d.status===200&&(C.value=d.result,V.value=d.result)},$=async(e,o={})=>{const l=await ct(Q.get(e),{...o,"sorts[0].name":"createTime","sorts[0].order":"desc",paging:!1});l.status===200&&(I.value=l.result,A.value=l.result)},ge=()=>{var l,d;const e=(l=K.menus["link/Type/Detail"])==null?void 0:l.path,o=window.open(`${window.location.origin+window.location.pathname}#${e}?type=${de.get((d=r.provider)==null?void 0:d.id)||""}`);o.onTabSaveSuccess=u=>{var f;u.success&&(m.value=u.result.id,O((f=r.provider)==null?void 0:f.id,m.value||""))}},ye=()=>{var l;const e=(l=K.menus["link/Protocol"])==null?void 0:l.path,o=window.open(`${window.location.origin+window.location.pathname}#${e}?save=true`);o.onTabSaveSuccess=d=>{var u,f;d.success&&(h.value=(u=d.result)==null?void 0:u.id,$((f=r.provider)==null?void 0:f.id))}},te=()=>C.value.find(e=>e.id===m)&&(C.value.find(e=>e.id===m).addresses||[]).length>0,we=()=>te()?C.value.find(e=>e.id===m).addresses:[],oe=e=>e.health===-1?"error":"processing",ke=e=>{let o="";return e.upstream&&e.downstream?o="上行、下行":e.upstream?o="上行":e.downstream&&(o="下行"),o},xe=e=>{m.value=e},Ce=e=>{C.value=e?V.value.filter(o=>o.name&&o.name.toLocaleLowerCase().includes(e.toLocaleLowerCase())):V.value},be=e=>{r.data.id||(h.value=e)},Se=e=>{I.value=e?A.value.filter(o=>o.name&&o.name.toLocaleLowerCase().includes(e.toLocaleLowerCase())):A.value},Te=()=>{fe().then(async e=>{var d,u;const o={...r.data,...e,protocol:h.value,channel:"network",channelId:m.value,provider:r.provider.id,transport:((d=r.provider)==null?void 0:d.id)==="child-device"?"Gateway":Q.get(r.provider.id)};J.value=!0;const l=P===":id"?await dt(o):await ut({...o,id:P});J.value=!1,l.status===200&&(E("操作成功","success"),history.back(),window.onTabSaveSuccess&&(u=l.result)!=null&&u.id&&(window.onTabSaveSuccess(l),setTimeout(()=>window.close(),300)))}).catch(e=>{})},Le=async()=>{if(c.value===0)m.value?($(r.provider.id),c.value=c.value+1):E("请选择网络组件！","error");else if(c.value===1)if(!h.value)E("请选择消息协议！","error");else{const e=B!=="child-device"?await pt(h.value,Q.get(r.provider.id)):await _t(h.value);if(e.status===200){k.value=e.result,c.value=c.value+1;const o={title:"分组",dataIndex:"group",key:"group",ellipsis:!0,align:"center",width:100,customCell:(l,d)=>{var q;const u={children:l,rowSpan:0},f=((q=k.value)==null?void 0:q.routes)||[],N=f.filter(S=>S.group===l.group);return(d===0||f[d-1].group!==l.group)&&(u.rowSpan=N.length),u}};z.value=[o,...mt],W.value=[o,...ht]}}},Pe=()=>{c.value=c.value-1};re(()=>{var e;r.data&&r.data.id?r.data.provider!=="child-device"?(h.value=r.data.protocol,c.value=0,m.value=r.data.channelId,O(r.provider.id,m.value),h.value=r.data.protocol,j.value=["网络组件","消息协议","完成"]):(j.value=["消息协议","完成"],c.value=1,$(r.provider.id)):(e=r.provider)!=null&&e.id&&(B!=="child-device"?(O(r.provider.id,""),j.value=["网络组件","消息协议","完成"],c.value=0):(j.value=["消息协议","完成"],c.value=1,$(r.provider.id)))}),re(()=>{P!==":id"&&(h.value=r.data.protocol,b.value={name:r.data.name,description:r.data.description})}),Ae(c,e=>{Z.value=B==="child-device"?e-1:e},{deep:!0,immediate:!0});const je=e=>{let o="";return e.forEach(l=>{o=o+" "+l.address}),o};return(e,o)=>{const l=Ee,d=Qe,u=le("AIcon"),f=Ge,N=Ke,U=Xe,q=Ze,S=ze,H=We,se=Ye,D=et,Ie=tt,Ne=ot,ae=st,Me=at,Be=ce,$e=le("Markdown"),qe=nt,ne=rt;return n(),p("div",null,[a(d,{current:t(Z)},{default:i(()=>[(n(!0),p(T,null,M(t(j),s=>(n(),g(l,{disabled:"",key:s,title:s},null,8,["title"]))),128))]),_:1},8,["current"]),_("div",ft,[t(c)===0?(n(),p("div",gt,[_("div",yt,[a(u,{type:"InfoCircleOutlined"}),x(" 选择与设备通信的网络组件 ")]),_("div",wt,[a(f,{allowClear:"",placeholder:"请输入",style:{width:"300px"},onSearch:Ce}),a(N,{type:"primary",onClick:ge,hasPermission:"link/Type:add"},{icon:i(()=>[a(u,{type:"PlusOutlined"})]),default:i(()=>[x(" 新增 ")]),_:1})]),a(D,{height:"480"},{default:i(()=>[t(C).length>0?(n(),g(H,{key:0,gutter:[24,24],style:{width:"100%"}},{default:i(()=>[(n(!0),p(T,null,M(t(C),s=>(n(),g(S,{span:8,key:s.id},{default:i(()=>[a(ue,{onCheckedChange:xe,checked:t(m),data:{...s,description:s.description?s.description:t(vt)[y.provider.id],type:"network"}},{other:i(()=>[_("div",kt,[a(q,{placement:"top",title:je(s.addresses)},{default:i(()=>[(n(!0),p(T,null,M((s.addresses||[]).slice(0,1),F=>(n(),p("div",{key:F.address,class:"item"},[a(U,{status:oe(F),text:F.address},null,8,["status","text"]),(s.addresses||[]).length>1?(n(),p("span",xt,"等"+L(s.addresses.length)+"条",1)):w("",!0)]))),128))]),_:2},1032,["title"])])]),_:2},1032,["checked","data"])]),_:2},1024))),128))]),_:1})):(n(),g(se,{key:1,style:{"margin-top":"10%"},description:"暂无数据"}))]),_:1})])):t(c)===1?(n(),p("div",Ct,[_("div",bt,[a(u,{type:"InfoCircleOutlined"}),x(" 使用选择的消息协议，对网络组件通信数据进行编解码、认证等操作 ")]),_("div",St,[a(f,{allowClear:"",placeholder:"请输入",style:{width:"300px"},onSearch:Se}),t(ee)?(n(),g(N,{key:0,type:"primary",onClick:ye,hasPermission:"link/Protocol:add",disabled:t(P)!==":id"},{icon:i(()=>[a(u,{type:"PlusOutlined"})]),default:i(()=>[x(" 新增 ")]),_:1},8,["disabled"])):w("",!0)]),a(D,{height:"480"},{default:i(()=>[t(I).length>0?(n(),g(H,{key:0,gutter:[24,24],style:{width:"100%"}},{default:i(()=>[(n(!0),p(T,null,M(t(I),s=>(n(),g(S,{span:8,key:s==null?void 0:s.id},{default:i(()=>[a(ue,{onCheckedChange:be,checked:t(h),disabled:!t(ee),data:{...s,type:"protocol"}},null,8,["checked","disabled","data"])]),_:2},1024))),128))]),_:1})):(n(),g(se,{key:1,style:{"margin-top":"10%"},description:"暂无数据"}))]),_:1})])):(n(),p("div",Tt,[_("div",{class:"card-last",style:Je(`max-height:${t(X)>900?750:t(X)*.7}px`)},[a(H,{gutter:[24,24]},{default:i(()=>[a(S,{span:12},{default:i(()=>[a(Ie,{data:"基本信息"}),a(Be,{ref_key:"formRef",ref:me,model:t(b),layout:"vertical"},{default:i(()=>[a(ae,ie({label:"名称"},t(Y).name),{default:i(()=>[a(Ne,{value:t(b).name,"onUpdate:value":o[0]||(o[0]=s=>t(b).name=s),allowClear:"",placeholder:"请输入名称"},null,8,["value"])]),_:1},16),a(ae,ie({label:"说明"},t(Y).description),{default:i(()=>[a(Me,{placeholder:"请输入说明",rows:4,value:t(b).description,"onUpdate:value":o[1]||(o[1]=s=>t(b).description=s),"show-count":"",maxlength:200},null,8,["value"])]),_:1},16)]),_:1},8,["model"])]),_:1}),a(S,{span:12},{default:i(()=>[a(D,{height:"580"},{default:i(()=>[_("div",Lt,[Pt,_("p",null,L(y.provider.name),1),_("p",null,L(y.provider.description),1),jt,_("p",null,L(t(I).find(s=>s.id===t(h)).name),1),t(k).document?(n(),p("p",It,[a($e,{source:t(k).document},null,8,["source"])])):w("",!0),te()?(n(),p("div",Nt,[Mt,(n(!0),p(T,null,M(we(),s=>(n(),p("p",{key:s.address},[a(U,{status:oe(s),text:s.address},null,8,["status","text"])]))),128))])):w("",!0),t(k).routes&&t(k).routes.length>0?(n(),p("div",Bt,[_("h1",null,L(y.data.provider==="mqtt-server-gateway"||y.data.provider==="mqtt-client-gateway"?"topic":"URL信息"),1),a(D,{height:"400"},{default:i(()=>[a(qe,{pagination:!1,rowKey:_e(),"data-source":t(k).routes||[],bordered:"",columns:t(k).id==="MQTT"?t(z):t(W),scroll:{y:400}},{bodyCell:i(({column:s,text:F,record:De})=>[s.dataIndex==="stream"?(n(),p(T,{key:0},[x(L(ke(De)),1)],64)):w("",!0)]),_:1},8,["rowKey","data-source","columns"])]),_:1})])):w("",!0)])]),_:1})]),_:1})]),_:1})],4)]))]),_("div",$t,[(t(B)==="child-device"?t(c)>1:t(c)>0)?(n(),g(ne,{key:0,style:{"margin-right":"8px"},onClick:Pe},{default:i(()=>[x(" 上一步 ")]),_:1})):w("",!0),t(c)===2&&t(ve)==="false"?(n(),g(N,{key:1,type:"primary",style:{"margin-right":"8px"},onClick:Te,hasPermission:`link/AccessConfig:${t(P)===":id"?"add":"update"}`,loading:t(J)},{default:i(()=>[x(" 保存 ")]),_:1},8,["hasPermission","loading"])):w("",!0),[0,1].includes(t(c))?(n(),g(ne,{key:2,type:"primary",onClick:Le},{default:i(()=>[x(" 下一步 ")]),_:1})):w("",!0)])])}}});const Xt=lt(Dt,[["__scopeId","data-v-a5566285"]]);export{Xt as default};
