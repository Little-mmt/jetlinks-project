import{a4 as $e,f9 as Ee,fa as ze,aL as Ue,aM as Je,aN as Me,$ as ue,ec as Fe,g as ne,e9 as re,au as he,dk as ke,o as be,_ as Ne,f as Be,a6 as Pe,I as Ke,aT as We,d as de,ah as He,ai as qe,fb as Ge,dp as Xe,e as we,z as Ye,dg as Ze,y as Qe,aa as et}from"./index-1730252110824.js";import{u as tt}from"./instance-1730252110824.js";import{u as Ce}from"./product-17302521108245.js";import{d as G,c as te,k as h,r as at,e as ae,o as nt,ab as pe,U as l,Z as m,_ as t,F as Q,a1 as ce,$ as z,f as s,X as a,V as A,E as O,a4 as xe,Y as f,u as c,G as _e,ah as st,b as ot,af as Se,ag as Te,w as lt,B as it}from"./vue-1730252110824.js";import"./index-1730252110824284.js";import"./index-1730252110824282.js";import"./index-1730252110824279.js";import"./index-1730252110824280.js";import"./index-1730252110824281.js";import{d as ve,r as Ie}from"./context-1730252110824.js";import{l as rt}from"./lodash.default-1730252110824.js";import{i as ct}from"./product-17302521108244.js";const ut={class:"editor-box"},dt={class:"top"},pt={class:"left"},_t=["onClick"],vt={class:"right"},yt={key:0},mt={class:"editor"},gt=G({name:"Editor"}),ft=G({...gt,props:{mode:{},id:{},value:{},tips:{}},emits:["change","update:value"],setup(n,{expose:d,emit:_}){const u=n,v=te("target"),g=tt(),y=Ce(),L=h(),U=at({typescript:""}),J=h({name:"javascript"}),X=(e,o)=>{o.languages.typescript.javascriptDefaults.setDiagnosticsOptions({noSemanticValidation:!0,noSyntaxValidation:!1}),o.languages.typescript.javascriptDefaults.setCompilerOptions({allowJs:!0,checkJs:!0,allowNonTsExtensions:!0,target:o.languages.typescript.ScriptTarget.ESNext,strictNullChecks:!1,strictPropertyInitialization:!0,strictFunctionTypes:!0,strictBindCallApply:!0,useDefineForClassFields:!0,moduleResolution:o.languages.typescript.ModuleResolutionKind.NodeJs,module:o.languages.typescript.ModuleKind.CommonJS,typeRoots:["types"],lib:["esnext"]})},V=[{key:"add",value:"+"},{key:"subtract",value:"-"},{key:"multiply",value:"*"},{key:"divide",value:"/"},{key:"parentheses",value:"()"},{key:"cubic",value:"^"},{key:"dayu",value:">"},{key:"dayudengyu",value:">="},{key:"dengyudengyu",value:"=="},{key:"xiaoyudengyu",value:"<="},{key:"xiaoyu",value:"<"},{key:"jiankuohao",value:"<>"},{key:"andand",value:"&&"},{key:"huohuo",value:"||"},{key:"fei",value:"!"},{key:"and",value:"&"},{key:"huo",value:"|"},{key:"bolang",value:"~"}],k=ae({get:()=>u.value||"",set:e=>{_("update:value",e)}}),w=h(!1),C=()=>{J.value.suggestions=$e(u.tips);let e="";v==="device"?(e=g.current.id,Ee(e).then(o=>{o.status===200&&(U.typescript=o.result)})):v==="product"&&(e=y.current.id,ze(e).then(o=>{o.status===200&&(U.typescript=o.result)}))},R=e=>{var o;(o=L.value)==null||o.insert(e)},j=()=>{u.id&&_("change","advance")};return d({addOperatorValue:R}),nt(()=>{setTimeout(()=>{w.value=!0},100)}),C(),(e,o)=>{const E=pe("AIcon"),D=Ue,b=Je,i=Me,S=ue,M=Fe;return l(),m("div",ut,[t("div",dt,[t("div",pt,[(l(!0),m(Q,null,ce(V.filter(($,F)=>F<=3),$=>(l(),m("span",{key:$.key,onClick:F=>R($.value)},z($.value),9,_t))),128)),t("span",null,[s(i,null,{overlay:a(()=>[s(b,null,{default:a(()=>[(l(!0),m(Q,null,ce(V.filter(($,F)=>F>6),$=>(l(),A(D,{key:$.key,onClick:F=>R($.value)},{default:a(()=>[O(z($.value),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:a(()=>[s(E,{type:"MoreOutlined"})]),_:1})])]),t("div",vt,[e.mode!=="advance"?(l(),m("span",yt,[s(S,{title:e.id?"设置属性规则":"请先输入标识"},{default:a(()=>[s(E,{type:"FullscreenOutlined",class:xe(e.id?"":"disabled"),onClick:j},null,8,["class"])]),_:1},8,["title"])])):f("",!0)])]),t("div",mt,[c(w)?(l(),A(M,{key:0,"model-value":c(k),"onUpdate:modelValue":o[0]||(o[0]=$=>_e(k)?k.value=$:null),theme:"vs",ref_key:"editor",ref:L,language:"javascript",registrationTypescript:c(U),registrationTips:c(J),init:X},null,8,["model-value","registrationTypescript","registrationTips"])):f("",!0)])])}}});const ht=ne(ft,[["__scopeId","data-v-03e459d5"]]),kt=st({id:"ruleEditor",state:()=>({state:{model:"simple",code:"",log:[]}}),actions:{set(n,d){this.state[n]=d}}});const se=n=>(Se("data-v-ec7c448b"),n=n(),Te(),n),bt={class:"debug-container"},$t={class:"top"},wt={class:"header"},Ct=se(()=>t("span",{class:"title"}," 属性赋值 ",-1)),xt=se(()=>t("span",{class:"title"}," 标签赋值 ",-1)),St={class:"description"},Tt={key:0,class:"top-bottom"},It={key:1,class:"top-bottom"},Ot={class:"bottom"},Rt={class:"header"},jt={class:"title"},Dt=se(()=>t("div",null,"运行结果",-1)),Lt={key:0},At={class:"action"},Vt=se(()=>t("a",null,"发送数据",-1)),Et=[Vt],zt={key:1},Ut={class:"log"},Jt={key:0},Mt=G({name:"Debug"}),Ft=G({...Mt,props:{virtualRule:Object,id:String,propertiesOptions:Array},emits:["success"],setup(n,{expose:d,emit:_}){const u=n,v=h(!0),g=h([]),y=h([]),L=ve(),U=Ie(),J=[{title:"属性名称",dataIndex:"id",key:"id"},{title:"当前值",dataIndex:"current",key:"current"},{title:"上一值",dataIndex:"last",key:"last"},{title:"操作",key:"action",width:50}],X=[{title:"属性名称",dataIndex:"id",key:"id"},{title:"当前值",dataIndex:"current",key:"current"},{title:"操作",key:"action",width:50}],V=h("property"),k=()=>{g.value.push({})},w=()=>{y.value.push({})},C=r=>{g.value.splice(r,1)},R=r=>{y.value.splice(r,1)},j=h(),e=h(new Date().getTime()),o=te("metadataSource"),E=te("_tagsDataSource"),D=kt(),b=h(0),i=h(null),S=r=>U.value?L.value||r:document.body,M=()=>{var W,q,H;const r=(o==null?void 0:o.value)||[],x=g.value.map(T=>{var Z;const B=r.find(le=>le.id===T.id);return{...T,type:(Z=B==null?void 0:B.valueType)==null?void 0:Z.type}});console.log("runScript",x,r);let N={};if(y.value.forEach(T=>{N[T.id]=T.current}),j.value&&((q=(W=j.value).unsubscribe)==null||q.call(W)),!((H=u.virtualRule)!=null&&H.script)){v.value=!0,re.config({getContainer(){return L.value||document.body}}),be("请编辑规则","warning");return}j.value=ke(`virtual-property-debug-${u.id}-${new Date().getTime()}`,"/virtual-property-debug",{virtualId:`${e.value}-virtual-id`,property:u.id,virtualRule:{...u.virtualRule},properties:x||[],tags:N}).subscribe(T=>{var B;D.state.log.push({time:new Date().getTime(),content:JSON.stringify(T.payload),_time:c(b.value)}),_("success",!1),((B=u.virtualRule)==null?void 0:B.type)!=="window"&&oe()},()=>{},()=>{D.state.log.push({time:new Date().getTime(),content:"运行结束",_time:c(b.value)}),oe()})},$=(r,x)=>{var N,W;return((N=u.virtualRule)==null?void 0:N.windowType)==="time"?`已运行${x}秒`:((W=u.virtualRule)==null?void 0:W.windowType)==="num"?`第${r}次运行`:!1},F=h(),ee=async()=>{var N,W;F.value&&((W=(N=F.value).unsubscribe)==null||W.call(N));const r=(o==null?void 0:o.value)||[],x=g.value.map(q=>{var T;const H=r.find(B=>B.id===q.id);return{...q,type:(T=H==null?void 0:H.valueType)==null?void 0:T.type}});console.log("runScriptAgain",x,r),F.value=ke(`virtual-property-debug-${u.id}-${new Date().getTime()}`,"/virtual-property-debug",{virtualId:`${e.value}-virtual-id`,property:u.id,virtualRule:{...u.virtualRule},properties:x||[]}).subscribe(q=>{})},K=()=>{b.value=0,i.value=setInterval(()=>{b.value+=1},1e3)},Y=()=>{if(!g.value.length||g.value.some(r=>!r.id||!(r.current||r.last)))return re.config({getContainer(){return L.value||document.body}}),be("请填写属性值","warning");v.value=!1,M(),K()},oe=()=>{var r,x;v.value=!0,j.value&&((x=(r=j.value).unsubscribe)==null||x.call(r)),window.clearInterval(i.value),i.value=null},ye=()=>{D.set("log",[])};ot(()=>{var r,x;j.value&&((x=(r=j.value).unsubscribe)==null||x.call(r)),ye(),re.config({getContainer(){return document.body}}),window.clearInterval(i.value),i.value=null});const De=ae(()=>(u.propertiesOptions||[]).map(r=>({label:r.name,value:r.id}))),Le=ae(()=>(E.value||[]).map(r=>({label:r.name,value:r.id})));return d({beginAction:Y}),(r,x)=>{var me,ge,fe;const N=Ne,W=Be,q=Pe,H=Ke,T=pe("AIcon"),B=We,Z=de,le=ue,Ae=He,Ve=qe;return l(),m("div",bt,[t("div",$t,[t("div",wt,[s(W,{activeKey:c(V),"onUpdate:activeKey":x[0]||(x[0]=p=>_e(V)?V.value=p:null)},{rightExtra:a(()=>{var p;return[(p=n.virtualRule)!=null&&p.script&&c(v)?(l(),m("a",{key:0,onClick:Y}," 开始运行 ")):f("",!0)]}),default:a(()=>[s(N,{key:"property"},{tab:a(()=>[Ct]),_:1}),s(N,{key:"tag"},{tab:a(()=>[xt]),_:1})]),_:1},8,["activeKey"])]),t("div",St,z(`请对上方规则使用的${c(V)==="property"?"属性":"标签"}进行赋值`),1),c(V)==="property"?(l(),m("div",Tt,[s(B,{columns:J,"data-source":c(g),pagination:!1,bordered:"",size:"small",scroll:{y:180}},{bodyCell:a(({column:p,record:I,index:ie})=>[p.key==="id"?(l(),A(q,{key:0,showSearch:"",options:c(De),value:I.id,"onUpdate:value":P=>I.id=P,getPopupContainer:S,size:"small",style:{width:"100%"},virtual:!0,dropdownStyle:{zIndex:1072}},null,8,["options","value","onUpdate:value"])):f("",!0),p.key==="current"?(l(),A(H,{key:1,value:I.current,"onUpdate:value":P=>I.current=P,size:"small"},null,8,["value","onUpdate:value"])):f("",!0),p.key==="last"?(l(),A(H,{key:2,value:I.last,"onUpdate:value":P=>I.last=P,size:"small"},null,8,["value","onUpdate:value"])):f("",!0),p.key==="action"?(l(),A(T,{key:3,type:"DeleteOutlined",onClick:P=>C(ie)},null,8,["onClick"])):f("",!0)]),_:1},8,["data-source"]),s(Z,{type:"dashed",block:"",style:{"margin-top":"5px"},onClick:k},{icon:a(()=>[s(T,{type:"PlusOutlined"})]),default:a(()=>[O(" 添加条目 ")]),_:1})])):f("",!0),c(V)==="tag"?(l(),m("div",It,[s(B,{columns:X,"data-source":c(y),pagination:!1,bordered:"",size:"small",scroll:{y:200}},{bodyCell:a(({column:p,record:I,index:ie})=>[p.key==="id"?(l(),A(q,{key:0,showSearch:"",options:c(Le),value:I.id,"onUpdate:value":P=>I.id=P,size:"small",style:{width:"100%"},virtual:!0,getPopupContainer:S,dropdownStyle:{zIndex:1072}},null,8,["options","value","onUpdate:value"])):f("",!0),p.key==="current"?(l(),A(H,{key:1,value:I.current,"onUpdate:value":P=>I.current=P,size:"small"},null,8,["value","onUpdate:value"])):f("",!0),p.key==="action"?(l(),A(T,{key:2,type:"DeleteOutlined",onClick:P=>R(ie)},null,8,["onClick"])):f("",!0)]),_:1},8,["data-source"]),s(Z,{type:"dashed",block:"",style:{"margin-top":"5px"},onClick:w},{icon:a(()=>[s(T,{type:"PlusOutlined"})]),default:a(()=>[O(" 添加条目 ")]),_:1})])):f("",!0)]),t("div",Ot,[t("div",Rt,[t("div",jt,[Dt,(me=n.virtualRule)!=null&&me.script&&!c(v)?(l(),m("div",Lt," 正在运行...... ")):f("",!0)]),t("div",At,[!c(v)&&((ge=n.virtualRule)==null?void 0:ge.type)==="window"?(l(),m("div",{key:0,class:"action",onClick:ee},Et)):f("",!0),(fe=n.virtualRule)!=null&&fe.script&&!c(v)?(l(),m("div",zt,[c(v)?f("",!0):(l(),m("a",{key:0,onClick:oe}," 停止运行 "))])):f("",!0),t("div",null,[t("a",{onClick:ye}," 清空 ")])])]),t("div",Ut,[s(Ve,null,{default:a(()=>[(l(!0),m(Q,null,ce(c(D).state.log,(p,I)=>(l(),A(Ae,{key:p.time,span:3},{label:a(()=>[$(I+1,p._time)?(l(),m(Q,{key:0},[O(z($(I+1,p._time)),1)],64)):(l(),m(Q,{key:1},[O(z(c(he)(p.time).format("HH:mm:ss")),1)],64))]),default:a(()=>[$(I+1,p._time)?(l(),m("div",Jt,z(c(he)(p.time).format("HH:mm:ss")),1)):f("",!0),s(le,{placement:"top",title:p.content},{default:a(()=>[O(z(p.content),1)]),_:2},1032,["title"])]),_:2},1024))),128))]),_:1})])])])}}});const Nt=ne(Ft,[["__scopeId","data-v-ec7c448b"]]);function Oe(n,d,_){const u=rt.cloneDeep(n),v=g=>{g.forEach(y=>{var L;if(y.visible=Bt(d,y,_),y.children&&v(y.children),!y.visible&&((L=y.children)!=null&&L.length)){const U=!y.children.some(J=>J.visible);y.visible=!U}})};return v(u),Re(u)}function Bt(n,d,_){return d[_].includes(n)}function Re(n){return n.filter(d=>(d.children&&(d.children=Re(d.children)),d.visible))}const Pt=[{children:[{children:[],name:"加",id:"operator-1"},{children:[],name:"减",id:"operator-2"},{children:[],name:"乘",id:"operator-3"},{children:[],name:"除",id:"operator-4"},{children:[],name:"括号",id:"operator-5"},{children:[],name:"按位异或",id:"operator-6"}],name:"操作符",id:"operator"},{children:[{children:[],name:"if",id:"if"},{children:[],name:"for",id:"for"},{children:[],name:"while",id:"while"}],name:"控制语句",id:"control"}],Kt=Oe(Pt,"操作","name");console.log(JSON.stringify(Kt),"mytree");const je=n=>(Se("data-v-c33ce9ae"),n=n(),Te(),n),Wt={class:"operator-box"},Ht={class:"left"},qt={class:"tree"},Gt={class:"node"},Xt={style:{"max-width":"160px"}},Yt=je(()=>t("a",{class:"has-property"},"添加",-1)),Zt=je(()=>t("a",{class:"has-property"},"添加",-1)),Qt=["onClick"],ea={class:"right"},ta=G({name:"Operator"}),aa=G({...ta,props:{id:String,propertiesOptions:Array},emits:["addOperatorValue"],setup(n,{emit:d}){const _=n,u=h(),v=h([]),g=h([]),y=te("_tagsDataSource"),L=ve(),U=Ie(),J=e=>{if(e){const o=Oe(g.value,e,"name");v.value=o}else v.value=g.value},X=(e,o)=>{u.value=o.node},V=e=>{d("addOperatorValue",`tag("${e.id}")`)},k=e=>{d("addOperatorValue",`$recent("${e.id}")`)},w=e=>{d("addOperatorValue",`$lastState("${e.id}")`)},C=e=>{d("addOperatorValue",e.code)};Ce();const R=async e=>{const E={id:"property",name:"属性",description:"",code:"",isLeaf:!1,children:_.propertiesOptions.filter(i=>i.id!==e).map(i=>{var M;const S=i.expands.type.length===1&&i.expands.type[0]==="read"?"是":"否";return{id:i.id,name:i.name,isLeaf:!0,description:`### ${i.name}
                
 标识: ${i.id}
                
 数据类型: ${(M=i.valueType)==null?void 0:M.type}
                
 是否只读: ${S}
                
 可写数值范围: `,type:"property"}})},D={id:"tags",name:"标签",Description:"",code:"",isLeaf:!1,children:y.value.map(i=>{var S;return{id:i.id,name:i.name,isLeaf:!0,description:`### ${i.name}
            
 标识: ${i.id}
            
 数据类型: ${(S=i.valueType)==null?void 0:S.type}
            
 可写数值范围: `,type:"tags"}})},b=await ct();b.status===200&&(v.value=[E,D,...b.result],g.value=[E,D,...b.result])},j=e=>U.value?L.value||e:document.body;return lt(()=>_.id,e=>{R(e)},{immediate:!0}),(e,o)=>{var ee;const E=Xe,D=pe("Ellipsis"),b=de,i=ue,S=we,M=Ye,$=Ze,F=Qe;return l(),m("div",Wt,[t("div",Ht,[s(E,{onSearch:J,"allow-clear":"",placeholder:"搜索关键字"}),t("div",qt,[s(F,null,{default:a(()=>[s($,{onSelect:X,"field-names":{title:"name",key:"id"},"auto-expand-parent":"","tree-data":c(v),showLine:{showLeafIcon:!1},"show-icon":!0},{title:a(K=>[t("div",Gt,[t("div",Xt,[s(D,null,{default:a(()=>[O(z(K.name),1)]),_:2},1024)]),t("div",{class:xe(K.isLeaf?"add":"parent")},[K.type==="property"?(l(),A(M,{key:0,overlayStyle:{zIndex:1200},placement:"right",title:"请选择使用值",getPopupContainer:j},{content:a(()=>[s(S,{direction:"vertical"},{default:a(()=>[s(i,{placement:"right",title:"实时值为空时获取上一有效值补齐，实时值不为空则使用实时值"},{default:a(()=>[s(b,{type:"text",onClick:Y=>k(K)},{default:a(()=>[O(" $recent实时值 ")]),_:2},1032,["onClick"])]),_:2},1024),s(i,{placement:"right",title:"实时值的上一有效值"},{default:a(()=>[s(b,{onClick:Y=>w(K),type:"text"},{default:a(()=>[O(" 上一值 ")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),default:a(()=>[Yt]),_:2},1024)):K.type==="tags"?(l(),A(M,{key:1,overlayStyle:{zIndex:1200},placement:"right",title:"请选择使用值",getPopupContainer:j},{content:a(()=>[s(S,{direction:"vertical"},{default:a(()=>[s(i,{placement:"right",title:"实时值为空时获取上一有效值补齐，实时值不为空则使用实时值"},{default:a(()=>[s(b,{type:"text",onClick:Y=>V(K)},{default:a(()=>[O(" tag实时值 ")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),default:a(()=>[Zt]),_:2},1024)):(l(),m("a",{key:2,class:"no-property",onClick:it(Y=>C(K),["stop"])}," 添加 ",8,Qt))],2)])]),_:1},8,["tree-data"])]),_:1})])]),t("div",ea,[s(c(Ge),{source:((ee=c(u))==null?void 0:ee.description)||""},null,8,["source"])])])}}});const na=ne(aa,[["__scopeId","data-v-c33ce9ae"]]),sa={key:0,class:"header"},oa={class:"header-item"},la={class:"header-item"},ia={class:"box"},ra={class:"left"},ca={style:{"margin-top":"10px"}},ua={class:"right"},da=G({name:"FRuleEditor"}),pa=G({...da,props:{value:String,id:String,virtualRule:Object,aggList:Array,propertiesOptions:Array},emits:["save","close"],setup(n,{emit:d}){const _=n,u=h(_.value),v=ve(),g=h([]),y=()=>{d("close")},L=()=>{d("save",u.value)},U=ae(()=>{const k=((_==null?void 0:_.aggList)||[]).find(w=>{var C;return(w==null?void 0:w.value)===((C=_.virtualRule)==null?void 0:C.aggType)});return k==null?void 0:k.label}),J=h(),X=k=>{J.value.addOperatorValue(k)};return(()=>{var w;const k=(w=$e(_.propertiesOptions))==null?void 0:w.filter(C=>(_==null?void 0:_.id)!==C.id);console.log(k,"list"),k.forEach(C=>{console.log(C);const R=C;g.value.push({label:`${R.name}$recent实时值`,insertText:`$recent ("${R.id}")`,kind:18}),g.value.push({label:`${R.name}上一值`,insertText:`$lastState("${R.id}"))`,kind:18})})})(),(k,w)=>{const C=de,R=we,j=et;return l(),A(j,{zIndex:1072,"mask-closable":!1,visible:"",width:"1300px",title:"编辑规则",destroyOnClose:!0,dialogStyle:{zIndex:1072},getContainer:e=>c(v)||e,onCancel:y},{footer:a(()=>[s(R,null,{default:a(()=>[s(C,{onClick:y},{default:a(()=>[O("取消")]),_:1}),s(C,{onClick:L,type:"primary"},{default:a(()=>[O("确定")]),_:1})]),_:1})]),default:a(()=>{var e,o,E,D,b,i,S;return[(e=n.virtualRule)!=null&&e.windowType&&((o=n.virtualRule)==null?void 0:o.windowType)!=="undefined"?(l(),m("div",sa,[t("div",oa,z(((E=n.virtualRule)==null?void 0:E.windowType)==="time"?"时间窗口":"频次窗口"),1),t("div",la,[t("div",null,[O("聚合函数: "),t("span",null,z(c(U)||"--"),1)]),t("div",null,[O("窗口长度(次)："),t("span",null,z(((b=(D=n.virtualRule)==null?void 0:D.window)==null?void 0:b.span)||"--"),1)]),t("div",null,[O("步长(次): "),t("span",null,z(((S=(i=n.virtualRule)==null?void 0:i.window)==null?void 0:S.every)||"--"),1)])])])):f("",!0),t("div",ia,[t("div",ra,[t("div",null,[s(ht,{ref_key:"editor",ref:J,mode:"advance",key:"advance",value:c(u),"onUpdate:value":w[0]||(w[0]=M=>_e(u)?u.value=M:null),tips:c(g)},null,8,["value","tips"])]),t("div",ca,[s(Nt,{virtualRule:{...n.virtualRule,script:c(u)},propertiesOptions:n.propertiesOptions,id:n.id},null,8,["virtualRule","propertiesOptions","id"])])]),t("div",ua,[s(na,{id:n.id,propertiesOptions:n.propertiesOptions,onAddOperatorValue:X},null,8,["id","propertiesOptions"])])])]}),_:1},8,["getContainer"])}}});const xa=ne(pa,[["__scopeId","data-v-de3c8ac4"]]);export{xa as F};
