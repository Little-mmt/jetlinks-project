import{fh as Ve,fi as Re,fj as je,fk as Ee,fl as Ue,fm as Be,k as qe,aC as Ke,a4 as ue,$ as Me,dw as Ne,aT as Fe,K as Je,cY as $e,d5 as Le,aR as Qe,v as ze,d9 as Ae,F as We,M as Ye,y as Ze,af as Ge,Z as Xe}from"./index-1731638920964.js";import"./index-1731638920964276.js";import"./index-1731638920964282.js";import"./index-1731638920964279.js";import"./index-1731638920964280.js";import"./index-1731638920964281.js";import{_ as He}from"./Metrics.vue_vue_type_script_setup_true_name_Metrics_lang-1731638920964.js";import{u as pe}from"./product-17316389209645.js";import{u as me}from"./instance-1731638920964.js";import{b as et,e as tt}from"./product-17316389209644.js";import{P as ot}from"./index-1731638920964294.js";import{d as at}from"./context-1731638920964.js";import"./index-1731638920964295.js";import"./index-1731638920964293.js";import{u as C}from"./useRequest-1731638920964.js";import{k as f,d as fe,c as lt,r as it,e as V,w as z,ab as de,U as u,V as m,X as o,u as a,G as ce,Z as R,F as A,a1 as nt,E as b,$ as W,f as s,Y as v,_ as k,af as rt,ag as st}from"./vue-1731638920964.js";const ut=i=>{const h=pe(),e=me(),D=f({}),{run:E}=C(Ve,{immediate:!1}),{run:U}=C(Re,{immediate:!1}),{run:B}=C(je,{immediate:!1}),{run:q}=C(Ee,{immediate:!1}),{run:K}=C(Ue,{immediate:!1,onSuccess(d){I(d.result)}}),{run:_}=C(Be,{immediate:!1,onSuccess(d){I(d.result)}}),I=d=>{D.value={type:d.configuration.matcher.provider,limit:{lower:d.configuration.matcher.configuration.min,upper:d.configuration.matcher.configuration.max},mode:d.configuration.processors[0].provider}};return{thresholdUpdate:d=>{const S={thingType:"device",provider:"simple",configuration:{matcher:{provider:d.type,configuration:{max:d.limit.upper,min:d.limit.lower,not:!0}},processors:[{provider:d.mode,configuration:{}}]}};i.target==="product"?E(h.current.id,i.id,S):U(e.current.productId,e.current.id,i.id,S)},thresholdDelete:()=>{i.target==="product"?B(h.current.id,i.id):q(e.current.productId,e.current.id,i.id)},thresholdDetailQuery:()=>{i.target==="product"?_(h.current.id,i.id,!1):K(e.current.productId,e.current.id,i.id)},thresholdDetail:D}},j=i=>(rt("data-v-d8c8c8c1"),i=i(),st(),i),dt=j(()=>k("div",null,"阈值限制",-1)),ct={class:"extra-limit extra-check-group"},pt=j(()=>k("div",{class:"extra-title"}," 阈值 ",-1)),mt=j(()=>k("span",null,"~",-1)),ft=j(()=>k("div",{class:"extra-title"}," 超出阈值数据处理方式 ",-1)),yt={class:"extra-handle extra-check-group"},vt={style:{margin:"8px 0"}},ht={key:1,style:{"padding-top":"24px"}},_t=fe({name:"OtherSetting"}),Ut=fe({..._t,props:{value:{type:Object,default:()=>({})},type:{type:String,default:void 0},disabled:{type:Boolean,default:!1},id:{type:String,default:void 0},name:{type:String,default:void 0},record:{type:Object,default:()=>({})},hasPermission:String,tooltip:Object,metadataType:{type:String,default:"properties"},target:String,isProduct:{type:Boolean,default:!1}},emits:["update:value","change"],setup(i,{emit:h}){var X;const e=i,D=lt("_metadataType"),{showThreshold:E}=qe(),U=pe(),B=me(),q=at(),{thresholdUpdate:K,thresholdDetail:_,thresholdDetailQuery:I,thresholdDelete:Y}=ut(e),M=f(),x=f(),d=f(),S=f(e.value),Z=f(!1),w=f(!1),N=f([]),T=f((X=e.value)==null?void 0:X.expands),l=it({limit:{upper:0,lower:0},mode:"ignore",type:""}),ye={properties:"property",functions:"function",events:"event",tags:"tag"},ve=V(()=>l.mode==="ignore"?"平台将忽略超出阈值的数据，无法查看上报记录":l.mode==="device-record"?"您可以在预处理数据-无效数据页面查看超出阈值的数据上报记录":"您可以在预处理数据-告警数据页面查看告警情况"),he=V(()=>e.isProduct&&e.target==="device"?O.value:(F.value||N.value.length>0)&&e.id),F=V(()=>["int","long","float","double","string","boolean","date"].includes(e.type)),O=V(()=>["int","long","float","double"].includes(e.type)&&e.metadataType==="properties"&&E),J=f([{label:"否",value:"false"},{label:"是",value:"true"}]),_e=f([{title:"参数名称",dataIndex:"name",width:150,ellipsis:!0},{title:"输入类型",dataIndex:"type",width:150},{title:"值",dataIndex:"value"}]),ge=(c,t,r)=>{r||t==="number-range"&&(l.limit.lower=0,l.limit.upper=0),c.length===0&&(l.mode="ignore")},be=()=>{l.mode="ignore",l.type="",l.limit.lower=0,l.limit.upper=0},G=async c=>{c.stopPropagation(),await Y(),be(),I()},xe=(c,t)=>t.lower!==null&&t.upper!==null?t.upper<t.lower?Promise.reject("上限必须大于下限"):Promise.resolve():Promise.reject("请输入上下限"),we=async()=>{var g;const c=D==="product"?(g=U.current)==null?void 0:g.id:B.current.id;if(!e.id||!c||!e.type)return;if(e.type==="boolean"){const p=e.record.valueType;J.value[0]={label:p.falseText||"否",value:p.falseValue||"false"},J.value[1]={label:p.trueText||"是",value:p.trueValue||"true"}}const t={deviceId:c,metadata:{id:e.id,type:ye[e.metadataType],dataType:e.type}},r=D==="product"?await et(t):await tt(t);r.success&&(N.value=r.result,r.result.length?x.value=["store_0"]:F.value&&(x.value=["metrics"]),O.value&&(x.value=["extra"]),r.result.length&&!T.value&&r.result.forEach(p=>{p.properties&&p.properties.forEach(y=>{T.value[y.property]=void 0})})),Z.value=!0},ke=()=>new Promise(async(c,t)=>{var r,g;try{let p;p=await((r=d.value)==null?void 0:r.getData());const y={...T.value||{}};p&&(y.metrics=p),O.value&&l.type?(g=M.value)==null||g.validate().then(async()=>{await K(l),y.otherEdit=!0,h("update:value",{...e.value,...y}),h("change"),w.value=!1,c(!0)}):(y.otherEdit=!0,h("update:value",{...e.value,...y}),h("change"),w.value=!1,c(!0))}catch{t(!1)}});z(()=>w.value,async()=>{w.value&&(T.value=Ke(e.value,["source","type","metrics","required"]),we(),O.value&&I())},{immediate:!0});const Se=()=>{S.value=ue(e.value)};return z(()=>_,()=>{var c,t,r;_.value&&JSON.stringify(_.value)!=="{}"&&(l.mode=(c=_.value)==null?void 0:c.mode,l.type=((t=_.value)==null?void 0:t.type)||"",l.limit=(r=_.value)==null?void 0:r.limit)},{immediate:!0,deep:!0}),z(()=>JSON.stringify(e.value),()=>{S.value=ue(e.value)},{immediate:!0}),(c,t)=>{const r=de("AIcon"),g=Me,p=Ne,y=Fe,$=Je,H=$e,Te=Le,ee=Qe,te=de("CardSelect"),L=ze,oe=Ae,Pe=We,Ce=Ye,De=Ze,Ie=Ge,ae=Xe;return i.disabled?(u(),m(ae,{key:"setting",disabled:i.disabled,"has-permission":i.hasPermission,tooltip:i.tooltip,type:"primary"},{default:o(()=>[s(r,{type:"EditOutlined"}),b(" 配置 ")]),_:1},8,["disabled","has-permission","tooltip"])):(u(),m(a(ot),{key:0,visible:a(w),"onUpdate:visible":t[7]||(t[7]=n=>ce(w)?w.value=n:null),"body-style":"padding-top:4px;width:600px;",placement:"bottomRight",disabled:i.disabled,onOk:ke,onCancel:Se},{content:o(()=>[a(he)?(u(),m(De,{key:0,height:"350"},{default:o(()=>[a(Z)?(u(),m(Ce,{key:0,activeKey:a(x),"onUpdate:activeKey":t[6]||(t[6]=n=>ce(x)?x.value=n:null)},{default:o(()=>[e.isProduct&&i.target==="device"?v("",!0):(u(!0),R(A,{key:0},nt(a(N),(n,Oe)=>(u(),m($,{key:"store_"+Oe},{header:o(()=>[b(W(n.name)+" ",1),n.description?(u(),m(g,{key:0,title:n.description},{default:o(()=>[s(r,{type:"ExclamationCircleOutlined",style:{"padding-left":"12px","padding-top":"4px"}})]),_:2},1032,["title"])):v("",!0)]),default:o(()=>[s(y,{columns:a(_e),"data-source":n.properties,pagination:!1,rowKey:"id"},{bodyCell:o(({column:le,record:Q,index:ie})=>{var ne,re,se;return[le.dataIndex==="type"?(u(),R(A,{key:0},[b(W((ne=Q.type)==null?void 0:ne.name),1)],64)):le.dataIndex==="value"?(u(),m(p,{key:1,modelValue:a(T)[Q.property],"onUpdate:modelValue":P=>a(T)[Q.property]=P,itemType:(re=n.properties[ie].type)==null?void 0:re.type,extra:{dropdownStyle:{zIndex:1071},popupStyle:{zIndex:1071}},getPopupContainer:P=>a(q)||P,options:(((se=n.properties[ie].type)==null?void 0:se.elements)||[]).map(P=>({label:P.text,value:P.value}))},null,8,["modelValue","onUpdate:modelValue","itemType","getPopupContainer","options"])):v("",!0)]}),_:2},1032,["columns","data-source"])]),_:2},1024))),128)),a(F)&&!(e.isProduct&&i.target==="device")?(u(),m($,{key:"metrics"},{header:o(()=>[b(" 指标配置 "),s(g,{title:"场景联动页面可引用指标配置作为触发条件"},{default:o(()=>[s(r,{type:"ExclamationCircleOutlined",style:{"padding-left":"12px","padding-top":"4px"}})]),_:1})]),default:o(()=>[s(He,{ref_key:"metricsRef",ref:d,options:a(J),type:e.type,value:a(S).metrics},null,8,["options","type","value"])]),_:1})):v("",!0),a(O)?(u(),m($,{key:"extra"},{header:o(()=>[s(ee,null,{default:o(()=>[dt,e.isProduct&&i.target==="device"?(u(),R(A,{key:0},[s(H,{type:"link",style:{padding:"0 4px",height:"22px"},onClick:t[0]||(t[0]=n=>G(n))},{icon:o(()=>[s(r,{type:"RedoOutlined"})]),default:o(()=>[b(" 重置 ")]),_:1}),s(Te,null,{title:o(()=>[b("重置后阀值限制继承于产品")]),default:o(()=>[s(r,{type:"QuestionCircleOutlined"})]),_:1})],64)):(u(),m(H,{key:1,type:"link",style:{padding:"0 4px",height:"22px"},onClick:t[1]||(t[1]=n=>G(n))},{icon:o(()=>[s(r,{type:"RedoOutlined"})]),default:o(()=>[b(" 清空 ")]),_:1}))]),_:1})]),default:o(()=>[s(Pe,{model:a(l),layout:"vertical",ref_key:"ThresholdRef",ref:M},{default:o(()=>[s(L,null,{default:o(()=>[k("div",ct,[s(te,{value:a(l).type,"onUpdate:value":t[2]||(t[2]=n=>a(l).type=n),options:[{label:"上下限",value:"number-range"}],showImage:!1,onSelect:ge},null,8,["value"])])]),_:1}),a(l).type?(u(),m(L,{key:0,name:"limit",rules:[{required:!0,message:"请输入上下限"},{validator:xe,trigger:"change"}]},{label:o(()=>[pt]),default:o(()=>[a(l).type==="number-range"?(u(),m(ee,{key:0},{default:o(()=>[s(oe,{value:a(l).limit.lower,"onUpdate:value":t[3]||(t[3]=n=>a(l).limit.lower=n),style:{width:"178px"},placeholder:"请输入下限"},null,8,["value"]),mt,s(oe,{value:a(l).limit.upper,"onUpdate:value":t[4]||(t[4]=n=>a(l).limit.upper=n),style:{width:"178px"},min:a(l).limit.lower,placeholder:"请输入上限"},null,8,["value","min"])]),_:1})):v("",!0)]),_:1},8,["rules"])):v("",!0),a(l).type?(u(),m(L,{key:1,name:"mode",rules:[{required:!0,message:"请选择处理方式"}]},{label:o(()=>[ft]),default:o(()=>[k("div",yt,[s(te,{value:a(l).mode,"onUpdate:value":t[5]||(t[5]=n=>a(l).mode=n),options:[{label:"忽略",value:"ignore"},{label:"记录",value:"device-record"},{label:"告警",value:"device-alarm"}],showImage:!1},null,8,["value"]),k("div",vt,W(a(ve)),1)])]),_:1})):v("",!0)]),_:1},8,["model"])]),_:1})):v("",!0)]),_:1},8,["activeKey"])):v("",!0)]),_:1})):(u(),R("div",ht,[s(Ie,{description:"没有动态配置项"})]))]),default:o(()=>[s(ae,{key:"setting",disabled:i.disabled,"has-permission":i.hasPermission,tooltip:i.tooltip,type:"primary"},{default:o(()=>[s(r,{type:"EditOutlined"}),b(" 配置 ")]),_:1},8,["disabled","has-permission","tooltip"])]),_:1},8,["visible","disabled"]))}}});export{Ut as _};
