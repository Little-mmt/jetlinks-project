import{o as T,I as L,v as D,F as x,af as O}from"./index-1731638920964.js";import{_ as F}from"./BuildIn.vue_vue_type_script_setup_true_name_NotifyBuildIn_lang-1731638920964.js";import{_ as Z}from"./Org.vue_vue_type_script_setup_true_lang-1731638920964.js";import{_ as z}from"./Tag.vue_vue_type_script_setup_true_lang-1731638920964.js";import{_ as B}from"./InputFile.vue_vue_type_script_setup_true_lang-1731638920964.js";import{_ as N}from"./User.vue_vue_type_script_setup_true_name_NotifyUser_lang-1731638920964.js";import{d as R,k as E,r as V,s as U,U as y,V as g,X as I,Z as q,F as K,a1 as S,u as l}from"./vue-1731638920964.js";const v=R({__name:"VariableDefinitions",props:{variableDefinitions:{type:Array,default:()=>[]},value:{type:Object,default:()=>({})},notify:{type:Object,default:()=>({})},template:{type:Object,default:()=>({})},options:{type:Object,default:()=>({})}},emits:["update:value","change"],setup(m,{expose:A,emit:_}){var b;const o=m,P=E(),s=V({}),j=E(((b=o.options)==null?void 0:b.otherColumns)||[]);U(()=>{Object.assign(s,o==null?void 0:o.value)}),U(()=>{var f,e,t,a,d,i,r,c,n,u;(e=(f=o==null?void 0:o.template)==null?void 0:f.template)!=null&&e.sendTo&&Array.isArray((a=(t=o==null?void 0:o.template)==null?void 0:t.template)==null?void 0:a.sendTo)&&((r=(i=(d=o==null?void 0:o.template)==null?void 0:d.template)==null?void 0:i.sendTo)!=null&&r.length)&&_("change",{sendTo:(u=(n=(c=o==null?void 0:o.template)==null?void 0:c.template)==null?void 0:n.sendTo)==null?void 0:u.join(" ")})});const p=f=>{var e;return((e=f.expands)==null?void 0:e.businessType)||f.type},$=(f,e,t)=>{var d,i;if(!e)return Promise.resolve();const a=((d=t.expands)==null?void 0:d.businessType)||(t==null?void 0:t.type);if(["user","org","tag","userIdList","departmentIdList"].includes(a)||a==="file")return Promise.resolve();if(a==="link")if(e){if(e.length>64)return Promise.reject(new Error("最多64个字符"))}else return Promise.reject(new Error("请输入"+t.name));else{if(a==="tag"&&!e)return Promise.reject(new Error("请选择"+t.name));if(["date","org"].includes(a))return e?(e==null?void 0:e.source)==="upper"?e!=null&&e.upperKey?Promise.resolve():Promise.reject(new Error("请选择"+t.name)):e!=null&&e.value?Promise.resolve():Promise.reject(new Error("请选择"+t.name)):Promise.reject(new Error("请选择"+t.name));if((e==null?void 0:e.source)==="fixed"&&!(e!=null&&e.value)){let r="请输入"+t.name;return o.notify.notifyType==="email"&&(r="请输入收件人"),Promise.reject(new Error(r))}else{if((e==null?void 0:e.source)==="relation"&&!(e!=null&&e.value)&&!(e!=null&&e.relation))return Promise.reject(new Error("请选择"+t.name));if((e==null?void 0:e.source)==="upper"&&!e.upperKey)return Promise.reject(new Error("请选择"+t.name));if(a==="user"){if(o.notify.notifyType==="email"&&(e==null?void 0:e.source)!=="relation")if(Array.isArray(e==null?void 0:e.value)){if(!(e!=null&&e.value.length))return Promise.reject(new Error("请输入收件人"));const r=/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;return(e==null?void 0:e.value.every(n=>r.test(n)))?Promise.resolve():Promise.reject(new Error("请输入正确的邮箱地址"))}else return Promise.resolve();if(o.notify.notifyType&&["sms","voice"].includes((i=o==null?void 0:o.notify)==null?void 0:i.notifyType)&&(e==null?void 0:e.source)!=="relation"&&(e!=null&&e.value))return/^[1][3-9]\d{9}$/.test(e==null?void 0:e.value)?Promise.resolve():Promise.reject(new Error("请输入正确的手机号码"))}}}return Promise.resolve()},h=(f,e,t,a)=>{e==="build-in"?j.value[t]=a:j.value[t]=void 0,e==="org"?_("change",{orgName:f.join(","),otherColumns:[]}):e==="tag"?_("change",{tagName:f,otherColumns:[]}):e==="user"?_("change",{sendTo:f,otherColumns:[]}):_("change",{otherColumns:j.value})};return A({onSave:()=>new Promise((f,e)=>{var d;const t=o.variableDefinitions.filter(i=>["user","org","tag","userIdList","departmentIdList"].includes(p(i))),a=t.length?t.some(i=>{var r,c,n,u,k,w,C;return i.id==="toUser"&&((r=s[i.id])==null?void 0:r.source)==="relation"?((c=s[i.id].relation)==null?void 0:c.objectId)||((n=s[i.id].relation)==null?void 0:n.related):i.id==="userIdList"?((u=s[i.id])==null?void 0:u.value)||((w=(k=s[i.id])==null?void 0:k.relation)==null?void 0:w.objectId):(C=s[i.id])==null?void 0:C.value}):!0;if(!a&&o.notify.notifyType==="weixin")return T("收信人，收信人部门，收信人标签至少填写一个","warning"),e(!1);if(!a&&o.notify.notifyType==="dingTalk")return T("收信人，收信人部门至少填写一个","warning"),e(!1);(d=P.value)==null||d.validate().then(i=>{f(i)}).catch(()=>{e(!1)})})}),(f,e)=>{const t=L,a=D,d=x,i=O;return m.variableDefinitions.length?(y(),g(d,{key:0,layout:"vertical",ref_key:"formRef",ref:P,model:l(s)},{default:I(()=>[(y(!0),q(K,null,S(m.variableDefinitions,(r,c)=>(y(),g(a,{name:`${r==null?void 0:r.id}`,label:r==null?void 0:r.name,key:r.id,required:!["file","user","org","tag"].includes(p(r))||r.id==="calledNumber",rules:[{validator:(n,u)=>$(n,u,r),trigger:["blur","change"]}]},{default:I(()=>[p(r)==="user"?(y(),g(N,{key:0,notify:m.notify,value:l(s)[r.id],"onUpdate:value":n=>l(s)[r.id]=n,onChange:n=>h(n,"user",c)},null,8,["notify","value","onUpdate:value","onChange"])):p(r)==="org"?(y(),g(Z,{key:1,notify:m.notify,value:l(s)[r.id],"onUpdate:value":n=>l(s)[r.id]=n,onChange:n=>h(n,"org",c)},null,8,["notify","value","onUpdate:value","onChange"])):p(r)==="tag"?(y(),g(z,{key:2,notify:m.notify,value:l(s)[r.id],"onUpdate:value":n=>l(s)[r.id]=n,onChange:n=>h(n,"tag",c)},null,8,["notify","value","onUpdate:value","onChange"])):p(r)==="file"?(y(),g(B,{key:3,value:l(s)[r.id],"onUpdate:value":n=>l(s)[r.id]=n},null,8,["value","onUpdate:value"])):p(r)==="link"?(y(),g(t,{key:4,value:l(s)[r.id],"onUpdate:value":n=>l(s)[r.id]=n},null,8,["value","onUpdate:value"])):(y(),g(F,{key:5,item:r,value:l(s)[r.id],"onUpdate:value":n=>l(s)[r.id]=n,onChange:(n,u)=>h(n,"build-in",c,u)},null,8,["item","value","onUpdate:value","onChange"]))]),_:2},1032,["name","label","required","rules"]))),128))]),_:1},8,["model"])):(y(),g(i,{key:1,style:{margin:"20px 0"},description:"暂无模板变量"}))}}});export{v as _};
